(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();class Bt{constructor(t,e,s,i,n,o){this.data=null,this._pos=[0,0],this._last_time=0,this.id=t,this.type=e,this.origin_id=s,this.origin_slot=i,this.target_id=n,this.target_slot=o}static configure(t){return t instanceof Array?new Bt(t[0],t[5],t[1],t[2],t[3],t[4]):new Bt(t.id,t.type,t.origin_id,t.origin_slot,t.target_id,t.target_slot)}serialize(){return[this.id,this.origin_id,this.origin_slot,this.target_id,this.target_slot,this.type]}}var ct=(r=>(r[r.STATUS_STOPPED=1]="STATUS_STOPPED",r[r.STATUS_RUNNING=2]="STATUS_RUNNING",r))(ct||{}),R=(r=>(r[r.UP=1]="UP",r[r.DOWN=2]="DOWN",r[r.LEFT=3]="LEFT",r[r.RIGHT=4]="RIGHT",r[r.CENTER=5]="CENTER",r))(R||{}),nt=(r=>(r[r.ALWAYS=0]="ALWAYS",r[r.ON_EVENT=1]="ON_EVENT",r[r.NEVER=2]="NEVER",r[r.ON_TRIGGER=3]="ON_TRIGGER",r[r.ON_REQUEST=4]="ON_REQUEST",r))(nt||{});const St=["Always","On Event","Never","On Trigger"],Je=["#666","#422","#333","#224","#626"];var L=(r=>(r[r.DEFAULT=0]="DEFAULT",r[r.BOX_SHAPE=1]="BOX_SHAPE",r[r.ROUND_SHAPE=2]="ROUND_SHAPE",r[r.CIRCLE_SHAPE=3]="CIRCLE_SHAPE",r[r.CARD_SHAPE=4]="CARD_SHAPE",r[r.ARROW_SHAPE=5]="ARROW_SHAPE",r[r.GRID_SHAPE=6]="GRID_SHAPE",r))(L||{});const $e=["default","box","round","circle","card","arrow","square"];var q=(r=>(r[r.INPUT=0]="INPUT",r[r.OUTPUT=1]="OUTPUT",r))(q||{}),qt=(r=>(r[r.STRAIGHT_LINK=0]="STRAIGHT_LINK",r[r.LINEAR_LINK=1]="LINEAR_LINK",r[r.SPLINE_LINK=2]="SPLINE_LINK",r))(qt||{}),yt=(r=>(r[r.NORMAL_TITLE=0]="NORMAL_TITLE",r[r.NO_TITLE=1]="NO_TITLE",r[r.TRANSPARENT_TITLE=2]="TRANSPARENT_TITLE",r[r.AUTOHIDE_TITLE=3]="AUTOHIDE_TITLE",r))(yt||{}),y=(r=>(r[r.EVENT=-2]="EVENT",r[r.ACTION=-1]="ACTION",r[r.DEFAULT=0]="DEFAULT",r))(y||{});const es=["*","array","object","number","string","enum","boolean","table"];var Ft=(r=>(r.VERTICAL_LAYOUT="vertical",r.HORIZONTAL_LAYOUT="horizontal",r))(Ft||{});function Nt(r,t,e){return t>r?t:e<r?e:r}function ie(r,t){return r.reduce((e,s)=>{const i=t(s);return e[i]=s,e},{})}function Ze(r,t){return t in r?r[t]:null}function De(r,t){return t in r.constructor?r.constructor[t]:null}function Js(r,t){if(r.target!==t)return;let e=r.clientX-parseInt(window.getComputedStyle(t).left),s=r.clientY-parseInt(window.getComputedStyle(t).top);const i=o=>{if(o.buttons===0){n();return}t.style.top=o.clientY-s+"px",t.style.left=o.clientX-e+"px"},n=()=>{window.removeEventListener("mousemove",i),window.removeEventListener("mouseup",n)};window.addEventListener("mousemove",i),window.addEventListener("mouseup",n)}function Le(r){return r.addEventListener("mousedown",t=>Js(t,r)),r.classList.add("draggable"),r}function ot(r){return r===y.EVENT?"Event":r===y.ACTION?"Action":r===y.DEFAULT?"Default":r}function ss(r){return r===y.EVENT||r===y.ACTION||r===y.DEFAULT||typeof r=="string"}let te;const $s=new Uint8Array(16);function Zs(){if(!te&&(te=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!te))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return te($s)}const et=[];for(let r=0;r<256;++r)et.push((r+256).toString(16).slice(1));function Qs(r,t=0){return et[r[t+0]]+et[r[t+1]]+et[r[t+2]]+et[r[t+3]]+"-"+et[r[t+4]]+et[r[t+5]]+"-"+et[r[t+6]]+et[r[t+7]]+"-"+et[r[t+8]]+et[r[t+9]]+"-"+et[r[t+10]]+et[r[t+11]]+et[r[t+12]]+et[r[t+13]]+et[r[t+14]]+et[r[t+15]]}const ti=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Qe={randomUUID:ti};function kt(r,t,e){if(Qe.randomUUID&&!t&&!r)return Qe.randomUUID();r=r||{};const s=r.random||(r.rng||Zs)();if(s[6]=s[6]&15|64,s[8]=s[8]&63|128,t){e=e||0;for(let i=0;i<16;++i)t[e+i]=s[i];return t}return Qs(s)}const is=class Pe{constructor(){this.desc="",this.pos=[0,0],this.subgraph=null,this.skip_subgraph_button=!1,this.priority=0,this.removable=!0,this.clonable=!0,this.collapsable=!0,this.titleMode=yt.NORMAL_TITLE,this.serialize_widgets=!1,this.hide_in_node_lists=!1,this.block_delete=!1,this.ignore_remove=!1,this.last_serialization=null,this._relative_id=null,this.exec_version=0,this.action_call=null,this.execute_triggered=0,this.action_triggered=0,this.console=[],this.size=[h.NODE_WIDTH,60],this.graph=null,this.pos=[10,10],h.use_uuids?this.id=kt():this.id=-1,this.type=null,this.inputs=[],this.outputs=[],this.connections=[],this.properties={},this.properties_info=[],this.flags={}}get slotLayout(){return"slotLayout"in this.constructor?this.constructor.slotLayout:null}configure(t){this.graph&&this.graph._version++;for(var e in t){if(e=="properties"){for(var s in t.properties)this.properties[s]=t.properties[s],this.onPropertyChanged&&this.onPropertyChanged(s,t.properties[s]);continue}t[e]!=null&&(typeof t[e]=="object"?this[e]&&this[e].configure?this[e].configure(t[e]):this[e]=h.cloneObject(t[e],this[e]):this[e]=t[e])}t.title||(this.title=De(this,"title")||this.title);const i=t.bgColor;if(i!=null&&(this.bgcolor||(this.bgcolor=i)),this.inputs)for(let a=0;a<this.inputs.length;++a){let l=this.inputs[a],u=this.graph?this.graph.links[l.link]:null;l.properties||(l.properties={}),this.onConnectionsChange&&this.onConnectionsChange(q.INPUT,a,!0,u,l),this.onInputAdded&&this.onInputAdded(l)}if(this.outputs)for(var n=0;n<this.outputs.length;++n){let a=this.outputs[n];if(a.properties||(a.properties={}),!!a.links){for(let l=0;l<a.links.length;++l){let u=this.graph?this.graph.links[a.links[l]]:null;this.onConnectionsChange&&this.onConnectionsChange(q.OUTPUT,n,!0,u,a)}this.onOutputAdded&&this.onOutputAdded(a)}}if(this.widgets){for(var n=0;n<this.widgets.length;++n){var o=this.widgets[n];o&&o.options&&o.options.property&&this.properties[o.options.property]&&(o.value=JSON.parse(JSON.stringify(this.properties[o.options.property])))}if(t.widgets_values)for(var n=0;n<t.widgets_values.length;++n)this.widgets[n]&&(this.widgets[n].value=t.widgets_values[n])}this.onConfigure&&this.onConfigure(t)}serialize(){let t={id:this.id,type:this.type,pos:this.pos,size:this.size,flags:h.cloneObject(this.flags),order:this.order,mode:this.mode};if(this.constructor===Pe&&this.last_serialization)return this.last_serialization;if(this.inputs&&(t.inputs=this.inputs),this.outputs){for(var e=0;e<this.outputs.length;e++)delete this.outputs[e]._data;t.outputs=this.outputs}if(this.title&&this.title!=this.constructor.title&&(t.title=this.title),this.properties&&(t.properties=h.cloneObject(this.properties)),this.widgets&&this.serialize_widgets){t.widgets_values=[];for(var e=0;e<this.widgets.length;++e)this.widgets[e]?t.widgets_values[e]=this.widgets[e].value:t.widgets_values[e]=null}return t.type||(t.type=this.constructor.type),this.color&&(t.color=this.color),this.bgcolor&&(t.bgcolor=this.bgcolor),this.boxcolor&&(t.boxcolor=this.boxcolor),this.shape&&(t.shape=this.shape),this.onSerialize&&this.onSerialize(t),t}clone(t={forNode:{}}){var e=h.createNode(this.type);if(!e)return null;var s=h.cloneObject(this.serialize());if(s.inputs)for(var i=0;i<s.inputs.length;++i)s.inputs[i].link=null;if(s.outputs)for(var i=0;i<s.outputs.length;++i)s.outputs[i].links&&(s.outputs[i].links.length=0);return delete s.id,h.use_uuids&&(s.id=kt()),e.configure(s),e}toString(){return JSON.stringify(this.serialize())}getTitle(){return this.title||this.constructor.title}getRootGraph(){var e;let t=this.graph;for(;t&&t._is_subgraph;)t=(e=t._subgraph_node)==null?void 0:e.graph;return t==null||t._is_subgraph?null:t}*iterateParentSubgraphNodes(){var e;let t=this.graph._subgraph_node;for(;t;)yield t,t=(e=t.graph)==null?void 0:e._subgraph_node}setProperty(t,e){if(this.properties||(this.properties={}),e!==this.properties[t]){var s=this.properties[t];if(this.properties[t]=e,this.graph&&this.graph._version++,this.onPropertyChanged&&this.onPropertyChanged(t,e,s)===!1&&(this.properties[t]=s),this.widgets)for(var i=0;i<this.widgets.length;++i){var n=this.widgets[i];if(n&&n.options.property==t){n.value=e;break}}}}getInputSlotProperty(t,e){if(!(!this.inputs||!this.graph)&&!(t==-1||t>=this.inputs.length)){var s=this.inputs[t];if(s)return s.properties||(s.properties={}),s.properties[e]}}getOutputSlotProperty(t,e){if(!(!this.outputs||!this.graph)&&!(t==-1||t>=this.outputs.length)){var s=this.outputs[t];if(s)return s.properties||(s.properties={}),s.properties[e]}}setInputSlotProperty(t,e,s){if(!(!this.inputs||!this.graph)&&!(t==-1||t>=this.inputs.length)){var i=this.inputs[t];if(i&&(i.properties||(i.properties={}),s!==i.properties[e])){var n=i.properties[e];i.properties[e]=s,this.graph&&this.graph._version++,this.onSlotPropertyChanged&&this.onSlotPropertyChanged(q.INPUT,t,i,e,s,n)===!1&&(i.properties[e]=n)}}}setOutputSlotProperty(t,e,s){if(!(!this.outputs||!this.graph)&&!(t==-1||t>=this.outputs.length)){var i=this.outputs[t];if(i&&(i.properties||(i.properties={}),s!==i.properties[e])){var n=i.properties[e];i.properties[e]=s,this.graph&&this.graph._version++,this.onSlotPropertyChanged&&this.onSlotPropertyChanged(q.OUTPUT,t,i,e,s,n)===!1&&(i.properties[e]=n)}}}setOutputData(t,e){if(!(!this.outputs||!this.graph)&&!(t==-1||t>=this.outputs.length)){var s=this.outputs[t];if(s&&(h.serialize_slot_data?s._data=e:s._data=void 0,this.outputs[t].links))for(var i=0;i<this.outputs[t].links.length;i++){var n=this.outputs[t].links[i],o=this.graph.links[n];o&&(o.data=e)}}}setOutputDataType(t,e){if(this.outputs&&!(t==-1||t>=this.outputs.length)){var s=this.outputs[t];if(s&&(s.type=e,this.outputs[t].links))for(let i=this.outputs[t].links.length-1;i>=0;i--){const n=this.outputs[t].links[i],o=this.graph.links[n];if(o){o.type=e;const a=this.graph.getNodeById(o.target_id);if(a){const l=a.getInputInfo(o.target_slot);l&&!h.isValidConnection(e,l.type)&&a.disconnectInput(o.target_slot)}}}}}*iterateInputInfo(){for(let t=0;t<this.inputs.length;t++)yield this.inputs[t]}getInputData(t,e){if(!(!this.inputs||!this.graph)&&!(t>=this.inputs.length||this.inputs[t].link==null)){var s=this.inputs[t].link,i=this.graph.links[s];if(!i)return h.debug&&console.error(`Link not found in slot ${t}!`,this,this.inputs[t],s),null;if(!e)return i.data;var n=this.graph.getNodeById(i.origin_id);return n&&(n.updateOutputData?n.updateOutputData(i.origin_slot):n.onExecute&&n.onExecute(null,{})),i.data}}getInputDataType(t){if(!this.inputs||t>=this.inputs.length||this.inputs[t].link==null)return null;var e=this.inputs[t].link,s=this.graph.links[e];if(!s)return h.debug&&console.error(`Link not found in slot ${t}!`,this,this.inputs[t],e),null;var i=this.graph.getNodeById(s.origin_id);if(!i)return s.type;var n=i.outputs[s.origin_slot];return n&&n.type!=-1?n.type:null}getInputDataByName(t,e){var s=this.findInputSlotIndexByName(t);return s==-1?null:this.getInputData(s,e)}isInputConnected(t){return this.inputs?t<this.inputs.length&&this.inputs[t].link!=null:!1}getInputInfo(t){return this.inputs&&t<this.inputs.length?this.inputs[t]:null}getInputLink(t){if(!this.inputs||!this.graph)return null;if(t<this.inputs.length){var e=this.inputs[t];return this.graph.links[e.link]}return null}getInputNode(t){if(!this.inputs||!this.graph)return null;if(t<this.inputs.length){const s=this.inputs[t].link,i=this.graph.links[s];if(!i)return h.debug&&console.error(`Link not found in slot ${t}!`,this,this.inputs[t],s),null;var e=this.graph.getNodeById(i.origin_id);if(e)return e}return null}getInputOrProperty(t){if(!this.inputs||!this.inputs.length||!this.graph)return this.properties?this.properties[t]:null;for(var e=0,s=this.inputs.length;e<s;++e){var i=this.inputs[e];if(t==i.name&&i.link!=null){var n=this.graph.links[i.link];if(n)return n.data}}return this.properties[t]}setInputDataType(t,e){if(!(!this.inputs||!this.graph)&&!(t==-1||t>=this.inputs.length)){var s=this.inputs[t];if(s&&(s.type=e,s.link)){const i=s.link,n=this.graph.links[i];n.type=e;const o=this.graph.getNodeById(n.origin_id);if(o){const a=o.getOutputInfo(n.origin_slot);a&&!h.isValidConnection(a.type,e)&&o.disconnectOutput(n.origin_slot)}}}}getOutputSlotConnectedTo(t){if(!this.outputs||!this.graph)return null;if(t>=0&&t<this.outputs.length){var e=this.inputs[t];if(e.link){const s=this.graph.links[e.link];return this.graph.getNodeById(s.origin_id).outputs[s.origin_slot]}}return null}*iterateOutputInfo(){for(let t=0;t<this.outputs.length;t++)yield this.outputs[t]}getOutputData(t){if(!this.outputs||!this.graph||t>=this.outputs.length)return null;var e=this.outputs[t];return e._data}getOutputLinks(t){if(!this.outputs||!this.graph)return[];if(t>=0&&t<this.outputs.length){var e=this.outputs[t];if(e.links){var s=[];for(const i of e.links)s.push(this.graph.links[i]);return s}}return[]}getInputSlotsConnectedTo(t){if(!this.outputs||!this.graph)return[];if(t>=0&&t<this.outputs.length){var e=this.outputs[t];if(e.links){var s=[];for(const i of e.links){const n=this.graph.links[i],o=this.graph.getNodeById(n.target_id);s.push(o.inputs[n.target_slot])}return s}}return[]}getOutputInfo(t){return this.outputs&&t<this.outputs.length?this.outputs[t]:null}isOutputConnected(t){return!this.outputs||!this.graph?!1:t<this.outputs.length&&this.outputs[t].links&&this.outputs[t].links.length>0}isAnyOutputConnected(){if(!this.outputs||!this.graph)return!1;for(var t=0;t<this.outputs.length;++t)if(this.outputs[t].links&&this.outputs[t].links.length)return!0;return!1}getOutputNodes(t){if(!this.outputs||this.outputs.length==0||!this.graph||t>=this.outputs.length)return null;var e=this.outputs[t];if(!e.links||e.links.length==0)return null;for(var s=[],i=0;i<e.links.length;i++){var n=e.links[i],o=this.graph.links[n];if(o){var a=this.graph.getNodeById(o.target_id);a&&s.push(a)}}return s}*iterateAllLinks(){if(this.graph){for(const t of this.iterateInputInfo())if(t.link){const e=this.graph.links[t.link];e&&(yield e)}for(const t of this.iterateOutputInfo())if(t.links!=null)for(const e of t.links){const s=this.graph.links[e];s&&(yield s)}}}addOnTriggerInput(){var t=this.findInputSlotIndexByName("onTrigger");if(t==-1){//!trigS ||
return this.addInput("onTrigger",y.EVENT,{optional:!0,nameLocked:!0}),this.findInputSlotIndexByName("onTrigger")}return t}addOnExecutedOutput(){var t=this.findOutputSlotIndexByName("onExecuted");if(t==-1){//!trigS ||
return this.addOutput("onExecuted",y.ACTION,{optional:!0,nameLocked:!0}),this.findOutputSlotIndexByName("onExecuted")}return t}onAfterExecuteNode(t,e){var s=this.findOutputSlotIndexByName("onExecuted");s!=-1&&this.triggerSlot(s,t,null,e)}changeMode(t){switch(t){case nt.ON_EVENT:break;case nt.ON_TRIGGER:this.addOnTriggerInput(),this.addOnExecutedOutput();break;case nt.NEVER:break;case nt.ALWAYS:break;case nt.ON_REQUEST:break;default:return!1}return this.mode=t,!0}doExecute(t,e={}){this.onExecute&&(e.action_call||(e.action_call=this.id+"_exec_"+Math.floor(Math.random()*9999)),this.graph.nodes_executing[this.id]=!0,this.onExecute(t,e),this.graph.nodes_executing[this.id]=!1,this.exec_version=this.graph.iteration,e&&e.action_call&&(this.action_call=e.action_call,this.graph.nodes_executedAction[this.id]=e.action_call)),this.execute_triggered=2,this.onAfterExecuteNode&&this.onAfterExecuteNode(t,e)}actionDo(t,e,s={}){this.onAction&&(s.action_call||(s.action_call=this.id+"_"+(t||"action")+"_"+Math.floor(Math.random()*9999)),this.graph.nodes_actioning[this.id]=t||"actioning",this.onAction(t,e,s),this.graph.nodes_actioning[this.id]=!1,s&&s.action_call&&(this.action_call=s.action_call,this.graph.nodes_executedAction[this.id]=s.action_call)),this.action_triggered=2,this.onAfterExecuteNode&&this.onAfterExecuteNode(e,s)}trigger(t,e,s){if(!(!this.outputs||!this.outputs.length)){this.graph&&(this.graph._last_trigger_time=h.getTime());for(var i=0;i<this.outputs.length;++i){var n=this.outputs[i];!n||n.type!==y.EVENT||t&&n.name!=t||this.triggerSlot(i,e,null,s)}}}triggerSlot(t,e,s,i={}){if(this.outputs){if(t==null){console.error("slot must be a number");return}typeof t!="number"&&console.warn("slot must be a number, use node.trigger('name') if you want to use a string");var n=this.outputs[t];if(n){var o=n.links;if(!(!o||!o.length)){this.graph&&(this.graph._last_trigger_time=h.getTime());for(var a=0;a<o.length;++a){var l=o[a];if(!(s!=null&&s!=l)){var u=this.graph.links[o[a]];if(u){u._last_time=h.getTime();var d=this.graph.getNodeById(u.target_id);if(d){if(d.inputs[u.target_slot],i.link=u,i.originNode=this,d.mode===nt.ON_TRIGGER)i.action_call||(i.action_call=this.id+"_trigg_"+Math.floor(Math.random()*9999)),d.onExecute&&d.doExecute(e,i);else if(d.onAction){i.action_call||(i.action_call=this.id+"_act_"+Math.floor(Math.random()*9999));const p=d.inputs[u.target_slot];d.actionDo(p.name,e,i)}}}}}}}}}clearTriggeredSlot(t,e){if(this.outputs){var s=this.outputs[t];if(s){var i=s.links;if(!(!i||!i.length))for(var n=0;n<i.length;++n){var o=i[n];if(!(e!=null&&e!=o)){var a=this.graph.links[i[n]];a&&(a._last_time=0)}}}}}setSize(t){this.size=t,this.onResize&&this.onResize(this.size)}addProperty(t,e,s,i){var n={name:t,type:s,default_value:e};if(i)for(var o in i)n[o]=i[o];return this.properties_info||(this.properties_info=[]),this.properties_info.push(n),this.properties||(this.properties={}),this.properties[t]=e,n}addOutput(t,e=y.DEFAULT,s){var i={name:t,type:e,links:[],properties:{}};if(s)for(var n in s)i[n]=s[n];return(i.shape==null||i.shape==L.DEFAULT)&&(e=="array"?i.shape=L.GRID_SHAPE:(e===y.EVENT||e===y.ACTION)&&(i.shape=L.BOX_SHAPE)),(e===y.EVENT||e===y.ACTION)&&(i.shape=L.BOX_SHAPE),this.outputs||(this.outputs=[]),this.outputs.push(i),this.onOutputAdded&&this.onOutputAdded(i),h.auto_load_slot_types&&h.registerNodeAndSlotType(this,e,!0),this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0),i}removeOutput(t){const e=this.outputs[t];this.disconnectOutput(t),this.outputs.splice(t,1);for(var s=t;s<this.outputs.length;++s)if(!(!this.outputs[s]||!this.outputs[s].links))for(var i=this.outputs[s].links,n=0;n<i.length;++n){var o=this.graph.links[i[n]];o&&(o.origin_slot-=1)}this.setSize(this.computeSize()),this.onOutputRemoved&&this.onOutputRemoved(t,e),this.setDirtyCanvas(!0,!0)}moveOutput(t,e){const s=this.outputs[t];if(s==null||e<0||e>this.outputs.length-1)return;const i=this.outputs[e];if(s.links)for(const n of s.links){const o=this.graph.links[n];o.origin_slot=e}if(i.links)for(const n of i.links){const o=this.graph.links[n];o.origin_slot=t}this.outputs[e]=s,this.outputs[t]=i}addInput(t,e=y.DEFAULT,s){var i={name:t,type:e,link:null,properties:{}};if(s)for(var n in s)i[n]=s[n];return(i.shape==null||i.shape==L.DEFAULT)&&(e=="array"?i.shape=L.GRID_SHAPE:(e===y.EVENT||e===y.ACTION)&&(i.shape=L.BOX_SHAPE)),this.inputs||(this.inputs=[]),this.inputs.push(i),this.setSize(this.computeSize()),this.onInputAdded&&this.onInputAdded(i),h.registerNodeAndSlotType(this,e),this.setDirtyCanvas(!0,!0),i}removeInput(t){this.disconnectInput(t);for(var e=this.inputs.splice(t,1),s=t;s<this.inputs.length;++s)if(this.inputs[s]){var i=this.graph.links[this.inputs[s].link];i&&(i.target_slot-=1)}this.setSize(this.computeSize()),this.onInputRemoved&&this.onInputRemoved(t,e[0]),this.setDirtyCanvas(!0,!0)}moveInput(t,e){const s=this.inputs[t];if(s==null||e<0||e>this.inputs.length-1)return;const i=this.inputs[e];if(s.link!=null){const n=this.graph.links[s.link];n.target_slot=e}if(i.link!=null){const n=this.graph.links[i.link];n.target_slot=t}this.inputs[e]=s,this.inputs[t]=i}addConnection(t,e,s,i){let n={name:t,type:e,pos:s,direction:i,links:null};return this.connections.push(n),n}computeSize(t=[0,0]){const e=De(this,"overrideSize");if(e)return e.concat();var s=Math.max(this.inputs?this.inputs.length:1,this.outputs?this.outputs.length:1),i=t;s=Math.max(s,1);var n=h.NODE_TEXT_SIZE,o=_(this.title),a=0,l=0;if(this.inputs)for(var u=0,d=this.inputs.length;u<d;++u){var p=this.inputs[u],g=p.label||p.name||"",c=_(g);a<c&&(a=c)}if(this.outputs)for(var u=0,d=this.outputs.length;u<d;++u){var b=this.outputs[u],g=b.label||b.name||"",c=_(g);l<c&&(l=c)}if(i[0]=Math.max(a+l+10,o),i[0]=Math.max(i[0],h.NODE_WIDTH),this.widgets&&this.widgets.length)for(const m of this.widgets)i[0]=Math.max(i[0],m.width||h.NODE_WIDTH*1.5);i[1]=(this.constructor.slot_start_y||0)+s*h.NODE_SLOT_HEIGHT;var f=0;if(this.widgets&&this.widgets.length){for(var u=0,d=this.widgets.length;u<d;++u){const T=this.widgets[u];T.hidden||(T.computeSize?f+=T.computeSize(i[0])[1]+4:f+=h.NODE_WIDGET_HEIGHT+4)}f+=8}this.widgets_up?i[1]=Math.max(i[1],f):this.widgets_start_y!=null?i[1]=Math.max(i[1],f+this.widgets_start_y):i[1]+=f;function _(m){return m?n*m.length*.6:0}return this.constructor.min_height&&i[1]<this.constructor.min_height&&(i[1]=this.constructor.min_height),i[1]+=6,i}getPropertyInfo(t){var e=null;if(this.properties_info){for(var s=0;s<this.properties_info.length;++s)if(this.properties_info[s].name==t){e=this.properties_info[s];break}}return this.constructor["@"+t]&&(e=this.constructor["@"+t]),this.constructor.widgets_info&&this.constructor.widgets_info[t]&&(e=this.constructor.widgets_info[t]),!e&&this.onGetPropertyInfo&&(e=this.onGetPropertyInfo(t)),e||(e={}),e.type||(e.type=typeof this.properties[t]),e.widget=="combo"&&(e.type="enum"),e}addWidget(t,e,s,i,n){this.widgets||(this.widgets=[]),!n&&i&&i.constructor===Object&&(n=i,i=null),n&&n.constructor===String&&(n={property:n}),i&&i.constructor===String&&(n||(n={}),n.property=i,i=null),i&&i.constructor!==Function&&(console.warn("addWidget: callback must be a function"),i=null);var o={type:t.toLowerCase(),name:e,value:s,callback:i,options:n||{}};if(o.options.y!==void 0&&(o.y=o.options.y),!i&&!o.options.callback&&!o.options.property&&console.warn("LiteGraph addWidget(...) without a callback or property assigned"),t=="combo"&&!o.options.values)throw"LiteGraph addWidget('combo',...) requires to pass values in options: { values:['red','blue'] }";return this.widgets.push(o),this.setSize(this.computeSize()),o}addCustomWidget(t){return this.widgets||(this.widgets=[]),this.widgets.push(t),this.setSize(this.computeSize()),t}setWidgetHidden(t,e){t.hidden=e,this.setSize(this.computeSize())}getBounding(t){return t=t||new Float32Array(4),t[0]=this.pos[0]-4,t[1]=this.pos[1]-h.NODE_TITLE_HEIGHT,t[2]=this.size[0]+4,t[3]=this.flags.collapsed?h.NODE_TITLE_HEIGHT:this.size[1]+h.NODE_TITLE_HEIGHT,this.onBounding&&this.onBounding(t),t}isPointInside(t,e,s=0,i=!1){var n=this.graph&&this.graph.isLive()?0:h.NODE_TITLE_HEIGHT;if(i&&(n=0),this.flags&&this.flags.collapsed){if(h.isInsideRectangle(t,e,this.pos[0]-s,this.pos[1]-h.NODE_TITLE_HEIGHT-s,(this._collapsed_width||h.NODE_COLLAPSED_WIDTH)+2*s,h.NODE_TITLE_HEIGHT+2*s))return!0}else if(this.pos[0]-4-s<t&&this.pos[0]+this.size[0]+4+s>t&&this.pos[1]-n-s<e&&this.pos[1]+this.size[1]+s>e)return!0;return!1}getSlotInPosition(t,e){var s=[0,0];if(this.inputs)for(var i=0,n=this.inputs.length;i<n;++i){var o=this.inputs[i];if(this.getConnectionPos(!0,i,s),h.isInsideRectangle(t,e,s[0]-10,s[1]-5,20,10))return{input:o,slot:i,link_pos:s}}if(this.outputs)for(var i=0,n=this.outputs.length;i<n;++i){var a=this.outputs[i];if(this.getConnectionPos(!1,i,s),h.isInsideRectangle(t,e,s[0]-10,s[1]-5,20,10))return{output:a,slot:i,link_pos:s}}return null}is(t){const e=t.__LITEGRAPH_TYPE__;return e!=null&&this.type===e}findInputSlotIndexByName(t,e=!1,s){if(!this.inputs)return-1;for(var i=0,n=this.inputs.length;i<n;++i)if(!(e&&this.inputs[i].link&&this.inputs[i].link!=null)&&!(s&&s.includes(this.inputs[i].type))&&(!t||t==this.inputs[i].name))return i;return-1}findInputSlotByName(t,e=!1,s){if(!this.inputs)return null;for(var i=0,n=this.inputs.length;i<n;++i)if(!(e&&this.inputs[i].link&&this.inputs[i].link!=null)&&!(s&&s.includes(this.inputs[i].type))&&(!t||t==this.inputs[i].name))return this.inputs[i];return null}findOutputSlotIndexByName(t,e=!1,s){if(!this.outputs)return-1;for(var i=0,n=this.outputs.length;i<n;++i)if(!(e&&this.outputs[i].links&&this.outputs[i].links!=null)&&!(s&&s.includes(this.outputs[i].type))&&(!t||t==this.outputs[i].name))return i;return-1}findOutputSlotByName(t,e=!1,s){if(!this.outputs)return null;for(var i=0,n=this.outputs.length;i<n;++i)if(!(e&&this.outputs[i].links&&this.outputs[i].links!=null)&&!(s&&s.includes(this.outputs[i].type))&&(!t||t==this.outputs[i].name))return this.outputs[i];return null}findInputSlotIndexByType(t,e=!1,s=!1){return this.findSlotByType(!0,t,!1,e,s)}findOutputSlotIndexByType(t,e=!1,s=!1){return this.findSlotByType(!1,t,!1,e,s)}findInputSlotByType(t,e=!1,s=!1){return this.findSlotByType(!0,t,!1,e,s)}findOutputSlotByType(t,e=!1,s=!1){return this.findSlotByType(!1,t,!1,e,s)}findSlotByType(t,e,s,i=!1,n=!1){i=i||!1,n=n||!1;var o=t?this.inputs:this.outputs;if(!o)return s?null:-1;(e==""||e=="*")&&(e=0);for(var a=0,l=o.length;a<l;++a){var u=(e+"").toLowerCase().split(","),d=o[a].type=="0"||o[a].type=="*"?"0":o[a].type;let p=(d+"").toLowerCase().split(",");for(let g=0;g<u.length;g++)for(let c=0;c<p.length;c++)if(u[g]=="_event_"&&(u[g]=y.EVENT),p[g]=="_event_"&&(p[g]=y.EVENT),u[g]=="*"&&(u[g]=y.DEFAULT),p[g]=="*"&&(p[g]=y.DEFAULT),u[g]==p[c]){let b=o[a];if(i&&b.links&&b.links!==null||b.link&&b.link!==null)continue;return s?b:a}}if(i&&!n)for(var a=0,l=o.length;a<l;++a){var u=(e+"").toLowerCase().split(","),d=o[a].type=="0"||o[a].type=="*"?"0":o[a].type;let f=(d+"").toLowerCase().split(",");for(let _=0;_<u.length;_++)for(let m=0;m<f.length;m++)if(u[_]=="*"&&(u[_]=y.DEFAULT),f[_]=="*"&&(f[_]=y.DEFAULT),u[_]==f[m])return s?o[a]:a}return s?null:-1}connectByTypeInput(t,e,s,i={}){var n={createEventInCase:!0,firstFreeIfOutputGeneralInCase:!0,generalTypeInCase:!0},o=Object.assign(n,i);e&&e.constructor===Number&&(e=this.graph.getNodeById(e));let a=s;s===y.EVENT?a=y.ACTION:s===y.ACTION&&(a=y.EVENT);let l=e.findInputSlotIndexByType(a,!0);if(l>=0&&l!==null)return h.debug&&console.debug("CONNbyTYPE type "+s+" for "+l),this.connect(t,e,l);if(h.debug&&console.log("type "+s+" not found or not free?"),o.createEventInCase&&s==y.EVENT)return h.debug&&console.debug("connect WILL CREATE THE onTrigger "+s+" to "+e),this.connect(t,e,-1);if(o.generalTypeInCase){let u=e.findInputSlotIndexByType(y.DEFAULT,!0,!0);if(h.debug&&console.debug("connect TO a general type (*, 0), if not found the specific type ",s," to ",e,"RES_SLOT:",u),u>=0)return this.connect(t,e,u)}if(o.firstFreeIfOutputGeneralInCase&&(s==0||s=="*"||s=="")){let u=e.findInputSlotIndexByName(null,!0,[y.EVENT]);if(h.debug&&console.debug("connect TO TheFirstFREE ",s," to ",e,"RES_SLOT:",u),u>=0)return this.connect(t,e,u)}return h.debug&&console.error("no way to connect type: ",s," to targetNODE ",e),null}connectByTypeOutput(t,e,s,i={}){var n={createEventInCase:!0,firstFreeIfInputGeneralInCase:!0,generalTypeInCase:!0},o=Object.assign(n,i);e&&e.constructor===Number&&(e=this.graph.getNodeById(e));let a=s;if(s===y.EVENT?a=y.ACTION:s===y.ACTION&&(a=y.EVENT),l=e.findOutputSlotIndexByType(a,!0),l>=0&&l!==null)return console.debug("CONNbyTYPE OUT! type "+s+" for "+l+" to "+a),e.connect(l,this,t);if(o.generalTypeInCase){var l=e.findOutputSlotIndexByType(0,!0,!0);if(l>=0)return e.connect(l,this,t)}if((o.createEventInCase&&s==y.EVENT||s==y.ACTION)&&h.do_add_triggers_slots){var l=e.addOnExecutedOutput();return e.connect(l,this,t)}if(o.firstFreeIfInputGeneralInCase&&(s==0||s=="*"||s=="")){let u=e.findOutputSlotIndexByName(null,!0,[y.EVENT,y.ACTION]);if(u>=0)return e.connect(u,this,t)}return console.error("no way to connect byOUT type: ",s," to sourceNODE ",e),console.error("type OUT! "+s+" not found or not free?"),null}connect(t,e,s){if(console.log("connect",t,e,s),s=s||0,!this.graph)throw new Error("Connect: Error, node doesn't belong to any graph. Nodes must be added first to a graph before connecting them.");if(typeof t=="string"){if(t=this.findOutputSlotIndexByName(t),t==-1)return h.debug&&console.error("Connect: Error, no slot of name "+t),null}else if(!this.outputs||t>=this.outputs.length)return h.debug&&console.error("Connect: Error, slot number not found"),null;if(e&&e.constructor===Number&&(e=this.graph.getNodeById(e)),!e)throw"target node is null";if(e==this)return h.debug&&console.error("Connect: Error, can't connect node to itself!"),null;if(!e.graph)throw new Error("Connect: Error, target node doesn't belong to any graph. Nodes must be added first to a graph before connecting them.");if(typeof s=="string"){if(s=e.findInputSlotIndexByName(s),s==-1)return h.debug&&console.error("Connect: Error, no slot of name "+s),null}else if(s===y.EVENT)if(h.do_add_triggers_slots)e.changeMode(nt.ON_TRIGGER),s=e.findInputSlotIndexByName("onTrigger");else return h.debug&&console.error("Connect: Error, can't connect event target slot"),null;else if(!e.inputs||s>=e.inputs.length)return h.debug&&console.error("Connect: Error, slot number not found"),null;var i=!1,n=e.inputs[s],o=null,a=this.outputs[t];if(!this.outputs[t])return h.debug&&(console.warn("Connect: Invalid slot passed: "+t),console.warn(this.outputs)),null;if(e.onBeforeConnectInput&&(s=e.onBeforeConnectInput(s)),s===-1||s===null||!h.isValidConnection(a.type,n.type))return this.setDirtyCanvas(!1,!0),i&&this.graph.connectionChange(this,o),console.warn("Connect: Invalid connection: ",s,a.type,n.type),null;if(h.debug&&console.debug("valid connection",a.type,n.type),e.onConnectInput&&e.onConnectInput(s,a.type,a,this,t)===!1)return h.debug&&console.debug("onConnectInput blocked",a.type,n.type),null;if(this.onConnectOutput&&this.onConnectOutput(t,n.type,n,e,s)===!1)return h.debug&&console.debug("onConnectOutput blocked",a.type,n.type),null;if(e.inputs[s]&&e.inputs[s].link!=null&&(this.graph.beforeChange(),e.disconnectInput(s,{doProcessChange:!1}),i=!0),a.links!==null&&a.links.length)switch(a.type){case y.EVENT:h.allow_multi_output_for_events||(this.graph.beforeChange(),this.disconnectOutput(t,null,{doProcessChange:!1}),i=!0);break}let l;return h.use_uuids?l=kt():l=++this.graph.last_link_id,o=new Bt(l,n.type||a.type,this.id,t,e.id,s),this.graph.links[o.id]&&console.error("Link already exists in graph!",o.id,o,this.graph.links[o.id]),this.graph.links[o.id]=o,a.links==null&&(a.links=[]),a.links.push(o.id),e.inputs[s].link=o.id,this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(q.OUTPUT,t,!0,o,a),e.onConnectionsChange&&e.onConnectionsChange(q.INPUT,s,!0,o,n),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(q.INPUT,e,s,this,t),this.graph.onNodeConnectionChange(q.OUTPUT,this,t,e,s)),this.setDirtyCanvas(!1,!0),this.graph.afterChange(),this.graph.connectionChange(this,o),o}disconnectOutput(t,e,s){if(typeof t=="string"){if(t=this.findOutputSlotIndexByName(t),t==-1)return h.debug&&console.error("Connect: Error, no slot of name "+t),!1}else if(!this.outputs||t>=this.outputs.length)return h.debug&&console.error("Connect: Error, slot number not found"),!1;var i=this.outputs[t];if(!i||!i.links||i.links.length==0)return!1;if(e){if(e.constructor===Number&&(e=this.graph.getNodeById(e)),!e)throw"Target Node not found";for(var n=0,o=i.links.length;n<o;n++){var a=i.links[n],l=this.graph.links[a];if(l.target_id==e.id){i.links.splice(n,1);var u=e.inputs[l.target_slot];u.link=null,delete this.graph.links[a],this.graph&&this.graph._version++,e.onConnectionsChange&&e.onConnectionsChange(q.INPUT,l.target_slot,!1,l,u),this.onConnectionsChange&&this.onConnectionsChange(q.OUTPUT,t,!1,l,i),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(q.OUTPUT,this,t),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(q.OUTPUT,this,t),this.graph.onNodeConnectionChange(q.INPUT,e,l.target_slot));break}}}else{for(var n=0,o=i.links.length;n<o;n++){var a=i.links[n],l=this.graph.links[a];if(l){var e=this.graph.getNodeById(l.target_id),u=null;this.graph&&this.graph._version++,e&&(u=e.inputs[l.target_slot],u.link=null,e.onConnectionsChange&&e.onConnectionsChange(q.INPUT,l.target_slot,!1,l,u),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(q.INPUT,e,l.target_slot)),delete this.graph.links[a],this.onConnectionsChange&&this.onConnectionsChange(q.OUTPUT,t,!1,l,i),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(q.OUTPUT,this,t),this.graph.onNodeConnectionChange(q.INPUT,e,l.target_slot))}}i.links=null}return this.setDirtyCanvas(!1,!0),this.graph.connectionChange(this),!0}disconnectInput(t,e={}){if(typeof t=="string"){if(t=this.findInputSlotIndexByName(t),t==-1)return h.debug&&console.error("Connect: Error, no slot of name "+t),!1}else if(!this.inputs||t>=this.inputs.length)return h.debug&&console.error("Connect: Error, slot number not found"),!1;var s=this.inputs[t];if(!s)return!1;var i=this.inputs[t].link;if(i!=null){this.inputs[t].link=null;var n=this.graph.links[i];if(n){var o=this.graph.getNodeById(n.origin_id);if(!o)return!1;var a=o.outputs[n.origin_slot];if(!a||!a.links||a.links.length==0)return!1;for(var l=0,u=a.links.length;l<u;l++)if(a.links[l]==i){a.links.splice(l,1);break}delete this.graph.links[i],this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(q.INPUT,t,!1,n,s),o.onConnectionsChange&&o.onConnectionsChange(q.OUTPUT,l,!1,n,a),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(q.OUTPUT,o,l),this.graph.onNodeConnectionChange(q.INPUT,this,t))}}return this.setDirtyCanvas(!1,!0),this.graph&&this.graph.connectionChange(this),!0}getConnectionPos(t,e,s=[0,0],i=!1){var n=0;t&&this.inputs&&(n=this.inputs.length),!t&&this.outputs&&(n=this.outputs.length);var o=h.NODE_SLOT_HEIGHT*.5;if(this.flags.collapsed&&!i){var a=this._collapsed_width||h.NODE_COLLAPSED_WIDTH;return this.horizontal?(s[0]=this.pos[0]+a*.5,t?s[1]=this.pos[1]-h.NODE_TITLE_HEIGHT:s[1]=this.pos[1]):(t?s[0]=this.pos[0]:s[0]=this.pos[0]+a,s[1]=this.pos[1]-h.NODE_TITLE_HEIGHT*.5),s}return t&&e==-1?(s[0]=this.pos[0]+h.NODE_TITLE_HEIGHT*.5,s[1]=this.pos[1]+h.NODE_TITLE_HEIGHT*.5,s):t&&n>e&&this.inputs[e].pos?(s[0]=this.pos[0]+this.inputs[e].pos[0],s[1]=this.pos[1]+this.inputs[e].pos[1],s):!t&&n>e&&this.outputs[e].pos?(s[0]=this.pos[0]+this.outputs[e].pos[0],s[1]=this.pos[1]+this.outputs[e].pos[1],s):this.horizontal?(s[0]=this.pos[0]+(e+.5)*(this.size[0]/n),t?s[1]=this.pos[1]-h.NODE_TITLE_HEIGHT:s[1]=this.pos[1]+this.size[1],s):(t?s[0]=this.pos[0]+o:s[0]=this.pos[0]+this.size[0]+1-o,s[1]=this.pos[1]+(e+.7)*h.NODE_SLOT_HEIGHT+(this.constructor.slot_start_y||0),s)}alignToGrid(){this.pos[0]=h.CANVAS_GRID_SIZE*Math.round(this.pos[0]/h.CANVAS_GRID_SIZE),this.pos[1]=h.CANVAS_GRID_SIZE*Math.round(this.pos[1]/h.CANVAS_GRID_SIZE)}trace(t){this.console||(this.console=[]),this.console.push(t),this.console.length>Pe.MAX_CONSOLE&&this.console.shift(),this.graph.onNodeTrace&&this.graph.onNodeTrace(this,t)}setDirtyCanvas(t,e=!1){this.graph&&this.graph.sendActionToCanvas("setDirty",[t,e])}loadImage(t){var e=new Image;e.src=h.node_images_path+t;var s=this;return e.onload=function(){s.setDirtyCanvas(!0)},e}captureInput(t){if(!(!this.graph||!this.graph.list_of_graphcanvas))for(var e=this.graph.list_of_graphcanvas,s=0;s<e.length;++s){var i=e[s];!t&&i.node_capturing_input!=this||(i.node_capturing_input=t?this:null)}}isShowingTitle(t){return this.titleMode==yt.TRANSPARENT_TITLE||this.titleMode==yt.NO_TITLE?!1:(this.titleMode==yt.AUTOHIDE_TITLE&&t,!0)}collapse(t=!1){this.graph._version++,!(this.collapsable===!1&&!t)&&(this.flags.collapsed?this.flags.collapsed=!1:this.flags.collapsed=!0,this.setDirtyCanvas(!0,!0))}pin(t){this.graph._version++,t===void 0?this.flags.pinned=!this.flags.pinned:this.flags.pinned=t}localToScreen(t,e,s){return[(t+this.pos[0])*s.ds.scale+s.ds.offset[0],(e+this.pos[1])*s.ds.scale+s.ds.offset[1]]}getOptionalSlots(){return De(this,"optionalSlots")}};is.MAX_CONSOLE=100;let C=is;const A=class D{static registerNodeType(t,e){let s;typeof t=="string"?s={type:t,class:e,title:e.name,name:e.name,desc:""}:s=t,D.debug&&console.log("Node registered: "+s.type);const i=s.name,n=s.type;if(!n)throw"Config has no type: "+s;if(D.debug&&console.debug(i,n),s.category==null||s.category===""){const a=n.lastIndexOf("/");s.category=n.substring(0,a)}s.title||(s.title=i);const o=D.registered_node_types[n];if(o&&console.warn("replacing node type: "+n),s.supported_extensions)for(let a in s.supported_extensions){const l=s.supported_extensions[a];l&&l.constructor===String&&(D.node_types_by_file_extension[l.toLowerCase()]=s)}s.class.__LITEGRAPH_TYPE__=n,Object.setPrototypeOf(s.class.prototype,C.prototype),D.registered_node_types[n]=s,s.class.name&&(D.Nodes[i]=s),D.onNodeTypeRegistered&&D.onNodeTypeRegistered(n,s),o&&D.onNodeTypeReplaced&&D.onNodeTypeReplaced(n,s,o)}static unregisterNodeType(t){let e;if(typeof t=="string"?e=D.registered_node_types[t]:e=t,!e)throw"node type not found: "+t;delete D.registered_node_types[e.type],e.constructor.name&&delete D.Nodes[e.constructor.name]}static registerNodeAndSlotType(t,e,s=!1){console.log(arguments);let i;if(typeof t=="string"?i=D.registered_node_types[t]:typeof t.type=="string"?i=D.registered_node_types[t.type]:i={class:t},!i)throw"Node not registered!"+t;var n=i.class.__litegraph_type__;if(typeof e=="string")var o=e.split(",");else if(e==y.EVENT||e==y.ACTION)var o=["_event_"];else var o=["*"];for(var a=0;a<o.length;++a){var l=o[a];l===""&&(l="*");var u=s?"registered_slot_out_types":"registered_slot_in_types";typeof this[u][l]>"u"&&(this[u][l]={nodes:[]}),this[u][l].nodes.push(n),l!=="_event_"&&l!=="*"&&(s?D.slot_types_out.includes(l.toLowerCase())||(D.slot_types_out.push(l.toLowerCase()),D.slot_types_out.sort()):D.slot_types_in.includes(l.toLowerCase())||(D.slot_types_in.push(l.toLowerCase()),D.slot_types_in.sort()))}}static clearRegisteredTypes(){D.registered_node_types={},D.node_types_by_file_extension={},D.Nodes={},D.searchbox_extras={}}static createNode(t,e,s={}){let i=null,n;if(typeof t=="string")n=t;else if(n=t.__LITEGRAPH_TYPE__,!n)throw console.error(t),"Node was not registered yet!";if(i=D.registered_node_types[n],!i)return console.warn('GraphNode type "'+t+'" not registered.'),null;e=e||i.title||n;var o=null;const a=s.constructorArgs||[];if(Object.setPrototypeOf(i.class.prototype,C.prototype),D.catch_exceptions)try{o=new i.class(e,...a)}catch(p){return console.error("Error creating node!",p),null}else o=new i.class(e,...a);if(o.class=i.class,o.type=n,!o.title&&e&&(o.title=e),o.properties||(o.properties={}),o.properties_info||(o.properties_info=[]),o.flags||(o.flags={}),o.size||(o.size=o.computeSize()),o.pos||(o.pos=[D.DEFAULT_POSITION[0],D.DEFAULT_POSITION[1]]),o.mode||(o.mode=nt.ALWAYS),s.instanceProps)for(var l in s.instanceProps)o[l]=s.instanceProps[l];const u=Ze(i.class,"propertyLayout");if(u){D.debug&&console.debug("Found property layout!",u);for(const p of u){const{name:g,defaultValue:c,type:b,options:f}=p;o.addProperty(g,c,b,f)}}const d=Ze(i.class,"slotLayout");if(d){if(D.debug&&console.debug("Found slot layout!",d),d.inputs)for(const p of d.inputs){const{name:g,type:c,options:b}=p;o.addInput(g,c,b)}if(d.outputs)for(const p of d.outputs){const{name:g,type:c,options:b}=p;o.addOutput(g,c,b)}}return o.onNodeCreated&&o.onNodeCreated(),o}static getNodeType(t){return D.registered_node_types[t]}static getNodeTypesInCategory(t,e){var s=[];for(var i in D.registered_node_types){var n=D.registered_node_types[i];n.filter==e&&(t==""?n.category==null&&s.push(n):n.category==t&&s.push(n))}return D.auto_sort_node_types&&s.sort(function(o,a){return o.title.localeCompare(a.title)}),s}static getNodeTypesCategories(t){var e={"":1};for(var s in D.registered_node_types){var i=D.registered_node_types[s];if(i.category&&!i.hide_in_node_lists){if(i.filter!=t)continue;e[i.category]=1}}var n=[];for(var s in e)n.push(s);return D.auto_sort_node_types?n.sort():n}static reloadNodes(t){for(var e=document.getElementsByTagName("script"),s=[],i=0;i<e.length;i++)s.push(e[i]);var n=document.getElementsByTagName("head")[0];t=document.location.href+t;for(var i=0;i<s.length;i++){var o=s[i].src;if(!(!o||o.substr(0,t.length)!=t))try{D.debug&&console.log("Reloading: "+o);var a=document.createElement("script");a.type="text/javascript",a.src=o,n.appendChild(a),n.removeChild(s[i])}catch(u){if(D.throw_errors)throw u;D.debug&&console.log("Error while reloading "+o)}}D.debug&&console.log("Nodes reloaded")}static cloneObject(t,e){if(t==null)return null;var s=JSON.parse(JSON.stringify(t));if(!e)return s;for(var i in s)e[i]=s[i];return e}static isValidConnection(t,e){if((t==""||t==="*")&&(t=y.DEFAULT),(e==""||e==="*")&&(e=y.DEFAULT),!t||!e||t==e||t==y.EVENT&&e==y.ACTION||t==y.ACTION&&e==y.EVENT)return!0;if(t=String(t),e=String(e),t=t.toLowerCase(),e=e.toLowerCase(),t.indexOf(",")==-1&&e.indexOf(",")==-1)return t==e;for(var s=t.split(","),i=e.split(","),n=0;n<s.length;++n)for(var o=0;o<i.length;++o)if(this.isValidConnection(s[n],i[o]))return!0;return!1}static getTime(){return Date.now()}static compareObjects(t,e){for(var s in t)if(t[s]!=e[s])return!1;return!0}static distance(t,e){return Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1]))}static colorToString(t){return"rgba("+Math.round(t[0]*255).toFixed()+","+Math.round(t[1]*255).toFixed()+","+Math.round(t[2]*255).toFixed()+","+(t.length==4?t[3].toFixed(2):"1.0")+")"}static isInsideRectangle(t,e,s,i,n,o){return s<t&&s+n>t&&i<e&&i+o>e}static growBounding(t,e,s){return e<t[0]?t[0]=e:e>t[2]&&(t[2]=e),s<t[1]?t[1]=s:s>t[3]&&(t[3]=s),t}static isInsideBounding(t,e){return!(t[0]<e[0][0]||t[1]<e[0][1]||t[0]>e[1][0]||t[1]>e[1][1])}static overlapBounding(t,e){var s=t[0]+t[2],i=t[1]+t[3],n=e[0]+e[2],o=e[1]+e[3];return!(t[0]>n||t[1]>o||s<e[0]||i<e[1])}static hex2num(t){t.charAt(0)=="#"&&(t=t.slice(1)),t=t.toUpperCase();var e="0123456789ABCDEF";let s;for(var i=0,n,o,a=0;a<6;a+=2)n=e.indexOf(t.charAt(a)),o=e.indexOf(t.charAt(a+1)),s[i]=n*16+o,i++;return s}static num2hex(t){for(var e="0123456789ABCDEF",s="#",i,n,o=0;o<3;o++)i=t[o]/16,n=t[o]%16,s+=e.charAt(i)+e.charAt(n);return s}static pointerListenerAdd(t,e,s,i=!1){if(!(!t||!t.addEventListener||!e||typeof s!="function")){var n=D.pointerevents_method,o=e;if(n=="pointer"&&!window.PointerEvent)switch(console.warn("sMethod=='pointer' && !window.PointerEvent"),console.log("Converting pointer["+o+"] : down move up cancel enter TO touchstart touchmove touchend, etc .."),o){case"down":{n="touch",o="start";break}case"move":{n="touch";break}case"up":{n="touch",o="end";break}case"cancel":{n="touch";break}case"enter":{console.log("debug: Should I send a move event?");break}default:console.warn("PointerEvent not available in this browser ? The event "+o+" would not be called")}switch(o){case"down":case"up":case"move":case"over":case"out":case"enter":t.addEventListener(n+o,s,i);case"leave":case"cancel":case"gotpointercapture":case"lostpointercapture":if(n!="mouse")return t.addEventListener(n+o,s,i);default:return t.addEventListener(o,s,i)}}}static pointerListenerRemove(t,e,s,i=!1){if(!(!t||!t.removeEventListener||!e||typeof s!="function"))switch(e){case"down":case"up":case"move":case"over":case"out":case"enter":(D.pointerevents_method=="pointer"||D.pointerevents_method=="mouse")&&t.removeEventListener(D.pointerevents_method+e,s,i);case"leave":case"cancel":case"gotpointercapture":case"lostpointercapture":if(D.pointerevents_method=="pointer")return t.removeEventListener(D.pointerevents_method+e,s,i);default:return t.removeEventListener(e,s,i)}}static use(t){const e=D._installedPlugins||(D._installedPlugins=[]);return e.indexOf(t)>-1?this:(typeof t.install=="function"?t.install(D):typeof t=="function"&&t(D),e.push(t),this)}};A.VERSION=10;A._installedPlugins=[];A.CANVAS_GRID_SIZE=10;A.NODE_TITLE_HEIGHT=20;A.NODE_TITLE_TEXT_Y=15;A.NODE_SLOT_HEIGHT=20;A.NODE_WIDGET_HEIGHT=20;A.NODE_WIDTH=140;A.NODE_MIN_WIDTH=50;A.NODE_COLLAPSED_RADIUS=10;A.NODE_COLLAPSED_WIDTH=80;A.NODE_TITLE_COLOR="#999";A.NODE_SELECTED_TITLE_COLOR="#FFF";A.NODE_TEXT_SIZE=14;A.NODE_TEXT_COLOR="#AAA";A.NODE_SUBTEXT_SIZE=12;A.NODE_DEFAULT_COLOR="#333";A.NODE_DEFAULT_BGCOLOR="#353535";A.NODE_DEFAULT_BOXCOLOR="#666";A.NODE_DEFAULT_SHAPE="box";A.NODE_BOX_OUTLINE_COLOR="#FFF";A.DEFAULT_SHADOW_COLOR="rgba(0,0,0,0.5)";A.DEFAULT_GROUP_FONT_SIZE=24;A.WIDGET_BGCOLOR="#222";A.WIDGET_OUTLINE_COLOR="#666";A.WIDGET_TEXT_COLOR="#DDD";A.WIDGET_SECONDARY_TEXT_COLOR="#999";A.LINK_COLOR="#9A9";A.EVENT_LINK_COLOR="#A86";A.ACTION_LINK_COLOR="#86A";A.CONNECTING_LINK_COLOR="#AFA";A.MAX_NUMBER_OF_NODES=1e3;A.DEFAULT_POSITION=[100,100];A.proxy=null;A.node_images_path="";A.debug=!1;A.catch_exceptions=!0;A.throw_errors=!0;A.allow_scripts=!1;A.registered_node_types={};A.node_types_by_file_extension={};A.Nodes={};A.Globals={};A.searchbox_extras={};A.auto_sort_node_types=!1;A.node_box_coloured_when_on=!1;A.node_box_coloured_by_mode=!1;A.dialog_close_on_mouse_leave=!0;A.dialog_close_on_mouse_leave_delay=500;A.shift_click_do_break_link_from=!1;A.click_do_break_link_to=!1;A.search_hide_on_mouse_leave=!0;A.search_filter_enabled=!1;A.search_show_all_on_open=!0;A.auto_load_slot_types=!1;A.registered_slot_in_types={};A.registered_slot_out_types={};A.slot_types_in=[];A.slot_types_out=[];A.slot_types_default_in={};A.slot_types_default_out={};A.alt_drag_do_clone_nodes=!1;A.do_add_triggers_slots=!1;A.allow_multi_output_for_events=!0;A.middle_click_slot_add_default_node=!1;A.release_link_on_empty_shows_menu=!1;A.ignore_all_widget_events=!1;A.pointerevents_method="mouse";A.use_uuids=!1;A.search_box_refresh_interval_ms=250;A.graph_inputs_outputs_use_combo_widget=!1;A.serialize_slot_data=!1;let h=A;window.LiteGraph=h;class Yt{static getTime(){return Date.now()}static compareObjects(t,e){for(var s in t)if(t[s]!=e[s])return!1;return!0}static distance(t,e){return Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1]))}static colorToString(t){return"rgba("+Math.round(t[0]*255).toFixed()+","+Math.round(t[1]*255).toFixed()+","+Math.round(t[2]*255).toFixed()+","+(t.length==4?t[3].toFixed(2):"1.0")+")"}static isInsideRectangle(t,e,s,i,n,o){return s<t&&s+n>t&&i<e&&i+o>e}static growBounding(t,e,s){return e<t[0]?t[0]=e:e>t[2]&&(t[2]=e),s<t[1]?t[1]=s:s>t[3]&&(t[3]=s),t}static isInsideBounding(t,e){return!(t[0]<e[0][0]||t[1]<e[0][1]||t[0]>e[1][0]||t[1]>e[1][1])}static overlapBounding(t,e){var s=t[0]+t[2],i=t[1]+t[3],n=e[0]+e[2],o=e[1]+e[3];return!(t[0]>n||t[1]>o||s<e[0]||i<e[1])}static hex2num(t){t.charAt(0)=="#"&&(t=t.slice(1)),t=t.toUpperCase();var e="0123456789ABCDEF";let s;for(var i=0,n,o,a=0;a<6;a+=2)n=e.indexOf(t.charAt(a)),o=e.indexOf(t.charAt(a+1)),s[i]=n*16+o,i++;return s}static num2hex(t){for(var e="0123456789ABCDEF",s="#",i,n,o=0;o<3;o++)i=t[o]/16,n=t[o]%16,s+=e.charAt(i)+e.charAt(n);return s}}class ei{constructor(t,e=!1){this.offset=[0,0],this.scale=1,this.max_scale=10,this.min_scale=.1,this.onredraw=null,this.enabled=!0,this.last_mouse=[0,0],this.element=null,this.visible_area=new Float32Array([0,0,0,0]),this.viewport=null,this.dragging=!1,this._binded_mouse_callback=null,t&&(this.element=t,e||this.bindEvents(t))}bindEvents(t){this.last_mouse=[0,0],this._binded_mouse_callback=this.onMouse.bind(this),h.pointerListenerAdd(t,"down",this._binded_mouse_callback),h.pointerListenerAdd(t,"move",this._binded_mouse_callback),h.pointerListenerAdd(t,"up",this._binded_mouse_callback),t.addEventListener("mousewheel",this._binded_mouse_callback,!1),t.addEventListener("wheel",this._binded_mouse_callback,!1)}computeVisibleArea(t){if(!this.element){this.visible_area[0]=this.visible_area[1]=this.visible_area[2]=this.visible_area[3]=0;return}var e=this.element.width,s=this.element.height,i=-this.offset[0],n=-this.offset[1];t&&(i+=t[0]/this.scale,n+=t[1]/this.scale,e=t[2],s=t[3]);var o=i+e/this.scale,a=n+s/this.scale;this.visible_area[0]=i,this.visible_area[1]=n,this.visible_area[2]=o-i,this.visible_area[3]=a-n}onMouse(t){if(!this.enabled)return;var e=this.element,s=e.getBoundingClientRect();let i=t;var n=i.clientX-s.left,o=i.clientY-s.top;i.canvasX=n,i.canvasX=o,i.dragging=this.dragging;var a=!this.viewport||this.viewport&&n>=this.viewport[0]&&n<this.viewport[0]+this.viewport[2]&&o>=this.viewport[1]&&o<this.viewport[1]+this.viewport[3];if(i.type==h.pointerevents_method+"down"&&a)this.dragging=!0,h.pointerListenerRemove(e,"move",this._binded_mouse_callback),h.pointerListenerAdd(document,"move",this._binded_mouse_callback),h.pointerListenerAdd(document,"up",this._binded_mouse_callback);else if(i.type==h.pointerevents_method+"move"){var l=n-this.last_mouse[0],u=o-this.last_mouse[1];this.dragging&&this.mouseDrag(l,u)}else i.type==h.pointerevents_method+"up"?(this.dragging=!1,h.pointerListenerRemove(document,"move",this._binded_mouse_callback),h.pointerListenerRemove(document,"up",this._binded_mouse_callback),h.pointerListenerAdd(e,"move",this._binded_mouse_callback)):a&&(i.type=="mousewheel"||i.type=="wheel"||i.type=="DOMMouseScroll")&&(i.eventType="mousewheel",i.type=="wheel"?i.wheel=-i.deltaY:i.wheel=i.wheelDeltaY!=null?i.wheelDeltaY:i.detail*-60,i.delta=i.wheelDelta?i.wheelDelta/40:i.deltaY?-i.deltaY/3:0,this.changeDeltaScale(1+i.delta*.05,[i.clientX,i.clientY]));if(this.last_mouse[0]=n,this.last_mouse[1]=o,a)return i.preventDefault(),i.stopPropagation(),!1}toCanvasContext(t){t.scale(this.scale,this.scale),t.translate(this.offset[0],this.offset[1])}convertOffsetToCanvas(t){return[(t[0]+this.offset[0])*this.scale,(t[1]+this.offset[1])*this.scale]}convertCanvasToOffset(t,e=[0,0]){return e[0]=t[0]/this.scale-this.offset[0],e[1]=t[1]/this.scale-this.offset[1],e}mouseDrag(t,e){this.offset[0]+=t/this.scale,this.offset[1]+=e/this.scale,this.onredraw&&this.onredraw(this)}changeScale(t,e){if(t<this.min_scale?t=this.min_scale:t>this.max_scale&&(t=this.max_scale),t!=this.scale&&this.element){var s=this.element.getBoundingClientRect();if(s){e=e||[s.width*.5,s.height*.5],e[0]-=s.left,e[1]-=s.top;var i=this.convertCanvasToOffset(e);this.scale=t,Math.abs(this.scale-1)<.01&&(this.scale=1);var n=this.convertCanvasToOffset(e),o=[n[0]-i[0],n[1]-i[1]];this.offset[0]+=o[0],this.offset[1]+=o[1],this.onredraw&&this.onredraw(this)}}}changeDeltaScale(t,e){this.changeScale(this.scale*t,e)}reset(){this.scale=1,this.offset[0]=0,this.offset[1]=0}}class ee{processMouseDown(t){if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),!this.graph)return;let e=t;this.adjustMouseEvent(e);var s=this.getCanvasWindow();s.document,O.active_canvas=this;var i=e.clientX,n=e.clientY;this.ds.viewport=this.viewport;var o=!this.viewport||this.viewport&&i>=this.viewport[0]&&i<this.viewport[0]+this.viewport[2]&&n>=this.viewport[1]&&n<this.viewport[1]+this.viewport[3];if(this.skip_events||(h.pointerListenerRemove(this.canvas,"move",this._mousemove_callback),h.pointerListenerAdd(s.document,"move",this._mousemove_callback,!0),h.pointerListenerAdd(s.document,"up",this._mouseup_callback,!0)),!!o){var a=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes,5),l=!1,u=h.getTime(),d=!(e instanceof PointerEvent)||!e.isPrimary,p=u-this.last_mouseclick<300&&d;if(this.mouse[0]=e.clientX,this.mouse[1]=e.clientY,this.offset_mouse[0]=e.offsetX,this.offset_mouse[1]=e.offsetY,this.graph_mouse[0]=e.canvasX,this.graph_mouse[1]=e.canvasY,this.last_click_position=[this.mouse[0],this.mouse[1]],this.last_click_position_offset=[this.offset_mouse[0],this.offset_mouse[1]],this.pointer_is_down&&d?this.pointer_is_double=!0:this.pointer_is_double=!1,this.pointer_is_down=!0,this.canvas.focus(),tt.closeAllContextMenus(s),this.search_box&&this.search_box.close(),!(this.onMouse&&this.onMouse(e)===!0)){if(e.which==1&&!this.pointer_is_double){if(e.ctrlKey&&this.allow_interaction&&!this.read_only&&(this.dragging_rectangle=new Float32Array(4),this.dragging_rectangle[0]=e.canvasX,this.dragging_rectangle[1]=e.canvasY,this.dragging_rectangle[2]=1,this.dragging_rectangle[3]=1,l=!0),h.alt_drag_do_clone_nodes&&e.altKey&&a&&this.allow_interaction&&!l&&!this.read_only){let M=a.clone();M&&(M.pos[0]+=5,M.pos[1]+=5,this.graph.add(M,{doCalcSize:!1}),a=M,l=!0,T||(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=a),this.selected_nodes[a.id]||this.processNodeSelected(a,e)))}var g=!1;if(a&&this.allow_interaction&&!l&&!this.read_only){if(!this.live_mode&&!a.flags.pinned&&this.bringToFront(a),!this.connecting_node&&!a.flags.collapsed&&!this.live_mode)if(!l&&a.resizable!==!1&&h.isInsideRectangle(e.canvasX,e.canvasY,a.pos[0]+a.size[0]-5,a.pos[1]+a.size[1]-5,10,10))this.graph.beforeChange(),this.resizing_node=a,this.canvas.style.cursor="se-resize",l=!0;else{if(a.outputs)for(var c=0,b=a.outputs.length;c<b;++c){var f=a.outputs[c],_=a.getConnectionPos(!1,c);if(h.isInsideRectangle(e.canvasX,e.canvasY,_[0]-15,_[1]-10,30,20)){this.connecting_node=a,this.connecting_output=f,this.connecting_output.slot_index=c,this.connecting_pos=a.getConnectionPos(!1,c),this.connecting_slot=c,h.shift_click_do_break_link_from&&e.shiftKey&&a.disconnectOutput(c),p?a.onOutputDblClick&&a.onOutputDblClick(c,e):a.onOutputClick&&a.onOutputClick(c,e),l=!0;break}}if(a.inputs)for(var c=0,b=a.inputs.length;c<b;++c){var m=a.inputs[c],_=a.getConnectionPos(!0,c);if(h.isInsideRectangle(e.canvasX,e.canvasY,_[0]-15,_[1]-10,30,20)){if(p?a.onInputDblClick&&a.onInputDblClick(c,e):a.onInputClick&&a.onInputClick(c,e),m.link!==null){var E=this.graph.links[m.link];h.click_do_break_link_to&&(a.disconnectInput(c),this.dirty_bgcanvas=!0,l=!0),(this.allow_reconnect_links||e.shiftKey)&&(h.click_do_break_link_to||a.disconnectInput(c),this.connecting_node=this.graph._nodes_by_id[E.origin_id],this.connecting_slot=E.origin_slot,this.connecting_output=this.connecting_node.outputs[this.connecting_slot],this.connecting_pos=this.connecting_node.getConnectionPos(!1,this.connecting_slot),this.dirty_bgcanvas=!0,l=!0)}l||(this.connecting_node=a,this.connecting_input=m,this.connecting_input.slot_index=c,this.connecting_pos=a.getConnectionPos(!0,c),this.connecting_slot=c,this.dirty_bgcanvas=!0,l=!0)}}}if(!l){var T=!1,v=[e.canvasX-a.pos[0],e.canvasY-a.pos[1]],N=this.processNodeWidgets(a,this.graph_mouse,e);N&&(T=!0,this.node_widget=[a,N]),p&&this.selected_nodes[a.id]&&(a.onDblClick&&a.onDblClick(e,v,this),this.processNodeDblClicked(a),T=!0),a.onMouseDown&&a.onMouseDown(e,v,this)?T=!0:(a.subgraph&&!a.skip_subgraph_button&&!a.flags.collapsed&&v[0]>a.size[0]-h.NODE_TITLE_HEIGHT&&v[1]<0&&setTimeout(()=>{this.openSubgraph(a.subgraph)},10),this.live_mode&&(g=!0,T=!0)),T||(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=a),this.selected_nodes[a.id]||this.processNodeSelected(a,e)),this.dirty_canvas=!0}}else if(!l){let M=!1;if(a&&a.subgraph&&!a.skip_subgraph_button){var v=[e.canvasX-a.pos[0],e.canvasY-a.pos[1]];!a.flags.collapsed&&v[0]>a.size[0]-h.NODE_TITLE_HEIGHT&&v[1]<0&&(M=!0,setTimeout(()=>{this.openSubgraph(a.subgraph)},10))}if(!M){if(this.allow_interaction&&!this.read_only){const V=this.findLinkCenterAtPos(e.canvasX,e.canvasY);V!=null&&(this.showLinkMenu(V,e),this.over_link_center=null)}if(this.selected_group=this.graph.getGroupOnPos(e.canvasX,e.canvasY),this.selected_group_resizing=!1,this.selected_group&&!this.read_only&&this.allow_interaction){e.ctrlKey&&(this.dragging_rectangle=null);var I=h.distance([e.canvasX,e.canvasY],[this.selected_group.pos[0]+this.selected_group.size[0],this.selected_group.pos[1]+this.selected_group.size[1]]);I*this.ds.scale<10?this.selected_group_resizing=!0:this.selected_group.recomputeInsideNodes()}p&&!this.read_only&&this.allow_searchbox&&this.allow_interaction&&(this.showSearchBox(e),e.preventDefault(),e.stopPropagation()),g=!0}}!l&&g&&this.allow_dragcanvas&&(this.dragging_canvas=!0)}else if(e.which==2){if(h.middle_click_slot_add_default_node&&a&&this.allow_interaction&&!l&&!this.read_only&&!this.connecting_node&&!a.flags.collapsed&&!this.live_mode){var S=null,F=null,x=null;if(a.outputs)for(var c=0,b=a.outputs.length;c<b;++c){var f=a.outputs[c],_=a.getConnectionPos(!1,c);if(h.isInsideRectangle(e.canvasX,e.canvasY,_[0]-15,_[1]-10,30,20)){S=f,F=c,x=!0;break}}if(a.inputs)for(var c=0,b=a.inputs.length;c<b;++c){var m=a.inputs[c],_=a.getConnectionPos(!0,c);if(h.isInsideRectangle(e.canvasX,e.canvasY,_[0]-15,_[1]-10,30,20)){S=m,F=c,x=!1;break}}if(S&&F!==!1){var z=.5-(F+1)/(x?a.outputs.length:a.inputs.length),Y=a.getBounding(),X=[x?Y[0]+Y[2]:Y[0],e.canvasY-80];this.createDefaultNodeForSlot("AUTO",{nodeFrom:x?a:null,slotFrom:x?F:null,nodeTo:x?null:a,slotTo:x?null:F,position:X,posAdd:[x?30:-30,-z*130],posSizeFix:[x?0:-1,0]})}}}else if((e.which==3||this.pointer_is_double)&&this.allow_interaction&&!l&&!this.read_only){let M=null;if(a)M={type:"node",item:a},Object.keys(this.selected_nodes).length&&(this.selected_nodes[a.id]||e.shiftKey||e.ctrlKey||e.metaKey)?this.selected_nodes[a.id]||this.selectNodes([a],!0):this.selectNodes([a]);else{const V=this.findLinkCenterAtPos(e.canvasX,e.canvasY);V!=null&&(this.over_link_center=null,this.dirty_canvas=!0,M={type:"link",item:V})}this.processContextMenu(M,e)}if(this.selected_group_moving=!1,this.selected_group&&!this.selected_group_resizing){var j=this.selected_group.fontSize||h.DEFAULT_GROUP_FONT_SIZE,P=j*1.4;h.isInsideRectangle(e.canvasX,e.canvasY,this.selected_group.pos[0],this.selected_group.pos[1],this.selected_group.size[0],P)&&(this.selected_group_moving=!0)}return this.last_mouse[0]=e.clientX,this.last_mouse[1]=e.clientY,this.last_mouseclick=h.getTime(),this.last_mouse_dragging=!0,this.graph.change(),(!s.document.activeElement||s.document.activeElement.nodeName.toLowerCase()!="input"&&s.document.activeElement.nodeName.toLowerCase()!="textarea")&&e.preventDefault(),e.stopPropagation(),this.onMouseDown&&this.onMouseDown(e),!1}}}processMouseMove(t){let e=t;if(this.autoresize&&this.resize(),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),!this.graph)return;O.active_canvas=this,this.adjustMouseEvent(e);let s=[e.clientX,e.clientY];this.mouse[0]=s[0],this.mouse[1]=s[1];let i=[s[0]-this.last_mouse[0],s[1]-this.last_mouse[1]];if(this.last_mouse=s,this.offset_mouse[0]=e.offsetX,this.offset_mouse[1]=e.offsetY,this.graph_mouse[0]=e.canvasX,this.graph_mouse[1]=e.canvasY,this.block_click)return e.preventDefault(),!1;e.dragging=this.last_mouse_dragging,this.node_widget&&(this.processNodeWidgets(this.node_widget[0],this.graph_mouse,e,this.node_widget[1]),this.dirty_canvas=!0);const n=this.selected_group;if(this.selected_group&&!this.selected_group_resizing&&!this.selected_group_moving&&(this.selected_group=null),this.dragging_rectangle)this.dragging_rectangle[2]=e.canvasX-this.dragging_rectangle[0],this.dragging_rectangle[3]=e.canvasY-this.dragging_rectangle[1],this.dirty_canvas=!0;else if(this.selected_group&&!this.read_only&&this.allow_interaction){if(this.selected_group_resizing)this.selected_group.size=[e.canvasX-this.selected_group.pos[0],e.canvasY-this.selected_group.pos[1]];else{var o=i[0]/this.ds.scale,a=i[1]/this.ds.scale;this.selected_group.move(o,a,e.ctrlKey),this.selected_group._nodes.length&&(this.dirty_canvas=!0)}this.dirty_bgcanvas=!0}else if(this.dragging_canvas)this.ds.offset[0]+=i[0]/this.ds.scale,this.ds.offset[1]+=i[1]/this.ds.scale,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;else{const E=this.allow_interaction&&!this.read_only;this.connecting_node&&(this.dirty_canvas=!0);var l=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes);if(E)for(var u=0,d=this.graph._nodes.length;u<d;++u){let T=this.graph._nodes[u];if(T.mouseOver&&l!=T){T.mouseOver=!1,this.node_over&&this.node_over.onMouseLeave&&this.node_over.onMouseLeave(e,[e.canvasX-this.node_over.pos[0],e.canvasY-this.node_over.pos[1]],this);const v=this.node_over;this.node_over=null,this.dirty_canvas=!0,v!=this.node_over&&this.onHoverChange&&this.onHoverChange(this.node_over,v)}}if(l){if(l.redraw_on_mouse&&(this.dirty_canvas=!0),E){if(!l.mouseOver){l.mouseOver=!0;const T=this.node_over;this.node_over=l,this.dirty_canvas=!0,T!=this.node_over&&this.onHoverChange&&this.onHoverChange(this.node_over,T),l.onMouseEnter&&l.onMouseEnter(e,[e.canvasX-l.pos[0],e.canvasY-l.pos[1]],this)}if(l.onMouseMove&&l.onMouseMove(e,[e.canvasX-l.pos[0],e.canvasY-l.pos[1]],this),this.connecting_node){if(this.connecting_output){var p=this._highlight_input||[0,0];if(!this.isOverNodeBox(l,e.canvasX,e.canvasY)){var g=this.isOverNodeInput(l,e.canvasX,e.canvasY,p);if(g!=-1&&l.inputs[g]){var c=l.inputs[g].type;h.isValidConnection(this.connecting_output.type,c)&&(this._highlight_input=p,this._highlight_input_slot=l.inputs[g])}else this._highlight_input=null,this._highlight_input_slot=null}}else if(this.connecting_input){var p=this._highlight_output||[0,0];if(!this.isOverNodeBox(l,e.canvasX,e.canvasY)){var g=this.isOverNodeOutput(l,e.canvasX,e.canvasY,p);if(g!=-1&&l.outputs[g]){var c=l.outputs[g].type;h.isValidConnection(this.connecting_input.type,c)&&(this._highlight_output=p)}else this._highlight_output=null}}}this.canvas&&(h.isInsideRectangle(e.canvasX,e.canvasY,l.pos[0]+l.size[0]-5,l.pos[1]+l.size[1]-5,5,5)?this.canvas.style.cursor="se-resize":this.canvas.style.cursor="crosshair")}}else{var b=this.findLinkCenterAtPos(e.canvasX,e.canvasY);b!=this.over_link_center&&(this.over_link_center=b,this.dirty_canvas=!0),this.canvas&&(this.canvas.style.cursor="")}if(E){if(this.node_capturing_input&&this.node_capturing_input!=l&&this.node_capturing_input.onMouseMove&&this.node_capturing_input.onMouseMove(e,[e.canvasX-this.node_capturing_input.pos[0],e.canvasY-this.node_capturing_input.pos[1]],this),this.node_dragged&&!this.live_mode){for(const T in this.selected_nodes){var f=this.selected_nodes[T];f.pos[0]+=i[0]/this.ds.scale,f.pos[1]+=i[1]/this.ds.scale}this.dirty_canvas=!0,this.dirty_bgcanvas=!0}if(this.resizing_node&&!this.live_mode){var _=[e.canvasX-this.resizing_node.pos[0],e.canvasY-this.resizing_node.pos[1]],m=this.resizing_node.computeSize();_[0]=Math.max(m[0],_[0]),_[1]=Math.max(m[1],_[1]),this.resizing_node.setSize(_),this.canvas.style.cursor="se-resize",this.dirty_canvas=!0,this.dirty_bgcanvas=!0}}}return n&&!this.selected_group_resizing&&!this.selected_group_moving&&(this.selected_group=n),e.preventDefault(),!1}processMouseUp(t){let e=t;var s=!(e instanceof PointerEvent)||!e.isPrimary;if(!s)return!1;if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),!!this.graph){var i=this.getCanvasWindow(),n=i.document;O.active_canvas=this,this.skip_events||(h.pointerListenerRemove(n,"move",this._mousemove_callback,!0),h.pointerListenerAdd(this.canvas,"move",this._mousemove_callback,!0),h.pointerListenerRemove(n,"up",this._mouseup_callback,!0)),this.adjustMouseEvent(e);var o=h.getTime();if(e.click_time=o-this.last_mouseclick,this.last_mouse_dragging=!1,this.last_click_position=null,this.block_click&&(this.block_click=!1),e.which==1){if(this.node_widget&&this.processNodeWidgets(this.node_widget[0],this.graph_mouse,e),this.node_widget=null,this.selected_group){var a=this.selected_group.pos[0]-Math.round(this.selected_group.pos[0]),l=this.selected_group.pos[1]-Math.round(this.selected_group.pos[1]);this.selected_group.move(a,l,e.ctrlKey),this.selected_group.pos[0]=Math.round(this.selected_group.pos[0]),this.selected_group.pos[1]=Math.round(this.selected_group.pos[1]),this.selected_group._nodes.length&&(this.dirty_canvas=!0),this.selected_group=null}this.selected_group_resizing=!1;var u=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes);if(this.dragging_rectangle){if(this.graph){var d=this.graph._nodes,p=new Float32Array(4),g=Math.abs(this.dragging_rectangle[2]),c=Math.abs(this.dragging_rectangle[3]),b=this.dragging_rectangle[2]<0?this.dragging_rectangle[0]-g:this.dragging_rectangle[0],f=this.dragging_rectangle[3]<0?this.dragging_rectangle[1]-c:this.dragging_rectangle[1];if(this.dragging_rectangle[0]=b,this.dragging_rectangle[1]=f,this.dragging_rectangle[2]=g,this.dragging_rectangle[3]=c,!u||g>10&&c>10){for(var _=[],m=0;m<d.length;++m){var E=d[m];E.getBounding(p),h.overlapBounding(this.dragging_rectangle,p)&&_.push(E)}_.length&&this.selectNodes(_,e.shiftKey)}else this.selectNodes([u],e.shiftKey||e.ctrlKey)}this.dragging_rectangle=null}else if(this.connecting_node){this.dirty_canvas=!0,this.dirty_bgcanvas=!0;var T=this.connecting_output||this.connecting_input,v=T.type;if(u){if(this.connecting_output){var N=this.isOverNodeInput(u,e.canvasX,e.canvasY);N!=-1?this.connecting_node.connect(this.connecting_slot,u,N):this.connecting_node.connectByTypeInput(this.connecting_slot,u,v)}else if(this.connecting_input){var N=this.isOverNodeOutput(u,e.canvasX,e.canvasY);N!=-1?u.connect(N,this.connecting_node,this.connecting_slot):this.connecting_node.connectByTypeOutput(this.connecting_slot,u,v)}}else h.release_link_on_empty_shows_menu&&(e.shiftKey&&this.allow_searchbox?this.connecting_output?this.showSearchBox(e,{node_from:this.connecting_node,slotFrom:this.connecting_output,type_filter_in:this.connecting_output.type}):this.connecting_input&&this.showSearchBox(e,{node_to:this.connecting_node,slotFrom:this.connecting_input,type_filter_out:this.connecting_input.type}):this.connecting_output?this.showConnectionMenu({nodeFrom:this.connecting_node,slotFrom:this.connecting_output,e}):this.connecting_input&&this.showConnectionMenu({nodeTo:this.connecting_node,slotTo:this.connecting_input,e}));this.connecting_output=null,this.connecting_input=null,this.connecting_pos=null,this.connecting_node=null,this.connecting_slot=-1}else if(this.resizing_node)this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.graph.afterChange(this.resizing_node),this.resizing_node=null;else if(this.node_dragged){var u=this.node_dragged;u&&e.click_time<300&&u.isShowingTitle(!0)&&h.isInsideRectangle(e.canvasX,e.canvasY,u.pos[0],u.pos[1]-h.NODE_TITLE_HEIGHT,h.NODE_TITLE_HEIGHT,h.NODE_TITLE_HEIGHT)&&u.collapse(),this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.node_dragged.pos[0]=Math.round(this.node_dragged.pos[0]),this.node_dragged.pos[1]=Math.round(this.node_dragged.pos[1]),(this.graph.config.align_to_grid||this.align_to_grid)&&this.node_dragged.alignToGrid(),this.onNodeMoved&&this.onNodeMoved(this.node_dragged),this.graph.afterChange(this.node_dragged),this.node_dragged=null}else{var u=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes);!u&&e.click_time<300&&this.deselectAllNodes(),this.dirty_canvas=!0,this.dragging_canvas=!1,this.node_over&&this.node_over.onMouseUp&&this.node_over.onMouseUp(e,[e.canvasX-this.node_over.pos[0],e.canvasY-this.node_over.pos[1]],this),this.node_capturing_input&&this.node_capturing_input.onMouseUp&&this.node_capturing_input.onMouseUp(e,[e.canvasX-this.node_capturing_input.pos[0],e.canvasY-this.node_capturing_input.pos[1]],this)}}else e.which==2?(this.dirty_canvas=!0,this.dragging_canvas=!1):e.which==3&&(this.dirty_canvas=!0,this.dragging_canvas=!1);return s&&(this.pointer_is_down=!1,this.pointer_is_double=!1),this.graph.change(),e.stopPropagation(),e.preventDefault(),!1}}processMouseWheel(t){let e=t;if(!(!this.graph||!this.allow_dragcanvas)){var s=e.wheelDeltaY!=null?e.wheelDeltaY:e.detail*-60;this.adjustMouseEvent(e);var i=e.clientX,n=e.clientY,o=!this.viewport||this.viewport&&i>=this.viewport[0]&&i<this.viewport[0]+this.viewport[2]&&n>=this.viewport[1]&&n<this.viewport[1]+this.viewport[3];if(o){var a=this.ds.scale;return s>0?a*=1.1:s<0&&(a*=1/1.1),this.ds.changeScale(a,[e.clientX,e.clientY]),this.graph.change(),e.preventDefault(),!1}}}}const Ct=class Et{setZoom(t,e){this.ds.changeScale(t,e),this.maxZoom&&this.ds.scale>this.maxZoom?this.scale=this.maxZoom:this.minZoom&&this.ds.scale<this.minZoom&&(this.scale=this.minZoom)}bringToFront(t){var e=this.graph._nodes.indexOf(t);e!=-1&&(this.graph._nodes.splice(e,1),this.graph._nodes.push(t))}sendToBack(t){var e=this.graph._nodes.indexOf(t);e!=-1&&(this.graph._nodes.splice(e,1),this.graph._nodes.unshift(t))}computeVisibleNodes(t,e=[]){var s=e;s.length=0,t=t||this.graph._nodes;for(var i=0,n=t.length;i<n;++i){var o=t[i];this.live_mode&&!o.onDrawBackground&&!o.onDrawForeground||h.overlapBounding(this.visible_area,o.getBounding(Et.temp))&&s.push(o)}return s}draw(t=!1,e=!1){if(!(!this.canvas||this.canvas.width==0||this.canvas.height==0)){var s=h.getTime();this.render_time=(s-this.last_draw_time)*.001,this.last_draw_time=s,this.graph&&this.ds.computeVisibleArea(this.viewport),(this.dirty_bgcanvas||e||this.always_render_background||this.graph&&this.graph._last_trigger_time&&s-this.graph._last_trigger_time<1e3)&&this.drawBackCanvas(),(this.dirty_canvas||t)&&this.drawFrontCanvas(),this.fps=this.render_time?1/this.render_time:0,this.frame+=1}}drawFrontCanvas(){this.dirty_canvas=!1,this.ctx||(this.ctx=this.canvas.getContext("2d"));var t=this.ctx;if(t){var e=this.canvas,s=this.viewport||this.dirty_area;if(s&&(t.save(),t.beginPath(),t.rect(s[0],s[1],s[2],s[3]),t.clip()),this.clear_background&&(s?t.clearRect(s[0],s[1],s[2],s[3]):t.clearRect(0,0,e.width,e.height)),this.bgcanvas==this.canvas?this.drawBackCanvas():t.drawImage(this.bgcanvas,0,0),this.onRender&&this.onRender(e,t),this.show_info&&this.renderInfo(t,s?s[0]:0,s?s[1]:0),this.graph){t.save(),this.ds.toCanvasContext(t);for(var i=this.computeVisibleNodes(null,this.visible_nodes),n=0;n<i.length;++n){var o=i[n];t.save(),t.translate(o.pos[0],o.pos[1]),this.drawNode(o,t),t.restore()}if(this.render_execution_order&&this.drawExecutionOrder(t),this.graph.config.links_ontop&&(this.live_mode||this.drawConnections(t)),this.connecting_pos!=null){t.lineWidth=this.connections_width;var a=null,l=this.connecting_output||this.connecting_input,u=l.type,d=l.dir;d==null&&(this.connecting_output?d=this.connecting_node.horizontal?R.DOWN:R.RIGHT:d=this.connecting_node.horizontal?R.UP:R.LEFT);var p=l.shape;switch(u){case y.EVENT:a=h.EVENT_LINK_COLOR;break;default:a=h.CONNECTING_LINK_COLOR}if(this.renderLink(t,this.connecting_pos,[this.graph_mouse[0],this.graph_mouse[1]],null,!1,null,a,d,R.CENTER),t.beginPath(),p===L.BOX_SHAPE?(t.rect(this.connecting_pos[0]-6+.5,this.connecting_pos[1]-5+.5,14,10),t.fill(),t.beginPath(),t.rect(this.graph_mouse[0]-6+.5,this.graph_mouse[1]-5+.5,14,10)):p===L.ARROW_SHAPE?(t.moveTo(this.connecting_pos[0]+8,this.connecting_pos[1]+.5),t.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]+6+.5),t.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]-6+.5),t.closePath()):(t.arc(this.connecting_pos[0],this.connecting_pos[1],4,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(this.graph_mouse[0],this.graph_mouse[1],4,0,Math.PI*2)),t.fill(),t.fillStyle="#ffcc00",this._highlight_input){t.beginPath();var g=this._highlight_input_slot.shape;g===L.ARROW_SHAPE?(t.moveTo(this._highlight_input[0]+8,this._highlight_input[1]+.5),t.lineTo(this._highlight_input[0]-4,this._highlight_input[1]+6+.5),t.lineTo(this._highlight_input[0]-4,this._highlight_input[1]-6+.5),t.closePath()):t.arc(this._highlight_input[0],this._highlight_input[1],6,0,Math.PI*2),t.fill()}this._highlight_output&&(t.beginPath(),g===L.ARROW_SHAPE?(t.moveTo(this._highlight_output[0]+8,this._highlight_output[1]+.5),t.lineTo(this._highlight_output[0]-4,this._highlight_output[1]+6+.5),t.lineTo(this._highlight_output[0]-4,this._highlight_output[1]-6+.5),t.closePath()):t.arc(this._highlight_output[0],this._highlight_output[1],6,0,Math.PI*2),t.fill())}this.dragging_rectangle&&(t.strokeStyle="#FFF",t.strokeRect(this.dragging_rectangle[0],this.dragging_rectangle[1],this.dragging_rectangle[2],this.dragging_rectangle[3])),this.over_link_center&&this.render_link_tooltip?this.drawLinkTooltip(t,this.over_link_center):this.onDrawLinkTooltip&&this.onDrawLinkTooltip(t,null,this),this.onDrawForeground&&this.onDrawForeground(t,this.visible_area),t.restore()}this._graph_stack&&this._graph_stack.length&&this.render_subgraph_panels&&this.drawSubgraphPanel(t),this.onDrawOverlay&&this.onDrawOverlay(t),s&&t.restore()}}drawSubgraphPanel(t){var e=this.graph,s=e._subgraph_node;if(!s){console.warn("subgraph without subnode");return}this.drawSubgraphPanelLeft(e,s,t),this.drawSubgraphPanelRight(e,s,t)}drawSubgraphPanelLeft(t,e,s){var i=e.inputs?e.inputs.length:0,n=200,o=Math.floor(h.NODE_SLOT_HEIGHT*1.6);if(s.fillStyle="#111",s.globalAlpha=.8,s.beginPath(),s.roundRect(10,10,n,(i+1)*o+50,[8]),s.fill(),s.globalAlpha=1,s.fillStyle="#888",s.font="14px Arial",s.textAlign="left",s.fillText("Graph Inputs",20,34),this.drawButton(n-20,20,20,20,"X","#151515",void 0,void 0,!0)){this.closeSubgraph();return}var a=50;if(s.font="14px Arial",e.inputs)for(var l=0;l<e.inputs.length;++l){var u=e.inputs[l];u.not_subgraph_input||(s.fillStyle="#9C9",s.beginPath(),s.arc(n-16,a,5,0,2*Math.PI),s.fill(),s.fillStyle="#AAA",s.fillText(u.name,30,a+o*.75),s.fillStyle="#777",s.fillText(ot(u.type),130,a+o*.75),a+=o)}this.drawButton(20,a+2,n-20,o-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialog(e)}drawSubgraphPanelRight(t,e,s){var i=e.outputs?e.outputs.length:0,n=this.bgcanvas.width,o=200,a=Math.floor(h.NODE_SLOT_HEIGHT*1.6);s.fillStyle="#111",s.globalAlpha=.8,s.beginPath(),s.roundRect(n-o-10,10,o,(i+1)*a+50,[8]),s.fill(),s.globalAlpha=1,s.fillStyle="#888",s.font="14px Arial",s.textAlign="left";var l="Graph Outputs",u=s.measureText(l).width;if(s.fillText(l,n-u-20,34),this.drawButton(n-o,20,20,20,"X","#151515",void 0,void 0,!0)){this.closeSubgraph();return}var d=50;if(s.font="14px Arial",e.outputs)for(var p=0;p<e.outputs.length;++p){var g=e.outputs[p];g.not_subgraph_output||(s.fillStyle="#9C9",s.beginPath(),s.arc(n-o+16,d,5,0,2*Math.PI),s.fill(),s.fillStyle="#AAA",s.fillText(g.name,n-o+30,d+a*.75),s.fillStyle="#777",s.fillText(ot(g.type),n-o+130,d+a*.75),d+=a)}this.drawButton(n-o,d+2,o-20,a-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialogRight(e)}drawButton(t,e,s,i,n,o=h.NODE_DEFAULT_COLOR,a="#555",l=h.NODE_TEXT_COLOR,u=!1){const d=!this.block_click&&(u||this.allow_interaction&&!this.read_only);var p=this.ctx,g=this.offset_mouse,c=d&&h.isInsideRectangle(g[0],g[1],t,e,s,i);g=this.last_click_position_offset;var b=d&&g&&this.pointer_is_down&&h.isInsideRectangle(g[0],g[1],t,e,s,i);p.fillStyle=c?a:o,b&&(p.fillStyle="#AAA"),p.beginPath(),p.roundRect(t,e,s,i,[4]),p.fill(),n!=null&&n.constructor==String&&(p.fillStyle=l,p.textAlign="center",p.font=(i*.65|0)+"px Arial",p.fillText(n,t+s*.5,e+i*.75),p.textAlign="left");var f=b&&d;return b&&this.blockClick(),f}drawGroups(t,e){if(this.graph){var s=this.graph._groups;e.save(),e.globalAlpha=.5*this.editor_alpha;for(var i=0;i<s.length;++i){var n=s[i];if(h.overlapBounding(this.visible_area,n._bounding)){e.fillStyle=n.color||"#335",e.strokeStyle=n.color||"#335";var o=n._pos,a=n._size;e.globalAlpha=.25*this.editor_alpha,e.beginPath(),e.rect(o[0]+.5,o[1]+.5,a[0],a[1]),e.fill(),e.globalAlpha=this.editor_alpha,e.stroke(),e.beginPath(),e.moveTo(o[0]+a[0],o[1]+a[1]),e.lineTo(o[0]+a[0]-10,o[1]+a[1]),e.lineTo(o[0]+a[0],o[1]+a[1]-10),e.fill();var l=n.font_size||h.DEFAULT_GROUP_FONT_SIZE;e.font=l+"px Arial",e.textAlign="left",e.fillText(n.title,o[0]+4,o[1]+l)}}e.restore()}}renderInfo(t,e=10,s){s=s||this.canvas.height-80,t.save(),t.translate(e,s),t.font="10px Arial",t.fillStyle="#888",t.textAlign="left",this.graph?(t.fillText("T: "+this.graph.globaltime.toFixed(2)+"s",5,13*1),t.fillText("I: "+this.graph.iteration,5,13*2),t.fillText("N: "+this.graph._nodes.length+" ["+this.visible_nodes.length+"]",5,13*3),t.fillText("V: "+this.graph._version,5,13*4),t.fillText("FPS:"+this.fps.toFixed(2),5,13*5)):t.fillText("No graph selected",5,13*1),t.restore()}drawBackCanvas(){var t=this.bgcanvas;(t.width!=this.canvas.width||t.height!=this.canvas.height)&&(t.width=this.canvas.width,t.height=this.canvas.height),this.bgctx||(this.bgctx=this.bgcanvas.getContext("2d"));var e=this.bgctx;let s=this.viewport||[0,0,e.canvas.width,e.canvas.height];if(this.clear_background&&e.clearRect(s[0],s[1],s[2],s[3]),this._graph_stack&&this._graph_stack.length&&this.render_subgraph_stack_header){e.save();const a=this._graph_stack[this._graph_stack.length-1].graph,l=this.graph._subgraph_node;e.strokeStyle=l.bgcolor,e.lineWidth=10,e.strokeRect(1,1,t.width-2,t.height-2),e.lineWidth=1,e.font="40px Arial",e.textAlign="center",e.fillStyle=l.bgcolor||"#AAA";let u="";for(let d=1;d<this._graph_stack.length;++d)u+=a._subgraph_node.getTitle()+" >> ";e.fillText(u+l.getTitle(),t.width*.5,40),e.restore()}let i=!1;if(this.onRenderBackground&&this.onRenderBackground(t,e)&&(i=!0),this.viewport||(e.restore(),e.setTransform(1,0,0,1,0,0)),this.visible_links.length=0,this.graph){if(e.save(),this.ds.toCanvasContext(e),this.background_image&&this.ds.scale>.5&&!i){this.zoom_modify_alpha?e.globalAlpha=(1-.5/this.ds.scale)*this.editor_alpha:e.globalAlpha=this.editor_alpha,e.imageSmoothingEnabled=e.imageSmoothingEnabled=!1,(!this._bg_img||this._bg_img.name!=this.background_image)&&(this._bg_img=new Image,this._bg_img.name=this.background_image,this._bg_img.src=this.background_image,this._bg_img.onload=()=>{this.draw(!0,!0)});var n=null;this._pattern==null&&this._bg_img.width>0?(n=e.createPattern(this._bg_img,"repeat"),this._pattern_img=this._bg_img,this._pattern=n):n=this._pattern,n&&(e.fillStyle=n,e.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3]),e.fillStyle="transparent"),e.globalAlpha=1,e.imageSmoothingEnabled=e.imageSmoothingEnabled=!0}this.graph._groups.length&&!this.live_mode&&this.drawGroups(t,e),this.onDrawBackground&&this.onDrawBackground(e,this.visible_area),h.debug&&(e.fillStyle="red",e.fillRect(this.visible_area[0]+10,this.visible_area[1]+10,this.visible_area[2]-20,this.visible_area[3]-20)),this.render_canvas_border&&(e.strokeStyle="#235",e.strokeRect(0,0,t.width,t.height)),this.render_connections_shadows?(e.shadowColor="#000",e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=6):e.shadowColor="rgba(0,0,0,0)",!this.live_mode&&this.render_connections&&this.drawConnections(e),e.shadowColor="rgba(0,0,0,0)",e.restore()}this.dirty_bgcanvas=!1,this.dirty_canvas=!0}drawNode(t,e){this.current_node=t;var s=t.color||t.constructor.color||h.NODE_DEFAULT_COLOR,i=t.bgcolor||t.constructor.bgcolor||h.NODE_DEFAULT_BGCOLOR;t.mouseOver;var n=this.ds.scale<.6;if(this.live_mode){t.flags.collapsed||(e.shadowColor="transparent",t.onDrawForeground&&t.onDrawForeground(e,this,this.canvas));return}var o=this.editor_alpha;if(e.globalAlpha=o,this.render_shadows&&!n?(e.shadowColor=h.DEFAULT_SHADOW_COLOR,e.shadowOffsetX=2*this.ds.scale,e.shadowOffsetY=2*this.ds.scale,e.shadowBlur=3*this.ds.scale):e.shadowColor="transparent",!(t.flags.collapsed&&t.onDrawCollapsed&&t.onDrawCollapsed(e,this)==!0)){var a=t.shape||L.BOX_SHAPE,l=Et.temp_vec2;Et.temp_vec2.set(t.size);var u=t.horizontal;if(t.flags.collapsed){e.font=this.inner_text_font;var d=t.getTitle?t.getTitle():t.title;d!=null&&(t._collapsed_width=Math.min(t.size[0],e.measureText(d).width+h.NODE_TITLE_HEIGHT*2),l[0]=t._collapsed_width,l[1]=0)}t.clip_area&&(e.save(),e.beginPath(),a==L.BOX_SHAPE?e.rect(0,0,l[0],l[1]):a==L.ROUND_SHAPE?e.roundRect(0,0,l[0],l[1],[10]):a==L.CIRCLE_SHAPE&&e.arc(l[0]*.5,l[1]*.5,l[0]*.5,0,Math.PI*2),e.clip()),t.has_errors&&(i="red"),this.drawNodeShape(t,e,[l[0],l[1]],s,i,t.is_selected,t.mouseOver),e.shadowColor="transparent",t.onDrawForeground&&t.onDrawForeground(e,this,this.canvas),e.textAlign=u?"center":"left",e.font=this.inner_text_font;var p=!n,g=this.connecting_output,c=this.connecting_input;e.lineWidth=1;var b=0,f=[0,0];if(t.flags.collapsed){if(this.render_collapsed_slots){var F=null,x=null;if(t.inputs)for(let X=0;X<t.inputs.length;X++){let j=t.inputs[X];if(j.link!=null){F=j;break}}if(t.outputs)for(let X=0;X<t.outputs.length;X++){let j=t.outputs[X];!j.links||!j.links.length||(x=j)}if(F){var z=0,Y=h.NODE_TITLE_HEIGHT*-.5;u&&(z=t._collapsed_width*.5,Y=-h.NODE_TITLE_HEIGHT),e.fillStyle="#686",e.beginPath(),F.shape===L.BOX_SHAPE?e.rect(z-7+.5,Y-4,14,8):F.shape===L.ARROW_SHAPE?(e.moveTo(z+8,Y),e.lineTo(z+-4,Y-4),e.lineTo(z+-4,Y+4),e.closePath()):e.arc(z,Y,4,0,Math.PI*2),e.fill()}if(x){var z=t._collapsed_width,Y=h.NODE_TITLE_HEIGHT*-.5;u&&(z=t._collapsed_width*.5,Y=0),e.fillStyle="#686",e.strokeStyle="black",e.beginPath(),x.shape===L.BOX_SHAPE?e.rect(z-7+.5,Y-4,14,8):x.shape===L.ARROW_SHAPE?(e.moveTo(z+6,Y),e.lineTo(z-6,Y-4),e.lineTo(z-6,Y+4),e.closePath()):e.arc(z,Y,4,0,Math.PI*2),e.fill()}}}else{if(t.inputs)for(var _=0;_<t.inputs.length;_++){var m=t.inputs[_],E=m.type,T=m.shape;e.globalAlpha=o,this.connecting_output&&!h.isValidConnection(m.type,g.type)?e.globalAlpha=.4*o:e.globalAlpha=o,e.fillStyle=m.link!=null?m.color_on||O.DEFAULT_CONNECTION_COLORS_BY_TYPE[E]||O.DEFAULT_CONNECTION_COLORS.input_on:m.color_off||O.DEFAULT_CONNECTION_COLORS_BY_TYPE_OFF[E]||O.DEFAULT_CONNECTION_COLORS_BY_TYPE[E]||O.DEFAULT_CONNECTION_COLORS.input_off;var v=t.getConnectionPos(!0,_,[f[0],f[1]]);v[0]-=t.pos[0],v[1]-=t.pos[1],b<v[1]+h.NODE_SLOT_HEIGHT*.5&&(b=v[1]+h.NODE_SLOT_HEIGHT*.5),e.beginPath();var N=!0;if(m.shape===L.BOX_SHAPE?u?e.rect(v[0]-5+.5,v[1]-8+.5,10,14):e.rect(v[0]-6+.5,v[1]-5+.5,14,10):T===L.ARROW_SHAPE?(e.moveTo(v[0]+8,v[1]+.5),e.lineTo(v[0]-4,v[1]+6+.5),e.lineTo(v[0]-4,v[1]-6+.5),e.closePath()):T===L.GRID_SHAPE?(e.rect(v[0]-4,v[1]-4,2,2),e.rect(v[0]-1,v[1]-4,2,2),e.rect(v[0]+2,v[1]-4,2,2),e.rect(v[0]-4,v[1]-1,2,2),e.rect(v[0]-1,v[1]-1,2,2),e.rect(v[0]+2,v[1]-1,2,2),e.rect(v[0]-4,v[1]+2,2,2),e.rect(v[0]-1,v[1]+2,2,2),e.rect(v[0]+2,v[1]+2,2,2),N=!1):n?e.rect(v[0]-4,v[1]-4,8,8):e.arc(v[0],v[1],4,0,Math.PI*2),e.fill(),p){var I=m.label!=null?m.label:m.name;I&&(e.fillStyle=h.NODE_TEXT_COLOR,u||m.dir==R.UP?e.fillText(I,v[0],v[1]-10):e.fillText(I,v[0]+10,v[1]+5))}}if(e.textAlign=u?"center":"right",e.strokeStyle="black",t.outputs)for(let X=0;X<t.outputs.length;X++){let j=t.outputs[X];var E=j.type,T=j.shape;this.connecting_input&&!h.isValidConnection(c.type,E)?e.globalAlpha=.4*o:e.globalAlpha=o;var v=t.getConnectionPos(!1,X,f);v[0]-=t.pos[0],v[1]-=t.pos[1],b<v[1]+h.NODE_SLOT_HEIGHT*.5&&(b=v[1]+h.NODE_SLOT_HEIGHT*.5),e.fillStyle=j.links&&j.links.length?j.color_on||O.DEFAULT_CONNECTION_COLORS_BY_TYPE[E]||O.DEFAULT_CONNECTION_COLORS.output_on:j.color_off||O.DEFAULT_CONNECTION_COLORS_BY_TYPE_OFF[E]||O.DEFAULT_CONNECTION_COLORS_BY_TYPE[E]||O.DEFAULT_CONNECTION_COLORS.output_off,e.beginPath();var N=!0;if(T===L.BOX_SHAPE?u?e.rect(v[0]-5+.5,v[1]-8+.5,10,14):e.rect(v[0]-6+.5,v[1]-5+.5,14,10):T===L.ARROW_SHAPE?(e.moveTo(v[0]+8,v[1]+.5),e.lineTo(v[0]-4,v[1]+6+.5),e.lineTo(v[0]-4,v[1]-6+.5),e.closePath()):T===L.GRID_SHAPE?(e.rect(v[0]-4,v[1]-4,2,2),e.rect(v[0]-1,v[1]-4,2,2),e.rect(v[0]+2,v[1]-4,2,2),e.rect(v[0]-4,v[1]-1,2,2),e.rect(v[0]-1,v[1]-1,2,2),e.rect(v[0]+2,v[1]-1,2,2),e.rect(v[0]-4,v[1]+2,2,2),e.rect(v[0]-1,v[1]+2,2,2),e.rect(v[0]+2,v[1]+2,2,2),N=!1):n?e.rect(v[0]-4,v[1]-4,8,8):e.arc(v[0],v[1],4,0,Math.PI*2),e.fill(),!n&&N&&e.stroke(),p){var I=j.label!=null?j.label:j.name;I&&(e.fillStyle=h.NODE_TEXT_COLOR,u||j.dir==R.DOWN?e.fillText(I,v[0],v[1]-8):e.fillText(I,v[0]-10,v[1]+5))}}if(e.textAlign="left",e.globalAlpha=1,t.widgets){var S=b;(u||t.widgets_up)&&(S=2),t.widgets_start_y!=null&&(S=t.widgets_start_y),this.drawNodeWidgets(t,S,e,this.node_widget&&this.node_widget[0]==t?this.node_widget[1]:null)}}t.clip_area&&e.restore(),e.globalAlpha=1}}drawLinkTooltip(t,e){var s=e._pos;if(this.allow_interaction&&!this.read_only&&(t.fillStyle="black",t.beginPath(),t.arc(s[0],s[1],3,0,Math.PI*2),t.fill()),e.data!=null&&!(this.onDrawLinkTooltip&&this.onDrawLinkTooltip(t,e,this)==!0)){var i=e.data,n=null;if(i.constructor===Number?n=i.toFixed(2):i.constructor===String?n='"'+i+'"':i.constructor===Boolean?n=String(i):i.toToolTip?n=i.toToolTip():n="["+i.constructor.name+"]",n!=null){n=n.substr(0,30),t.font="14px Courier New";var o=t.measureText(n),a=o.width+20,l=24;t.shadowColor="black",t.shadowOffsetX=2,t.shadowOffsetY=2,t.shadowBlur=3,t.fillStyle="#454",t.beginPath(),t.roundRect(s[0]-a*.5,s[1]-15-l,a,l,[3]),t.moveTo(s[0]-10,s[1]-15),t.lineTo(s[0]+10,s[1]-15),t.lineTo(s[0],s[1]-5),t.fill(),t.shadowColor="transparent",t.textAlign="center",t.fillStyle="#CEC",t.fillText(n,s[0],s[1]-15-l*.3)}}}drawNodeShape(t,e,s,i,n,o,a){e.strokeStyle=i,e.fillStyle=n;var l=h.NODE_TITLE_HEIGHT,u=this.ds.scale<.5,d=t.shape||t.constructor.shape||L.ROUND_SHAPE,p=t.titleMode,g=t.isShowingTitle(a),c=Et.tmp_area;c[0]=0,c[1]=g?-l:0,c[2]=s[0]+1,c[3]=g?s[1]+l:s[1];var b=e.globalAlpha;if(e.beginPath(),d==L.BOX_SHAPE||u?e.fillRect(c[0],c[1],c[2],c[3]):d==L.ROUND_SHAPE||d==L.CARD_SHAPE?e.roundRect(c[0],c[1],c[2],c[3],d==L.CARD_SHAPE?[this.round_radius,this.round_radius,0,0]:[this.round_radius]):d==L.CIRCLE_SHAPE&&e.arc(s[0]*.5,s[1]*.5,s[0]*.5,0,Math.PI*2),e.fill(),!t.flags.collapsed&&g&&(e.shadowColor="transparent",e.fillStyle="rgba(0,0,0,0.2)",e.fillRect(0,-1,c[2],2)),e.shadowColor="transparent",t.onDrawBackground&&t.onDrawBackground(e,this,this.canvas,this.graph_mouse),g||p==yt.TRANSPARENT_TITLE){if(t.onDrawTitleBar)t.onDrawTitleBar(e,this,l,s,this.ds.scale,i);else if(p!=yt.TRANSPARENT_TITLE&&(t.constructor.title_color||this.render_title_colored)){var f=t.constructor.title_color||i;if(t.flags.collapsed&&(e.shadowColor=h.DEFAULT_SHADOW_COLOR),this.use_gradients){var _=O.gradients[f];_||(_=O.gradients[f]=e.createLinearGradient(0,0,400,0),_.addColorStop(0,f),_.addColorStop(1,"#000")),e.fillStyle=_}else e.fillStyle=f;e.beginPath(),d==L.BOX_SHAPE||u?e.rect(0,-l,s[0]+1,l):(d==L.ROUND_SHAPE||d==L.CARD_SHAPE)&&e.roundRect(0,-l,s[0]+1,l,t.flags.collapsed?[this.round_radius]:[this.round_radius,this.round_radius,0,0]),e.fill(),e.shadowColor="transparent"}var m=null;h.node_box_coloured_by_mode&&Je[t.mode]&&(m=Je[t.mode]),h.node_box_coloured_when_on&&(m=t.action_triggered?"#FFF":t.execute_triggered?"#AAA":m);var E=10;if(t.onDrawTitleBox?t.onDrawTitleBox(e,this,l,s,this.ds.scale):d==L.ROUND_SHAPE||d==L.CIRCLE_SHAPE||d==L.CARD_SHAPE?(u&&(e.fillStyle="black",e.beginPath(),e.arc(l*.5,l*-.5,E*.5+1,0,Math.PI*2),e.fill()),e.fillStyle=t.boxcolor||m||h.NODE_DEFAULT_BOXCOLOR,u?e.fillRect(l*.5-E*.5,l*-.5-E*.5,E,E):(e.beginPath(),e.arc(l*.5,l*-.5,E*.5,0,Math.PI*2),e.fill())):(u&&(e.fillStyle="black",e.fillRect((l-E)*.5-1,(l+E)*-.5-1,E+2,E+2)),e.fillStyle=t.boxcolor||m||h.NODE_DEFAULT_BOXCOLOR,e.fillRect((l-E)*.5,(l+E)*-.5,E,E)),e.globalAlpha=b,t.onDrawTitleText&&t.onDrawTitleText(e,this,l,s,this.ds.scale,this.title_text_font,o),!u){e.font=this.title_text_font;var T=String(t.getTitle());T&&(o?e.fillStyle=h.NODE_SELECTED_TITLE_COLOR:e.fillStyle=t.constructor.title_text_color||this.node_title_color,t.flags.collapsed?(e.textAlign="left",e.fillText(T.substr(0,20),l,h.NODE_TITLE_TEXT_Y-l),e.textAlign="left"):(e.textAlign="left",e.fillText(T,l,h.NODE_TITLE_TEXT_Y-l)))}if(!t.flags.collapsed&&t.subgraph&&!t.skip_subgraph_button){var v=h.NODE_TITLE_HEIGHT,N=t.size[0]-v,I=h.isInsideRectangle(this.graph_mouse[0]-t.pos[0],this.graph_mouse[1]-t.pos[1],N+2,-v+2,v-4,v-4);e.fillStyle=I?"#888":"#555",d==L.BOX_SHAPE||u?e.fillRect(N+2,-v+2,v-4,v-4):(e.beginPath(),e.roundRect(N+2,-v+2,v-4,v-4,[4]),e.fill()),e.fillStyle="#333",e.beginPath(),e.moveTo(N+v*.2,-v*.6),e.lineTo(N+v*.8,-v*.6),e.lineTo(N+v*.5,-v*.3),e.fill()}t.onDrawTitle&&t.onDrawTitle(e,this)}o&&(t.onBounding&&t.onBounding(c),p==yt.TRANSPARENT_TITLE&&(c[1]-=l,c[3]+=l),e.lineWidth=1,e.globalAlpha=.8,e.beginPath(),d==L.BOX_SHAPE?e.rect(-6+c[0],-6+c[1],12+c[2],12+c[3]):d==L.ROUND_SHAPE||d==L.CARD_SHAPE&&t.flags.collapsed?e.roundRect(-6+c[0],-6+c[1],12+c[2],12+c[3],[this.round_radius*2]):d==L.CARD_SHAPE?e.roundRect(-6+c[0],-6+c[1],12+c[2],12+c[3],[this.round_radius*2,2,this.round_radius*2,2]):d==L.CIRCLE_SHAPE&&e.arc(s[0]*.5,s[1]*.5,s[0]*.5+6,0,Math.PI*2),e.strokeStyle=h.NODE_BOX_OUTLINE_COLOR,e.stroke(),e.strokeStyle=i,e.globalAlpha=1),t.execute_triggered>0&&t.execute_triggered--,t.action_triggered>0&&t.action_triggered--}drawConnections(t){var e=h.getTime(),s=this.visible_area;let i=Et.margin_area;i[0]=s[0]-20,i[1]=s[1]-20,i[2]=s[2]+40,i[3]=s[3]+40,t.lineWidth=this.connections_width,t.fillStyle="#AAA",t.strokeStyle="#AAA",t.globalAlpha=this.editor_alpha;for(var n=this.graph._nodes,o=0,a=n.length;o<a;++o){var l=n[o];if(!(!l.inputs||!l.inputs.length))for(var u=0;u<l.inputs.length;++u){var d=l.inputs[u];if(!d||d.link==null)continue;var p=d.link,g=this.graph.links[p];if(!g)continue;var c=this.graph.getNodeById(g.origin_id);if(c==null)continue;var b=g.origin_slot,f=null;b==-1?f=[c.pos[0]+10,c.pos[1]+10]:f=c.getConnectionPos(!1,b,Et.tempA);var _=l.getConnectionPos(!0,u,Et.tempB);let S=Et.link_bounding;if(S[0]=f[0],S[1]=f[1],S[2]=_[0]-f[0],S[3]=_[1]-f[1],S[2]<0&&(S[0]+=S[2],S[2]=Math.abs(S[2])),S[3]<0&&(S[1]+=S[3],S[3]=Math.abs(S[3])),!!h.overlapBounding(S,i)){var m=c.outputs[b],E=l.inputs[u];if(!(!m||!E)){var T=m.dir||(c.horizontal?R.DOWN:R.RIGHT),v=E.dir||(l.horizontal?R.UP:R.LEFT);if(this.renderLink(t,f,_,g,!1,!1,null,T,v),g&&g._last_time&&e-g._last_time<1e3){var N=2-(e-g._last_time)*.002,I=t.globalAlpha;t.globalAlpha=I*N,this.renderLink(t,f,_,g,!0,!0,"white",T,v),t.globalAlpha=I}}}}}t.globalAlpha=1}renderLink(t,e,s,i,n,o,a,l,u,d){i&&this.visible_links.push(i),!a&&i&&(a=i.color||this.link_type_colors[i.type]),a||(a=this.default_link_color),i!=null&&this.highlighted_links[i.id]&&(a="#FFF"),l=l||R.RIGHT,u=u||R.LEFT;var p=h.distance(e,s);this.render_connections_border&&this.ds.scale>.6&&(t.lineWidth=this.connections_width+4),t.lineJoin="round",d=d||1,d>1&&(t.lineWidth=.5),t.beginPath();for(var g=0;g<d;g+=1){var c=(g-(d-1)*.5)*5;if(this.links_render_mode==qt.SPLINE_LINK){t.moveTo(e[0],e[1]+c);var b=0,f=0,_=0,m=0;switch(l){case R.LEFT:b=p*-.25;break;case R.RIGHT:b=p*.25;break;case R.UP:f=p*-.25;break;case R.DOWN:f=p*.25;break}switch(u){case R.LEFT:_=p*-.25;break;case R.RIGHT:_=p*.25;break;case R.UP:m=p*-.25;break;case R.DOWN:m=p*.25;break}t.bezierCurveTo(e[0]+b,e[1]+f+c,s[0]+_,s[1]+m+c,s[0],s[1]+c)}else if(this.links_render_mode==qt.LINEAR_LINK){t.moveTo(e[0],e[1]+c);var b=0,f=0,_=0,m=0;switch(l){case R.LEFT:b=-1;break;case R.RIGHT:b=1;break;case R.UP:f=-1;break;case R.DOWN:f=1;break}switch(u){case R.LEFT:_=-1;break;case R.RIGHT:_=1;break;case R.UP:m=-1;break;case R.DOWN:m=1;break}var E=15;t.lineTo(e[0]+b*E,e[1]+f*E+c),t.lineTo(s[0]+_*E,s[1]+m*E+c),t.lineTo(s[0],s[1]+c)}else if(this.links_render_mode==qt.STRAIGHT_LINK){t.moveTo(e[0],e[1]);var T=e[0],v=e[1],N=s[0],I=s[1];l==R.RIGHT?T+=10:v+=10,u==R.LEFT?N-=10:I-=10,t.lineTo(T,v),t.lineTo((T+N)*.5,v),t.lineTo((T+N)*.5,I),t.lineTo(N,I),t.lineTo(s[0],s[1])}else return}this.render_connections_border&&this.ds.scale>.6&&!n&&(t.strokeStyle="rgba(0,0,0,0.5)",t.stroke()),t.lineWidth=this.connections_width,t.fillStyle=t.strokeStyle=a,t.stroke();var S=this.computeConnectionPoint(e,s,.5,l,u);if(i&&i._pos&&(i._pos[0]=S[0],i._pos[1]=S[1]),this.ds.scale>=.6&&this.highquality_render&&u!=R.CENTER){if(this.render_connection_arrows){var F=this.computeConnectionPoint(e,s,.25,l,u),x=this.computeConnectionPoint(e,s,.26,l,u),z=this.computeConnectionPoint(e,s,.75,l,u),Y=this.computeConnectionPoint(e,s,.76,l,u),X=0,j=0;this.render_curved_connections?(X=-Math.atan2(x[0]-F[0],x[1]-F[1]),j=-Math.atan2(Y[0]-z[0],Y[1]-z[1])):j=X=s[1]>e[1]?0:Math.PI,t.save(),t.translate(F[0],F[1]),t.rotate(X),t.beginPath(),t.moveTo(-5,-3),t.lineTo(0,7),t.lineTo(5,-3),t.fill(),t.restore(),t.save(),t.translate(z[0],z[1]),t.rotate(j),t.beginPath(),t.moveTo(-5,-3),t.lineTo(0,7),t.lineTo(5,-3),t.fill(),t.restore()}t.beginPath(),t.arc(S[0],S[1],5,0,Math.PI*2),t.fill()}if(o){t.fillStyle=a;for(var g=0;g<5;++g){var P=(h.getTime()*.001+g*.2)%1,S=this.computeConnectionPoint(e,s,P,l,u);t.beginPath(),t.arc(S[0],S[1],5,0,2*Math.PI),t.fill()}}}computeConnectionPoint(t,e,s,i=R.RIGHT,n=R.LEFT){var o=h.distance(t,e),a=t,l=[t[0],t[1]],u=[e[0],e[1]],d=e;switch(i){case R.LEFT:l[0]+=o*-.25;break;case R.RIGHT:l[0]+=o*.25;break;case R.UP:l[1]+=o*-.25;break;case R.DOWN:l[1]+=o*.25;break}switch(n){case R.LEFT:u[0]+=o*-.25;break;case R.RIGHT:u[0]+=o*.25;break;case R.UP:u[1]+=o*-.25;break;case R.DOWN:u[1]+=o*.25;break}var p=(1-s)*(1-s)*(1-s),g=3*((1-s)*(1-s))*s,c=3*(1-s)*(s*s),b=s*s*s,f=p*a[0]+g*l[0]+c*u[0]+b*d[0],_=p*a[1]+g*l[1]+c*u[1]+b*d[1];return[f,_]}drawExecutionOrder(t){t.shadowColor="transparent",t.globalAlpha=.25,t.textAlign="center",t.strokeStyle="white",t.globalAlpha=.75;for(var e=this.visible_nodes,s=0;s<e.length;++s){var i=e[s];t.fillStyle="black",t.fillRect(i.pos[0]-h.NODE_TITLE_HEIGHT,i.pos[1]-h.NODE_TITLE_HEIGHT,h.NODE_TITLE_HEIGHT,h.NODE_TITLE_HEIGHT),i.order==0&&t.strokeRect(i.pos[0]-h.NODE_TITLE_HEIGHT+.5,i.pos[1]-h.NODE_TITLE_HEIGHT+.5,h.NODE_TITLE_HEIGHT,h.NODE_TITLE_HEIGHT),t.fillStyle="#FFF",t.fillText(""+i.order,i.pos[0]+h.NODE_TITLE_HEIGHT*-.5,i.pos[1]-6)}t.globalAlpha=1}drawNodeWidgets(t,e,s,i){if(!(!t.widgets||!t.widgets.length)){var n=t.size[0],o=t.widgets;e+=2;var a=h.NODE_WIDGET_HEIGHT,l=this.ds.scale>.5;s.save(),s.globalAlpha=this.editor_alpha;for(var u=h.WIDGET_OUTLINE_COLOR,d=h.WIDGET_BGCOLOR,p=h.WIDGET_TEXT_COLOR,g=h.WIDGET_SECONDARY_TEXT_COLOR,c=15,b=0;b<o.length;++b){var f=o[b];if(!f.hidden){var _=e;f.y&&(_=f.y),f.last_y=_,s.strokeStyle=u,s.fillStyle="#222",s.textAlign="left",f.disabled&&(s.globalAlpha*=.5);var m=f.width||n;switch(f.type){case"button":f.clicked&&(s.fillStyle="#AAA",f.clicked=!1,this.dirty_canvas=!0),s.fillRect(c,_,m-c*2,a),l&&!f.disabled&&!h.ignore_all_widget_events&&s.strokeRect(c,_,m-c*2,a),l&&(s.textAlign="center",s.fillStyle=p,s.fillText(f.name,m*.5,_+a*.7));break;case"toggle":s.textAlign="left",s.strokeStyle=u,s.fillStyle=d,s.beginPath(),l?s.roundRect(c,_,m-c*2,a,[a*.5]):s.rect(c,_,m-c*2,a),s.fill(),l&&!f.disabled&&!h.ignore_all_widget_events&&s.stroke(),s.fillStyle=f.value?"#89A":"#333",s.beginPath(),s.arc(m-c*2,_+a*.5,a*.36,0,Math.PI*2),s.fill(),l&&(s.fillStyle=g,f.name!=null&&s.fillText(f.name,c*2,_+a*.7),s.fillStyle=f.value?p:g,s.textAlign="right",s.fillText(f.value?f.options.on||"true":f.options.off||"false",m-40,_+a*.7));break;case"slider":s.fillStyle=d,s.fillRect(c,_,m-c*2,a);var E=f.options.max-f.options.min,T=(f.value-f.options.min)/E;if(s.fillStyle=i==f?"#89A":"#678",s.fillRect(c,_,T*(m-c*2),a),l&&!f.disabled&&s.strokeRect(c,_,m-c*2,a),f.marker){var v=(+f.marker-f.options.min)/E;s.fillStyle="#AA9",s.fillRect(c+v*(m-c*2),_,2,a)}l&&(s.textAlign="center",s.fillStyle=p,s.fillText(f.name+"  "+Number(f.value).toFixed(3),m*.5,_+a*.7));break;case"number":case"combo":if(s.textAlign="left",s.strokeStyle=u,s.fillStyle=d,s.beginPath(),l?s.roundRect(c,_,m-c*2,a,[a*.5]):s.rect(c,_,m-c*2,a),s.fill(),l)if(!f.disabled&&!h.ignore_all_widget_events&&s.stroke(),s.fillStyle=p,!f.disabled&&!h.ignore_all_widget_events&&(s.beginPath(),s.moveTo(c+16,_+5),s.lineTo(c+6,_+a*.5),s.lineTo(c+16,_+a-5),s.fill(),s.beginPath(),s.moveTo(m-c-16,_+5),s.lineTo(m-c-6,_+a*.5),s.lineTo(m-c-16,_+a-5),s.fill()),s.fillStyle=g,s.fillText(f.name,c*2+5,_+a*.7),s.fillStyle=p,s.textAlign="right",f.type=="number")s.fillText(Number(f.value).toFixed(f.options.precision!==void 0?f.options.precision:3),m-c*2-20,_+a*.7);else{var N=f.value;if(f.options.values){var I=f.options.values;I.constructor===Function&&(I=I()),I&&I.constructor!==Array&&(N=I[f.value])}s.fillText(N,m-c*2-20,_+a*.7)}break;case"string":case"text":s.textAlign="left",s.strokeStyle=u,s.fillStyle=d,s.beginPath(),l?s.roundRect(c,_,m-c*2,a,[a*.5]):s.rect(c,_,m-c*2,a),s.fill(),l&&(f.disabled||s.stroke(),s.save(),s.beginPath(),s.rect(c,_,m-c*2,a),s.clip(),s.fillStyle=g,f.name!=null&&s.fillText(f.name,c*2,_+a*.7),s.fillStyle=p,s.textAlign="right",s.fillText(String(f.value).substr(0,f.options.max_length||30),m-c*2,_+a*.7),s.restore());break;default:f.draw&&f.draw(s,t,m,_,a);break}e+=(f.computeSize?f.computeSize(m)[1]:a)+4,s.globalAlpha=this.editor_alpha}}s.restore(),s.textAlign="left"}}};Ct.temp=new Float32Array(4);Ct.temp_vec2=new Float32Array(2);Ct.tmp_area=new Float32Array(4);Ct.margin_area=new Float32Array(4);Ct.link_bounding=new Float32Array(4);Ct.tempA=[0,0];Ct.tempB=[0,0];let $=Ct;class ne{constructor(t="Group"){this.fontSize=h.DEFAULT_GROUP_FONT_SIZE,this._nodes=[],this.graph=null,this._bounding=new Float32Array([10,10,140,80]),this.title=t,this.color=O.node_colors.pale_blue?O.node_colors.pale_blue.groupcolor:"#AAA",this._pos=this._bounding.subarray(0,2),this._size=this._bounding.subarray(2,4)}get bounding(){return this._bounding}get pos(){return[this._pos[0],this._pos[1]]}set pos(t){!t||t.length<2||(this._pos[0]=t[0],this._pos[1]=t[1])}get size(){return[this._size[0],this._size[1]]}set size(t){!t||t.length<2||(this._size[0]=Math.max(140,t[0]),this._size[1]=Math.max(80,t[1]))}configure(t){t.bounding,this.title=t.title,this._bounding.set(t.bounding),this.color=t.color,this.font=t.font}serialize(){const t=this._bounding;return{title:this.title,bounding:[Math.round(t[0]),Math.round(t[1]),Math.round(t[2]),Math.round(t[3])],color:this.color,font:this.font}}move(t,e,s){if(this._pos[0]+=t,this._pos[1]+=e,!s)for(var i=0;i<this._nodes.length;++i){var n=this._nodes[i];n.pos[0]+=t,n.pos[1]+=e}}recomputeInsideNodes(){this._nodes.length=0;for(var t=this.graph._nodes,e=new Float32Array(4),s=0;s<t.length;++s){var i=t[s];i.getBounding(e),h.overlapBounding(this._bounding,e)&&this._nodes.push(i)}}isPointInside(t,e,s=0,i=!1){var n=this.graph&&this.graph.isLive()?0:h.NODE_TITLE_HEIGHT;return i&&(n=0),this.pos[0]-4-s<t&&this.pos[0]+this.size[0]+4+s>t&&this.pos[1]-n-s<e&&this.pos[1]+this.size[1]+s>e}setDirtyCanvas(t,e=!1){this.graph&&this.graph.sendActionToCanvas("setDirty",[t,e])}}function ns(){let r=[];return r=r.concat(es),r=r.concat([y.ACTION]),r=r.concat(h.slot_types_in.map(t=>t.toUpperCase())),r}function si(){return ns().map(ot)}class lt extends C{constructor(t){super(),this.properties={name:"",type:"number",value:0,subgraphID:null},this.nameInGraph="",this.clonable=!1,this.size=[180,90];let e=this;this.nameWidget=this.addWidget("text","Name",this.properties.name,this.setName.bind(this)),h.graph_inputs_outputs_use_combo_widget?this.typeWidget=this.addWidget("combo","Type",ot(this.properties.type),this.setType.bind(this),{values:si}):this.typeWidget=this.addWidget("text","Type",ot(this.properties.type),this.setType.bind(this)),this.valueWidget=this.addWidget("number","Value",this.properties.value,function(s){e.setProperty("value",s)}),this.widgets_up=!0}setName(t){if(t==null||t===this.properties.name)return;const e=this.getParentSubgraph();e&&(t=e.getValidGraphInputName(t),this.setProperty("name",t))}setType(t){t||(t="*");let e=t;t==="-1"||t==="Action"?e=y.ACTION:t==="-2"||t==="Event"?e=y.EVENT:t==="0"&&(e="*"),this.setProperty("type",e)}onConfigure(){this.updateType()}getParentSubgraph(){var t,e;return(e=(t=this.graph._subgraph_node)==null?void 0:t.graph)==null?void 0:e.getNodeById(this.properties.subgraphID)}updateType(){var t=this.properties.type;this.typeWidget.value=ot(t);const e=this.outputs[0];e.type!=t&&(h.isValidConnection(e.type,t)||this.disconnectOutput(0),e.type=t),t=="array"?e.shape=L.GRID_SHAPE:t===y.EVENT||t===y.ACTION?e.shape=L.BOX_SHAPE:e.shape=L.DEFAULT,t=="number"?(this.valueWidget.type="number",this.valueWidget.value=0):t=="boolean"?(this.valueWidget.type="toggle",this.valueWidget.value=!0):t=="string"?(this.valueWidget.type="text",this.valueWidget.value=""):(this.valueWidget.type=null,this.valueWidget.value=null),this.properties.value=this.valueWidget.value,this.graph&&this.nameInGraph&&ss(t)?(this.graph.changeInputType(this.nameInGraph,t),e.type!==t&&this.setOutputDataType(0,t)):console.error("[GraphInput] Can't change output to type",t,this.graph,this.nameInGraph)}onPropertyChanged(t,e){if(t=="name"){if(e==""||e==this.nameInGraph||e=="enabled")return!1;this.graph&&(this.nameInGraph?this.graph.renameInput(this.nameInGraph,e):this.graph.addInput(e,""+this.properties.type,null)),this.nameWidget.value=e,this.nameInGraph=e}else t=="type"&&this.updateType()}getTitle(){return this.flags.collapsed?this.properties.name:this.title}onAction(t,e){this.properties.type==y.EVENT&&this.triggerSlot(0,e)}onExecute(){var t=this.properties.name,e=this.graph.inputs[t];if(!e){this.setOutputData(0,this.properties.value);return}this.setOutputData(0,e.value!==void 0?e.value:this.properties.value)}onRemoved(){this.nameInGraph&&this.graph.removeInput(this.nameInGraph)}}lt.slotLayout={inputs:[],outputs:[{name:"",type:"number"}]};h.registerNodeType({class:lt,title:"Input",desc:"Input of the graph",type:"graph/input",hide_in_node_lists:!0});function rs(){let r=[];return r=r.concat(es),r=r.concat([y.EVENT]),r=r.concat(h.slot_types_out),r}function ii(){return rs().map(ot)}class dt extends C{constructor(t){super(),this.properties={name:"",type:"number",subgraphID:null},this.nameInGraph="",this.clonable=!1,this.size=[180,60],this.nameWidget=this.addWidget("text","Name",this.properties.name,this.setName.bind(this)),h.graph_inputs_outputs_use_combo_widget?this.typeWidget=this.addWidget("combo","Type",ot(this.properties.type),this.setType.bind(this),{values:ii}):this.typeWidget=this.addWidget("text","Type",ot(this.properties.type),this.setType.bind(this)),this.widgets_up=!0}setName(t){if(t==null||t===this.properties.name)return;const e=this.getParentSubgraph();e&&(t=e.getValidGraphOutputName(t),this.setProperty("name",t))}setType(t){t||(t="*");let e=t;t==="-1"||t==="Action"?e=y.ACTION:t==="-2"||t==="Event"?e=y.EVENT:t==="0"&&(e="*"),this.setProperty("type",e)}onConfigure(){this.updateType()}getParentSubgraph(){var t,e;return(e=(t=this.graph._subgraph_node)==null?void 0:t.graph)==null?void 0:e.getNodeById(this.properties.subgraphID)}updateType(){var t=this.properties.type;const e=this.inputs[0];this.typeWidget&&(this.typeWidget.value=ot(t)),t=="array"?e.shape=L.GRID_SHAPE:t===y.EVENT||t===y.ACTION?e.shape=L.BOX_SHAPE:e.shape=L.DEFAULT,e.type!=t&&((t=="action"||t=="event")&&(t=y.EVENT),h.isValidConnection(e.type,t)||this.disconnectInput(0),e.type=t),this.graph&&this.nameInGraph&&ss(t)?(this.graph.changeOutputType(this.nameInGraph,t),e.type!==t&&this.setInputDataType(0,t)):console.error("Can't change GraphOutput to type",t,this.graph,this.nameInGraph)}onPropertyChanged(t,e){if(t=="name"){if(e==""||e==this.nameInGraph||e=="enabled")return!1;this.graph?this.nameInGraph?this.graph.renameOutput(this.nameInGraph,e):this.graph.addOutput(e,""+this.properties.type,null):console.error("[GraphOutput] missing graph!",t,e),this.nameWidget.value=e,this.nameInGraph=e}else t=="type"&&this.updateType()}getTitle(){return this.flags.collapsed?this.properties.name:this.title}onAction(t,e,s){const i=this.getParentSubgraph();if(!i)return;const n=i.findOutputSlotIndexByName(this.properties.name);n==null||i.outputs[n]==null||i.triggerSlot(n,e)}onExecute(){const t=this.getInputData(0);this.graph.setOutputData(this.properties.name,t)}onRemoved(){this.nameInGraph&&this.graph.removeOutput(this.nameInGraph)}}dt.slotLayout={inputs:[{name:"",type:""}],outputs:[]};h.registerNodeType({class:dt,title:"Output",desc:"Output of the graph",type:"graph/output",hide_in_node_lists:!0});const os=class as{constructor(t){this.supported_types=null,this.vars={},this.extra={},this.inputs={},this.outputs={},this.links={},this.list_of_graphcanvas=[],this._nodes=[],this._groups=[],this._nodes_by_id={},this._nodes_executable=null,this._nodes_in_order=[],this._version=-1,this._last_trigger_time=0,this._is_subgraph=!1,this._subgraph_node=null,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[],this.execution_timer_id=-1,this.execution_time=0,this.errors_in_execution=!1,h.debug&&console.log("Graph created"),this.list_of_graphcanvas=null,this.clear(),t&&this.configure(t)}getSupportedTypes(){return this.supported_types||as.DEFAULT_SUPPORTED_TYPES}getRootGraph(){const t=Array.from(this.iterateParentGraphs()),e=t[t.length-1];return e._is_subgraph?null:e}*iterateParentGraphs(){var e;let t=this;for(;t;)yield t,t=(e=t._subgraph_node)==null?void 0:e.graph}clear(){if(this.stop(),this.status=ct.STATUS_STOPPED,this.last_node_id=0,this.last_link_id=0,this._version=-1,this._nodes)for(var t=0;t<this._nodes.length;++t){var e=this._nodes[t];e.onRemoved&&e.onRemoved()}this._nodes=[],this._nodes_by_id={},this._nodes_in_order=[],this._nodes_executable=null,this._groups=[],this.links={},this.iteration=0,this.config={},this.vars={},this.extra={},this.globaltime=0,this.runningtime=0,this.fixedtime=0,this.fixedtime_lapse=.01,this.elapsed_time=.01,this.last_update_time=0,this.starttime=0,this.catch_errors=!0,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[],this.inputs={},this.outputs={},this.change(),this.sendActionToCanvas("clear")}attachCanvas(t){if(!(t instanceof O))throw"attachCanvas expects a LGraphCanvas instance";t.graph&&t.graph!=this&&t.graph.detachCanvas(t),t.graph=this,this.list_of_graphcanvas||(this.list_of_graphcanvas=[]),this.list_of_graphcanvas.push(t)}detachCanvas(t){if(this.list_of_graphcanvas){var e=this.list_of_graphcanvas.indexOf(t);e!=-1&&(t.graph=null,this.list_of_graphcanvas.splice(e,1))}}start(t){if(this.status!=ct.STATUS_RUNNING){this.status=ct.STATUS_RUNNING,this.onPlayEvent&&this.onPlayEvent(),this.sendEventToAllNodes("onStart"),this.starttime=h.getTime(),this.last_update_time=this.starttime,t=t||0;var e=this;if(t==0&&typeof window<"u"&&window.requestAnimationFrame){let s=function(){e.execution_timer_id==-1&&(window.requestAnimationFrame(s),e.onBeforeStep&&e.onBeforeStep(),e.runStep(1,!e.catch_errors),e.onAfterStep&&e.onAfterStep())};this.execution_timer_id=-1,s()}else this.execution_timer_id=setInterval(function(){e.onBeforeStep&&e.onBeforeStep(),e.runStep(1,!e.catch_errors),e.onAfterStep&&e.onAfterStep()},t)}}stop(){this.status!=ct.STATUS_STOPPED&&(this.status=ct.STATUS_STOPPED,this.onStopEvent&&this.onStopEvent(),this.execution_timer_id!=null&&(this.execution_timer_id!=-1&&clearInterval(this.execution_timer_id),this.execution_timer_id=null),this.sendEventToAllNodes("onStop"))}runStep(t=1,e=!1,s){var i=h.getTime();this.globaltime=.001*(i-this.starttime);let n=this._nodes_executable?this._nodes_executable:this._nodes;if(n){if(s=s||n.length,e){for(var o=0;o<t;o++){for(var a=0;a<s;++a){var l=n[a];l.mode==nt.ALWAYS&&l.onExecute&&l.doExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute()}else try{for(var o=0;o<t;o++){for(var a=0;a<s;++a){var l=n[a];l.mode==nt.ALWAYS&&l.onExecute&&l.onExecute(null,{})}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute(),this.errors_in_execution=!1}catch(p){if(this.errors_in_execution=!0,h.throw_errors)throw p;h.debug&&console.log("Error during execution: "+p),this.stop()}var u=h.getTime(),d=u-i;d==0&&(d=1),this.execution_time=.001*d,this.globaltime+=.001*d,this.iteration+=1,this.elapsed_time=(u-this.last_update_time)*.001,this.last_update_time=u,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[]}}updateExecutionOrder(){this._nodes_in_order=this.computeExecutionOrder(!1),this._nodes_executable=[];for(var t=0;t<this._nodes_in_order.length;++t)if(this._nodes_in_order[t].onExecute){let e=this._nodes_in_order[t];this._nodes_executable.push(e)}}*computeExecutionOrderRecursive(t=!1,e){for(const s of this.computeExecutionOrder(t,e))if(yield s,s.is(re))for(const i of s.subgraph.computeExecutionOrderRecursive(t,e))yield i}computeExecutionOrder(t=!1,e){for(var s=[],i=[],n={},o={},a={},l=0,m=this._nodes.length;l<m;++l){var u=this._nodes[l];if(!(t&&!u.onExecute)){n[u.id]=u;var d=0;if(u.inputs)for(var p=0,g=u.inputs.length;p<g;p++)u.inputs[p]&&u.inputs[p].link!=null&&(d+=1);d==0?(i.push(u),e&&(u._level=1)):(e&&(u._level=0),a[u.id]=d)}}for(;i.length!=0;){let E=i.shift();if(s.push(E),delete n[E.id],!!E.outputs)for(var l=0;l<E.outputs.length;l++){var c=E.outputs[l];if(!(c==null||c.links==null||c.links.length==0))for(var p=0;p<c.links.length;p++){var b=c.links[p],f=this.links[b];if(f&&!o[f.id]){var _=this.getNodeById(f.target_id);if(_==null){o[f.id]=!0;continue}e&&(!_._level||_._level<=E._level)&&(_._level=E._level+1),o[f.id]=!0,a[_.id]-=1,a[_.id]==0&&i.push(_)}}}}for(let E of Object.keys(n).sort())s.push(n[E]);s.length!=this._nodes.length&&h.debug&&console.warn("something went wrong, nodes missing");for(var m=s.length,l=0;l<m;++l)s[l].order=l;s=s.sort(function(E,T){var v=E.constructor.priority||E.priority||0,N=T.constructor.priority||T.priority||0;return v==N?E.order-T.order:v-N});for(var l=0;l<m;++l)s[l].order=l;return s}getAncestors(t){for(var e=[],s=[t],i={};s.length;){var n=s.shift();if(n.inputs){!i[n.id]&&n!=t&&(i[n.id]=!0,e.push(n));for(var o=0;o<n.inputs.length;++o){var a=n.getInputNode(o);a&&e.indexOf(a)==-1&&s.push(a)}}}return e.sort(function(l,u){return l.order-u.order}),e}arrange(t=100,e=Ft.HORIZONTAL_LAYOUT){const s=this.computeExecutionOrder(!1,!0),i=[];for(let o=0;o<s.length;++o){const a=s[o],l=a._level||1;i[l]||(i[l]=[]),i[l].push(a)}let n=t;for(let o=0;o<i.length;++o){const a=i[o];if(!a)continue;let l=100,u=t+h.NODE_TITLE_HEIGHT;for(let d=0;d<a.length;++d){const p=a[d];p.pos[0]=e==Ft.VERTICAL_LAYOUT?u:n,p.pos[1]=e==Ft.VERTICAL_LAYOUT?n:u;const g=e==Ft.VERTICAL_LAYOUT?1:0;p.size[g]>l&&(l=p.size[g]);const c=e==Ft.VERTICAL_LAYOUT?0:1;u+=p.size[c]+t+h.NODE_TITLE_HEIGHT}n+=l+t}this.setDirtyCanvas(!0,!0)}getTime(){return this.globaltime}getFixedTime(){return this.fixedtime}getElapsedTime(){return this.elapsed_time}*iterateNodesInOrder(){const t=this._nodes_in_order?this._nodes_in_order:this._nodes||[];for(const e of t)yield e}*iterateNodesInOrderRecursive(){const t=this._nodes_in_order?this._nodes_in_order:this._nodes||[];for(const e of t)if(yield e,e.subgraph!=null)for(const s of e.subgraph.iterateNodesInOrderRecursive())yield s}*iterateNodesOfClass(t){const e=t.__LITEGRAPH_TYPE__;if(e!=null)for(const s of this.iterateNodesInOrder())s.type===e&&(yield s)}*iterateNodesOfClassRecursive(t){const e=t.__LITEGRAPH_TYPE__;if(e!=null)for(const s of this.iterateNodesInOrderRecursive())s.type===e&&(yield s)}*iterateNodesOfTypeRecursive(t){for(const e of this.iterateNodesInOrderRecursive())e.type===t&&(yield e)}sendEventToAllNodes(t,e=[],s=nt.ALWAYS){var i=this._nodes_in_order?this._nodes_in_order:this._nodes;if(i)for(const n of this.iterateNodesInOrder()){if(n.type==="basic/subgraph"&&t!="onExecute"){n.mode==s&&n.sendEventToAllNodes(t,e,s);continue}!n[t]||n.mode!=s||(e===void 0?n[t]():e&&e.constructor===Array?n[t].apply(n,e):n[t](e))}}sendActionToCanvas(t,e=[]){if(this.list_of_graphcanvas)for(var s=0;s<this.list_of_graphcanvas.length;++s){var i=this.list_of_graphcanvas[s];i[t]&&i[t].apply(i,e)}}addGroup(t){return this._groups.push(t),this.setDirtyCanvas(!0),this.change(),t.graph=this,this._version++,t}add(t,e={}){if(t.id!=-1&&this._nodes_by_id[t.id]!=null&&(console.warn("LiteGraph: there is already a node with this ID, changing it",t.id),h.use_uuids?t.id=kt():t.id=++this.last_node_id),e.pos&&(isNaN(e.pos[0])||isNaN(e.pos[1])))throw"LiteGraph: Node position contained NaN(s)!";if(this._nodes.length>=h.MAX_NUMBER_OF_NODES)throw"LiteGraph: max number of nodes in a graph reached";return h.use_uuids?t.id||(t.id=kt()):t.id==null||t.id==-1?t.id=++this.last_node_id:this.last_node_id<t.id&&(this.last_node_id=t.id),t.graph=this,this._version++,this._nodes.push(t),this._nodes_by_id[t.id]=t,e.pos&&(t.pos=e.pos),t.onAdded&&t.onAdded(this),this.config.align_to_grid&&t.alignToGrid(),e.skipComputeOrder||this.updateExecutionOrder(),this.onNodeAdded&&this.onNodeAdded(t,e),this.setDirtyCanvas(!0),this.change(),t}remove(t,e={}){if(t instanceof ne){var s=this._groups.indexOf(t);s!=-1&&this._groups.splice(s,1),t.graph=null,this._version++,this.setDirtyCanvas(!0,!0),this.change();return}if(this._nodes_by_id[t.id]!=null&&!t.ignore_remove){if(this.beforeChange(),t.inputs)for(var i=0;i<t.inputs.length;i++){var n=t.inputs[i];n.link!=null&&t.disconnectInput(i)}if(t.outputs)for(var i=0;i<t.outputs.length;i++){let u=t.outputs[i];u.links!=null&&u.links.length&&t.disconnectOutput(i)}if(t.onRemoved&&t.onRemoved(e),t.graph=null,this._version++,this.list_of_graphcanvas)for(var i=0;i<this.list_of_graphcanvas.length;++i){var o=this.list_of_graphcanvas[i];o.selected_nodes[t.id]&&delete o.selected_nodes[t.id],o.node_dragged==t&&(o.node_dragged=null)}var a=this._nodes.indexOf(t);a!=-1&&this._nodes.splice(a,1),delete this._nodes_by_id[t.id],this.onNodeRemoved&&this.onNodeRemoved(t,e),this.sendActionToCanvas("checkPanels"),this.setDirtyCanvas(!0,!0),this.afterChange(),this.change(),this.updateExecutionOrder()}}getNodeById(t){return t==null?null:this._nodes_by_id[t]}getNodeByIdRecursive(t){const e=this.getNodeById(t);if(e!=null)return e;for(const s of this.iterateNodesOfClass(re)){const i=s.subgraph.getNodeByIdRecursive(t);if(i)return i}return null}findNodesByClass(t,e=[]){e.length=0;for(const s of this.iterateNodesOfClass(t))e.push(s);return e}findNodesByType(s,e=[]){var s=s.toLowerCase();e.length=0;for(var i=0,n=this._nodes.length;i<n;++i)this._nodes[i].type.toLowerCase()==s&&e.push(this._nodes[i]);return e}findNodesByClassRecursive(t,e=[]){e.length=0;for(const s of this.iterateNodesOfClassRecursive(t))e.push(s);return e}findNodesByTypeRecursive(s,e=[]){var s=s.toLowerCase();e.length=0;for(const i of this.iterateNodesOfTypeRecursive(s))e.push(i);return e}findNodeByTitle(t){for(var e=0,s=this._nodes.length;e<s;++e)if(this._nodes[e].title==t)return this._nodes[e];return null}findNodesByTitle(t){for(var e=[],s=0,i=this._nodes.length;s<i;++s)this._nodes[s].title==t&&e.push(this._nodes[s]);return e}getNodeOnPos(t,e,s,i){s=s||this._nodes;for(var n=null,o=s.length-1;o>=0;o--){var a=s[o],l=a.titleMode==yt.NO_TITLE;if(a.isPointInside(t,e,i,l))return a}return n}getGroupOnPos(t,e){for(var s=this._groups.length-1;s>=0;s--){var i=this._groups[s];if(i.isPointInside(t,e,2,!0))return i}return null}checkNodeTypes(){for(var t=!1,e=0;e<this._nodes.length;e++){var s=this._nodes[e],i=h.registered_node_types[s.type];if(s.constructor!=i.class){console.log("node being replaced by newer version: "+s.type);var n=h.createNode(s.type);t=!0,this._nodes[e]=n,n.configure(s.serialize()),n.graph=this,this._nodes_by_id[n.id]=n,s.inputs&&(n.inputs=s.inputs.concat()),s.outputs&&(n.outputs=s.outputs.concat())}}return this.updateExecutionOrder(),t}onAction(t,e,s={}){for(const i of this.iterateNodesOfClass(lt))if(i.properties.name==t){i.actionDo(t,e,s);break}}trigger(t,e){this.onTrigger&&this.onTrigger(t,e)}triggerSlot(t,e){this.onTrigger&&this.onTrigger(t,e)}addInput(t,e,s){var i=this.inputs[t];i||(this.beforeChange(),this.inputs[t]={name:t,type:e,value:s},this._version++,this.afterChange(),this.onInputAdded&&this.onInputAdded(t,e,s),this.onInputsOutputsChange&&this.onInputsOutputsChange())}setInputData(t,e){var s=this.inputs[t];s&&(s.value=e)}getInputData(t){var e=this.inputs[t];return e?e.value:null}renameInput(t,e){if(e!=t)return this.inputs[t]?this.inputs[e]?(console.error("there is already one input with that name"),!1):(this.inputs[e]=this.inputs[t],delete this.inputs[t],this._version++,this.onInputRenamed&&this.onInputRenamed(t,e),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0):!1}changeInputType(t,e){if(!this.inputs[t])return!1;if(this.inputs[t].type&&String(this.inputs[t].type).toLowerCase()==String(e).toLowerCase())return;const s=this.inputs[t].type;return this.inputs[t].type=e,this._version++,this.onInputTypeChanged&&this.onInputTypeChanged(t,s,e),!0}removeInput(t){return this.inputs[t]?(delete this.inputs[t],this._version++,this.onInputRemoved&&this.onInputRemoved(t),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0):!1}addOutput(t,e,s){this.outputs[t]={name:t,type:e,value:s},this._version++,this.onOutputAdded&&this.onOutputAdded(t,e,s),this.onInputsOutputsChange&&this.onInputsOutputsChange()}setOutputData(t,e){var s=this.outputs[t];s&&(s.value=e)}getOutputData(t){var e=this.outputs[t];return e?e.value:null}renameOutput(t,e){return this.outputs[t]?this.outputs[e]?(console.error("there is already one output with that name"),!1):(this.outputs[e]=this.outputs[t],delete this.outputs[t],this._version++,this.onOutputRenamed&&this.onOutputRenamed(t,e),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0):!1}changeOutputType(t,e){if(!this.outputs[t])return!1;if(this.outputs[t].type&&String(this.outputs[t].type).toLowerCase()==String(e).toLowerCase())return;const s=this.outputs[t].type;return this.outputs[t].type=e,this._version++,this.onOutputTypeChanged&&this.onOutputTypeChanged(t,s,e),!0}removeOutput(t){return this.outputs[t]?(delete this.outputs[t],this._version++,this.onOutputRemoved&&this.onOutputRemoved(t),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0):!1}beforeChange(t){this.onBeforeChange&&this.onBeforeChange(this,t),this.sendActionToCanvas("onBeforeChange",[this])}afterChange(t){this.onAfterChange&&this.onAfterChange(this,t),this.sendActionToCanvas("onAfterChange",[this])}connectionChange(t,e){this.updateExecutionOrder(),this.onConnectionChange&&this.onConnectionChange(t),this._version++,this.sendActionToCanvas("onConnectionChange")}isLive(){if(!this.list_of_graphcanvas)return!1;for(var t=0;t<this.list_of_graphcanvas.length;++t){var e=this.list_of_graphcanvas[t];if(e.live_mode)return!0}return!1}clearTriggeredSlots(){for(var t in this.links){var e=this.links[t];e&&e._last_time&&(e._last_time=0)}}change(){h.debug&&console.log("Graph changed"),this.sendActionToCanvas("setDirty",[!0,!0]),this.onChange&&this.onChange(this)}setDirtyCanvas(t=!1,e=!1){this.sendActionToCanvas("setDirty",[t,e])}removeLink(t){var e=this.links[t];if(e){var s=this.getNodeById(e.target_id);s&&s.disconnectInput(e.target_slot)}}serialize(){for(var t=[],e=0,s=this._nodes.length;e<s;++e)t.push(this._nodes[e].serialize());var i=[];for(const d in this.links){var n=this.links[d];if(!n.serialize){console.error("weird LLink bug, link info is not a LLink but a regular object",n);var o=Bt.configure(n);for(var a in n)o[a]=n[a];this.links[d]=o,n=o}i.push(n.serialize())}for(var l=[],e=0;e<this._groups.length;++e)l.push(this._groups[e].serialize());var u={last_node_id:this.last_node_id,last_link_id:this.last_link_id,nodes:t,links:i,groups:l,config:this.config,extra:this.extra,version:h.VERSION};return this.onSerialize&&this.onSerialize(u),u}configure(t,e){if(t){e||this.clear();var s=t.nodes;if(t.links&&t.links.constructor===Array){for(var i=[],n=0;n<t.links.length;++n){var o=t.links[n];if(!o){console.warn("serialized graph link data contains errors, skipping.");continue}var a=Bt.configure(o);i[a.id]=a}t.links=i}for(const c in t)c=="nodes"||c=="groups"||(this[c]=t[c]);var l=!1;if(this._nodes=[],s){for(var n=0,u=s.length;n<u;++n){var d=s[n],p=h.createNode(d.type,d.title);p||(console.error("Node not found or has errors: "+d.type),p=new C,p.last_serialization=d,p.has_errors=!0,l=!0),p.id=d.id,this.add(p,{addedBy:"configure",skipComputeOrder:!0})}for(var n=0,u=s.length;n<u;++n){var d=s[n],p=this.getNodeById(d.id);p&&p.configure(d)}}if(this._groups.length=0,t.groups)for(var n=0;n<t.groups.length;++n){var g=new ne;g.configure(t.groups[n]),this.addGroup(g)}return this.updateExecutionOrder(),this.extra=t.extra||{},this.onConfigure&&this.onConfigure(t),this._version++,this.setDirtyCanvas(!0,!0),l}}load(t,e){var s=this;if(t.constructor===File||t.constructor===Blob){var i=new FileReader;i.addEventListener("load",function(o){var a=JSON.parse(i.result);s.configure(a),e&&e(a)}),i.readAsText(t);return}var n=new XMLHttpRequest;n.open("GET",t,!0),n.send(null),n.onload=function(o){if(n.status!==200){console.error("Error loading graph:",n.status,n.response);return}var a=JSON.parse(n.response);s.configure(a),e&&e(a)},n.onerror=function(o){console.error("Error loading graph:",o)}}};os.DEFAULT_SUPPORTED_TYPES=["number","string","boolean"];let Fe=os;window.LGraph=Fe;function ls(r){const t={nodeIDs:{},linkIDs:{}};for(const e of r.nodes){const s=e.id,i=kt();if(e.id=i,t.nodeIDs[s]||t.nodeIDs[i])throw new Error(`New/old node UUID wasn't unique in changed map! ${s} ${i}`);t.nodeIDs[s]=i,t.nodeIDs[i]=s}for(const e of r.links){const s=e[0],i=kt();if(e[0]=i,t.linkIDs[s]||t.linkIDs[i])throw new Error(`New/old link UUID wasn't unique in changed map! ${s} ${i}`);t.linkIDs[s]=i,t.linkIDs[i]=s;const n=e[1],o=e[3];if(!t.nodeIDs[n])throw new Error(`Old node UUID not found in mapping! ${n}`);if(e[1]=t.nodeIDs[n],!t.nodeIDs[o])throw new Error(`Old node UUID not found in mapping! ${o}`);e[3]=t.nodeIDs[o]}for(const e of r.nodes){for(const s of e.inputs)s.link&&(s.link=t.linkIDs[s.link]);for(const s of e.outputs)s.links&&(s.links=s.links.map(i=>t.linkIDs[i]))}for(const e of r.nodes)if(e.type==="graph/subgraph"){const s=ls(e.subgraph);t.nodeIDs={...t.nodeIDs,...s.nodeIDs},t.linkIDs={...t.linkIDs,...s.linkIDs}}return t}function ni(r,t){for(const e of r.iterateNodesInOrderRecursive())e.onReassignID&&e.onReassignID(t)}const Xt=class us extends C{constructor(t,e){super(),this.properties={enabled:!0},this.size=[140,80],this.enabled=!0,this.subgraph=(e||us.default_lgraph_factory)(),this.subgraph._subgraph_node=this,this.subgraph._is_subgraph=!0;const s=(i,n)=>{const o=n.bind(this);return function(...a){i==null||i.apply(this,a),o(...a)}};this.subgraph.onTrigger=s(this.subgraph.onTrigger,this.onSubgraphTrigger),this.subgraph.onNodeAdded=s(this.subgraph.onNodeAdded,this.onSubgraphNodeAdded),this.subgraph.onNodeRemoved=s(this.subgraph.onNodeRemoved,this.onSubgraphNodeRemoved),this.subgraph.onInputAdded=s(this.subgraph.onInputAdded,this.onSubgraphNewInput),this.subgraph.onInputRenamed=s(this.subgraph.onInputRenamed,this.onSubgraphRenamedInput),this.subgraph.onInputTypeChanged=s(this.subgraph.onInputTypeChanged,this.onSubgraphTypeChangeInput),this.subgraph.onInputRemoved=s(this.subgraph.onInputRemoved,this.onSubgraphRemovedInput),this.subgraph.onOutputAdded=s(this.subgraph.onOutputAdded,this.onSubgraphNewOutput),this.subgraph.onOutputRenamed=s(this.subgraph.onOutputRenamed,this.onSubgraphRenamedOutput),this.subgraph.onOutputTypeChanged=s(this.subgraph.onOutputTypeChanged,this.onSubgraphTypeChangeOutput),this.subgraph.onOutputRemoved=s(this.subgraph.onOutputRemoved,this.onSubgraphRemovedOutput)}*iterateParentGraphs(){var e;let t=this.graph;for(;t;)yield t,t=(e=t._subgraph_node)==null?void 0:e.graph}onDblClick(t,e,s){var i=this;setTimeout(function(){s.openSubgraph(i.subgraph)},10)}onAction(t,e,s){const{originNode:i,link:n}=s;if(!i||!n)return;const o=n.target_slot;this.getInnerGraphInputByIndex(o).triggerSlot(0,e)}onExecute(){if(this.enabled=this.getInputOrProperty("enabled"),!!this.enabled){if(this.inputs)for(var t=0;t<this.inputs.length;t++){var e=this.inputs[t],s=this.getInputData(t);this.subgraph.setInputData(e.name,s)}if(this.subgraph.runStep(),this.outputs)for(var t=0;t<this.outputs.length;t++){var i=this.outputs[t],s=this.subgraph.getOutputData(i.name);this.setOutputData(t,s)}}}sendEventToAllNodes(t,e,s){this.enabled&&this.subgraph.sendEventToAllNodes(t,e,s)}onDrawBackground(t,e,s,i){}computeSize(){var t=this.inputs?this.inputs.length:0,e=this.outputs?this.outputs.length:0;return[200,Math.max(t,e)*h.NODE_SLOT_HEIGHT+h.NODE_SLOT_HEIGHT*.5]}onSubgraphTrigger(t,e){}onSubgraphNodeAdded(t,e){var s,i;(s=this.graph)!=null&&s.onNodeAdded&&(e.subgraphs||(e.subgraphs=[]),e.subgraphs.push(this),(i=this.graph)==null||i.onNodeAdded(t,e))}onSubgraphNodeRemoved(t,e){var s,i;(s=this.graph)!=null&&s.onNodeRemoved&&(e.subgraphs||(e.subgraphs=[]),e.subgraphs.push(this),(i=this.graph)==null||i.onNodeRemoved(t,e))}onSubgraphNewInput(t,e){var s=this.findInputSlotIndexByName(t);s==-1&&this.addInput(t,e)}onSubgraphRenamedInput(t,e){var s=this.findInputSlotIndexByName(t);if(s!=-1){var i=this.getInputInfo(s);i.name=e}}onSubgraphTypeChangeInput(t,e,s){var i=this.findInputSlotIndexByName(t);if(i!=-1){var n=this.getInputInfo(i);n.type=s}}onSubgraphRemovedInput(t){var e=this.findInputSlotIndexByName(t);e!=-1&&this.removeInput(e)}onSubgraphNewOutput(t,e){var s=this.findOutputSlotIndexByName(t);s==-1&&this.addOutput(t,e)}onSubgraphRenamedOutput(t,e){var s=this.findOutputSlotIndexByName(t);if(s!=-1){var i=this.getOutputInfo(s);i.name=e}}onSubgraphTypeChangeOutput(t,e,s){var i=this.findOutputSlotIndexByName(t);if(i!=-1){var n=this.getOutputInfo(i);n.type=s}}onSubgraphRemovedOutput(t){var e=this.findOutputSlotIndexByName(t);e!=-1&&this.removeOutput(e)}getExtraMenuOptions(t,e){var s=this;return[{content:"Open",callback:function(){t.openSubgraph(s.subgraph)}}]}onResize(t){console.error("TEST subgraph resize")}serialize(){var t=C.prototype.serialize.call(this);return t.subgraph=this.subgraph.serialize(),t}onConfigure(t){super.onConfigure&&super.onConfigure(t),this.subgraph._is_subgraph=!0,this.subgraph._subgraph_node=this;for(const e of this.subgraph.iterateNodesInOrder())(e.is(lt)||e.is(dt))&&(e.properties.subgraphID=this.id)}onReassignID(){for(const t of this.subgraph.iterateNodesInOrder())(t.is(lt)||t.is(dt))&&(t.properties.subgraphID=this.id)}clone(t={forNode:{}}){var n,o,a,l;var e=h.createNode(this.type),s=this.serialize();let i=null;if(h.use_uuids){const u=h.cloneObject(s.subgraph);i=ls(u),s.subgraph=u}return delete s.id,delete s.inputs,delete s.outputs,e.configure(s),h.use_uuids&&ni(e.subgraph,i),(n=t.forNode)[o=this.id]||(n[o]={}),t.forNode[this.id].subgraphNewIDMapping=i,(a=t.forNode)[l=e.id]||(a[l]={}),t.forNode[e.id].subgraphNewIDMapping=i,e}buildFromNodes(t){var m,E;if(t=t.filter(T=>!T.is(lt)&&!T.is(dt)),t.length===0)return;const e={},s={},i={},n=t.reduce((T,v)=>(T[v.id]=v,T),{});let o=Number.MAX_SAFE_INTEGER,a=0,l=Number.MAX_SAFE_INTEGER,u=0;for(const T of Object.values(t))o=Math.min(T.pos[0],o),a=Math.max(T.pos[0]+T.size[0],a),l=Math.min(T.pos[1],l),u=Math.max(T.pos[1]+T.size[1],u);const d={};for(const T of t){d[T.id]=T;for(let v=0;v<T.inputs.length;v++){const N=T.getInputLink(v);if(N){const I=T.getConnectionPos(!0,v),S=T.getInputInfo(v),F=T.getInputNode(v);F&&(d[F.id]=F),n[N.origin_id]!=null?i[N.id]=[N,I]:e[N.id]=[N,I,S.name]}}for(let v=0;v<T.outputs.length;v++){const N=T.getOutputLinks(v);for(const I of N){const S=T.getConnectionPos(!1,v),F=T.getOutputInfo(v),x=T.graph.getNodeById(I.target_id);x&&(d[x.id]=x),n[I.target_id]!=null?i[I.id]=[I,S]:s[I.id]=[I,S,F.name]}}}const p=Object.values(e),g=Object.values(s);p.sort((T,v)=>T[1][1]-v[1][1]),g.sort((T,v)=>T[1][1]-v[1][1]),h.debug&&(console.debug("NODES",Object.keys(t)),console.debug("IN",Object.keys(e)),console.debug("OUT",Object.keys(s)),console.debug("INNER",Object.keys(i)));const c={},b={};for(const T of t){const v=[T.pos[0]-o,T.pos[1]-l],N=T.id;T.graph.remove(T,{removedBy:"moveIntoSubgraph"}),this.subgraph.add(T,{addedBy:"moveIntoSubgraph",prevNodeID:N}),T.pos=v,d[N]=T,d[T.id]=T}let f=0,_=0;for(const[T,v,N]of p){let I=null;if(c[T.origin_id]&&(I=c[T.origin_id][T.origin_slot]),!I&&(I=this.addGraphInput(N,T.type,[-200,f]),f+=I.innerNode.size[1]+h.NODE_SLOT_HEIGHT,!I)){console.error("Failed creating subgraph output pair!",T);continue}const S=d[T.origin_id],F=d[T.target_id];S.connect(T.origin_slot,this,I.outerInputIndex),I.innerNode.connect(0,F,T.target_slot),c[m=T.origin_id]||(c[m]={}),c[T.origin_id][T.origin_slot]=I}for(const[T,v,N]of g){let I=null;if(b[T.target_id]&&(I=b[T.target_id][T.target_slot]),!I&&(I=this.addGraphOutput(N,T.type,[a-o+200,_]),_+=I.innerNode.size[1]+h.NODE_SLOT_HEIGHT,!I)){console.error("Failed creating subgraph output pair!",T);continue}const S=d[T.origin_id],F=d[T.target_id];S.connect(T.origin_slot,I.innerNode,0),this.connect(I.outerOutputIndex,F,T.target_slot),b[E=T.target_id]||(b[E]={}),b[T.target_id][T.origin_slot]=I}for(const[T,v]of Object.values(i)){const N=d[T.origin_id],I=d[T.target_id];N.connect(T.origin_slot,I,T.target_slot)}}addGraphInput(t,e,s){t=this.getValidGraphInputName(t);const i=h.createNode(lt);if(i==null)return null;let n=e;e===y.EVENT?n=y.ACTION:e===y.ACTION&&(e=y.EVENT),console.warn("[Subgraph] addGraphInput",t,e,n,s),i.setProperty("name",t),i.setProperty("type",e),i.properties.subgraphID=this.id,this.subgraph.add(i);const o=i.computeSize();s&&(i.pos=[s[0]-o[0]*.5,s[1]-o[1]*.5]),this.subgraph.addInput(t,n,null);const a=this.inputs.length-1,l=this.inputs[a];return{innerNode:i,outerInput:l,outerInputIndex:a}}addGraphOutput(t,e,s){t=this.getValidGraphOutputName(t);const i=h.createNode(dt);if(i==null)return null;let n=e;e===y.EVENT?e=y.ACTION:e===y.ACTION&&(n=y.EVENT),console.warn("[Subgraph] addGraphOutput",t,e,n,s),i.setProperty("name",t),i.setProperty("type",e),i.properties.subgraphID=this.id,this.subgraph.add(i);const o=i.computeSize();s&&(i.pos=[s[0],s[1]-o[1]*.5]),this.subgraph.addOutput(t,n,null);const a=this.outputs.length-1,l=this.outputs[a];return{innerNode:i,outerOutput:l,outerOutputIndex:a}}removeGraphInput(t){if(this.findInputSlotIndexByName(t)==null){console.error("[Subgraph] No input in slot!",t);return}const s=this.subgraph.findNodesByClass(lt).filter(i=>i.properties.name===t);if(s.length>0)for(const i of s)this.subgraph.remove(i);else{console.warn("[Subgraph] No GraphInputs found on input removal",t);const i=this.findInputSlotIndexByName(t);i!==-1&&this.removeInput(i)}}removeGraphOutput(t){if(this.findOutputSlotIndexByName(t)==null){console.error("[Subgraph] No output in slot!",t);return}const s=this.subgraph.findNodesByClass(dt).filter(i=>i.properties.name===t);if(s.length>0)for(const i of s)this.subgraph.remove(i);else{console.warn("[Subgraph] No GraphOutputs found on output removal",t);const i=this.findOutputSlotIndexByName(t);i!==-1&&this.removeOutput(i)}}getValidGraphInputName(t){t||(t="newInput");let e=t,s=this.getInnerGraphInput(e),i=1;for(;s!=null;)e=`${t}_${i++}`,s=this.getInnerGraphInput(e);return e}getValidGraphOutputName(t){t||(t="newOutput");let e=t,s=this.getInnerGraphOutput(e),i=1;for(;s!=null;)e=`${t}_${i++}`,s=this.getInnerGraphOutput(e);return e}getInnerGraphOutput(t){return this.subgraph._nodes.find(s=>s.is(dt)&&s.properties.name===t)||null}getInnerGraphInput(t){return this.subgraph._nodes.find(s=>s.is(lt)&&s.properties.name===t)||null}getInnerGraphOutputByIndex(t){const e=this.getOutputInfo(t);return e?this.getInnerGraphOutput(e.name):null}getInnerGraphInputByIndex(t){const e=this.getInputInfo(t);return e?this.getInnerGraphInput(e.name):null}moveNodesToParentGraph(t){if(t=t.filter(f=>!f.is(lt)&&!f.is(dt)),t.length===0)return;const e=this,s=e.graph;let i=Number.MAX_SAFE_INTEGER,n=0,o=Number.MAX_SAFE_INTEGER,a=0;for(const f of Object.values(t))i=Math.min(f.pos[0],i),n=Math.max(f.pos[0]+f.size[0],n),o=Math.min(f.pos[1],o),a=Math.max(f.pos[1]+f.size[1],a);const l=n-i,u=a-o,d=e.pos[0]+e.size[0]/2-l/2,p=e.pos[1]+e.size[1]/2-u/2,g={},c={};for(const[f,_]of t.entries())c[_.id]=_;for(const f of t)for(const _ of f.iterateAllLinks()){const m=_.target_id===f.id,E=f.getConnectionPos(m,m?_.target_slot:_.origin_slot);c[_.origin_id]!=null&&c[_.target_id]!=null&&(g[_.id]=[_,E])}const b={};for(const[f,_]of t.entries()){const m=[_.pos[0]-i+d,_.pos[1]-o+p],E=_.id;_.graph.remove(_,{removedBy:"moveOutOfSubgraph"}),s.add(_,{addedBy:"moveOutOfSubgraph",prevNodeID:E}),_.pos=m,b[E]=_}for(const[f,_]of Object.values(g)){const m=c[f.origin_id],E=c[f.target_id];m.connect(f.origin_slot,E,f.target_slot)}return b}convertNodesToSubgraphInputs(t){var l;if(t=t.filter(u=>!u.is(lt)&&!u.is(dt)),t.length===0)return;const e=ie(t,u=>u.id),s=[],i={},n=this.subgraph;for(const u of t)for(const d of u.iterateAllLinks()){if(e[d.origin_id]==null)throw new Error("Can't convert to input with an origin link outward");if(e[d.target_id]==null){s.push(d);const p=[0,0];u.getConnectionPos(!1,d.target_slot,p),i[u.id]=[[u.pos[0],u.pos[1]],p]}}const o=this.moveNodesToParentGraph(t),a={};for(const u of s){const d=n.getNodeById(u.target_id),p=d.getInputInfo(u.target_slot);a[l=u.origin_id]||(a[l]={});let g=a[u.origin_id][u.origin_slot];if(g==null){const b=this.getValidGraphInputName(p.name);g=this.addGraphInput(b,p.type),a[u.origin_id][u.origin_slot]=g;const[f,_]=i[u.origin_id],m=g.innerNode.pos,E=g.innerNode.computeSize(),T=g.innerNode.getConnectionPos(!0,0),v=[g.innerNode.pos[0]-T[0],g.innerNode.pos[1]-T[1]],N=[_[0]+v[0]-E[0],_[1]+v[1]];console.warn("newPos",m,"size",g.innerNode.size,"connPos",_,"newConPos",T,"offset",v),g.innerNode.pos=N}o[u.origin_id].connect(u.origin_slot,this,g.outerInputIndex),g.innerNode.connect(0,d,u.target_slot)}}convertNodesToSubgraphOutputs(t){var l;if(t=t.filter(u=>!u.is(lt)&&!u.is(dt)),t.length===0)return;const e=ie(t,u=>u.id),s=[],i={},n=this.subgraph;for(const u of t)for(const d of u.iterateAllLinks())if(e[d.origin_id]==null){s.push(d);const p=[0,0];u.getConnectionPos(!0,d.origin_slot,p),i[u.id]=[[u.pos[0],u.pos[1]],p]}else if(e[d.target_id]==null)throw new Error("Can't convert to input with an origin link outward");const o=this.moveNodesToParentGraph(t),a={};for(const u of s){const d=n.getNodeById(u.origin_id),p=d.getOutputInfo(u.origin_slot);a[l=u.target_id]||(a[l]={});let g=a[u.target_id][u.target_slot];if(g==null){g=this.addGraphOutput(p.name,p.type),a[u.target_id][u.target_slot]=g;const[b,f]=i[u.target_id],_=g.innerNode.getConnectionPos(!0,0),m=[g.innerNode.pos[0]-_[0],g.innerNode.pos[1]-_[1]],E=[f[0]+m[0],f[1]+m[1]];g.innerNode.pos=E}const c=o[u.target_id];d.connect(u.origin_slot,g.innerNode,0),this.connect(g.outerOutputIndex,c,u.target_slot)}}};Xt.default_lgraph_factory=()=>new Fe;Xt.slotLayout={inputs:[],outputs:[]};Xt.propertyLayout=[{name:"enabled",defaultValue:!0}];Xt.optionalSlots={outputs:[{name:"enabled",type:"boolean"}]};let re=Xt;h.registerNodeType({class:re,title:"Subgraph",desc:"Graph inside a node",title_color:"#334",type:"graph/subgraph"});class w{static onMenuCollapseAll(){}static onMenuNodeEdit(){}prompt(t="",e,s,i,n=!1,o=null){var a=this,l=document.createElement("div");if(l.is_modified=!1,l.className="graphdialog rounded",n){let N=5;typeof e!="string"&&(e=JSON.stringify(e,null,2));const I=(e.match(/\n/g)||"").length+1;N=Nt(I,5,10),l.innerHTML=`
<span class='name'></span>
<textarea autofocus rows='${N}' cols='30' class='value'></textarea>
<button class='rounded'>OK</button>
`}else l.innerHTML=`
<span class='name'></span>
<input autofocus type='text' class='value'/>
<button class='rounded'>OK</button>`;l.close=function(){a.prompt_box=null,l.parentNode&&l.parentNode.removeChild(l)};var u=O.active_canvas,d=u.canvas;d.parentNode.appendChild(l),this.ds.scale>1&&(l.style.transform="scale("+this.ds.scale+")");var p=null,g=0;h.pointerListenerAdd(l,"leave",function(N){g||h.dialog_close_on_mouse_leave&&!l.is_modified&&h.dialog_close_on_mouse_leave&&N.buttons===0&&(p=setTimeout(l.close,h.dialog_close_on_mouse_leave_delay))}),h.pointerListenerAdd(l,"enter",function(N){h.dialog_close_on_mouse_leave&&p&&clearTimeout(p)});var c=l.querySelectorAll("select");c&&c.forEach(function(N){N.addEventListener("click",function(I){g++}),N.addEventListener("blur",function(I){g=0}),N.addEventListener("change",function(I){g=-1})}),a.prompt_box&&a.prompt_box.close(),a.prompt_box=l;var b=l.querySelector(".name");b.innerText=t;let f=l.querySelector(".value");f.value=e;var _=f;if(_.addEventListener("keydown",function(N){if(l.is_modified=!0,N.keyCode==27)l.close();else if(N.keyCode==13&&N.target instanceof Element&&N.target.localName!="textarea")s&&s(this.value),l.close();else return;N.preventDefault(),N.stopPropagation()}),o)for(const[N,I]of Object.entries(o))_.style[N]=I;var m=l.querySelector("button");m.addEventListener("click",function(N){s&&s(_.value),a.setDirty(!0),l.close()});var E=d.getBoundingClientRect(),T=-20,v=-20;return E&&(T-=E.left,v-=E.top),i?(l.style.left=i.clientX+"px",l.style.top=i.clientY+"px"):(l.style.left=d.width*.5+T+"px",l.style.top=d.height*.5+v+"px"),console.warn(l.style.left,l.style.top),console.warn(i),setTimeout(function(){_.focus()},10),Le(l),l}showSearchBox(t,e={}){var s={slotFrom:null,node_from:null,node_to:null,do_type_filter:h.search_filter_enabled,type_filter_in:null,type_filter_out:null,show_general_if_none_on_typefilter:!0,show_general_after_typefiltered:!0,hide_on_mouse_leave:h.search_hide_on_mouse_leave,show_all_if_empty:!0,show_all_on_open:h.search_show_all_on_open};e=Object.assign(s,e);var i=this,n=O.active_canvas,o=n.canvas,a=o.ownerDocument||document;let l=t;var u=document.createElement("div");u.className="litegraph litesearchbox graphdialog rounded",u.innerHTML="<span class='name'>Search</span> <input autofocus type='text' class='value rounded'/>",e.do_type_filter&&(u.innerHTML+="<select class='slot_in_type_filter'><option value=''></option></select>",u.innerHTML+="<select class='slot_out_type_filter'><option value=''></option></select>"),u.innerHTML+="<div class='helper'></div>",a.fullscreenElement?a.fullscreenElement.appendChild(u):(a.body.appendChild(u),a.body.style.overflow="hidden");let d=null,p=null;if(e.do_type_filter&&(d=u.querySelector(".slot_in_type_filter"),p=u.querySelector(".slot_out_type_filter")),u.close=function(){i.search_box=null,this.blur(),o.focus(),a.body.style.overflow="",setTimeout(function(){i.canvas.focus()},20),u.parentNode&&u.parentNode.removeChild(u)},this.ds.scale>1&&(u.style.transform="scale("+this.ds.scale+")"),e.hide_on_mouse_leave){var g=0,c=null;h.pointerListenerAdd(u,"enter",function(P){c&&(clearTimeout(c),c=null)}),h.pointerListenerAdd(u,"leave",function(P){g||(c=setTimeout(function(){u.close()},500))}),e.do_type_filter&&(d.addEventListener("click",function(P){g++}),d.addEventListener("blur",function(P){g=0}),d.addEventListener("change",function(P){g=-1}),p.addEventListener("click",function(P){g++}),p.addEventListener("blur",function(P){g=0}),p.addEventListener("change",function(P){g=-1}))}i.search_box&&i.search_box.close(),i.search_box=u;var b=u.querySelector(".helper"),f=null,_=null,m=null;const E=P=>{if(P)if(i.onSearchBoxSelection)i.onSearchBoxSelection(P,l,n);else{var M=h.searchbox_extras[P.toLowerCase()];M&&(P=M.type),n.graph.beforeChange();var V=h.createNode(P);if(V&&(V.pos=n.convertEventToCanvasOffset(l),n.graph.add(V)),M&&M.data){if(M.data.properties)for(var Q in M.data.properties)V.addProperty(""+Q,M.data.properties[Q]);if(M.data.inputs){V.inputs=[];for(var Q in M.data.inputs)V.addInput(M.data.inputs[Q][0],M.data.inputs[Q][1])}if(M.data.outputs){V.outputs=[];for(var Q in M.data.outputs)V.addOutput(M.data.outputs[Q][0],M.data.outputs[Q][1])}M.data.title&&(V.title=M.data.title),M.data.json&&V.configure(M.data.json)}if(e.node_from){var G=null;switch(typeof e.slotFrom){case"string":G=e.node_from.findOutputSlotIndexByName(e.slotFrom);break;case"object":e.slotFrom.name?G=e.node_from.findOutputSlotIndexByName(e.slotFrom.name):G=-1,G==-1&&typeof e.slotFrom.slot_index<"u"&&(G=e.slotFrom.slot_index);break;case"number":G=e.slotFrom;break;default:G=0}G=G,typeof e.node_from.outputs[G]!==void 0&&G!==null&&G>-1&&e.node_from.connectByTypeInput(G,V,e.node_from.outputs[G].type)}if(e.node_to){var G=null;switch(typeof e.slotFrom){case"string":G=e.node_to.findInputSlotIndexByName(e.slotFrom);break;case"number":G=e.slotFrom;break;default:G=0}typeof e.node_to.inputs[G]!==void 0&&G!==null&&G>-1&&e.node_to.connectByTypeOutput(G,V,e.node_to.inputs[G].type)}n.graph.afterChange()}u.close()},T=P=>{var M=m;m&&m.classList.remove("selected"),m?(m=P?m.nextElementSibling:m.previousElementSibling,m||(m=M)):m=P?b.children[0]:b.children[b.children.length],m&&(m.classList.add("selected"),m.scrollIntoView({block:"end",behavior:"smooth"}))},v=(P,M,V,Q,G,xt={})=>{const vt=Object.assign({skipFilter:!1,inTypeOverride:null,outTypeOverride:null},xt),Qt=h.registered_node_types[P];if(Qt.hide_in_node_lists||M&&Qt.filter!=M||(!e.show_all_if_empty||V)&&P.toLowerCase().indexOf(V)===-1)return!1;if(e.do_type_filter&&!vt.skipFilter){const J=P;let H=Q==null?void 0:Q.value;if(vt.inTypeOverride!=null&&(H=vt.inTypeOverride),Q&&H&&h.registered_slot_in_types[H]&&h.registered_slot_in_types[H].nodes){var Tt=h.registered_slot_in_types[H].nodes.includes(J);if(Tt===!1)return!1}if(H=G==null?void 0:G.value,vt.outTypeOverride!=null&&(H=vt.outTypeOverride),G&&H&&h.registered_slot_out_types[H]&&h.registered_slot_out_types[H].nodes){var Tt=h.registered_slot_out_types[H].nodes.includes(J);if(Tt===!1)return!1}}return!0},N=()=>{_=null;var P=I.value;if(f=null,b.innerHTML="",!P&&!e.show_all_if_empty)return;if(i.onSearchBox){var M=i.onSearchBox(b,P,n);if(M)for(var V=0;V<M.length;++V)Tt(M[V])}else{var Q=0;P=P.toLowerCase();var G=n.filter||n.graph.filter;let J,H;e.do_type_filter&&i.search_box?(J=i.search_box.querySelector(".slot_in_type_filter"),H=i.search_box.querySelector(".slot_out_type_filter")):(J=null,H=null);for(const Z in h.searchbox_extras){var xt=h.searchbox_extras[Z];if(!((!e.show_all_if_empty||P)&&xt.desc.toLowerCase().indexOf(P)===-1)){var we=h.registered_node_types[xt.type];if(!(we&&we.filter!=G)&&v(xt.type,G,P,J,H)&&(Tt(xt.desc,"searchbox_extra"),O.search_limit!==-1&&Q++>O.search_limit))break}}var vt=null;if(Array.prototype.filter)var Qt=Object.keys(h.registered_node_types),vt=Qt.filter(st=>v(st,G,P,J,H));else{vt=[];for(const Z in h.registered_node_types)v(Z,G,P,J,H)&&vt.push(Z)}for(var V=0;V<vt.length&&(Tt(vt[V]),!(O.search_limit!==-1&&Q++>O.search_limit));V++);if(e.show_general_after_typefiltered&&(J!=null&&J.value||H!=null&&H.value)){let Z=[];for(const st in h.registered_node_types)v(st,G,P,J,H,{inTypeOverride:J&&J.value?"*":null,outTypeOverride:H&&H.value?"*":null})&&Z.push(st);for(let st=0;st<Z.length&&(Tt(Z[st],"generic_type"),!(O.search_limit!==-1&&Q++>O.search_limit));st++);}if((J!=null&&J.value||H!=null&&H.value)&&(b==null?void 0:b.childNodes.length)==0&&e.show_general_if_none_on_typefilter){let Z=[];for(const st in h.registered_node_types)v(st,G,P,J,H,{skipFilter:!0})&&Z.push(st);for(let st=0;st<Z.length&&(Tt(Z[st],"not_in_filter"),!(O.search_limit!==-1&&Q++>O.search_limit));st++);}}function Tt(J,H){var Z=document.createElement("div");f||(f=J),Z.innerText=J,Z.dataset.type=escape(J),Z.className="litegraph lite-search-item",H&&(Z.className+=" "+H),Z.addEventListener("click",function(st){E(unescape(this.dataset.type))}),b.appendChild(Z)}};var I=u.querySelector("input");if(I&&(I.addEventListener("blur",function(P){this.focus()}),I.addEventListener("keydown",function(P){if(P.keyCode==38)T(!1);else if(P.keyCode==40)T(!0);else if(P.keyCode==27)u.close();else if(P.keyCode==13)m?E(m.innerHTML):f?E(f):u.close();else{_&&clearInterval(_),_=setTimeout(N,h.search_box_refresh_interval_ms);return}return P.preventDefault(),P.stopPropagation(),P.stopImmediatePropagation(),!0})),e.do_type_filter){if(d){var S=h.slot_types_in,F=S.length;(e.type_filter_in==y.EVENT||e.type_filter_in==y.ACTION)&&(e.type_filter_in="_event_");for(var x=0;x<F;x++){var z=document.createElement("option");z.value=S[x],z.innerHTML=S[x],d.appendChild(z),e.type_filter_in!==null&&(e.type_filter_in+"").toLowerCase()==(S[x]+"").toLowerCase()&&(z.selected=!0)}d.addEventListener("change",N)}if(p){var S=h.slot_types_out,F=S.length;(e.type_filter_out==y.EVENT||e.type_filter_out==y.ACTION)&&(e.type_filter_out="_event_");for(var x=0;x<F;x++){var z=document.createElement("option");z.value=S[x],z.innerHTML=S[x],p.appendChild(z),e.type_filter_out!==null&&(e.type_filter_out+"").toLowerCase()==(S[x]+"").toLowerCase()&&(z.selected=!0)}p.addEventListener("change",N)}}var Y=o.getBoundingClientRect(),X=(l?l.clientX:Y.left+Y.width*.5)-80,j=(l?l.clientY:Y.top+Y.height*.5)-20;return u.style.left=X+"px",u.style.top=j+"px",l.layerY>Y.height-200&&(b.style.maxHeight=Y.height-l.layerY-20+"px"),I.focus(),e.show_all_on_open&&N(),u}showShowNodePanel(t){this.closePanels();var e=this.getCanvasWindow(),s=this,i=this.createPanel(t.title||"",{closable:!0,window:e,onOpen:function(){},onClose:function(){s.node_panel=null}});s.node_panel=i,i.id="node-panel",i.node=t,i.classList.add("settings");function n(){i.content.innerHTML="",i.addHTML("<span class='node_type'>"+t.type+"</span><span class='node_desc'>"+(t.constructor.desc||"")+"</span><span class='separator'></span>"),i.addHTML("<h3>Properties</h3>");var o=function(p,g){switch(s.graph.beforeChange(t),p){case"Title":t.title=g;break;case"Mode":var c=Object.values(St).indexOf(g);c>=nt.ALWAYS&&St[c]?t.changeMode(c):console.warn("unexpected mode: "+g);break;case"Color":O.node_colors[g]?(t.color=O.node_colors[g].color,t.bgcolor=O.node_colors[g].bgcolor):console.warn("unexpected color: "+g);break;default:t.setProperty(p,g);break}s.graph.afterChange(),s.dirty_canvas=!0};i.addWidget("string","Title",t.title,{},o),i.addWidget("combo","Mode",St[t.mode],{values:St},o);var a="";t.color!==void 0&&(a=Object.keys(O.node_colors).filter(function(p){return O.node_colors[p].color==t.color})[0]),i.addWidget("combo","Color",a,{values:Object.keys(O.node_colors)},o);for(var l in t.properties){var u=t.properties[l],d=t.getPropertyInfo(l);d.type,!(t.onAddPropertyToPanel&&t.onAddPropertyToPanel(l,i))&&i.addWidget(d.widget||d.type,l,u,d,o)}i.addSeparator(),t.onShowCustomPanelInfo&&t.onShowCustomPanelInfo(i),i.footer.innerHTML="",i.addButton("Delete",function(){t.block_delete||(t.graph.remove(t),i.close())}).classList.add("delete")}i.inner_showCodePad=function(o){i.classList.remove("settings"),i.classList.add("centered"),i.alt_content.innerHTML="<textarea class='code'></textarea>";var a=i.alt_content.querySelector("textarea"),l=function(){i.toggleAltContent(!1),i.toggleFooterVisibility(!0),a.parentNode.removeChild(a),i.classList.add("settings"),i.classList.remove("centered"),n()};a.value=t.properties[o],a.addEventListener("keydown",function(p){p.code=="Enter"&&p.ctrlKey&&(t.setProperty(o,a.value),l())}),i.toggleAltContent(!0),i.toggleFooterVisibility(!1),a.style.height="calc(100% - 40px)";var u=i.addButton("Assign",function(){t.setProperty(o,a.value),l()});i.alt_content.appendChild(u);var d=i.addButton("Close",l);d.style.float="right",i.alt_content.appendChild(d)},n(),this.canvas.parentNode.appendChild(i)}showSubgraphPropertiesDialog(t){console.log("showing subgraph properties dialog");var e=this.canvas.parentNode.querySelector(".subgraph_dialog");e&&e.close();var s=this.createPanel("Subgraph Inputs",{closable:!0,width:500});s.node=t,s.classList.add("subgraph_dialog");const i=t;var n=i.subgraph;if(!n){console.warn("subnode without subgraph!");return}function o(){if(s.clear(),t.inputs)for(var f=0;f<t.inputs.length;++f){var _=t.inputs[f];if(_.not_subgraph_input)continue;var m=`
<button class="delete">&#10005;</button>
<button class="move_up"></button>
<button class="move_down"></button>
<span class='bullet_icon'></span>
<span class='name'></span>
<span class='type'></span>`,E=s.addHTML(m,"subgraph_property");E.dataset.name=_.name,E.dataset.slot=""+f,E.querySelector(".name").innerText=_.name,E.querySelector(".type").innerText=ot(_.type),E.querySelector(".delete").addEventListener("click",function(N){const I=this.parentNode.dataset.name;i.removeGraphInput(I),o()});const T=E.querySelector(".move_up");T.disabled=f<=0,T.addEventListener("click",function(N){const I=+this.parentNode.dataset.slot;I<0||(i.moveInput(I,I-1),o())});const v=E.querySelector(".move_down");v.disabled=f>=t.inputs.length-1,v.addEventListener("click",function(N){const I=+this.parentNode.dataset.slot;I>t.inputs.length-1||(i.moveInput(I,I+1),o())})}}var a=`
+
<span class='label'>Name</span>
<input class='name'/>
<span class='label'>Type</span>
<select class='type'></select>
<button>+</button>`,l=s.addHTML(a,"subgraph_property extra",!0);const u=l.querySelector(".name"),d=l.querySelector(".type"),p=l.querySelector("button");for(const f of ns()){var g=document.createElement("option");g.value=f,g.innerHTML=ot(f),d.appendChild(g),f==="*"&&(g.selected=!0)}const c=()=>{const f=u.value;let _=d.value;_==="-1"?_=y.ACTION:_==="-2"&&(_=y.EVENT),!(!f||t.findInputSlotIndexByName(f)!=-1)&&(this.addGraphInputNode(t,f,_),u.value="",d.value="",o(),u.focus())},b=f=>{f.keyCode==13?(c(),f.preventDefault()):f.keyCode==27&&(s.close(),f.preventDefault())};return p.addEventListener("click",c),u.addEventListener("keydown",b),d.addEventListener("keydown",b),o(),this.canvas.parentNode.appendChild(s),u.focus(),s}showSubgraphPropertiesDialogRight(t){var e=this.canvas.parentNode.querySelector(".subgraph_dialog");e&&e.close();var s=this.createPanel("Subgraph Outputs",{closable:!0,width:500});s.node=t,s.classList.add("subgraph_dialog");const i=t;if(!i.subgraph){console.warn("subnode without subgraph!");return}function o(){if(s.clear(),t.outputs)for(var f=0;f<t.outputs.length;++f){var _=t.outputs[f];if(_.not_subgraph_output)continue;var m=`
<button>&#10005;</button>
<button class="move_up"></button>
<button class="move_down"></button>
<span class='bullet_icon'></span>
<span class='name'></span>
<span class='type'></span>`,E=s.addHTML(m,"subgraph_property");E.dataset.name=_.name,E.dataset.slot=""+f,E.querySelector(".name").innerText=_.name,E.querySelector(".type").innerText=ot(_.type),E.querySelector("button").addEventListener("click",function(N){const I=this.parentNode.dataset.name;i.removeGraphOutput(I),o()});const T=E.querySelector(".move_up");T.disabled=f<=0,T.addEventListener("click",function(N){const I=+this.parentNode.dataset.slot;I<0||(i.moveOutput(I,I-1),o())});const v=E.querySelector(".move_down");v.disabled=f>=t.outputs.length-1,v.addEventListener("click",function(N){const I=+this.parentNode.dataset.slot;I>t.outputs.length-1||(i.moveOutput(I,I+1),o())})}}var a=`
+
<span class='label'>Name</span>
<input class='name'/>
<span class='label'>Type</span>
<select class='type'></select>
<button>+</button>`,l=s.addHTML(a,"subgraph_property extra",!0);const u=l.querySelector(".name"),d=l.querySelector(".type"),p=l.querySelector("button");for(const f of rs()){var g=document.createElement("option");g.value=f,g.innerHTML=ot(f),d.appendChild(g),f==="*"&&(g.selected=!0)}const c=()=>{const f=u.value;let _=d.value;_==="-1"?_=y.ACTION:_==="-2"&&(_=y.EVENT),!(!f||t.findOutputSlotIndexByName(f)!=-1)&&(this.addGraphOutputNode(t,f,_),u.value="",d.value="",o(),u.focus())},b=f=>{f.keyCode==13?(c(),f.preventDefault()):f.keyCode==27&&(s.close(),f.preventDefault())};return p.addEventListener("click",c),u.addEventListener("keydown",b),d.addEventListener("keydown",b),o(),this.canvas.parentNode.appendChild(s),u.focus(),s}showConnectionMenu(t={}){var e=t.nodeFrom&&t.slotFrom,s=!e&&t.nodeTo&&t.slotTo;if(!e&&!s)return console.warn("No data passed to showConnectionMenu"),!1;var i=e?t.nodeFrom:t.nodeTo;const n=e?t.slotFrom:t.slotTo;let o;var a=null;switch(typeof n){case"string":a=e?i.findOutputSlotIndexByName(n):i.findInputSlotIndexByName(n),o=e?i.outputs[n]:i.inputs[n];break;case"object":o=n,a=e?i.findOutputSlotIndexByName(o.name):i.findInputSlotIndexByName(o.name);break;case"number":a=n,o=e?i.outputs[a]:i.inputs[a];break;default:return console.error("Can't get slot information",n),!1}var l=[{content:"Add Node"},it.SEPARATOR];i.graph._is_subgraph&&(e?l.push({content:"Add Subgraph Output"}):l.push({content:"Add Subgraph Input"}),l.push(it.SEPARATOR)),this.allow_searchbox&&(l.push({content:"Search"}),l.push(it.SEPARATOR));var u=o.type==y.EVENT?"_event_":o.type,d=e?h.slot_types_default_out:h.slot_types_default_in;const p=d[u];if(console.warn("FROMSL",d,p),d&&d[u])if(Array.isArray(p))for(var g of p){const E=typeof g=="string"?g:(g==null?void 0:g.title)||(g==null?void 0:g.node);l.push({content:E,value:g})}else throw new Error(`Invalid default slot specifier, must be an array: ${p}`);const c=E=>{const T=i.graph._subgraph_node,v=[E.canvasX,E.canvasY];T.addGraphInput(o.name,o.type,v).innerNode.connect(0,i,a)},b=E=>{const T=i.graph._subgraph_node,v=[E.canvasX,E.canvasY],N=T.addGraphOutput(o.name,o.type,v);i.connect(a,N.innerNode,0)},f=E=>{const T=Object.assign(t,{position:[t.e.canvasX,t.e.canvasY]});var v=this.createDefaultNodeForSlot(E,T);v?console.log("node created",E):console.error("node not in defaults",E)},_=(E,T,v)=>{switch(E.content){case"Add Node":O.onMenuAdd(E,T,v,m,function(N){e?t.nodeFrom.connectByTypeInput(a,N,u):t.nodeTo.connectByTypeOutput(a,N,u)});break;case"Add Subgraph Input":c(this.adjustMouseEvent(v));break;case"Add Subgraph Output":b(this.adjustMouseEvent(v));break;case"Search":e?this.showSearchBox(v,{node_from:t.nodeFrom,slotFrom:o,type_filter_in:u}):this.showSearchBox(v,{node_to:t.nodeTo,slotFrom:o,type_filter_out:u});break;default:f(E.value);break}};var m=new tt(l,{event:t.e,title:(o&&o.name!=""?o.name+(u?" | ":""):"")+(o&&u?u:""),callback:_});return!1}getLinkMenuOptions(t){const e=this.graph.getNodeById(t.origin_id),s=this.graph.getNodeById(t.target_id);let i=null;e&&e.outputs&&e.outputs[t.origin_slot]&&(i=e.outputs[t.origin_slot].type);let n=null;s&&s.outputs&&s.outputs[t.target_slot]&&(n=s.inputs[t.target_slot].type);const o=d=>{console.debug("node autoconnect"),!(!d.inputs||!d.inputs.length||!d.outputs||!d.outputs.length)&&e.connectByTypeInput(t.origin_slot,d,i)&&(d.connectByTypeInput(t.target_slot,s,n),d.pos[0]-=d.size[0]*.5)},a=(d,p,g,c,b)=>{O.onMenuAdd(d,p,g,c,o)},l=()=>{this.graph.removeLink(t.id)};let u=[{content:"Add Node",has_submenu:!0,callback:a},it.SEPARATOR,{content:"Delete",has_submenu:!0,callback:l},it.SEPARATOR];return this.graph.onGetLinkMenuOptions&&(u=this.graph.onGetLinkMenuOptions(u,t)),e.getExtraLinkOptions&&(u=e.getExtraLinkOptions(this,t,q.OUTPUT,u)),s.getExtraLinkOptions&&(u=s.getExtraLinkOptions(this,t,q.INPUT,u)),u}showLinkMenu(t,e){const s=this.getLinkMenuOptions(t);return new tt(s,{event:e,title:t.data!=null?t.data.constructor.name:null,extra:t}),!1}showEditPropertyValue(t,e,s={}){if(!t||t.properties[e]===void 0||h.ignore_all_widget_events)return;var i=t.getPropertyInfo(e),n=i.type,o="";if(n=="string"||n=="number"||n=="array"||n=="object")if(i.multiline){let f=t.properties[e],_=5;if(n!=="string"){f=JSON.stringify(f,null,2);const m=(f.match(/\n/g)||"").length+1;_=Nt(m,5,10)}o="<textarea autofocus type='text' rows='"+_+"' cols='30' class='value'>"+(f||"")+"</textarea>"}else o="<input autofocus type='text' class='value'/>";else if((n=="enum"||n=="combo")&&i.values){o="<select autofocus type='text' class='value'>";for(var a in i.values){var l=a;i.values instanceof Array&&(l=i.values[a]),o+="<option value='"+l+"' "+(l==t.properties[e]?"selected":"")+">"+i.values[a]+"</option>"}o+="</select>"}else if(n=="boolean"||n=="toggle")o="<input autofocus type='checkbox' class='value' "+(t.properties[e]?"checked":"")+"/>";else{console.warn("unknown type: "+n);return}var u=this.createDialog("<span class='name'>"+(i.label?i.label:e)+"</span>"+o+"<button>OK</button>",s),d=null;if((n=="enum"||n=="combo")&&i.values)d=u.querySelector("select"),d.addEventListener("change",function(f){u.modified(),c(f.target.value)});else if(n=="boolean"||n=="toggle")d=u.querySelector("input"),d&&d.addEventListener("click",function(f){u.modified(),c(!!d.checked)});else if(i.multiline?d=u.querySelector("textarea"):d=u.querySelector("input"),d){d.addEventListener("blur",function(_){this.focus()});let f=t.properties[e]!==void 0?t.properties[e]:"";if(n!=="string"){let _=null;i.multiline&&(_=2),f=JSON.stringify(f,null,_)}if(d.value=f,d.addEventListener("keydown",function(_){let m=!1;_.keyCode==27?(u.close(),m=!0):_.keyCode==13&&!i.multiline?(g(),m=!0):_.keyCode!=13&&u.modified(),m&&(_.preventDefault(),_.stopPropagation())}),i.inputStyle)for(const[_,m]of Object.entries(i.inputStyle))d.style[_]=m}d&&d.focus();const p=()=>{s.onclose&&s.onclose(),u.close(),t.setDirtyCanvas(!0,!0)},g=()=>{n!="boolean"&&n!="toggle"?c(d.value):p()},c=f=>{i&&i.values&&i.values.constructor===Object&&i.values[f]!=null&&(f=i.values[f]),typeof t.properties[e]=="number"&&(f=Number(f)),(n=="array"||n=="object")&&(f=JSON.parse(f)),t.setProperty(e,f),p()};var b=u.querySelector("button");return b.addEventListener("click",g),Le(u),u}createDialog(t,e={checkForInput:!1,closeOnLeave:!0,closeOnLeave_checkModified:!0}){var s=document.createElement("div");s.className="graphdialog",s.innerHTML=t,s.is_modified=!1;var i=this.canvas.getBoundingClientRect(),n=-20,o=-20;if(i&&(n-=i.left,o-=i.top),e.position?(n=e.position[0],o=e.position[1]):e.event?(n=e.event.clientX,o=e.event.clientY):(n+=this.canvas.width*.5,o+=this.canvas.height*.5),s.style.left=n+"px",s.style.top=o+"px",this.canvas.parentNode.appendChild(s),e.checkForInput){var a=s.querySelectorAll("input"),l=!1;a&&a.forEach(function(g){g.addEventListener("keydown",function(c){if(s.modified(),c.keyCode==27)s.close();else if(c.keyCode!=13)return;c.preventDefault(),c.stopPropagation()}),l||g.focus()})}s.modified=function(){s.is_modified=!0},s.close=function(){s.parentNode&&s.parentNode.removeChild(s)};var u=null,d=0;s.addEventListener("mouseleave",function(g){d||(e.closeOnLeave||h.dialog_close_on_mouse_leave)&&!s.is_modified&&h.dialog_close_on_mouse_leave&&g.buttons===0&&(u=setTimeout(s.close,h.dialog_close_on_mouse_leave_delay))}),s.addEventListener("mouseenter",function(g){(e.closeOnLeave||h.dialog_close_on_mouse_leave)&&u&&clearTimeout(u)});var p=s.querySelectorAll("select");return p&&p.forEach(function(g){g.addEventListener("click",function(c){d++}),g.addEventListener("blur",function(c){d=0}),g.addEventListener("change",function(c){d=-1})}),s}getCanvasMenuOptions(){var t=null;if(this.getMenuOptions?t=this.getMenuOptions(this):(t=[{content:"Add Node",has_submenu:!0,callback:O.onMenuAdd},{content:"Add Group",callback:O.onGroupAdd}],this._graph_stack&&this._graph_stack.length>0&&t.push(it.SEPARATOR,{content:"Close subgraph",callback:this.closeSubgraph.bind(this)})),this.getExtraMenuOptions){var e=this.getExtraMenuOptions(this,t);e&&(t=t.concat(e))}return t}getNodeMenuOptions(t){let e=[];t.getMenuOptions?e=t.getMenuOptions(this):(e=[{content:"Inputs",has_submenu:!0,disabled:!0,callback:O.showMenuNodeOptionalInputs},{content:"Outputs",has_submenu:!0,disabled:!0,callback:O.showMenuNodeOptionalOutputs},it.SEPARATOR,{content:"Properties",has_submenu:!0,disabled:h.ignore_all_widget_events,callback:O.onShowMenuNodeProperties},it.SEPARATOR,{content:"Title",value:{name:"title",type:"string"},callback:O.onShowPropertyEditor},{content:"Mode",has_submenu:!0,callback:O.onMenuNodeMode}],t.resizable!==!1&&e.push({content:"Resize",callback:O.onMenuResizeNode}),e.push({content:"Collapse",callback:O.onMenuNodeCollapse},{content:"Pin",callback:O.onMenuNodePin},{content:"Colors",has_submenu:!0,callback:O.onMenuNodeColors},{content:"Shapes",has_submenu:!0,callback:O.onMenuNodeShapes},it.SEPARATOR));const s=t.getOptionalSlots();if(s&&(s.inputs&&s.inputs.length>0&&typeof e[0]=="object"&&(e[0].disabled=!1),s.outputs&&s.outputs.length&&typeof e[1]=="object"&&(e[1].disabled=!1)),t.getExtraMenuOptions){var i=t.getExtraMenuOptions(this,e);i&&(i.push(it.SEPARATOR),e=i.concat(e))}t.clonable!==!1&&e.push({content:"Clone",callback:O.onMenuNodeClone}),e.push({content:"To Subgraph",callback:O.onMenuNodeToSubgraph});let n=Object.values(this.selected_nodes||{});if(n.length||(n=[t]),n=n.filter(o=>!o.is(lt)&&!o.is(dt)),e.push({content:"To Parent Graph",disabled:!t.graph._is_subgraph||n.length===0,callback:O.onMenuNodeToParentGraph}),t.graph._is_subgraph){const o=d=>{let p=0;const g=ie(d,c=>c.id);for(const c of d)for(const b of c.iterateAllLinks()){if(g[b.origin_id]==null)return 0;g[b.target_id]==null&&(p+=1)}return p},a=d=>{let p=0;const g=ie(d,c=>c.id);for(const c of d)for(const b of c.iterateAllLinks())if(g[b.origin_id]==null)p+=1;else if(g[b.target_id]==null)return 0;return p},l=o(n);e.push({content:"To Subgraph Input"+(l>1?"s":""),disabled:l===0,callback:O.onMenuNodeToSubgraphInputs});const u=a(n);e.push({content:"To Subgraph Output"+(u>1?"s":""),disabled:u===0,callback:O.onMenuNodeToSubgraphOutputs})}return e.push(it.SEPARATOR,{content:"Remove",disabled:!(t.removable!==!1&&!t.block_delete),callback:O.onMenuNodeRemove}),t.graph&&t.graph.onGetNodeMenuOptions&&(e=t.graph.onGetNodeMenuOptions(e,t)),e}getGroupMenuOptions(t){var e=[{content:"Title",value:{name:"title",type:"string"},callback:O.onShowPropertyEditor},{content:"Color",has_submenu:!0,callback:O.onMenuNodeColors},{content:"Font size",value:{name:"fontSize",type:"number"},callback:O.onShowPropertyEditor},it.SEPARATOR,{content:"Remove",callback:O.onMenuNodeRemove}];return e}processContextMenu(t,e){var s=O.active_canvas,i=s.getCanvasWindow();let n=e,o=null,a=null,l=null;t!=null&&(l=t.item,t.type==="node"&&(o=t.item),t.type==="link"&&(a=t.item));let u=null;var d={event:n,extra:l};o!=null&&(d.title=o.type);let p=null;o!=null&&(p=o.getSlotInPosition(n.canvasX,n.canvasY),O.active_node=o);const g=m=>{const E=m.slot;o.graph.beforeChange(),E.input?o.removeInput(E.slot):E.output&&o.removeOutput(E.slot),o.graph.afterChange()},c=m=>{var E=m.slot;o.graph.beforeChange(),E.output?o.disconnectOutput(E.slot):E.input&&o.disconnectInput(E.slot),o.graph.afterChange()},b=m=>{var E=m.slot,T=E.input?o.getInputInfo(E.slot):o.getOutputInfo(E.slot),v=this.createDialog("<span class='name'>Name</span><input autofocus type='text'/><button>OK</button>",d),N=v.querySelector("input");N&&T&&(N.value=T.label||"");var I=()=>{o.graph.beforeChange(),N.value&&(T&&(T.label=N.value),this.setDirty(!0)),v.close(),o.graph.afterChange()};v.querySelector("button").addEventListener("click",I),N.addEventListener("keydown",function(S){if(v.is_modified=!0,S.keyCode==27)v.close();else if(S.keyCode==13)I();else if(S.keyCode!=13&&S.target instanceof Element&&S.target.localName!="textarea")return;S.preventDefault(),S.stopPropagation()}),N.focus()};if(p){if(u=[],o.getSlotMenuOptions)u=o.getSlotMenuOptions(p);else{p&&p.output&&p.output.links&&p.output.links.length&&u.push({content:"Disconnect Links",slot:p,callback:c});var f=p.input||p.output;f.removable&&u.push(f.locked?"Cannot remove":{content:"Remove Slot",slot:p,callback:g}),f.nameLocked||u.push({content:"Rename Slot",slot:p,callback:b})}const m=(p.input?p.input.type:p.output.type)||"*";d.title=ot(m)}else if(o)u=this.getNodeMenuOptions(o);else if(a)u=this.getLinkMenuOptions(a);else{u=this.getCanvasMenuOptions();var _=this.graph.getGroupOnPos(n.canvasX,n.canvasY);_&&u.push(it.SEPARATOR,{content:"Edit Group",has_submenu:!0,submenu:{title:"Group",extra:_,options:this.getGroupMenuOptions(_)}})}u&&new tt(u,d,i)}createPanel(t,e={}){var s=e.window||window,i=document.createElement("div");if(i.className="litegraph dialog",i.innerHTML=`
<div class='dialog-header'><span class='dialog-title'></span></div>
<div class='dialog-content'></div>
<div style='display:none;' class='dialog-alt-content'></div>
<div class='dialog-footer'></div>`,i.header=i.querySelector(".dialog-header"),e.width&&(i.style.width=e.width+(e.width.constructor===Number?"px":"")),e.height&&(i.style.height=e.height+(e.height.constructor===Number?"px":"")),e.closable){var n=document.createElement("span");n.innerHTML="&#10005;",n.classList.add("close"),n.addEventListener("click",function(){i.close()}),i.header.appendChild(n)}return e.onOpen&&(i.onOpen=e.onOpen),e.onClose&&(i.onClose=e.onClose),i.title_element=i.querySelector(".dialog-title"),i.title_element.innerText=t,i.content=i.querySelector(".dialog-content"),i.alt_content=i.querySelector(".dialog-alt-content"),i.footer=i.querySelector(".dialog-footer"),i.close=function(){i.onClose&&typeof i.onClose=="function"&&i.onClose(),i.parentNode&&i.parentNode.removeChild(i),this.parentNode&&this.parentNode.removeChild(this)},i.toggleAltContent=function(o=!1){if(typeof o<"u")var a=o?"block":"none",l=o?"none":"block";else var a=i.alt_content.style.display!="block"?"block":"none",l=i.alt_content.style.display!="block"?"none":"block";i.alt_content.style.display=a,i.content.style.display=l},i.toggleFooterVisibility=function(o=!1){if(typeof o<"u")var a=o?"block":"none";else var a=i.footer.style.display!="block"?"block":"none";i.footer.style.display=a},i.clear=function(){this.content.innerHTML=""},i.addHTML=function(o,a,l){var u=document.createElement("div");return a&&(u.className=a),u.innerHTML=o,l?i.footer.appendChild(u):i.content.appendChild(u),u},i.addButton=function(o,a,l){var u=document.createElement("button");return u.innerText=o,u.options=l,u.classList.add("btn"),u.addEventListener("click",a),i.footer.appendChild(u),u},i.addSeparator=function(){var o=document.createElement("div");return o.className="separator",i.content.appendChild(o),o},i.addWidget=function(o,a,l,u={},d){var p=String(l);o=o.toLowerCase(),o=="number"&&(p=l.toFixed(3));var g=document.createElement("div");g.className="property",g.innerHTML="<span class='property_name'></span><span class='property_value'></span>";let c=g.querySelector(".property_name");c.innerText=u.label||a;var b=g.querySelector(".property_value");if(b.innerText=p,g.dataset.property=a,g.dataset.type=u.type||o,g.options=u,g.value=l,o=="code")g.addEventListener("click",function(_){i.inner_showCodePad(this.dataset.property)});else if(o=="boolean")g.classList.add("boolean"),l&&g.classList.add("bool-on"),g.addEventListener("click",function(){var _=this.dataset.property;this.value=!this.value,this.classList.toggle("bool-on");const m=this.querySelector(".property_value");m.innerText=this.value?"true":"false",f(_,this.value)});else if(o=="string"||o=="number")b.setAttribute("contenteditable","true"),b.addEventListener("keydown",function(_){_.code=="Enter"&&(o!="string"||!_.shiftKey)&&(_.preventDefault(),this.blur())}),b.addEventListener("blur",function(){let _=this.innerText;const m=this.parentNode;var E=m.dataset.property,T=m.dataset.type;T=="number"&&(_=Number(_)),f(E,_)});else if((o=="enum"||o=="combo")&&"values"in u){var p=O.getPropertyPrintableValue(l,u.values);b.innerText=p,b.addEventListener("click",function(m){let E=u.values||[];typeof E=="function"&&(console.error("Values by callback not supported in panel.addWidget!",E),E=[]);var v=this.parentNode.dataset.property,N=this;let I=Array.from(E).map(F=>({content:F}));new tt(I,{event:m,className:"dark",callback:S},s);function S(F,x,z){return N.innerText=F.content,f(v,F.content),!1}})}i.content.appendChild(g);function f(_,m){u.callback&&u.callback(_,m,u),d&&d(_,m,u)}return g},i.onOpen&&typeof i.onOpen=="function"&&i.onOpen(),i}checkPanels(){if(this.canvas)for(var t=this.canvas.parentNode.querySelectorAll(".litegraph.dialog"),e=0;e<t.length;++e){var s=t[e];if(s.node&&(s.node.graph||s.close(),s.node.graph!=this.graph)){if(s.node.is(re)&&this.graph._is_subgraph&&this.graph===s.node.subgraph)continue;s.close()}}}closePanels(){var t=document.querySelector("#node-panel");t&&t.close();var t=document.querySelector("#option-panel");t&&t.close()}}w.onShowPropertyEditor=function(r,t,e,s,i){var n=r.value,o=n.name,a=i[o],l=document.createElement("div");l.is_modified=!1,l.className="graphdialog",l.innerHTML="<span class='name'></span><input autofocus type='text' class='value'/><button>OK</button>",l.close=function(){l.parentNode&&l.parentNode.removeChild(l)};var u=l.querySelector(".name");u.innerText=o;var d=l.querySelector(".value");if(d&&(d.value=a,d.addEventListener("blur",function(v){this.focus()}),d.addEventListener("keydown",function(v){if(l.is_modified=!0,v.keyCode==27)l.close();else if(v.keyCode==13)_();else if(v.keyCode!=13&&v.target instanceof Element&&v.target.localName!="textarea")return;v.preventDefault(),v.stopPropagation()}),n.inputStyle))for(const[v,N]of Object.entries(n.inputStyle))d.style[v]=N;var p=O.active_canvas,g=p.canvas,c=g.getBoundingClientRect(),b=-20,f=-20;c&&(b-=c.left,f-=c.top),e?(l.style.left=e.clientX+b+"px",l.style.top=e.clientY+f+"px"):(l.style.left=g.width*.5+b+"px",l.style.top=g.height*.5+f+"px");const _=()=>{d&&m(d.value)},m=v=>{n.type=="number"?v=Number(v):n.type=="boolean"&&(v=!!v);const N=i[o];i[o]=v,i.onJSPropertyChanged&&i.onJSPropertyChanged(o,v,N)===!1&&(i[o]=N),l.parentNode&&l.parentNode.removeChild(l),i.setDirtyCanvas(!0,!0)};var E=l.querySelector("button");E.addEventListener("click",_),g.parentNode.appendChild(l),d&&d.focus();var T=null;l.addEventListener("mouseleave",function(v){h.dialog_close_on_mouse_leave&&!l.is_modified&&h.dialog_close_on_mouse_leave&&v.buttons===0&&(T=setTimeout(l.close,h.dialog_close_on_mouse_leave_delay))}),l.addEventListener("mouseenter",function(v){h.dialog_close_on_mouse_leave&&T&&clearTimeout(T)}),Le(l)};w.onGroupAdd=function(r,t,e,s){var i=O.active_canvas;i.getCanvasWindow();var n=new ne;n.pos=i.convertEventToCanvasOffset(e),i.graph.addGroup(n)};w.onMenuAdd=function(r,t,e,s,i){var n=O.active_canvas,o=n.getCanvasWindow(),a=n.graph;if(!a)return;function l(u,d){var p=h.getNodeTypesCategories(n.filter||a.filter).filter(function(b){return b.startsWith(u)}),g=[];p.map(function(b){if(b){var f=new RegExp("^("+u+")"),_=b.replace(f,"").split("/")[0],m=u===""?_+"/":u+_+"/",E=_;E.indexOf("::")!=-1&&(E=E.split("::")[1]);var T=g.findIndex(function(v){return v.value===m});T===-1&&g.push({value:m,content:E,has_submenu:!0,callback:function(v,N,I,S){l(v.value,S)}})}});var c=h.getNodeTypesInCategory(u.slice(0,-1),n.filter||a.filter);c.map(function(b){if(!b.hide_in_node_lists){var f={value:b.class,content:b.title,has_submenu:!1,callback:function(_,m,E,T){var v=T.getFirstEvent();n.graph.beforeChange();var N=h.createNode(_.value);N&&(N.pos=n.convertEventToCanvasOffset(v),n.graph.add(N)),i&&i(N),n.graph.afterChange()}};g.push(f)}}),new tt(g,{event:e,parentMenu:d},o)}return l("",s),!1};w.showMenuNodeOptionalInputs=function(r,t,e,s,i){if(!i)return;var n=this,o=O.active_canvas,a=o.getCanvasWindow();let l=i.getOptionalSlots().inputs,u=[];if(l)for(let c=0;c<l.length;c++){let b=l[c];if(!b){u.push(it.SEPARATOR);continue}let{name:f,type:_,options:m}=b;m||(m={}),m.label&&(f=m.label),m.removable=!0;var d={content:f,value:b};_==y.ACTION&&(d.className="event"),u.push(d)}if(i.onMenuNodeInputs){var p=i.onMenuNodeInputs(u);p&&(u=p)}if(!u.length){console.log("no input entries");return}new tt(u,{event:e,callback:g,parentMenu:s,node:i},a);function g(c,b,f,_){if(i&&(c.callback&&c.callback.call(n,i,c,f,_),c.value)){let m=c.value;i.graph.beforeChange(),i.addInput(m.name,m.type,m.options),i.onNodeOptionalInputAdd&&i.onNodeOptionalInputAdd(c.value),i.setDirtyCanvas(!0,!0),i.graph.afterChange()}}return!1};w.showMenuNodeOptionalOutputs=function(r,t,e,s,i){if(!i)return;var n=this,o=O.active_canvas,a=o.getCanvasWindow(),l=i.getOptionalSlots().outputs,u=[];if(l)for(var d=0;d<l.length;d++){var p=l[d];if(!p){u.push(it.SEPARATOR);continue}let{name:f,type:_,options:m}=p;if(!(i.flags&&i.flags.skip_repeated_outputs&&i.findOutputSlotIndexByName(p[0])!=-1)){m||(m={}),m.label&&(f=m.label),m.removable=!0;var g={content:f,value:[f,_,m]};_==y.EVENT&&(g.className="event"),u.push(g)}}if(this.onMenuNodeOutputs&&(u=this.onMenuNodeOutputs(u)),h.do_add_triggers_slots&&i.findOutputSlotIndexByName("onExecuted")==-1&&u.push({content:"On Executed",value:["onExecuted",y.EVENT,{nameLocked:!0}],className:"event"}),i.onMenuNodeOutputs){var c=i.onMenuNodeOutputs(u);c&&(u=c)}if(!u.length)return;let b=function(f,_,m,E){if(i&&(f.callback&&f.callback.call(n,i,f,m,E),!!f.value)){var T=f.value[1];if(T&&(T.constructor===Object||T.constructor===Array)){var v=[];for(var N in T)v.push({content:N,value:T[N]});return new tt(v,{event:m,callback:b,parentMenu:s,node:i}),!1}else{const I=f.value;i.graph.beforeChange(),i.addOutput(I.name,I.type,I.options),i.onNodeOptionalOutputAdd&&i.onNodeOptionalOutputAdd(f.value),i.setDirtyCanvas(!0,!0),i.graph.afterChange()}}};return new tt(u,{event:e,callback:b,parentMenu:s,node:i},a),!1};w.onMenuResizeNode=function(r,t,e,s,i){if(i){var n=function(l){l.size=l.computeSize(),l.onResize&&l.onResize(l.size)},o=O.active_canvas;if(!o.selected_nodes||Object.keys(o.selected_nodes).length<=1)n(i);else for(var a in o.selected_nodes)n(o.selected_nodes[a]);i.setDirtyCanvas(!0,!0)}};w.onShowMenuNodeProperties=function(r,t,e,s,i){if(!i||!i.properties)return;var n=O.active_canvas,o=n.getCanvasWindow(),a=[];for(var l in i.properties){var u=i.properties[l]!==void 0?i.properties[l]:" ";typeof u=="object"&&(u=JSON.stringify(u));var d=i.getPropertyInfo(l);(d.type=="enum"||d.type=="combo")&&(u=O.getPropertyPrintableValue(u,d.values)),u=O.decodeHTML(u),a.push({content:"<span class='property_name'>"+(d.label?d.label:l)+"</span><span class='property_value'>"+u+"</span>",value:l})}if(!a.length)return;new tt(a,{event:e,callback:p,parentMenu:s,allow_html:!0,node:i},o);function p(g,c,b,f){if(i){var _=this.getBoundingClientRect();n.showEditPropertyValue(i,g.value,{position:[_.left,_.top]})}}return!1};w.onResizeNode=function(r,t,e,s,i){i&&(i.size=i.computeSize(),i.setDirtyCanvas(!0,!0))};w.onMenuNodeCollapse=function(r,t,e,s,i){i.graph.beforeChange();var n=function(l){l.collapse()},o=O.active_canvas;if(!o.selected_nodes||Object.keys(o.selected_nodes).length<=1)n(i);else for(var a in o.selected_nodes)n(o.selected_nodes[a]);i.graph.afterChange()};w.onMenuNodePin=function(r,t,e,s,i){i.pin()};w.onMenuNodeMode=function(r,t,e,s,i){let n=Array.from(St).map(a=>({content:a}));new tt(n,{event:e,callback:o,parentMenu:s,node:i});function o(a){if(i){var l=Object.values(St).indexOf(a.content),u=function(g){l>=nt.ALWAYS&&St[l]?g.changeMode(l):(console.warn("unexpected mode: "+a),g.changeMode(nt.ALWAYS))},d=O.active_canvas;if(!d.selected_nodes||Object.keys(d.selected_nodes).length<=1)u(i);else for(var p in d.selected_nodes)u(d.selected_nodes[p])}}return!1};w.onMenuNodeColors=function(r,t,e,s,i){if(!i)throw"no node for color";var n=[];n.push({value:null,content:"<span style='display: block; padding-left: 4px;'>No color</span>"});for(let l in O.node_colors){var o=O.node_colors[l];let u={value:l,content:"<span style='display: block; color: #999; padding-left: 4px; border-left: 8px solid "+o.color+"; background-color:"+o.bgcolor+"'>"+l+"</span>"};n.push(u)}new tt(n,{event:e,callback:a,parentMenu:s,node:i,allow_html:!0});function a(l){if(i){var u=l.value?O.node_colors[l.value]:null,d=function(c){u?c instanceof ne?c.color=u.groupcolor:(c.color=u.color,c.bgcolor=u.bgcolor):(delete c.color,c instanceof C&&delete c.bgcolor)},p=O.active_canvas;if(!p.selected_nodes||Object.keys(p.selected_nodes).length<=1)d(i);else for(var g in p.selected_nodes)d(p.selected_nodes[g]);i.setDirtyCanvas(!0,!0)}}return!1};w.onMenuNodeShapes=function(r,t,e,s,i){if(!i)throw"no node passed";const n=Array.from($e).map(a=>({content:a}));new tt(n,{event:e,callback:o,parentMenu:s,node:i});function o(a){if(i){i.graph.beforeChange();var l=function(p){p.shape=$e.indexOf(a.content)},u=O.active_canvas;if(!u.selected_nodes||Object.keys(u.selected_nodes).length<=1)l(i);else for(var d in u.selected_nodes)l(u.selected_nodes[d]);i.graph.afterChange(),i.setDirtyCanvas(!0)}}return!1};w.onMenuNodeRemove=function(r,t,e,s,i){if(!i)throw"no node passed";var n=i.graph;n.beforeChange();var o=function(u){u.removable!==!1&&n.remove(u)},a=O.active_canvas;if(!a.selected_nodes||Object.keys(a.selected_nodes).length<=1)o(i);else for(var l in a.selected_nodes)o(a.selected_nodes[l]);n.afterChange(),i.setDirtyCanvas(!0,!0)};w.onMenuNodeToSubgraph=function(r,t,e,s,i){var n=i.graph,o=O.active_canvas;if(o){var a=Object.values(o.selected_nodes||{});a.length||(a=[i]);var l=h.createNode("graph/subgraph",null,{constructorArgs:[null]});l.pos=i.pos.concat(),n.add(l),l.buildFromNodes(a),o.deselectAllNodes(),i.setDirtyCanvas(!0,!0)}};w.onMenuNodeToSubgraphInputs=function(r,t,e,s,i){var n=O.active_canvas;if(!n)return;const o=i.graph._subgraph_node;if(!i.graph._is_subgraph||!o){console.error("[To Subgraph Inputs] Current graph is not a subgraph!",i.graph);return}let a=Object.values(n.selected_nodes||{});a.length||(a=[i]),o.convertNodesToSubgraphInputs(a),n.deselectAllNodes(),i.setDirtyCanvas(!0,!0)};w.onMenuNodeToSubgraphOutputs=function(r,t,e,s,i){var n=O.active_canvas;if(!n)return;const o=i.graph._subgraph_node;if(!i.graph._is_subgraph||!o){console.error("[To Subgraph Outputs] Current graph is not a subgraph!",i.graph);return}let a=Object.values(n.selected_nodes||{});a.length||(a=[i]),o.convertNodesToSubgraphOutputs(a),n.deselectAllNodes(),i.setDirtyCanvas(!0,!0)};w.onMenuNodeToParentGraph=function(r,t,e,s,i){var n=O.active_canvas;if(!n)return;const o=i.graph._subgraph_node;if(!i.graph._is_subgraph||!o){console.error("[To Parent Graph] Current graph is not a subgraph!",i.graph);return}let a=Object.values(n.selected_nodes||{});a.length||(a=[i]),o.moveNodesToParentGraph(a),n.deselectAllNodes(),i.setDirtyCanvas(!0,!0)};w.onMenuNodeClone=function(r,t,e,s,i){var n=O.active_canvas;(!n.selected_nodes||Object.keys(n.selected_nodes).length<=1)&&n.selectNode(i),n.cloneSelection()};const W=class Vt{constructor(t,e,s={}){this.link_type_colors={},this.node_panel=null,this.options_panel=null,this.render_time=0,this.allow_dragcanvas=!0,this.allow_dragnodes=!0,this.allow_interaction=!0,this.allow_reconnect_links=!0,this.allow_searchbox=!0,this.always_render_background=!1,this.background_image=Vt.DEFAULT_BACKGROUND_IMAGE,this.block_click=!1,this.clear_background=!0,this.connecting_pos=null,this.connecting_slot=null,this.connecting_input=null,this.connecting_output=null,this.connections_width=3,this.current_node=null,this.drag_mode=!1,this.dragging_rectangle=null,this.ds=new ei,this.editor_alpha=1,this.filter=null,this.highquality_render=!0,this.skip_events=!1,this.last_mouse_position=[0,0],this.last_click_position=[0,0],this.last_click_position_offset=[0,0],this.last_mouse_dragging=!1,this.links_render_mode=qt.SPLINE_LINK,this.live_mode=!1,this.mouse=[0,0],this.offset_mouse=[0,0],this.graph_mouse=[0,0],this.node_widget=null,this.maxZoom=null,this.minZoom=null,this.multi_select=!1,this.over_link_center=null,this.pause_rendering=!1,this.read_only=!1,this.render_canvas_border=!0,this.render_collapsed_slots=!0,this.render_connection_arrows=!1,this.render_connections_border=!0,this.render_connections_shadows=!1,this.render_connections=!0,this.render_curved_connections=!1,this.render_execution_order=!1,this.render_link_tooltip=!0,this.render_only_selected=!0,this.render_shadows=!0,this.render_title_colored=!0,this.render_subgraph_panels=!0,this.render_subgraph_stack_header=!0,this.round_radius=8,this.set_canvas_dirty_on_mouse_event=!0,this.show_info=!0,this.use_gradients=!1,this.visible_links=[],this.zoom_modify_alpha=!0,this.pointer_is_down=!1,this.pointer_is_double=!1,this._highlight_input=null,this._highlight_input_slot=null,this._highlight_output=null,this._graph_stack=[],this._bg_img=null,this._pattern=null,this._pattern_img=null,this.search_box=null,this.prompt_box=null,this._events_binded=!1,this.resizing_node=null,typeof t=="string"&&(t=document.querySelector(t)),this.skip_events=s.skip_events||!1,this.title_text_font=""+h.NODE_TEXT_SIZE+"px Arial",this.inner_text_font="normal "+h.NODE_SUBTEXT_SIZE+"px Arial",this.node_title_color=h.NODE_TITLE_COLOR,this.default_link_color=h.LINK_COLOR,this.link_type_colors=h.cloneObject(Vt.DEFAULT_LINK_TYPE_COLORS),this.canvas_mouse=this.graph_mouse,this.visible_area=this.ds.visible_area,this.viewport=s.viewport||null,e&&e.attachCanvas(this),this.setCanvas(t,s.skip_events),this.clear(),s.skip_render||this.startRendering(),this.autoresize=s.autoresize}static getFileExtension(t){var e=t.indexOf("?");e!=-1&&(t=t.substr(0,e));var s=t.lastIndexOf(".");return s==-1?"":t.substr(s+1).toLowerCase()}static decodeHTML(t){var e=document.createElement("div");return e.innerText=t,e.innerHTML}static getPropertyPrintableValue(t,e){if(!e||e.constructor===Array)return String(t);if(e.constructor===Object){var s="";for(var i in e)if(e[i]==t){s=i;break}return String(t)+" ("+s+")"}}get scale(){return this.ds.scale}set scale(t){this.ds.scale=t}clear(){this.frame=0,this.last_draw_time=0,this.render_time=0,this.fps=0,this.dragging_rectangle=null,this.selected_nodes={},this.selected_group=null,this.visible_nodes=[],this.node_dragged=null,this.node_over=null,this.node_capturing_input=null,this.connecting_node=null,this.highlighted_links={},this.dragging_canvas=!1,this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.dirty_area=null,this.node_in_panel=null,this.node_widget=null,this.last_mouse=[0,0],this.last_mouseclick=0,this.pointer_is_down=!1,this.pointer_is_double=!1,this.onClear&&this.onClear()}setGraph(t,e=!1){if(this.graph!=t){if(e||this.clear(),!t&&this.graph){this.graph.detachCanvas(this);return}t.attachCanvas(this),this._graph_stack&&(this._graph_stack=null),this.setDirty(!0,!0)}}openSubgraph(t){if(!t)throw"graph cannot be null";if(this.graph==t)throw"graph cannot be the same";if(this.clear(),this.graph){this._graph_stack||(this._graph_stack=[]);const s=[this.ds.offset[0],this.ds.offset[1]];this._graph_stack.push({graph:this.graph,offset:s,scale:this.ds.scale})}h.debug&&(console.warn("SubGraph opened",t),console.warn("Graph inputs",t.inputs),console.warn("Graph outputs",t.outputs)),t.attachCanvas(this);const e=[0,0];if(t._nodes.length>0){let s=Number.MAX_SAFE_INTEGER,i=0,n=Number.MAX_SAFE_INTEGER,o=0;for(const a of t.iterateNodesInOrder())s=Math.min(a.pos[0],s),i=Math.max(a.pos[0]+a.size[0],i),n=Math.min(a.pos[1],n),o=Math.max(a.pos[1]+a.size[1],o);e[0]=-(s+(i-s)/2)+this.canvas.width/2,e[1]=-(n+(o-n)/2)+this.canvas.height/2}this.ds.offset=e,this.ds.scale=1,this.checkPanels(),this.setDirty(!0,!0)}closeAllSubgraphs(){for(;this._graph_stack&&this._graph_stack.length>0;)this.closeSubgraph()}closeSubgraph(){if(!(!this._graph_stack||this._graph_stack.length==0)){var t=this.graph._subgraph_node,{graph:e,offset:s,scale:i}=this._graph_stack.pop();this.selected_nodes={},this.highlighted_links={},e.attachCanvas(this),this.setDirty(!0,!0),t&&(this.centerOnNode(t),this.selectNodes([t])),this.ds.offset=s,this.ds.scale=i}}setCanvas(t,e=!1){if(t&&typeof t=="string"&&(t=document.getElementById(t),!t))throw"Error creating LiteGraph canvas: Canvas not found";if(t=t,t!==this.canvas&&(!t&&this.canvas&&(e||this.unbindEvents()),this.canvas=t,this.ds.element=t,!!t)){if(t.className+=" lgraphcanvas",t.data=this,t.tabIndex=1,this.bgcanvas=null,this.bgcanvas||(this.bgcanvas=document.createElement("canvas"),this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height),t.getContext==null)throw t.localName!="canvas"?"Element supplied for LGraphCanvas must be a <canvas> element, you passed a "+t.localName:"This browser doesn't support Canvas";e||this.bindEvents(),this.adjustCanvasForHiDPI()}}_doNothing(t){return t.preventDefault(),!1}_doReturnTrue(t){return t.preventDefault(),!0}bindEvents(){if(this._events_binded){console.warn("LGraphCanvas: events already binded");return}var t=this.canvas,e=this.getCanvasWindow(),s=e.document;this._mousedown_callback=this.processMouseDown.bind(this),this._mousewheel_callback=this.processMouseWheel.bind(this),this._mousemove_callback=this.processMouseMove.bind(this),this._mouseup_callback=this.processMouseUp.bind(this),h.pointerListenerAdd(t,"down",this._mousedown_callback,!0),t.addEventListener("mousewheel",this._mousewheel_callback,!1),h.pointerListenerAdd(t,"up",this._mouseup_callback,!0),h.pointerListenerAdd(t,"move",this._mousemove_callback),t.addEventListener("contextmenu",this._doNothing),t.addEventListener("DOMMouseScroll",this._mousewheel_callback,!1),this._key_callback=this.processKey.bind(this),t.addEventListener("keydown",this._key_callback,!0),s.addEventListener("keyup",this._key_callback,!0),this._ondrop_callback=this.processDrop.bind(this),t.addEventListener("dragover",this._doNothing,!1),t.addEventListener("dragend",this._doNothing,!1),t.addEventListener("drop",this._ondrop_callback,!1),t.addEventListener("dragenter",this._doReturnTrue,!1),this._events_binded=!0}unbindEvents(){if(!this._events_binded){console.warn("LGraphCanvas: no events binded");return}h.debug&&console.log("pointerevents: unbindEvents");var t=this.getCanvasWindow(),e=t.document;h.pointerListenerRemove(this.canvas,"move",this._mousedown_callback),h.pointerListenerRemove(this.canvas,"up",this._mousedown_callback),h.pointerListenerRemove(this.canvas,"down",this._mousedown_callback),this.canvas.removeEventListener("mousewheel",this._mousewheel_callback),this.canvas.removeEventListener("DOMMouseScroll",this._mousewheel_callback),this.canvas.removeEventListener("keydown",this._key_callback),e.removeEventListener("keyup",this._key_callback),this.canvas.removeEventListener("contextmenu",this._doNothing),this.canvas.removeEventListener("drop",this._ondrop_callback),this.canvas.removeEventListener("dragenter",this._doReturnTrue),this._mousedown_callback=null,this._mousewheel_callback=null,this._key_callback=null,this._ondrop_callback=null,this._events_binded=!1}enableWebGL(){}setDirty(t=!1,e=!1){t&&(this.dirty_canvas=!0),e&&(this.dirty_bgcanvas=!0)}getCanvasWindow(){if(!this.canvas)return window;var t=this.canvas.ownerDocument;return t.defaultView}adjustCanvasForHiDPI(t){if(t||(t=window.devicePixelRatio),t==1||!this.canvas.parentNode)return;const e=this.canvas.parentNode.getBoundingClientRect(),{width:s,height:i}=e;this.canvas.width=s*t,this.canvas.height=i*t,this.canvas.style.width=s+"px",this.canvas.style.height=i+"px",this.canvas.getContext("2d").scale(t,t)}startRendering(){if(this.is_rendering)return;this.is_rendering=!0,t.call(this);function t(){this.pause_rendering||this.draw();var e=this.getCanvasWindow();this.is_rendering&&e.requestAnimationFrame(t.bind(this))}}stopRendering(){this.is_rendering=!1}blockClick(){this.block_click=!0,this.last_mouseclick=0}createDefaultNodeForSlot(t,e={}){var s=this,i=e.nodeFrom&&e.slotFrom!==null,n=!i&&e.nodeTo&&e.slotTo!==null;if(e={...{position:[0,0],posAdd:[0,0],posSizeFix:[0,0]},...e},!i&&!n)return console.warn("No data passed to createDefaultNodeForSlot "+e.nodeFrom+" "+e.slotFrom+" "+e.nodeTo+" "+e.slotTo),!1;if(!t)return console.warn("No type to createDefaultNodeForSlot"),!1;var a=i?e.nodeFrom:e.nodeTo,l=i?e.slotFrom:e.slotTo,u=null;switch(typeof l){case"string":u=i?a.findOutputSlotIndexByName(l):a.findInputSlotIndexByName(l),l=i?a.outputs[l]:a.inputs[l];break;case"object":u=i?a.findOutputSlotIndexByName(l.name):a.findInputSlotIndexByName(l.name);break;case"number":u=l,l=i?a.outputs[l]:a.inputs[l];break;case"undefined":default:return console.warn("Cant get slot information "+l),!1}l=l,(!l||!u)&&console.warn("createDefaultNodeForSlot bad slotX "+l+" "+u);var d=l.type==y.EVENT?"_event_":l.type,p=i?h.slot_types_default_out:h.slot_types_default_in;const g=p[d];if(p&&g){l.link!==null||l.links&&l.links.length>0;let m=null;if(Array.isArray(g)){for(var c in g)if(t==p[d][c]||t=="AUTO"){m=p[d][c],h.debug&&console.log("opts.nodeType == slotTypesDefault[fromSlotType][typeX] :: "+t);break}}else throw new Error(`Invalid default slot specifier, must be an array: ${g}`);if(m){var b=null;typeof m=="object"&&m.node&&(b=m,m=m.node);var f=h.createNode(m);if(f){if(b){if(b.properties)for(var _ in b.properties)f.addProperty(_,b.properties[_]);if(b.inputs){f.inputs=[];for(var _ in b.inputs)f.addOutput(b.inputs[_][0],b.inputs[_][1])}if(b.outputs){f.outputs=[];for(var _ in b.outputs)f.addOutput(b.outputs[_][0],b.outputs[_][1])}b.title&&(f.title=b.title),b.json&&f.configure(b.json)}console.warn("PLACING",f.type,e);const E=e.position[0]+e.posAdd[0]+(e.posSizeFix[0]?e.posSizeFix[0]*f.size[0]:0),T=e.position[1]+e.posAdd[1]+(e.posSizeFix[1]?e.posSizeFix[1]*f.size[1]:0),v=[E,T];return s.graph.add(f,{pos:v}),i?e.nodeFrom.connectByTypeInput(u,f,d):e.nodeTo.connectByTypeOutput(u,f,d),i&&n&&console.debug("connecting in between"),!0}else console.log("failed creating "+m)}}return!1}isOverNodeBox(t,e,s){var i=h.NODE_TITLE_HEIGHT;return!!h.isInsideRectangle(e,s,t.pos[0]+2,t.pos[1]+2-i,i-4,i-4)}isOverNodeInput(t,e,s,i){if(t.inputs)for(var n=0,o=t.inputs.length;n<o;++n){var a=t.getConnectionPos(!0,n),l=!1;if(t.horizontal?l=h.isInsideRectangle(e,s,a[0]-5,a[1]-10,10,20):l=h.isInsideRectangle(e,s,a[0]-10,a[1]-5,40,10),l)return i&&(i[0]=a[0],i[1]=a[1]),n}return-1}isOverNodeOutput(t,e,s,i){if(t.outputs)for(var n=0,o=t.outputs.length;n<o;++n){t.outputs[n];var a=t.getConnectionPos(!1,n),l=!1;if(t.horizontal?l=h.isInsideRectangle(e,s,a[0]-5,a[1]-10,10,20):l=h.isInsideRectangle(e,s,a[0]-10,a[1]-5,40,10),l)return i&&(i[0]=a[0],i[1]=a[1]),n}return-1}findLinkCenterAtPos(t,e){for(let s=0;s<this.visible_links.length;++s){const i=this.visible_links[s];if(this.graph&&this.graph.links[i.id]==null)continue;const n=i._pos;if(!(!n||t<n[0]-4||t>n[0]+4||e<n[1]-4||e>n[1]+4))return i}return null}processKey(t){if(!this.graph)return;var e=!1;if(h.debug&&console.log("processKey",t),t.target instanceof Element&&t.target.localName=="input")return;const s=this.allow_interaction&&!this.read_only;if(t.type=="keydown"){if(t.keyCode==32&&!(t.metaKey||t.ctrlKey||t.shiftKey)&&(this.dragging_canvas=!0,e=!0),t.keyCode==27&&!(t.metaKey||t.ctrlKey||t.shiftKey)&&(this.node_panel&&this.node_panel.close(),this.options_panel&&this.options_panel.close(),e=!0),s&&(t.keyCode==65&&t.ctrlKey&&(this.selectNodes(),e=!0),t.code=="KeyX"&&(t.metaKey||t.ctrlKey)&&!t.shiftKey&&this.selected_nodes&&(this.cutToClipboard(),e=!0),t.code=="KeyC"&&(t.metaKey||t.ctrlKey)&&!t.shiftKey&&this.selected_nodes&&(this.copyToClipboard(),e=!0),t.code=="KeyV"&&(t.metaKey||t.ctrlKey)&&!t.shiftKey&&this.pasteFromClipboard(),t.code=="KeyD"&&(t.metaKey||t.ctrlKey)&&!t.shiftKey&&(this.cloneSelection(),e=!0),(t.keyCode==46||t.keyCode==8)&&t.target instanceof Element&&t.target.localName!="input"&&t.target.localName!="textarea"&&(this.deleteSelectedNodes(),e=!0),this.selected_nodes))for(var i in this.selected_nodes)this.selected_nodes[i].onKeyDown&&this.selected_nodes[i].onKeyDown(t)}else if(t.type=="keyup"&&(t.keyCode==32&&(this.dragging_canvas=!1),s&&this.selected_nodes))for(var i in this.selected_nodes)this.selected_nodes[i].onKeyUp&&this.selected_nodes[i].onKeyUp(t);if(this.graph.change(),e)return t.preventDefault(),t.stopImmediatePropagation(),!1}cutToClipboard(){this.copyToClipboard(),this.deleteSelectedNodes()}copyToClipboard(){var t={nodes:[],nodeCloneData:{},links:[]},e=0,s=[];for(var i in this.selected_nodes){var n=this.selected_nodes[i];n._relative_id=e,s.push(n),e+=1}for(let d=0;d<s.length;++d){let p=s[d];if(!p.clonable)continue;const g={forNode:{}};let c=p.clone(g);if(!c){console.warn("node type not found: "+p.type);continue}if(t.nodes.push(c.serialize()),t.nodeCloneData[c.id]={prevNodeID:p.id,cloneData:g},p.inputs&&p.inputs.length)for(var o=0;o<p.inputs.length;++o){var a=p.inputs[o];if(!(!a||a.link==null)){var l=this.graph.links[a.link];if(l){var u=this.graph.getNodeById(l.origin_id);!u||!this.selected_nodes[u.id]||!this.selected_nodes[u.id].clonable||t.links.push([u._relative_id,l.origin_slot,p._relative_id,l.target_slot])}}}}localStorage.setItem("litegrapheditor_clipboard",JSON.stringify(t))}pasteFromClipboard(){var t=localStorage.getItem("litegrapheditor_clipboard");if(t){this.graph.beforeChange();for(var e=JSON.parse(t),s=null,i=null,n=0;n<e.nodes.length;++n)s?(s[0]>e.nodes[n].pos[0]&&(s[0]=e.nodes[n].pos[0],i[0]=n),s[1]>e.nodes[n].pos[1]&&(s[1]=e.nodes[n].pos[1],i[1]=n)):(s=[e.nodes[n].pos[0],e.nodes[n].pos[1]],i=[n,n]);for(var o=[],n=0;n<e.nodes.length;++n){var a=e.nodes[n],l=h.createNode(a.type);if(l){l.configure(a),l.pos[0]+=this.graph_mouse[0]-s[0],l.pos[1]+=this.graph_mouse[1]-s[1];const{cloneData:c,prevNodeID:b}=e.nodeCloneData[l.id];this.graph.add(l,{doProcessChange:!1,addedBy:"paste",prevNodeID:b,cloneData:c}),o.push(l)}}for(var n=0;n<e.links.length;++n){var u=e.links[n],d=o[u[0]],p=o[u[2]];d&&p?d.connect(u[1],p,u[3]):console.warn("Warning, nodes missing on pasting")}this.selectNodes(o),this.graph.afterChange()}}cloneSelection(){if(!this.selected_nodes||Object.keys(this.selected_nodes).length===0)return;this.graph.beforeChange();const t={},e=[],s={};for(const o of Object.values(this.selected_nodes))for(const a of o.iterateAllLinks())this.selected_nodes[a.origin_id]&&this.selected_nodes[a.target_id]&&e.push(a);const i=function(o){if(o.clonable==!1)return;const a=o.id,l={forNode:{}},u=o.clone(l);u&&(s[a]=u,u.pos=[o.pos[0]+5,o.pos[1]+5],o.graph.add(u,{addedBy:"cloneSelection",prevNodeID:a,prevNode:o,cloneData:l}),t[u.id]=u)};for(var n in this.selected_nodes)i(this.selected_nodes[n]);for(const o of e){const a=s[o.origin_id],l=s[o.target_id];a&&l&&a.connect(o.origin_slot,l,o.target_slot)}Object.keys(t).length&&this.selectNodes(Object.values(t)),this.graph.afterChange(),this.setDirty(!0,!0)}processDrop(t){let e=t;e.preventDefault(),this.adjustMouseEvent(e);var s=e.clientX,i=e.clientY,n=!this.viewport||this.viewport&&s>=this.viewport[0]&&s<this.viewport[0]+this.viewport[2]&&i>=this.viewport[1]&&i<this.viewport[1]+this.viewport[3];if(n){var o=[e.canvasX,e.canvasY],a=this.graph?this.graph.getNodeOnPos(o[0],o[1]):null;if(!a){var l=null;this.onDropItem&&(l=this.onDropItem(e)),l||this.checkDropItem(e);return}if(a.onDropFile||a.onDropData){var u=e.dataTransfer.files;if(u&&u.length)for(var d=0;d<u.length;d++){var p=e.dataTransfer.files[0],g=p.name;if(Vt.getFileExtension(g),a.onDropFile&&a.onDropFile(p),a.onDropData){var c=new FileReader;c.onload=function(f){var _=f.target.result;a.onDropData(_,g,p)};var b=p.type.split("/")[0];b=="text"||b==""?c.readAsText(p):b=="image"?c.readAsDataURL(p):c.readAsArrayBuffer(p)}}}return!!(a.onDropItem&&a.onDropItem(e)||this.onDropItem&&this.onDropItem(e))}}checkDropItem(t){let e=t;if(e.dataTransfer.files.length){var s=e.dataTransfer.files[0],i=Vt.getFileExtension(s.name).toLowerCase(),n=h.node_types_by_file_extension[i];if(n){this.graph.beforeChange();var o=h.createNode(n.type);o.pos=[e.canvasX,e.canvasY],this.graph.add(o),o.onDropFile&&o.onDropFile(s),this.graph.afterChange()}}}processNodeDblClicked(t){this.onShowNodePanel?this.onShowNodePanel(t):this.showShowNodePanel(t),this.onNodeDblClicked&&this.onNodeDblClicked(t),this.setDirty(!0)}processNodeSelected(t,e){this.selectNode(t,e&&(e.shiftKey||e.ctrlKey||this.multi_select)),this.onNodeSelected&&this.onNodeSelected(t)}selectNode(t,e=!1){t==null?this.deselectAllNodes():this.selectNodes([t],e)}selectNodes(t,e=!1){e||this.deselectAllNodes(),t=t||this.graph._nodes,typeof t=="string"&&(t=[t]);for(var s in t){var i=t[s];if(i.is_selected){this.deselectNode(i);continue}if(!i.is_selected&&i.onSelected&&i.onSelected(),i.is_selected=!0,this.selected_nodes[i.id]=i,i.inputs)for(var n=0;n<i.inputs.length;++n)this.highlighted_links[i.inputs[n].link]=!0;if(i.outputs)for(var n=0;n<i.outputs.length;++n){var o=i.outputs[n];if(o.links)for(var a=0;a<o.links.length;++a)this.highlighted_links[o.links[a]]=!0}}this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)}deselectNode(t){if(t.is_selected){if(t.onDeselected&&t.onDeselected(),t.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(t),t.inputs)for(var e=0;e<t.inputs.length;++e)delete this.highlighted_links[t.inputs[e].link];if(t.outputs)for(var e=0;e<t.outputs.length;++e){var s=t.outputs[e];if(s.links)for(var i=0;i<s.links.length;++i)delete this.highlighted_links[s.links[i]]}}}deselectAllNodes(){if(this.graph){for(var t=this.graph._nodes,e=0,s=t.length;e<s;++e){var i=t[e];i.is_selected&&(i.onDeselected&&i.onDeselected(),i.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(i))}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)}}deleteSelectedNodes(){this.graph.beforeChange();for(var t in this.selected_nodes){var e=this.selected_nodes[t];if(!e.block_delete){if(e.inputs&&e.inputs.length&&e.outputs&&e.outputs.length&&h.isValidConnection(e.inputs[0].type,e.outputs[0].type)&&e.inputs[0].link&&e.outputs[0].links&&e.outputs[0].links.length){var s=e.graph.links[e.inputs[0].link],i=e.graph.links[e.outputs[0].links[0]],n=e.getInputNode(0),o=e.getOutputNodes(0)[0];n&&o&&n.connect(s.origin_slot,o,i.target_slot)}this.graph.remove(e),this.onNodeDeselected&&this.onNodeDeselected(e)}}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.setDirty(!0),this.graph.afterChange()}centerOnNode(t){this.ds.offset[0]=-t.pos[0]-t.size[0]*.5+this.canvas.width*.5/this.ds.scale,this.ds.offset[1]=-t.pos[1]-t.size[1]*.5+this.canvas.height*.5/this.ds.scale,this.setDirty(!0,!0)}adjustMouseEvent(t){let e=t;var s=0,i=0;if(this.canvas){var n=this.canvas.getBoundingClientRect();s=e.clientX-n.left,i=e.clientY-n.top}else s=e.clientX,i=e.clientY;return this.last_mouse_position[0]=s,this.last_mouse_position[1]=i,e.canvasX=s/this.ds.scale-this.ds.offset[0],e.canvasY=i/this.ds.scale-this.ds.offset[1],e}processNodeWidgets(t,e,s,i){if(!t.widgets||!t.widgets.length||h.ignore_all_widget_events)return null;for(var n=e[0]-t.pos[0],o=e[1]-t.pos[1],a=t.size[0],l=this,u=this.getCanvasWindow(),d=0;d<t.widgets.length;++d){var p=t.widgets[d];if(!(!p||p.disabled)){var g=p.computeSize?p.computeSize(a)[1]:h.NODE_WIDGET_HEIGHT,c=p.width||a;if(!(p!=i&&(n<6||n>c-12||o<p.last_y||o>p.last_y+g||p.last_y===void 0))){var b=p.value;switch(p.type){case"button":s.type===h.pointerevents_method+"down"&&(p.callback&&setTimeout(function(){p.callback(p,l,t,e,s)},20),p.clicked=!0,this.dirty_canvas=!0);break;case"slider":p.options.max-p.options.min;var f=Nt((n-15)/(c-30),0,1);p.value=p.options.min+(p.options.max-p.options.min)*f,p.callback&&setTimeout(function(){N(p,p.value)},20),this.dirty_canvas=!0;break;case"number":case"combo":var b=p.value;if(s.type==h.pointerevents_method+"move"&&p.type=="number")s.deltaX&&(p.value+=s.deltaX*(p.options.step||.1)),p.options.min!=null&&p.value<p.options.min&&(p.value=p.options.min),p.options.max!=null&&p.value>p.options.max&&(p.value=p.options.max);else if(s.type==h.pointerevents_method+"down"){var _=p.options.values;if(_&&typeof _=="function"){let S=p.options.values;_=S(p,t)}var m=null;p.type!="number"&&(m=Array.isArray(_)?_:Object.keys(_));var E=n<40?-1:n>c-40?1:0;if(p.type=="number")p.value+=E*(p.options.step||.1),p.options.min!=null&&p.value<p.options.min&&(p.value=p.options.min),p.options.max!=null&&p.value>p.options.max&&(p.value=p.options.max);else if(E){var T=-1;this.last_mouseclick=0,_.constructor===Object?T=m.indexOf(String(p.value))+E:T=m.indexOf(p.value)+E,T>=m.length&&(T=m.length-1),T<0&&(T=0),Array.isArray(_)?p.value=_[T]:p.value=T}else{let S=function(x,z,Y){let X=x.content;return _!=m&&(X=v.indexOf(X)),this.value=X,N(this,X),l.dirty_canvas=!0,!1};var v=_!=m?Object.values(_):_;let F=Array.from(v).map(x=>({content:x}));new tt(F,{scale:Math.max(1,this.ds.scale),event:s,className:"dark",callback:S.bind(p)},u)}}else if(s.type==h.pointerevents_method+"up"&&p.type=="number"){var E=n<40?-1:n>c-40?1:0;s.click_time<200&&E==0&&this.prompt("Value",p.value,(function(F){this.value=Number(F),N(this,this.value)}).bind(p),s)}b!=p.value&&setTimeout((function(){N(this,this.value)}).bind(p),20),this.dirty_canvas=!0;break;case"toggle":s.type==h.pointerevents_method+"down"&&(p.value=!p.value,setTimeout(function(){N(p,p.value)},20));break;case"string":case"text":s.type==h.pointerevents_method+"down"&&this.prompt("Value",p.value,(function(S){this.value=S,N(this,S)}).bind(p),s,p.options?p.options.multiline:!1,p.options.inputStyle);break;default:p.mouse&&(this.dirty_canvas=p.mouse(s,[n,o],t));break}return b!=p.value&&(t.onWidgetChanged&&t.onWidgetChanged(p,b),t.graph._version++),p}}}function N(I,S){I.value=S,I.options&&I.options.property&&t.properties[I.options.property]!==void 0&&t.setProperty(I.options.property,S),I.callback&&I.callback(I.value,l,t,e,s)}return null}adjustNodesSize(){for(var t=this.graph._nodes,e=0;e<t.length;++e)t[e].size=t[e].computeSize();this.setDirty(!0,!0)}resize(t,e){if(!t&&!e){var s=this.canvas.parentNode;t=s.offsetWidth,e=s.offsetHeight}this.canvas.width==t&&this.canvas.height==e||(this.canvas.width=t,this.canvas.height=e,this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.adjustCanvasForHiDPI(),this.setDirty(!0,!0))}isAreaClicked(t,e,s,i,n){var o=this.offset_mouse;h.isInsideRectangle(o[0],o[1],t,e,s,i),o=this.last_click_position;var a=o&&h.isInsideRectangle(o[0],o[1],t,e,s,i),l=a&&!this.block_click;return a&&n&&this.blockClick(),l}switchLiveMode(t){if(!t){this.live_mode=!this.live_mode,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;return}var e=this,s=this.live_mode?1.1:.9;this.live_mode&&(this.live_mode=!1,this.editor_alpha=.1);var i=setInterval(function(){e.editor_alpha*=s,e.dirty_canvas=!0,e.dirty_bgcanvas=!0,s<1&&e.editor_alpha<.01&&(clearInterval(i),s<1&&(e.live_mode=!0)),s>1&&e.editor_alpha>.99&&(clearInterval(i),e.editor_alpha=1)},1)}onNodeSelectionChange(){}touchHandler(t){}convertOffsetToCanvas(t){return this.ds.convertOffsetToCanvas(t)}convertCanvasToOffset(t,e=[0,0]){return this.ds.convertCanvasToOffset(t,e)}convertEventToCanvasOffset(t){var e=this.canvas.getBoundingClientRect();return this.convertCanvasToOffset([t.clientX-e.left,t.clientY-e.top])}addGraphInputNode(t,e,s){const i=this.graph.findNodesByClass(lt).find(a=>a.properties.name===e);if(i){this.selectNodes([i]);return}(!s||s==="")&&(s="*");const n=[this.canvas.width*.25/this.ds.scale-this.ds.offset[0],this.canvas.height*.5/this.ds.scale-this.ds.offset[1]];this.graph.beforeChange();const o=t.addGraphInput(e,s,n);if(o){const a=o.innerNode;this.selectNodes([a]),this.graph.afterChange()}else console.error("graph input node not found:",s)}addGraphOutputNode(t,e,s){const i=this.graph.findNodesByClass(dt).find(a=>a.properties.name===e);if(i){this.selectNodes([i]);return}(!s||s==="")&&(s="*");const n=[this.canvas.width*.75/this.ds.scale-this.ds.offset[0],this.canvas.height*.5/this.ds.scale-this.ds.offset[1]];this.graph.beforeChange();const o=t.addGraphOutput(e,s,n);if(o){const a=o.innerNode;this.selectNodes([a]),this.graph.afterChange()}else console.error("graph output node not found:",s)}getCanvasMenuOptions(){return w.prototype.getCanvasMenuOptions.apply(this,arguments)}getNodeMenuOptions(t){return w.prototype.getNodeMenuOptions.apply(this,arguments)}getLinkMenuOptions(t){return w.prototype.getLinkMenuOptions.apply(this,arguments)}getGroupMenuOptions(t){return w.prototype.getGroupMenuOptions.apply(this,arguments)}checkPanels(){w.prototype.checkPanels.apply(this,arguments)}closePanels(){w.prototype.closePanels.apply(this,arguments)}createDialog(t,e){return w.prototype.createDialog.apply(this,arguments)}createPanel(t,e={}){return w.prototype.createPanel.apply(this,arguments)}showSearchBox(t,e={}){return w.prototype.showSearchBox.apply(this,arguments)}prompt(t="",e,s,i,n=!1,o=null){return w.prototype.prompt.apply(this,arguments)}showConnectionMenu(t={}){return w.prototype.showConnectionMenu.apply(this,arguments)}showLinkMenu(t,e){return w.prototype.showLinkMenu.apply(this,arguments)}showEditPropertyValue(t,e,s){return w.prototype.showEditPropertyValue.apply(this,arguments)}showShowNodePanel(t){w.prototype.showShowNodePanel.apply(this,arguments)}showSubgraphPropertiesDialog(t){return w.prototype.showSubgraphPropertiesDialog.apply(this,arguments)}showSubgraphPropertiesDialogRight(t){return w.prototype.showSubgraphPropertiesDialogRight.apply(this,arguments)}processContextMenu(t,e){w.prototype.processContextMenu.apply(this,arguments)}processMouseMove(t){return ee.prototype.processMouseMove.apply(this,arguments)}processMouseDown(t){return ee.prototype.processMouseDown.apply(this,arguments)}processMouseUp(t){return ee.prototype.processMouseUp.apply(this,arguments)}processMouseWheel(t){return ee.prototype.processMouseWheel.apply(this,arguments)}setZoom(t,e){$.prototype.setZoom.apply(this,arguments)}bringToFront(t){$.prototype.bringToFront.apply(this,arguments)}sendToBack(t){$.prototype.sendToBack.apply(this,arguments)}computeVisibleNodes(t,e=[]){return $.prototype.computeVisibleNodes.apply(this,arguments)}draw(t=!1,e=!1){$.prototype.draw.apply(this,arguments)}drawFrontCanvas(){$.prototype.drawFrontCanvas.apply(this,arguments)}drawSubgraphPanel(t){$.prototype.drawSubgraphPanel.apply(this,arguments)}drawSubgraphPanelLeft(t,e,s){$.prototype.drawSubgraphPanelLeft.apply(this,arguments)}drawSubgraphPanelRight(t,e,s){$.prototype.drawSubgraphPanelRight.apply(this,arguments)}drawButton(t,e,s,i,n,o=h.NODE_DEFAULT_COLOR,a="#555",l=h.NODE_TEXT_COLOR,u=!0){return $.prototype.drawButton.apply(this,arguments)}drawBackCanvas(){$.prototype.drawBackCanvas.apply(this,arguments)}renderInfo(t,e=10,s){$.prototype.renderInfo.apply(this,arguments)}drawNode(t,e){$.prototype.drawNode.apply(this,arguments)}drawLinkTooltip(t,e){$.prototype.drawLinkTooltip.apply(this,arguments)}drawNodeShape(t,e,s,i,n,o,a){$.prototype.drawNodeShape.apply(this,arguments)}drawConnections(t){$.prototype.drawConnections.apply(this,arguments)}renderLink(t,e,s,i,n,o,a,l,u,d){$.prototype.renderLink.apply(this,arguments)}computeConnectionPoint(t,e,s,i=R.RIGHT,n=R.LEFT){return $.prototype.computeConnectionPoint.apply(this,arguments)}drawExecutionOrder(t){$.prototype.drawExecutionOrder.apply(this,arguments)}drawNodeWidgets(t,e,s,i){$.prototype.drawNodeWidgets.apply(this,arguments)}drawGroups(t,e){$.prototype.drawGroups.apply(this,arguments)}};W.DEFAULT_BACKGROUND_IMAGE="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQBJREFUeNrs1rEKwjAUhlETUkj3vP9rdmr1Ysammk2w5wdxuLgcMHyptfawuZX4pJSWZTnfnu/lnIe/jNNxHHGNn//HNbbv+4dr6V+11uF527arU7+u63qfa/bnmh8sWLBgwYJlqRf8MEptXPBXJXa37BSl3ixYsGDBMliwFLyCV/DeLIMFCxYsWLBMwSt4Be/NggXLYMGCBUvBK3iNruC9WbBgwYJlsGApeAWv4L1ZBgsWLFiwYJmCV/AK3psFC5bBggULloJX8BpdwXuzYMGCBctgwVLwCl7Be7MMFixYsGDBsu8FH1FaSmExVfAxBa/gvVmwYMGCZbBg/W4vAQYA5tRF9QYlv/QAAAAASUVORK5CYII=";W.node_colors={red:{color:"#322",bgcolor:"#533",groupcolor:"#A88"},brown:{color:"#332922",bgcolor:"#593930",groupcolor:"#b06634"},green:{color:"#232",bgcolor:"#353",groupcolor:"#8A8"},blue:{color:"#223",bgcolor:"#335",groupcolor:"#88A"},pale_blue:{color:"#2a363b",bgcolor:"#3f5159",groupcolor:"#3f789e"},cyan:{color:"#233",bgcolor:"#355",groupcolor:"#8AA"},purple:{color:"#323",bgcolor:"#535",groupcolor:"#a1309b"},yellow:{color:"#432",bgcolor:"#653",groupcolor:"#b58b2a"},black:{color:"#222",bgcolor:"#000",groupcolor:"#444"}};W.DEFAULT_LINK_TYPE_COLORS={[y.ACTION]:h.ACTION_LINK_COLOR,[y.EVENT]:h.EVENT_LINK_COLOR,number:"#AAA",node:"#DCA"};W.DEFAULT_CONNECTION_COLORS={input_off:"#778",input_on:"#7F7",output_off:"#778",output_on:"#7F7"};W.DEFAULT_CONNECTION_COLORS_BY_TYPE={number:"#7F7",string:"#77F",boolean:"#F77"};W.DEFAULT_CONNECTION_COLORS_BY_TYPE_OFF={number:"#474",string:"#447",boolean:"#744"};W.active_canvas=null;W.active_node=null;W.onMenuCollapseAll=w.onMenuCollapseAll;W.onMenuNodeEdit=w.onMenuNodeEdit;W.onShowPropertyEditor=w.onShowPropertyEditor;W.onGroupAdd=w.onGroupAdd;W.onMenuAdd=w.onMenuAdd;W.showMenuNodeOptionalInputs=w.showMenuNodeOptionalInputs;W.showMenuNodeOptionalOutputs=w.showMenuNodeOptionalOutputs;W.onShowMenuNodeProperties=w.onShowMenuNodeProperties;W.onResizeNode=w.onResizeNode;W.onMenuResizeNode=w.onMenuResizeNode;W.onMenuNodeCollapse=w.onMenuNodeCollapse;W.onMenuNodePin=w.onMenuNodePin;W.onMenuNodeMode=w.onMenuNodeMode;W.onMenuNodeColors=w.onMenuNodeColors;W.onMenuNodeShapes=w.onMenuNodeShapes;W.onMenuNodeRemove=w.onMenuNodeRemove;W.onMenuNodeClone=w.onMenuNodeClone;W.onMenuNodeToSubgraph=w.onMenuNodeToSubgraph;W.onMenuNodeToSubgraphInputs=w.onMenuNodeToSubgraphInputs;W.onMenuNodeToSubgraphOutputs=w.onMenuNodeToSubgraphOutputs;W.onMenuNodeToParentGraph=w.onMenuNodeToParentGraph;let O=W;var it=(r=>(r[r.SEPARATOR=0]="SEPARATOR",r))(it||{});class tt{static trigger(t,e,s,i){var n=document.createEvent("CustomEvent");return n.initCustomEvent(e,!0,!0,s),n.target=i,t.dispatchEvent&&t.dispatchEvent(n),n}static isCursorOverElement(t,e){var s=t.clientX,i=t.clientY,n=e.getBoundingClientRect();return n?i>n.top&&i<n.top+n.height&&s>n.left&&s<n.left+n.width:!1}static closeAllContextMenus(t){t=t||window;var e=t.document.querySelectorAll(".litecontextmenu");if(e.length){var s=Array.from(e);for(const i of s)i.close()}}constructor(t,e={},s){this.options=e;var i=this;e.parentMenu&&(e.parentMenu.constructor!==this.constructor?(console.error("parentMenu must be of class ContextMenu, ignoring it"),e.parentMenu=null):(this.parentMenu=e.parentMenu,this.parentMenu.lock=!0,this.parentMenu.current_submenu=this));var n=null;e.event&&(n=e.event.constructor.name),n!=="MouseEvent"&&n!=="CustomEvent"&&n!=="PointerEvent"&&(console.error("Event passed to ContextMenu is not of type MouseEvent or CustomEvent. Ignoring it. ("+n+")"),e.event=null);var o=document.createElement("div");o.className="litegraph litecontextmenu litemenubar-panel",e.className&&(o.className+=" "+e.className),o.style.pointerEvents="none",setTimeout(function(){o.style.pointerEvents="auto"},100),h.pointerListenerAdd(o,"up",function(f){return f.preventDefault(),!0},!0),o.addEventListener("contextmenu",function(f){return f.button!=2||f.preventDefault(),!1},!0),o.close=()=>{o.parentNode.removeChild(o)},h.pointerListenerAdd(o,"down",function(f){if(f.button==2)return i.close(),f.preventDefault(),!0},!0);function a(f){var _=parseInt(o.style.top);return o.style.top=(_+f.deltaY*e.scroll_speed).toFixed()+"px",f.preventDefault(),!0}if(e.scroll_speed||(e.scroll_speed=.1),o.addEventListener("wheel",a,!0),o.addEventListener("mousewheel",a,!0),this.root=o,e.title){var l=document.createElement("div");l.className="litemenu-title",l.innerHTML=e.title,o.appendChild(l)}this.values=[];for(let f=0;f<t.length;f++){let _=t[f],m="";_===0?m="":typeof _=="string"?m=_:m=_.content,this.addItem(m,_,e)}h.pointerListenerAdd(o,"enter",function(f){o.closing_timer&&clearTimeout(o.closing_timer)});var u=document;e.event&&e.event.target instanceof Node&&(u=e.event.target.ownerDocument),u||(u=document),u.fullscreenElement?u.fullscreenElement.appendChild(o):u.body.appendChild(o);var d=e.left||0,p=e.top||0;if(e.event){if(d=e.event.clientX-10,p=e.event.clientY-10,e.title&&(p-=20),e.parentMenu){var g=e.parentMenu.root.getBoundingClientRect();d=g.left+g.width}var c=document.body.getBoundingClientRect(),b=o.getBoundingClientRect();c.height==0&&console.error("document.body height is 0. That is dangerous, set html,body { height: 100%; }"),c.width&&d>c.width-b.width-10&&(d=c.width-b.width-10),c.height&&p>c.height-b.height-10&&(p=c.height-b.height-10)}o.style.left=d+"px",o.style.top=p+"px",e.scale&&(o.style.transform="scale("+e.scale+")")}addItem(t,e,s={}){var i=this,n=document.createElement("div");n.className="litemenu-entry submenu";var o=!1;typeof e=="string"&&(e={content:e}),e===0?n.classList.add("separator"):(n.innerHTML=e.title?e.title:t,e.disabled&&(o=!0,n.classList.add("disabled")),(e.submenu||e.has_submenu)&&n.classList.add("has_submenu"),typeof e=="function"?n.dataset.value=t:n.dataset.value=""+this.values.length,e.className&&(n.className+=" "+e.className)),this.values.push(e),this.root.appendChild(n),o||n.addEventListener("click",u),s.autoopen&&h.pointerListenerAdd(n,"enter",l);let a=this;function l(d){var p=this.value;!p||!p.has_submenu||u.call(this,d)}function u(d){let p=parseInt(this.dataset.value);var g=a.values[p];h.debug&&console.debug("ContextMenu inner_onclick",p,g);const c=O.active_canvas;if(!c)return;const b=c.adjustMouseEvent(d);var f=!0;if(i.current_submenu&&i.current_submenu.close(b),s.callback){var _=s.callback.call(this,g,s,b,i,s.node);_===!0&&(f=!1)}if(g&&typeof g=="object"){if(g.callback&&!s.ignore_item_callbacks&&g.disabled!==!0){var _=g.callback.call(this,g,s,b,i,s.extra);_===!0&&(f=!1)}if(g.submenu){if(!g.submenu.options)throw"ContextMenu submenu needs options";new tt(g.submenu.options,{callback:g.submenu.callback,event:b,parentMenu:i,ignore_item_callbacks:g.submenu.ignore_item_callbacks,title:g.submenu.title,extra:g.submenu.extra,autoopen:s.autoopen}),f=!1}}f&&!i.lock&&i.close()}return n}close(t,e){this.root.parentNode&&this.root.parentNode.removeChild(this.root),this.parentMenu&&!e&&(this.parentMenu.lock=!1,this.parentMenu.current_submenu=null,t===void 0?this.parentMenu.close():t&&!tt.isCursorOverElement(t,this.parentMenu.root)&&tt.trigger(this.parentMenu.root,h.pointerevents_method+"leave",t)),this.current_submenu&&this.current_submenu.close(t,!0),this.root.closing_timer&&clearTimeout(this.root.closing_timer)}getTopMenu(){return this.options.parentMenu?this.options.parentMenu.getTopMenu():this}getFirstEvent(){return this.options.parentMenu?this.options.parentMenu.getFirstEvent():this.options.event}}const hs=class rt{static getAudioContext(){if(!this._audio_context){if(window.AudioContext=window.AudioContext||window.webkitAudioContext,!window.AudioContext)return console.error("AudioContext not supported by browser"),null;this._audio_context=new AudioContext,this._audio_context.onmessage=function(t){console.log("msg",t)},this._audio_context.onended=function(t){console.log("ended",t)},this._audio_context.oncomplete=function(t){console.log("complete",t)}}return this._audio_context}static connect(t,e){try{t.connect(e)}catch(s){console.warn("LGraphAudio:",s)}}static disconnect(t,e){try{t.disconnect(e)}catch(s){console.warn("LGraphAudio:",s)}}static changeAllAudiosConnections(t,e){if(t.inputs)for(var s=0;s<t.inputs.length;++s){var i=t.inputs[s],n=t.graph.links[i.link];if(n){var o=t.graph.getNodeById(n.origin_id),a=null;o.getAudioNodeInOutputSlot?a=o.getAudioNodeInOutputSlot(n.origin_slot):a=o.audionode;var l=null;t.getAudioNodeInInputSlot?l=t.getAudioNodeInInputSlot(s):l=t.audionode,e?rt.connect(a,l):rt.disconnect(a,l)}}if(t.outputs)for(var s=0;s<t.outputs.length;++s)for(var u=t.outputs[s],d=0;d<u.links.length;++d){var n=t.graph.links[u.links[d]];if(n){var a=null;t.getAudioNodeInOutputSlot?a=t.getAudioNodeInOutputSlot(s):a=t.audionode;var p=t.graph.getNodeById(n.target_id),l=null;p.getAudioNodeInInputSlot?l=p.getAudioNodeInInputSlot(n.target_slot):l=p.audionode,e?rt.connect(a,l):rt.disconnect(a,l)}}}static onConnectionsChange(t,e,s,i){if(t==q.OUTPUT){var n=null;if(i&&(n=this.graph.getNodeById(i.target_id)),!!n){var o=null;this.getAudioNodeInOutputSlot?o=this.getAudioNodeInOutputSlot(e):o=this.audionode;var a=null;n.getAudioNodeInInputSlot?a=n.getAudioNodeInInputSlot(i.target_slot):a=n.audionode,s?rt.connect(o,a):rt.disconnect(o,a)}}}static createAudioNodeWrapper(t){var e=t.prototype.onPropertyChanged;t.prototype.onPropertyChanged=function(s,i){e&&e.call(this,s,i),this.audionode&&this.audionode[s]!==void 0&&(this.audionode[s].value!==void 0?this.audionode[s].value=i:this.audionode[s]=i)},t.prototype.onConnectionsChange=rt.onConnectionsChange}static loadSound(t,e,s){if(rt.cached_audios[t]&&t.indexOf("blob:")==-1){e&&e(rt.cached_audios[t]);return}rt.onProcessAudioURL&&(t=rt.onProcessAudioURL(t));var i=new XMLHttpRequest;i.open("GET",t,!0),i.responseType="arraybuffer";var n=rt.getAudioContext();i.onload=function(){console.log("AudioSource loaded"),n.decodeAudioData(i.response,function(a){console.log("AudioSource decoded"),rt.cached_audios[t]=a,rt.currentBuffer=a,e&&e(a)},o)},i.send();function o(a){console.log("Audio loading sample error:",a),s&&s(a)}return i}};hs.cached_audios={};let B=hs;window.LGAudio=B;class ps extends C{constructor(){super(),this.properties={A:.1,D:.1,S:.1,R:.1},this.audionode=B.getAudioContext().createGain(),this.audionode.gain.value=0,this.addInput("in","audio"),this.addInput("gate","boolean"),this.addOutput("out","audio"),this.gate=!1}onExecute(){var t=B.getAudioContext(),e=t.currentTime,s=this.audionode,i=s.gain,n=this.getInputData(1),o=this.getInputOrProperty("A"),a=this.getInputOrProperty("D"),l=this.getInputOrProperty("S"),u=this.getInputOrProperty("R");!this.gate&&n?(i.cancelScheduledValues(0),i.setValueAtTime(0,e),i.linearRampToValueAtTime(1,e+o),i.linearRampToValueAtTime(l,e+o+a)):this.gate&&!n&&(i.cancelScheduledValues(0),i.setValueAtTime(i.value,e),i.linearRampToValueAtTime(0,e+u)),this.gate=n}onGetInputs(){return[["A","number"],["D","number"],["S","number"],["R","number"]]}}B.createAudioNodeWrapper(ps);class ri extends C{constructor(t){super(),this.properties={fftSize:2048,minDecibels:-100,maxDecibels:-10,smoothingTimeConstant:.5};var e=B.getAudioContext();this.audionode=e.createAnalyser(),this.audionode.fftSize=this.properties.fftSize,this.audionode.minDecibels=this.properties.minDecibels,this.audionode.maxDecibels=this.properties.maxDecibels,this.audionode.smoothingTimeConstant=this.properties.smoothingTimeConstant,this.addInput("in","audio"),this.addOutput("freqs","array"),this.addOutput("samples","array"),this._freq_bin=null,this._time_bin=null}onPropertyChanged(t,e){this.audionode[t]=e}onExecute(){if(this.isOutputConnected(0)){var t=this.audionode.frequencyBinCount;(!this._freq_bin||this._freq_bin.length!=t)&&(this._freq_bin=new Uint8Array(t)),this.audionode.getByteFrequencyData(this._freq_bin),this.setOutputData(0,this._freq_bin)}if(this.isOutputConnected(1)){var t=this.audionode.frequencyBinCount;(!this._time_bin||this._time_bin.length!=t)&&(this._time_bin=new Uint8Array(t)),this.audionode.getByteTimeDomainData(this._time_bin),this.setOutputData(1,this._time_bin)}for(var e=1;e<this.inputs.length;++e){var s=this.inputs[e];if(s.link!=null){var i=this.getInputData(e);i!==void 0&&(this.audionode[s.name].value=i)}}}onGetInputs(){return[["minDecibels","number"],["maxDecibels","number"],["smoothingTimeConstant","number"]]}onGetOutputs(){return[["freqs","array"],["samples","array"]]}}class oi extends C{constructor(){super(),this.properties={band:440,amplitude:1},this.addInput("freqs","array"),this.addOutput("signal","number")}onExecute(){if(this._freqs=this.getInputData(0),!!this._freqs){var t=this.properties.band,e=this.getInputData(1);e!==void 0&&(t=e);var s=B.getAudioContext().sampleRate,i=s/this._freqs.length,n=2*(t/i);if(e=0,n<0&&(e=this._freqs[0]),n>=this._freqs.length)e=this._freqs[this._freqs.length-1];else{var o=n|0,a=this._freqs[o],l=this._freqs[o+1],u=n-o;e=a*(1-u)+l*u}this.setOutputData(0,e/255*this.properties.amplitude)}}onGetInputs(){return[["band","number"]]}}class ds extends C{constructor(){super(),this.properties={frequency:350,detune:0,Q:1},this.addProperty("type","lowpass","enum",{values:["lowpass","highpass","bandpass","lowshelf","highshelf","peaking","notch","allpass"]}),this.audionode=B.getAudioContext().createBiquadFilter(),this.addInput("in","audio"),this.addOutput("out","audio")}onExecute(){if(!(!this.inputs||!this.inputs.length))for(var t=1;t<this.inputs.length;++t){var e=this.inputs[t];if(e.link!=null){var s=this.getInputData(t);s!==void 0&&(this.audionode[e.name].value=s)}}}onGetInputs(){return[["frequency","number"],["detune","number"],["Q","number"]]}}B.createAudioNodeWrapper(ds);class cs extends C{constructor(){super(),this.properties={impulse_src:"",normalize:!0},this.audionode=B.getAudioContext().createConvolver(),this.addInput("in","audio"),this.addOutput("out","audio")}onRemove(){this._dropped_url&&URL.revokeObjectURL(this._dropped_url)}onPropertyChanged(t,e){t=="impulse_src"?this.loadImpulse(e):t=="normalize"&&(this.audionode.normalize=e)}onDropFile(t){this._dropped_url&&URL.revokeObjectURL(this._dropped_url),this._dropped_url=URL.createObjectURL(t),this.properties.impulse_src=this._dropped_url,this.loadImpulse(this._dropped_url)}loadImpulse(t){var e=this;if(this._request&&(this._request.abort(),this._request=null),this._impulse_buffer=null,this._loading_impulse=!1,!t)return;this._request=B.loadSound(t,s),this._loading_impulse=!0;function s(i){e._impulse_buffer=i,e.audionode.buffer=i,console.log("Impulse signal set"),e._loading_impulse=!1}}}B.createAudioNodeWrapper(cs);class fs extends C{constructor(){super(),this.properties={delayTime:.5},this.audionode=B.getAudioContext().createDelay(10),this.audionode.delayTime.value=this.properties.delayTime,this.addInput("in","audio"),this.addInput("time","number"),this.addOutput("out","audio")}onExecute(){var t=this.getInputData(1);t!==void 0&&(this.audionode.delayTime.value=t)}}B.createAudioNodeWrapper(fs);class ai extends C{constructor(){super(),this.audionode=B.getAudioContext().destination,this.addInput("in","audio")}}class gs extends C{constructor(){super(),this.properties={threshold:-50,knee:40,ratio:12,reduction:-20,attack:0,release:.25},this.audionode=B.getAudioContext().createDynamicsCompressor(),this.addInput("in","audio"),this.addOutput("out","audio")}onExecute(){if(!(!this.inputs||!this.inputs.length))for(var t=1;t<this.inputs.length;++t){var e=this.inputs[t];if(e.link!=null){var s=this.getInputData(t);s!==void 0&&(this.audionode[e.name].value=s)}}}onGetInputs(){return[["threshold","number"],["knee","number"],["ratio","number"],["reduction","number"],["attack","number"],["release","number"]]}}B.createAudioNodeWrapper(gs);class _s extends C{constructor(){super(),this.properties={gain:1},this.audionode=B.getAudioContext().createGain(),this.addInput("in","audio"),this.addInput("gain","number"),this.addOutput("out","audio")}onExecute(){if(!(!this.inputs||!this.inputs.length))for(var t=1;t<this.inputs.length;++t){var e=this.inputs[t],s=this.getInputData(t);s!==void 0&&(this.audionode[e.name].value=s)}}}B.createAudioNodeWrapper(_s);class li extends C{constructor(){super(),this.onConnectionsChange=B.onConnectionsChange,this.properties={gain:.5},this._media_stream=null,this.addOutput("out","audio"),this.addInput("gain","number");var t=B.getAudioContext();this.audionode=t.createGain(),this.audionode.gain.value=this.properties.gain}onAdded(t){t.status===ct.STATUS_RUNNING&&this.onStart()}onStart(){this._media_stream==null&&!this._waiting_confirmation&&this.openStream()}onStop(){this.audionode.gain.value=0}onPause(){this.audionode.gain.value=0}onUnpause(){this.audionode.gain.value=this.properties.gain}onRemoved(){if(this.audionode.gain.value=0,this.audiosource_node&&(this.audiosource_node.disconnect(this.audionode),this.audiosource_node=null),this._media_stream){var t=this._media_stream.getTracks();t.length&&t[0].stop()}}openStream(){if(!navigator.mediaDevices){console.log("getUserMedia() is not supported in your browser, use chrome and enable WebRTC from about://flags");return}this._waiting_confirmation=!0,navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(this.streamReady.bind(this)).catch(e);var t=this;function e(s){console.log("Media rejected",s),t._media_stream=!1,t.boxcolor="red"}}streamReady(t){this._media_stream=t,this.audiosource_node&&this.audiosource_node.disconnect(this.audionode);var e=B.getAudioContext();this.audiosource_node=e.createMediaStreamSource(t),this.audiosource_node.connect(this.audionode),this.boxcolor="white"}onExecute(){if(this._media_stream==null&&!this._waiting_confirmation&&this.openStream(),this.inputs)for(var t=0;t<this.inputs.length;++t){var e=this.inputs[t];if(e.link!=null){var s=this.getInputData(t);s!==void 0&&e.name=="gain"&&(this.audionode.gain.value=this.properties.gain=s)}}}onAction(t){t=="Play"?this.audionode.gain.value=this.properties.gain:t=="Stop"&&(this.audionode.gain.value=0)}onPropertyChanged(t,e){t=="gain"&&(this.audionode.gain.value=e)}onGetInputs(){return[["playbackRate","number"],["Play",y.ACTION],["Stop",y.ACTION]]}}class vs extends C{constructor(){super(),this.properties={gain1:.5,gain2:.5},this.audionode=B.getAudioContext().createGain(),this.audionode1=B.getAudioContext().createGain(),this.audionode1.gain.value=this.properties.gain1,this.audionode2=B.getAudioContext().createGain(),this.audionode2.gain.value=this.properties.gain2,this.audionode1.connect(this.audionode),this.audionode2.connect(this.audionode),this.addInput("in1","audio"),this.addInput("in1 gain","number"),this.addInput("in2","audio"),this.addInput("in2 gain","number"),this.addOutput("out","audio")}getAudioNodeInInputSlot(t){if(t==0)return this.audionode1;if(t==2)return this.audionode2}onPropertyChanged(t,e){t=="gain1"?this.audionode1.gain.value=e:t=="gain2"&&(this.audionode2.gain.value=e)}onExecute(){if(!(!this.inputs||!this.inputs.length))for(var t=1;t<this.inputs.length;++t){var e=this.inputs[t];if(!(e.link==null||e.type=="audio")){var s=this.getInputData(t);s!==void 0&&(t==1?this.audionode1.gain.value=s:t==3&&(this.audionode2.gain.value=s))}}}}B.createAudioNodeWrapper(vs);class ms extends C{constructor(){super(),this.properties={frequency:440,detune:0,type:"sine"},this.addProperty("type","sine","enum",{values:["sine","square","sawtooth","triangle","custom"]}),this.audionode=B.getAudioContext().createOscillator(),this.addOutput("out","audio")}onStart(){if(!this.audionode.started){this.audionode.started=!0;try{this.audionode.start()}catch{}}}onStop(){this.audionode.started&&(this.audionode.started=!1,this.audionode.stop())}onPause(){this.onStop()}onUnpause(){this.onStart()}onExecute(){if(!(!this.inputs||!this.inputs.length))for(var t=0;t<this.inputs.length;++t){var e=this.inputs[t];if(e.link!=null){var s=this.getInputData(t);s!==void 0&&(this.audionode[e.name].value=s)}}}onGetInputs(){return[["frequency","number"],["detune","number"],["type","string"]]}}B.createAudioNodeWrapper(ms);class ui extends C{constructor(){super(),this.addInput("xy","buffer"),this.size=[300,200],this._last_buffer=null,this.start_time=Date.now()}onExecute(){this._last_buffer=this.getInputData(0),this.setDirtyCanvas(!0,!1)}onDrawForeground(t){if(!this._last_buffer)return;const e=this._last_buffer,s=B.getAudioContext(),i=s.currentTime,n=e.getChannelData(0),o=e.getChannelData(1),[a,l]=this.size;t.fillStyle="black",t.fillRect(0,0,this.size[0],this.size[1]),t.strokeStyle="white",t.beginPath();const u=60,d=Math.floor(s.sampleRate*1/u),p=Math.floor(i*s.sampleRate),g=Math.min(p+d,n.length);for(let c=p;c<g;c++){const b=n[c]*(a/2)+a/2,f=o[c]*(l/2)+l/2;t.lineTo(b,f)}t.stroke()}}class at extends C{constructor(){if(super(),!at.default_code){var t=at.default_function.toString(),e=t.indexOf("{")+1,s=t.lastIndexOf("}");at.default_code=t.substr(e,s-e)}this.properties={code:at.default_code};var i=B.getAudioContext();i.createScriptProcessor?this.audionode=i.createScriptProcessor(4096,1,1):(console.warn("ScriptProcessorNode deprecated"),this.audionode=i.createGain()),this.processCode(),at._bypass_function||(at._bypass_function=this.audionode.onaudioprocess),this.addInput("in","audio"),this.addOutput("out","audio")}static default_function(){this.onaudioprocess=function(t){for(var e=t.inputBuffer,s=t.outputBuffer,i=0;i<s.numberOfChannels;i++)for(var n=e.getChannelData(i),o=s.getChannelData(i),a=0;a<e.length;a++)o[a]=n[a]}}onAdded(t){t.status==ct.STATUS_RUNNING&&(this.audionode.onaudioprocess=this._callback)}onStart(){this.audionode.onaudioprocess=this._callback}onStop(){this.audionode.onaudioprocess=at._bypass_function}onPause(){this.audionode.onaudioprocess=at._bypass_function}onUnpause(){this.audionode.onaudioprocess=this._callback}onExecute(){}onRemoved(){this.audionode.onaudioprocess=at._bypass_function}processCode(){try{const t=new Function("properties",this.properties.code);this._script=t(this.properties),this._old_code=this.properties.code,this._callback=this._script.onaudioprocess}catch(t){console.error("Error in onaudioprocess code",t),this._callback=at._bypass_function,this.audionode.onaudioprocess=this._callback}}onPropertyChanged(t,e){t=="code"&&(this.properties.code=e,this.processCode(),this.graph&&this.graph.status==ct.STATUS_RUNNING&&(this.audionode.onaudioprocess=this._callback))}}at["@code"]={widget:"code",type:"code"};B.createAudioNodeWrapper(at);class ae extends C{constructor(){super(),this.onConnectionsChange=B.onConnectionsChange,this.properties={src:"",gain:.5,loop:!0,autoplay:!0,playbackRate:1},this._loading_audio=!1,this._audiobuffer=null,this._audionodes=[],this._last_sourcenode=null,this.addOutput("out","audio"),this.addOutput("buffer","buffer"),this.addInput("gain","number");var t=B.getAudioContext();this.audionode=t.createGain(),this.audionode.gain.value=this.properties.gain,this.properties.src&&this.loadSound(this.properties.src)}onAdded(t){t.status===ct.STATUS_RUNNING&&this.onStart()}onStart(){this._audiobuffer&&this.properties.autoplay&&this.playBuffer(this._audiobuffer)}onStop(){this.stopAllSounds()}onPause(){this.pauseAllSounds()}onUnpause(){this.unpauseAllSounds()}onRemoved(){this.stopAllSounds(),this._dropped_url&&URL.revokeObjectURL(this._url)}stopAllSounds(){for(var t=0;t<this._audionodes.length;++t)this._audionodes[t].started&&(this._audionodes[t].started=!1,this._audionodes[t].stop());this._audionodes.length=0}pauseAllSounds(){B.getAudioContext().suspend()}unpauseAllSounds(){B.getAudioContext().resume()}onExecute(){if(this.inputs)for(var t=0;t<this.inputs.length;++t){var e=this.inputs[t];if(e.link!=null){var s=this.getInputData(t);if(s!==void 0){if(e.name=="gain")this.audionode.gain.value=s;else if(e.name=="src")console.log(e),this.setProperty("src",s);else if(e.name=="playbackRate"){this.properties.playbackRate=s;for(var i=0;i<this._audionodes.length;++i)this._audionodes[i].playbackRate.value=s}}}}if(this.outputs)for(var t=0;t<this.outputs.length;++t){var n=this.outputs[t];n.name=="buffer"&&this._audiobuffer&&this.setOutputData(t,this._audiobuffer)}}onAction(t){this._audiobuffer&&(t=="Play"?this.playBuffer(this._audiobuffer):t=="Stop"&&this.stopAllSounds())}onPropertyChanged(t,e){if(t=="src")this.loadSound(e);else if(t=="gain")this.audionode.gain.value=e;else if(t=="playbackRate")for(var s=0;s<this._audionodes.length;++s)this._audionodes[s].playbackRate.value=e}playBuffer(t){var e=B.getAudioContext(),s=e.createBufferSource();return this._last_sourcenode=s,s.buffer=t,s.loop=this.properties.loop,s.playbackRate.value=this.properties.playbackRate,this._audionodes.push(s),s.connect(this.audionode),this.trigger("start"),s.onended=()=>{this.trigger("ended");var i=this._audionodes.indexOf(s);i!=-1&&this._audionodes.splice(i,1)},s.started||(s.started=!0,s.start()),s}loadSound(t){var e=this;if(this._request&&(this._request.abort(),this._request=null),this._audiobuffer=null,this._loading_audio=!1,!t)return;this._request=B.loadSound(t,s),this._loading_audio=!0,this.boxcolor="#AA4";function s(i){e.boxcolor=h.NODE_DEFAULT_BOXCOLOR,e._audiobuffer=i,e._loading_audio=!1,e.graph&&e.graph.status===ct.STATUS_RUNNING&&e.onStart()}}onGetInputs(){return[["playbackRate","number"],["src","string"],["Play",y.ACTION],["Stop",y.ACTION]]}onGetOutputs(){return[["buffer","audiobuffer"],["start",y.EVENT],["ended",y.EVENT]]}onDropFile(t){this._dropped_url&&URL.revokeObjectURL(this._dropped_url);var e=URL.createObjectURL(t);this.properties.src=e,this.loadSound(e),this._dropped_url=e}}ae.title="Audio Source";ae.desc="Plays an audio file";ae.supported_extensions=["wav","ogg","mp3"];class hi extends C{constructor(){super(),this.properties={continuous:!0,mark:-1},this.addInput("data","array"),this.addInput("mark","number"),this.size=[300,200],this._last_buffer=null}onExecute(){this._last_buffer=this.getInputData(0);var t=this.getInputData(1);t!==void 0&&(this.properties.mark=t),this.setDirtyCanvas(!0,!1)}onDrawForeground(t){if(this._last_buffer){var e=this._last_buffer,s=e.length/this.size[0],i=this.size[1];t.fillStyle="black",t.fillRect(0,0,this.size[0],this.size[1]),t.strokeStyle="white",t.beginPath();var n=0;if(this.properties.continuous){t.moveTo(n,i);for(var o=0;o<e.length;o+=s)t.lineTo(n,i-e[o|0]/255*i),n++}else for(var o=0;o<e.length;o+=s)t.moveTo(n+.5,i),t.lineTo(n+.5,i-e[o|0]/255*i),n++;if(t.stroke(),this.properties.mark>=0){const l=B.getAudioContext().sampleRate/e.length;let u=2*(this.properties.mark/l)/s;u>=this.size[0]&&(u=this.size[0]-1),t.strokeStyle="red",t.beginPath(),t.moveTo(u,i),t.lineTo(u,0),t.stroke()}}}}class ys extends C{constructor(){super(),this.properties={},this.audionode=B.getAudioContext().createWaveShaper(),this.addInput("in","audio"),this.addInput("shape","waveshape"),this.addOutput("out","audio")}onExecute(){if(!(!this.inputs||!this.inputs.length)){var t=this.getInputData(1);t!==void 0&&(this.audionode.curve=t)}}setWaveShape(t){this.audionode.curve=t}}B.createAudioNodeWrapper(ys);const pi=r=>{r.registerNodeType({type:"audio/adsr",class:ps,title:"ADSR",desc:"Audio envelope"}),r.registerNodeType({type:"audio/analyser",class:ri,title:"Analyser",desc:"Audio Analyser"}),r.registerNodeType({type:"audio/signal",class:oi,title:"Signal",desc:"extract the signal of some frequency"}),r.registerNodeType({type:"audio/biquadfilter",class:ds,title:"BiquadFilter",desc:"Audio filter"}),r.registerNodeType({type:"audio/convolver",class:cs,title:"Convolver",desc:"Convolves the signal (used for reverb)"}),r.registerNodeType({type:"audio/delay",class:fs,title:"Delay",desc:"Audio delay"}),r.registerNodeType({type:"audio/destination",class:ai,title:"Destination",desc:"Audio output"}),r.registerNodeType({type:"audio/dynamicsCompressor",title:"DynamicsCompressor",class:gs,desc:"Dynamics Compressor"}),r.registerNodeType({type:"audio/gain",title:"Gain",class:_s,desc:"Audio gain"}),r.registerNodeType({type:"audio/media_source",title:"MediaSource",class:li,desc:"Plays microphone"}),r.registerNodeType({type:"audio/mixer",class:vs,title:"Mixer",desc:"Audio mixer"}),r.registerNodeType({type:"audio/oscillator",class:ms,title:"Oscillator",desc:"Oscillator"}),r.registerNodeType({type:"audio/oscilloscope",class:ui,title:"Oscilloscope",desc:"Audio oscilloscope"}),r.registerNodeType({type:"audio/script",title:"Script",class:at,desc:"apply script to signal"}),r.registerNodeType({type:"audio/source",class:ae,title:"Audio Source",desc:"Plays audio"}),r.registerNodeType({type:"audio/visualization",class:hi,title:"Visualization",desc:"Audio Visualization"}),r.registerNodeType({type:"audio/waveShaper",class:ys,title:"WaveShaper",desc:"Distortion using wave shape"})};class oe extends C{constructor(t){super(),this.properties={value:1},this.nameInGraph="",this.size=[180,30],this.widget=this.addWidget("number","value",1,"value"),this.widgets_up=!0}getTitle(){return this.flags.collapsed?""+this.properties.value:this.title}setValue(t){typeof t!="number"&&(t=parseFloat(t)),this.setProperty("value",t)}onExecute(){this.setOutputData(0,this.properties.value)}onDrawBackground(t){this.outputs[0].label=this.properties.value.toFixed(3)}}oe.slotLayout={inputs:[],outputs:[{name:"value",type:"number"}]};oe.propertyLayout=[{name:"value",defaultValue:1}];class Be extends C{constructor(t){super(),this.properties={value:1},this.nameInGraph="",this.size=[180,30],this.widget=this.addWidget("number","value",1,"value",{step:1,precision:0}),this.widgets_up=!0}onExecute(){this.setOutputData(0,this.properties.value)}getTitle(){return this.flags.collapsed?""+this.properties.value:this.title}setValue(t){typeof t!="number"&&(t=parseFloat(t)),this.setProperty("value",Math.floor(t))}onDrawBackground(t){this.outputs[0].label=this.properties.value.toFixed(0)}}Be.slotLayout={inputs:[],outputs:[{name:"value",type:"number"}]};Be.propertyLayout=[{name:"value",defaultValue:1}];class le extends C{constructor(t){super(),this.properties={value:!0},this.size=[140,30],this.widget=this.addWidget("toggle","value",!0,"value"),this.widgets_up=!0}onExecute(){this.setOutputData(0,this.properties.value)}onAction(){this.setValue(!this.properties.value)}getTitle(){return this.flags.collapsed?""+this.properties.value:this.title}setValue(t){this.setProperty("value",!!t)}}le.slotLayout={inputs:[],outputs:[{name:"bool",type:"boolean"}]};le.propertyLayout=[{name:"value",defaultValue:!0}];le.optionalSlots={inputs:[{name:"toggle",type:y.ACTION}]};class ue extends C{constructor(t){super(),this.properties={value:""},this.size=[180,30],this.widget=this.addWidget("text","value","","value"),this.widgets_up=!0}onExecute(){this.setOutputData(0,this.properties.value)}getTitle(){return this.flags.collapsed?""+this.properties.value:this.title}setValue(t){this.setProperty("value",String(t))}onDropFile(t){var e=this,s=new FileReader;s.onload=function(i){e.setProperty("value",s.result)},s.readAsText(t)}}ue.slotLayout={inputs:[],outputs:[{name:"string",type:"string"}]};ue.propertyLayout=[{name:"value",defaultValue:""}];ue.optionalSlots={};class he extends C{constructor(t){super(),this.properties={value:""},this.size=[120,30],this._object={}}onExecute(){this.setOutputData(0,this._object)}}he.slotLayout={inputs:[],outputs:[{name:"obj",type:"object"}]};he.propertyLayout=[];he.optionalSlots={};class pe extends C{constructor(t){super(),this.properties={url:"",type:"text"},this._data=null,this._url=null,this._type=null,this.widget=this.addWidget("text","url","","url"),this._data=null,this.widgets_up=!0}onPropertyChanged(t,e){t=="url"&&(e==null||e==""?this._data=null:this.fetchFile(e))}onExecute(){var t=this.getInputData(0)||this.properties.url;t&&(t!=this._url||this._type!=this.properties.type)&&this.fetchFile(t),this.setOutputData(0,this._data)}setValue(t){this.setProperty("value",t)}async fetchFile(t){var e=this;if(!t||t.constructor!==String){e._data=null,e.boxcolor=null;return}this._url=t,this._type=this.properties.type,t.substr(0,4)=="http"&&h.proxy&&(t=h.proxy+t.substr(t.indexOf(":")+3)),await fetch(t).then(function(s){if(!s.ok)throw new Error("File not found");if(e.properties.type=="arraybuffer")return s.arrayBuffer();if(e.properties.type=="text")return s.text();if(e.properties.type=="json")return s.json();if(e.properties.type=="blob")return s.blob()}).then(function(s){e._data=s,e.boxcolor="#AEA"}).catch(function(s){e._data=null,e.boxcolor="red",console.error("error fetching file:",s,t)})}onDropFile(t){this._url=t.name,this._type=this.properties.type,this.properties.url=t.name;var e=new FileReader;if(e.onload=s=>{this.boxcolor="#AEA";var i=e.result;this.properties.type=="json"&&(i=JSON.parse(i)),this._data=i},this.properties.type=="arraybuffer")e.readAsArrayBuffer(t);else if(this.properties.type=="text"||this.properties.type=="json")e.readAsText(t);else if(this.properties.type=="blob")return e.readAsBinaryString(t)}}pe.slotLayout={inputs:[{name:"url",type:"string"}],outputs:[{name:"file",type:"string"}]};pe.propertyLayout=[{name:"url",defaultValue:""},{name:"type",defaultValue:"text"}];pe.optionalSlots={};const Ge=class Re extends C{constructor(t){super(),this.properties={value:0},this.nameInGraph="",this.size=[60,30],this.value=0}onExecute(){this.inputs[0]&&(this.value=this.getInputData(0))}getTitle(){return this.flags.collapsed?this.inputs[0].label||"":this.title}static toString(t){if(t==null)return"null";if(t.constructor===Number)return t.toFixed(3);if(t.constructor===Array){for(var e="[",s=0;s<t.length;++s)e+=Re.toString(t[s])+(s+1!=t.length?",":"");return e+="]",e}else return String(t)}onDrawBackground(t){this.inputs[0].label=Re.toString(this.value)}};Ge.slotLayout={inputs:[{name:"value",type:y.DEFAULT,options:{label:""}}],outputs:[]};Ge.propertyLayout=[{name:"value",defaultValue:1}];let bs=Ge;class de extends C{constructor(t){super(),this.properties={json:"",value:"",type:"object"},this.size=[140,30],this.jsonWidget=this.addWidget("text","json","","json",{multiline:!0,inputStyle:{fontFamily:"monospace"}}),this.valueWidget=this.addWidget("text","value","","value"),this.valueWidget.disabled=!0,this.typeWidget=this.addWidget("text","type",this.properties.type,"type"),this.typeWidget.disabled=!0,this.widgets_up=!0,this._value=null}getType(){return Array.isArray(this._value)?"array":typeof this._value}updateType(){var t=this.getType();this.typeWidget.value=""+t,this.outputs[0].type!=t&&(h.isValidConnection(this.outputs[0].type,t)||this.disconnectOutput(0),this.outputs[0].type=t),this.valueWidget.value=this._value,this.outputs[0].shape=L.DEFAULT,t=="number"?this.valueWidget.type="number":t=="boolean"?this.valueWidget.type="toggle":t=="string"?this.valueWidget.type="text":t=="object"||t=="array"?(this.valueWidget.type="text",this.valueWidget.value=bs.toString(this._value),t=="array"&&(this.outputs[0].shape=L.GRID_SHAPE)):this.valueWidget.type=null,this.properties.value=this.valueWidget.value}onPropertyChanged(t,e){if(t=="json"){if(this.jsonWidget.value=e,e==null||e=="")return;try{this._value=JSON.parse(e),this.boxcolor="#AEA",this.updateType()}catch{this.boxcolor="red"}}else t=="type"&&this.updateType()}onExecute(){this.setOutputData(0,this._value)}setValue(t){this.setProperty("value",t)}onDropFile(t){var e=this,s=new FileReader;s.onload=function(i){e.setProperty("value",s.result)},s.readAsText(t)}}de.slotLayout={inputs:[],outputs:[{name:"data",type:"object"}]};de.propertyLayout=[{name:"json",defaultValue:"",options:{multiline:!0}},{name:"value",defaultValue:""},{name:"type",defaultValue:"object"}];de.optionalSlots={};class ce extends C{constructor(t){super(),this.properties={value:null},this.size=[140,30],this.widget=this.addWidget("toggle","value",this.properties.value,"value"),this.widgets_up=!0}onExecute(){this.setOutputData(0,this.properties.value)}onAction(){this.properties.value===null?this.setValue(void 0):this.setValue(null)}getTitle(){return this.flags.collapsed?""+String(this.properties.value):this.title}setValue(t){this.setProperty("value",t===void 0?void 0:null)}}ce.slotLayout={inputs:[],outputs:[{name:"null",type:"*"}]};ce.propertyLayout=[{name:"value",defaultValue:null}];ce.optionalSlots={inputs:[{name:"toggle",type:y.ACTION}]};class fe extends C{constructor(){super(...arguments),this.properties={index:0}}onExecute(){const t=this.getInputData(0);let e=this.getInputData(1);e==null&&(e=this.properties.index),!(t==null||e==null)&&(e=Math.floor(Number(e)),e>=0&&e<t.length?(this.boxcolor="#AEA",this.setOutputData(0,t[e])):this.boxcolor="red")}}fe.slotLayout={inputs:[{name:"array",type:"array,table,string",options:{shape:L.GRID_SHAPE}},{name:"index",type:"number"}],outputs:[{name:"value",type:""}]};fe.propertyLayout=[{name:"index",defaultValue:0}];fe.optionalSlots={};class ge extends C{constructor(t){super(),this.properties={index:0},this.widget=this.addWidget("number","i",this.properties.index,"index",{precision:0,step:10,min:0}),this.widgets_up=!0}onExecute(){var t=this.getInputData(0);if(!t)return;var e=this.getInputData(1);if(e===void 0)return;const s=Math.floor(this.properties.index);s>=0&&s<t.length?(this.boxcolor="#AEA",t[s]=e):this.boxcolor="red",this.setOutputData(0,t)}}ge.slotLayout={inputs:[{name:"arr",type:"array"},{name:"value",type:""}],outputs:[{name:"arr",type:"array"}]};ge.propertyLayout=[{name:"index",defaultValue:0}];ge.optionalSlots={};class ze extends C{constructor(){super(...arguments),this.resizable=!1,this.titleMode=yt.NO_TITLE}onExecute(){this.setOutputData(0,this.getInputData(0))}getExtraMenuOptions(t,e){const s=this.getInputLink(0)!=null&&this.getOutputLinks(0).length>0;return e.push({content:"Splice & Remove",disabled:!s,callback:()=>{const i=this.getInputLink(0),n=this.getOutputLinks(0);if(!i||!n)return;const o=this.graph.getNodeById(i.origin_id);this.graph.removeLink(i.id);for(const a of n){const l=this.graph.getNodeById(a.target_id);this.graph.removeLink(a.id),o.connect(i.origin_slot,l,a.target_slot)}this.graph.remove(this)}}),null}}ze.slotLayout={inputs:[{name:"",type:"*"}],outputs:[{name:"",type:"*"}]};ze.overrideSize=[60,30];class He extends C{constructor(){super(...arguments),this.properties={enabled:!0}}onExecute(){this.setOutputData(0,this.graph.globaltime*1e3),this.setOutputData(1,this.graph.globaltime)}}He.slotLayout={inputs:[],outputs:[{name:"in ms",type:"number"},{name:"in sec",type:"number"}]};He.propertyLayout=[{name:"enabled",defaultValue:!0}];const _e=class Ts extends C{constructor(t){super(),this.properties={A:1,B:1,OP:"=="},this.opWidget=this.addWidget("combo","Op.",this.properties.OP,null,{property:"OP",values:Ts.values})}getTitle(){return"*A "+this.properties.OP+" *B"}onExecute(){var t=this.getInputData(0);t===void 0?t=this.properties.A:this.properties.A=t;var e=this.getInputData(1);e===void 0?e=this.properties.B:this.properties.B=e;var s=!1;if(typeof t==typeof e)switch(this.properties.OP){case"==":case"!=":switch(s=!0,typeof t){case"object":var i=Object.getOwnPropertyNames(t),n=Object.getOwnPropertyNames(e);if(i.length!=n.length){s=!1;break}for(var o=0;o<i.length;o++){var a=i[o];if(t[a]!==e[a]){s=!1;break}}break;default:s=t==e}this.properties.OP=="!="&&(s=!s);break;case">":s=t>e;break;case"<":s=t<e;break;case"<=":s=t<=e;break;case">=":s=t>=e;break;case"||":s=t||e;break;case"&&":s=t&&e;break}this.setOutputData(0,s),this.setOutputData(1,!s)}};_e.slotLayout={inputs:[{name:"A",type:y.DEFAULT},{name:"B",type:y.DEFAULT}],outputs:[{name:"true",type:"boolean"},{name:"false",type:"boolean"}]};_e.propertyLayout=[{name:"enabled",defaultValue:!0}];_e.values=["==","!=",">","<",">=","<=","||","&&"];let di=_e;class Ue extends C{constructor(){super(...arguments),this.properties={strictEquality:!0}}onExecute(){const t=this.getInputData(0),e=this.properties.strictEquality?t===null:t==null;this.setOutputData(0,e)}}Ue.slotLayout={inputs:[{name:"in",type:"*"}],outputs:[{name:"is_null",type:"boolean"}]};Ue.propertyLayout=[];const ci=r=>{r.registerNodeType({class:fe,title:"Array[i]",desc:"Returns an element from an array",type:"basic/array[]"}),r.registerNodeType({class:le,title:"Const Boolean",desc:"Constant boolean",type:"basic/boolean"}),r.registerNodeType({class:pe,title:"Const File",desc:"Fetches a file from an url",type:"basic/file"}),r.registerNodeType({class:Be,title:"Const Integer",desc:"Constant integer",type:"basic/integer"}),r.registerNodeType({class:de,title:"Const JSON",desc:"Parses a string to JSON object",type:"basic/json"}),r.registerNodeType({class:oe,title:"Const Number",desc:"Constant number",type:"basic/number"}),r.registerNodeType({class:oe,title:"Const Number",desc:"Constant number",type:"basic/const"}),r.registerNodeType({class:ce,title:"Const Null",desc:"Constant null or undefined",type:"basic/null"}),r.registerNodeType({class:he,title:"Const Object",desc:"Constant object",type:"basic/object"}),r.registerNodeType({class:ue,title:"Const String",desc:"Constant string",type:"basic/string"}),r.registerNodeType({class:di,title:"GenericCompare",desc:"Compare *",type:"basic/CompareValues"}),r.registerNodeType({class:Ue,title:"== Null",desc:"Returns true if input is null",type:"basic/is_null"}),r.registerNodeType({class:ze,title:"Reroute",desc:"Simple pass-through for organization",type:"basic/reroute"}),r.registerNodeType({class:ge,title:"Set Array",desc:"Sets index of array",type:"basic/set_array"}),r.registerNodeType({class:He,title:"Time",desc:"Current time",type:"basic/time"}),r.registerNodeType({class:bs,title:"Watch",desc:"Show value of input",type:"basic/watch"})};class ve extends C{constructor(){super(...arguments),this.properties={timeInMs:1e3},this._pending=[],this.size=[60,30]}onAction(t,e,s){var i=this.properties.timeInMs;i<=0?this.trigger(null,e,s):this._pending.push([i,e])}onExecute(t,e){var s=this.graph.elapsed_time*1e3;this.isInputConnected(1)&&(this.properties.timeInMs=this.getInputData(1));for(var i=0;i<this._pending.length;++i){var n=this._pending[i];n[0]-=s,!(n[0]>0)&&(this._pending.splice(i,1),--i,this.trigger(null,n[1],e))}}}ve.slotLayout={inputs:[{name:"event",type:y.ACTION}],outputs:[{name:"on_time",type:y.EVENT}]};ve.propertyLayout=[];ve.optionalSlots={};function Dt(){this.addInput("inc",y.ACTION),this.addInput("dec",y.ACTION),this.addInput("reset",y.ACTION),this.addOutput("change",y.EVENT),this.addOutput("num","number"),this.addProperty("doCountExecution",!1,"boolean",{name:"Count Executions"}),this.addWidget("toggle","Count Exec.",this.properties.doCountExecution,"doCountExecution"),this.num=0}Dt.title="Counter";Dt.desc="Counts events";Dt.prototype.getTitle=function(){return this.flags.collapsed?String(this.num):this.title};Dt.prototype.onAction=function(r,t,e){var s=this.num;r=="inc"?this.num+=1:r=="dec"?this.num-=1:r=="reset"&&(this.num=0),this.num!=s&&this.trigger("change",this.num)};Dt.prototype.onDrawBackground=function(r){this.flags.collapsed||(r.fillStyle="#AAA",r.font="20px Arial",r.textAlign="center",r.fillText(this.num,this.size[0]*.5,this.size[1]*.5))};Dt.prototype.onExecute=function(){this.properties.doCountExecution&&(this.num+=1),this.setOutputData(1,this.num)};class Es extends C{constructor(){super(...arguments),this._value=!1,this.size=[120,60]}onExecute(t,e){this._value=this.getInputData(1)}onAction(t,e,s){this._value=this.getInputData(1),this.triggerSlot(this._value?0:1,e,null,s)}}Es.slotLayout={inputs:[{name:"in",type:y.ACTION},{name:"cond",type:"boolean"}],outputs:[{name:"true",type:y.EVENT},{name:"false",type:y.EVENT}]};const We=class Ns extends C{constructor(t){super(),this.properties={compareValue:null,propertyName:"",mode:"param",operation:"=="},this.size=[60,30],this.modeWidget=this.addWidget("combo","Mode",this.properties.mode,null,{property:"mode",values:["param","property"]}),this.propertyNameWidget=this.addWidget("text","Prop.",this.properties.propertyName,"propertyName"),this.propertyNameWidget.disabled=!0,this.opWidget=this.addWidget("combo","Op.",this.properties.operation,null,{property:"operation",values:Ns.values}),this.compareValueWidget=this.addWidget("text","Value",this.properties.compareValue,"compareValue")}onPropertyChanged(t,e){t==="mode"&&(this.propertyNameWidget.disabled=e==="param")}compare(t,e){if(typeof t!=typeof e)return!1;let s=!1;switch(this.properties.operation){case"==":case"!=":switch(s=!0,typeof t){case"object":var i=Object.getOwnPropertyNames(t),n=Object.getOwnPropertyNames(e);if(i.length!=n.length){s=!1;break}for(var o=0;o<i.length;o++){var a=i[o];if(t[a]!==e[a]){s=!1;break}}break;default:s=t==e}this.properties.operation=="!="&&(s=!s);break;case">":s=t>e;break;case"<":s=t<e;break;case"<=":s=t<=e;break;case">=":s=t>=e;break;case"||":s=t||e;break;case"&&":s=t&&e;break}return s}evaluate(t){if(this.properties.mode==="property"){if(!this.properties.propertyName)return console.warn("[FilterEvent] No property name supplied!",t),!1;var e=t[this.properties.propertyName];return e==null?!1:this.compare(this.properties.compareValue,e)}else return this.compare(this.properties.compareValue,t)}onExecute(){const t=this.getInputData(1);t!=null&&this.setProperty("compareValue",t),this.compareValueWidget.value=String(this.properties.compareValue)}onAction(t,e,s){this.evaluate(e)?this.triggerSlot(0,e,null,s):this.triggerSlot(1,e,null,s)}};We.slotLayout={inputs:[{name:"event",type:y.ACTION},{name:"compare_value",type:"*"}],outputs:[{name:"accept",type:y.EVENT},{name:"reject",type:y.EVENT}]};We.values=["==","!=",">","<",">=","<=","||","&&"];let fi=We;class me extends C{constructor(){super(...arguments),this.properties={timeInFrames:30},this._pending=[],this.size=[60,30]}onAction(t,e,s){var i=this.properties.timeInFrames;i<=0?this.trigger(null,e,s):this._pending.push([i,e])}onExecute(t,e){var s=1;this.isInputConnected(1)&&(this.properties.timeInFrames=this.getInputData(1));for(var i=0;i<this._pending.length;++i){var n=this._pending[i];n[0]-=s,!(n[0]>0)&&(this._pending.splice(i,1),--i,this.trigger(null,n[1],e))}}}me.slotLayout={inputs:[{name:"event",type:y.ACTION}],outputs:[{name:"on_time",type:y.EVENT}]};me.propertyLayout=[];me.optionalSlots={};class ye extends C{constructor(t){super(),this.properties={},this.size=[60,30],this.actionWidget=this.addWidget("text","Action","",null,{multiline:!0,max_length:100}),this.paramWidget=this.addWidget("text","Param","",null,{multiline:!0,max_length:100}),this.optionsWidget=this.addWidget("text","Opts","",null,{multiline:!0,max_length:100})}onAction(t,e,s){console.log("[LogEvent] Event received:",t,e,s),this.actionWidget.value=JSON.stringify(t),this.paramWidget.value=JSON.stringify(e),this.optionsWidget.value=JSON.stringify(s)}}ye.slotLayout={inputs:[{name:"event",type:y.ACTION}]};ye.propertyLayout=[];ye.optionalSlots={};class Is extends C{constructor(){super(...arguments),this.properties={onlyOnChange:!0},this.prev=0,this.size=[60,30]}onExecute(t,e){var s=this.getInputData(0),i=s!=this.prev;this.prev===0&&(i=!1);var n=i&&this.properties.onlyOnChange||!i&&!this.properties.onlyOnChange;s&&n&&this.triggerSlot(0,s,null,e),!s&&n&&this.triggerSlot(2,s,null,e),i&&this.triggerSlot(1,s,null,e),this.prev=s}}Is.slotLayout={inputs:[{name:"if",type:""}],outputs:[{name:"true",type:y.EVENT},{name:"change",type:y.EVENT},{name:"false",type:y.EVENT}]};let Os=class extends C{constructor(t){super(),this.size=[90,70]}getTitle(){return this.horizontal?"":this.title}onAction(t,e,s){if(this.outputs){s=s||{};for(var i=0;i<this.outputs.length;++i)s.action_call?s.action_call=s.action_call+"_seq_"+i:s.action_call=this.id+"_"+(t||"action")+"_seq_"+i+"_"+Math.floor(Math.random()*9999),this.triggerSlot(i,e,null,s)}}onConnectionsChange(t,e,s,i,n){const o=t===q.INPUT,a=t===q.INPUT?this.inputs:this.outputs,l=d=>o?this.getInputLink(a.length-1)?1:0:this.getOutputLinks(a.length-1).length,u=()=>{o?this.addInput("",y.ACTION):this.addOutput("",y.EVENT)};if(s)i!=null&&e===a.length-1&&u();else{if(l(a.length-1)>0)return;for(let d=a.length-1;d>0&&!(d<=0);d--)if(l()===0)o?this.removeInput(d):this.removeOutput(d);else break;l(a.length-1)>0&&u()}}};Os.slotLayout={inputs:[{name:"",type:y.ACTION},{name:"",type:y.ACTION},{name:"",type:y.ACTION}],outputs:[{name:"",type:y.EVENT},{name:"",type:y.EVENT},{name:"",type:y.EVENT}]};class Cs extends C{constructor(){super(...arguments),this.properties={}}onAction(t,e,s){var i=this.getInputData(1);this.triggerSlot(0,i,null,s)}}Cs.slotLayout={inputs:[{name:"trigger",type:y.ACTION},{name:"param",type:""}],outputs:[{name:"event",type:y.EVENT}]};function ft(){this.addProperty("interval",1e3),this.addProperty("event","tick"),this.addOutput("on_tick",y.EVENT),this.time=0,this.last_interval=1e3,this.triggered=!1}ft.title="Timer";ft.desc="Sends an event every N milliseconds";ft.prototype.onStart=function(){this.time=0};ft.prototype.getTitle=function(){return"Timer: "+this.last_interval.toString()+"ms"};ft.on_color="#AAA";ft.off_color="#222";ft.prototype.onDrawBackground=function(){this.boxcolor=this.triggered?ft.on_color:ft.off_color,this.triggered=!1};ft.prototype.onExecute=function(){var r=this.graph.elapsed_time*1e3,t=this.time==0;if(this.time+=r,this.last_interval=Math.max(1,this.getInputOrProperty("interval")|0),!t&&(this.time<this.last_interval||isNaN(this.last_interval))){this.inputs&&this.inputs.length>1&&this.inputs[1]&&this.setOutputData(1,!1);return}this.triggered=!0,this.time=this.time%this.last_interval,this.trigger("on_tick",this.properties.event),this.inputs&&this.inputs.length>1&&this.inputs[1]&&this.setOutputData(1,!0)};ft.prototype.onGetInputs=function(){return[["interval","number"]]};ft.prototype.onGetOutputs=function(){return[["tick","boolean"]]};const gi=r=>{r.registerNodeType({class:ve,title:"Delay",desc:"Delays one event",type:"events/delay"}),r.registerNodeType({class:Es,title:"Branch",desc:"If condition is true, outputs triggers true, otherwise false",type:"events/branch"}),r.registerNodeType("events/counter",Dt),r.registerNodeType({class:fi,title:"Filter Event",desc:"Blocks events that do not match the filter",type:"events/filter"}),r.registerNodeType({class:me,title:"Frame Delay",desc:"Delays one event by frame count",type:"events/frame_delay"}),r.registerNodeType("events/timer",ft),r.registerNodeType({class:ye,title:"Log Event",desc:"Log event in console",type:"events/log"}),r.registerNodeType({class:Os,title:"Sequence",desc:"Triggers a sequence of events when an event arrives",type:"events/sequence"}),r.registerNodeType({class:Is,title:"Trigger Event",desc:"Triggers event if input evaluates to true",type:"events/trigger"}),r.registerNodeType({class:Cs,title:"Wrap As Event",desc:"Triggers an event setting its parameter to the input value",type:"events/wrap_as_event"})};function wt(){this.addInput("A","Number"),this.addInput("B","Number"),this.addInput("C","Number"),this.addInput("D","Number"),this.values=[[],[],[],[]],this.properties={scale:2}}wt.title="Plot";wt.desc="Plots data over time";wt.colors=["#FFF","#F99","#9F9","#99F"];wt.prototype.onExecute=function(r){if(!this.flags.collapsed)for(var t=this.size,e=0;e<4;++e){var s=this.getInputData(e);if(s!=null){var i=this.values[e];i.push(s),i.length>t[0]&&i.shift()}}};wt.prototype.onDrawBackground=function(r){if(!this.flags.collapsed){var t=this.size,e=.5*t[1]/this.properties.scale,s=wt.colors,i=t[1]*.5;if(r.fillStyle="#000",r.fillRect(0,0,t[0],t[1]),r.strokeStyle="#555",r.beginPath(),r.moveTo(0,i),r.lineTo(t[0],i),r.stroke(),this.inputs)for(var n=0;n<4;++n){var o=this.values[n];if(!(!this.inputs[n]||!this.inputs[n].link)){r.strokeStyle=s[n],r.beginPath();var a=o[0]*e*-1+i;r.moveTo(0,Nt(a,0,t[1]));for(var l=1;l<o.length&&l<t[0];++l){var a=o[l]*e*-1+i;r.lineTo(l,Nt(a,0,t[1]))}r.stroke()}}}};const _i=r=>{r.registerNodeType("graphics/plot",wt)};function U(){this.addOutput("left_x_axis","number"),this.addOutput("left_y_axis","number"),this.addOutput("button_pressed",y.EVENT),this.properties={gamepad_index:0,threshold:.1},this._left_axis=new Float32Array(2),this._right_axis=new Float32Array(2),this._triggers=new Float32Array(2),this._previous_buttons=new Uint8Array(17),this._current_buttons=new Uint8Array(17)}U.title="Gamepad";U.desc="gets the input of the gamepad";U.CENTER=0;U.LEFT=1;U.RIGHT=2;U.UP=4;U.DOWN=8;U.zero=new Float32Array(2);U.buttons=["a","b","x","y","lb","rb","lt","rt","back","start","ls","rs","home"];U.prototype.onExecute=function(){var r=this.getGamepad(),t=this.properties.threshold||0;if(r&&(this._left_axis[0]=Math.abs(r.xbox.axes.lx)>t?r.xbox.axes.lx:0,this._left_axis[1]=Math.abs(r.xbox.axes.ly)>t?r.xbox.axes.ly:0,this._right_axis[0]=Math.abs(r.xbox.axes.rx)>t?r.xbox.axes.rx:0,this._right_axis[1]=Math.abs(r.xbox.axes.ry)>t?r.xbox.axes.ry:0,this._triggers[0]=Math.abs(r.xbox.axes.ltrigger)>t?r.xbox.axes.ltrigger:0,this._triggers[1]=Math.abs(r.xbox.axes.rtrigger)>t?r.xbox.axes.rtrigger:0),this.outputs)for(var e=0;e<this.outputs.length;e++){var s=this.outputs[e];if(!(!s.links||!s.links.length)){var i=null;if(r)switch(s.name){case"left_axis":i=this._left_axis;break;case"right_axis":i=this._right_axis;break;case"left_x_axis":i=this._left_axis[0];break;case"left_y_axis":i=this._left_axis[1];break;case"right_x_axis":i=this._right_axis[0];break;case"right_y_axis":i=this._right_axis[1];break;case"trigger_left":i=this._triggers[0];break;case"trigger_right":i=this._triggers[1];break;case"a_button":i=r.xbox.buttons.a?1:0;break;case"b_button":i=r.xbox.buttons.b?1:0;break;case"x_button":i=r.xbox.buttons.x?1:0;break;case"y_button":i=r.xbox.buttons.y?1:0;break;case"lb_button":i=r.xbox.buttons.lb?1:0;break;case"rb_button":i=r.xbox.buttons.rb?1:0;break;case"ls_button":i=r.xbox.buttons.ls?1:0;break;case"rs_button":i=r.xbox.buttons.rs?1:0;break;case"hat_left":i=r.xbox.hatmap&U.LEFT;break;case"hat_right":i=r.xbox.hatmap&U.RIGHT;break;case"hat_up":i=r.xbox.hatmap&U.UP;break;case"hat_down":i=r.xbox.hatmap&U.DOWN;break;case"hat":i=r.xbox.hatmap;break;case"start_button":i=r.xbox.buttons.start?1:0;break;case"back_button":i=r.xbox.buttons.back?1:0;break;case"button_pressed":for(var n=0;n<this._current_buttons.length;++n)this._current_buttons[n]&&!this._previous_buttons[n]&&this.triggerSlot(e,U.buttons[n]);break}else switch(s.name){case"button_pressed":break;case"left_axis":case"right_axis":i=U.zero;break;default:i=0}this.setOutputData(e,i)}}};U.mapping={a:0,b:1,x:2,y:3,lb:4,rb:5,lt:6,rt:7,back:8,start:9,ls:10,rs:11};U.mapping_array=["a","b","x","y","lb","rb","lt","rt","back","start","ls","rs"];U.prototype.getGamepad=function(){var r=navigator.getGamepads;if(!r)return null;var t=r.call(navigator),e=null;this._previous_buttons.set(this._current_buttons);for(var s=this.properties.gamepad_index;s<4;s++)if(t[s]){e=t[s];var i=this.xbox_mapping;i||(i=this.xbox_mapping={axes:[],buttons:{},hat:"",hatmap:U.CENTER}),i.axes.lx=e.axes[0],i.axes.ly=e.axes[1],i.axes.rx=e.axes[2],i.axes.ry=e.axes[3],i.axes.ltrigger=e.buttons[6].value,i.axes.rtrigger=e.buttons[7].value,i.hat="",i.hatmap=U.CENTER;for(var n=0;n<e.buttons.length;n++)if(this._current_buttons[n]=e.buttons[n].pressed,n<12)i.buttons[U.mapping_array[n]]=e.buttons[n].pressed,e.buttons[n].was_pressed&&this.trigger(U.mapping_array[n]+"_button_event");else switch(n){case 12:e.buttons[n].pressed&&(i.hat+="up",i.hatmap|=U.UP);break;case 13:e.buttons[n].pressed&&(i.hat+="down",i.hatmap|=U.DOWN);break;case 14:e.buttons[n].pressed&&(i.hat+="left",i.hatmap|=U.LEFT);break;case 15:e.buttons[n].pressed&&(i.hat+="right",i.hatmap|=U.RIGHT);break;case 16:i.buttons.home=e.buttons[n].pressed;break}return e.xbox=i,e}};U.prototype.onDrawBackground=function(r){if(!this.flags.collapsed){var t=this._left_axis,e=this._right_axis;r.strokeStyle="#88A",r.strokeRect((t[0]+1)*.5*this.size[0]-4,(t[1]+1)*.5*this.size[1]-4,8,8),r.strokeStyle="#8A8",r.strokeRect((e[0]+1)*.5*this.size[0]-4,(e[1]+1)*.5*this.size[1]-4,8,8);var s=this.size[1]/this._current_buttons.length;r.fillStyle="#AEB";for(var i=0;i<this._current_buttons.length;++i)this._current_buttons[i]&&r.fillRect(0,s*i,6,s)}};U.prototype.onGetOutputs=function(){return[["left_axis","vec2"],["right_axis","vec2"],["left_x_axis","number"],["left_y_axis","number"],["right_x_axis","number"],["right_y_axis","number"],["trigger_left","number"],["trigger_right","number"],["a_button","number"],["b_button","number"],["x_button","number"],["y_button","number"],["lb_button","number"],["rb_button","number"],["ls_button","number"],["rs_button","number"],["start_button","number"],["back_button","number"],["a_button_event",y.EVENT],["b_button_event",y.EVENT],["x_button_event",y.EVENT],["y_button_event",y.EVENT],["lb_button_event",y.EVENT],["rb_button_event",y.EVENT],["ls_button_event",y.EVENT],["rs_button_event",y.EVENT],["start_button_event",y.EVENT],["back_button_event",y.EVENT],["hat_left","number"],["hat_right","number"],["hat_up","number"],["hat_down","number"],["hat","number"],["button_pressed",y.EVENT]]};const vi=r=>{r.registerNodeType({class:U,type:"input/gamepad"})};class As extends C{onExecute(){let t=!0;for(let e=0;e<this.inputs.length;e++)if(!this.getInputData(e)){t=!1;break}this.setOutputData(0,t)}}As.slotLayout={inputs:[{name:"a",type:"boolean"},{name:"b",type:"boolean"}],outputs:[{name:"out",type:"boolean"}]};class Ve extends C{constructor(){super(),this.properties={},this.addInput("onTrigger",y.ACTION),this.addInput("condition","boolean"),this.addOutput("true",y.EVENT),this.addOutput("false",y.EVENT),this.mode=nt.ON_TRIGGER}onExecute(){this.getInputData(1)?this.triggerSlot(0):this.triggerSlot(1)}}Ve.title="Branch";Ve.desc="Branch execution on condition";class qe extends C{constructor(){super(),this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean")}onExecute(){const t=this.getInputData(0)===this.getInputData(1);this.setOutputData(0,t)}onGetInputs(){return[["bool","boolean"]]}}qe.title="Compare";qe.desc="Compare for logical equality";class Ss extends C{onExecute(){var t=!this.getInputData(0);this.setOutputData(0,t)}}Ss.slotLayout={inputs:[{name:"in",type:"boolean"}],outputs:[{name:"out",type:"boolean"}]};class ks extends C{onExecute(){let t=!1;for(let e=0;e<this.inputs.length;e++)if(this.getInputData(e)){t=!0;break}this.setOutputData(0,t)}}ks.slotLayout={inputs:[{name:"a",type:"boolean"},{name:"b",type:"boolean"}],outputs:[{name:"out",type:"boolean"}]};class Ye extends C{onExecute(){const t=this.getInputData(0);this.setOutputData(0,!!t)}}Ye.slotLayout={inputs:[{name:"in",type:"*"}],outputs:[{name:"truthy",type:"boolean"}]};Ye.propertyLayout=[];function zt(){this.addInput("sel","number"),this.addInput("A"),this.addInput("B"),this.addInput("C"),this.addInput("D"),this.addOutput("out"),this.selected=0}zt.title="Selector";zt.desc="selects an output";zt.prototype.onDrawBackground=function(r){if(!this.flags.collapsed){r.fillStyle="#AFB";var t=(this.selected+1)*h.NODE_SLOT_HEIGHT+6;r.beginPath(),r.moveTo(50,t),r.lineTo(50,t+h.NODE_SLOT_HEIGHT),r.lineTo(34,t+h.NODE_SLOT_HEIGHT*.5),r.fill()}};zt.prototype.onExecute=function(){var r=this.getInputData(0);(r==null||r.constructor!==Number)&&(r=0),this.selected=r=Math.round(r)%(this.inputs.length-1);var t=this.getInputData(r+1);t!==void 0&&this.setOutputData(0,t)};zt.prototype.onGetInputs=function(){return[["E",0],["F",0],["G",0],["H",0]]};class ws extends C{constructor(){super(),this.selected=0,this.addInput("sel","number"),this.addInput("A","*"),this.addInput("B","*"),this.addInput("C","*"),this.addInput("D","*"),this.addOutput("out","*"),this.selected=0}onDrawBackground(t){if(this.flags.collapsed)return;t.fillStyle="#AFB";const e=(this.selected+1)*h.NODE_SLOT_HEIGHT+6;t.beginPath(),t.moveTo(50,e),t.lineTo(50,e+h.NODE_SLOT_HEIGHT),t.lineTo(34,e+h.NODE_SLOT_HEIGHT*.5),t.fill()}onExecute(){let t=this.getInputData(0);(t==null||typeof t!="number")&&(t=0),this.selected=t=Math.round(t)%(this.inputs.length-1);const e=this.getInputData(t+1);e!==void 0&&this.setOutputData(0,e)}onGetInputs(){return[["E",0],["F",0],["G",0],["H",0]]}}ws.title="Selector";ws.desc="selects an output";class Xe extends C{constructor(){super(),this.current_sequence="",this.properties={sequence:"A,B,C"},this.addInput("index","number"),this.addInput("seq","*"),this.addOutput("out","*"),this.index=0,this.values=this.properties.sequence.split(",")}onPropertyChanged(t,e){t=="sequence"&&(this.values=e.split(","))}onExecute(){const t=this.getInputData(1);t&&t!==this.current_sequence&&(this.current_sequence=t,this.values=t.split(","));let e=this.getInputData(0);typeof e!="number"&&(e=0),this.index=e=Math.round(e)%this.values.length,this.setOutputData(0,this.values[e])}}Xe.title="Sequence";Xe.desc="select one element from a sequence from a string";const mi=r=>{r.registerNodeType({class:As,title:"AND",desc:"Return true if all inputs are true",type:"logic/and"}),r.registerNodeType({type:"logic/branch",class:Ve}),r.registerNodeType({type:"logic/compare",class:qe}),r.registerNodeType({class:Ss,title:"NOT",desc:"Return the logical negation",type:"logic/not"}),r.registerNodeType({class:ks,title:"OR",desc:"Return true if at least one input is true",type:"logic/or"}),r.registerNodeType({type:"logic/truthy",class:Ye,title:"~= TRUE",desc:"Returns true if input is truthy"}),r.registerNodeType({type:"logic/selector",class:zt,title:"Selector",desc:"selects an output"}),r.registerNodeType({type:"logic/sequence",class:Xe})},Ds=class Ls extends C{constructor(){super(...arguments),this.size=[80,30]}static approxEq(t,e,s){return s==null&&(s=.001),Math.abs(t-e)<s}onExecute(){const t=this.getInputData(0),e=this.getInputData(1);if(t==null||e==null)return;const s=this.getInputData(2)||this.properties.epsilon,i=Ls.approxEq(t,e,s);this.setOutputData(0,i),this.setOutputData(1,!i)}};Ds.slotLayout={inputs:[{name:"A",type:"number"},{name:"B",type:"number"},{name:"epsilon",type:"number"}],outputs:[{name:"true",type:"boolean"},{name:"false",type:"boolean"}]};let yi=Ds;class Ps extends C{constructor(){super(...arguments),this.size=[80,30]}onExecute(){var t=this.getInputData(0);t!=null&&this.setOutputData(0,Math.floor(t))}}Ps.slotLayout={inputs:[{name:"in",type:"number"}],outputs:[{name:"out",type:"number"}]};class je extends C{constructor(){super(...arguments),this.properties={A:1,B:1,OP:"+"},this._func=(t,e)=>t+e,this._result=[],this.size=[100,60]}getTitle(){return this.properties.OP=="max"||this.properties.OP=="min"?this.properties.OP+"(A,B)":"A "+this.properties.OP+" B"}setValue(t){typeof t=="string"&&(t=parseFloat(t)),this.properties.value=t}onPropertyChanged(t,e){if(t=="OP")switch(this.properties.OP){case"+":this._func=function(s,i){return s+i};break;case"-":this._func=function(s,i){return s-i};break;case"*":this._func=function(s,i){return s*i};break;case"/":this._func=function(s,i){return s/i};break;case"%":this._func=function(s,i){return s%i};break;case"^":this._func=function(s,i){return Math.pow(s,i)};break;case"max":this._func=function(s,i){return Math.max(s,i)};break;case"min":this._func=function(s,i){return Math.min(s,i)};break;default:console.warn("Unknown operation: "+this.properties.OP),this._func=function(s){return s};break}}onExecute(){var t=this.getInputData(0),e=this.getInputData(1);t!=null?t.constructor===Number&&(this.properties.A=t):t=this.properties.A,e!=null?this.properties.B=e:e=this.properties.B;var s;if(t.constructor===Number)s=0,s=this._func(t,e);else if(t.constructor===Array){s=this._result,s.length=t.length;for(var i=0;i<t.length;++i)s[i]=this._func(t[i],e)}else{s={};for(let n in t)s[n]=this._func(t[n],e)}this.setOutputData(0,s)}onDrawBackground(t){this.flags.collapsed||(t.font="40px Arial",t.fillStyle="#666",t.textAlign="center",t.fillText(this.properties.OP,this.size[0]*.5,(this.size[1]+h.NODE_TITLE_HEIGHT)*.5),t.textAlign="left")}}je.values=["+","-","*","/","%","^","max","min"];je.slotLayout={inputs:[{name:"A",type:"number,array,object"},{name:"B",type:"number"}],outputs:[{name:"=",type:"number"}]};function ut(){this.addInput("in","number"),this.addOutput("out","number"),this.addProperty("min",0),this.addProperty("max",1),this.addProperty("smooth",!0),this.addProperty("seed",0),this.addProperty("octaves",1),this.addProperty("persistence",.8),this.addProperty("speed",1),this.size=[90,30]}ut.title="Noise";ut.desc="Random number with temporal continuity";ut.data=null;ut.getValue=function(r,t){if(!ut.data){ut.data=new Float32Array(1024);for(var e=0;e<ut.data.length;++e)ut.data[e]=Math.random()}r=r%1024,r<0&&(r+=1024);var s=Math.floor(r);r=r-s;var i=ut.data[s],n=ut.data[s==1023?0:s+1];return t&&(r=r*r*r*(r*(r*6-15)+10)),i*(1-r)+n*r};ut.prototype.onExecute=function(){var r=this.getInputData(0)||0,t=this.properties.octaves||1,e=0,s=1,i=this.properties.seed||0;r+=i;for(var n=this.properties.speed||1,o=0,a=0;a<t&&(e+=ut.getValue(r*(1+a)*n,this.properties.smooth)*s,o+=s,s*=this.properties.persistence,!(s<.001));++a);e/=o;var l=this.properties.min,u=this.properties.max;this._last_v=e*(u-l)+l,this.setOutputData(0,this._last_v)};ut.prototype.onDrawBackground=function(r){this.outputs[0].label=(this._last_v||0).toFixed(3)};function Ht(){this.addOutput("value","number"),this.addProperty("min",0),this.addProperty("max",1),this.size=[80,30]}Ht.title="Rand";Ht.desc="Random number";Ht.prototype.onExecute=function(){if(this.inputs)for(var r=0;r<this.inputs.length;r++){var t=this.inputs[r],e=this.getInputData(r);e!==void 0&&(this.properties[t.name]=e)}var s=this.properties.min,i=this.properties.max;this._last_v=Math.random()*(i-s)+s,this.setOutputData(0,this._last_v)};Ht.prototype.onDrawBackground=function(r){this.outputs[0].label=(this._last_v||0).toFixed(3)};Ht.prototype.onGetInputs=function(){return[["min","number"],["max","number"]]};const bi=r=>{r.registerNodeType({class:yi,title:"Approx. Eq",desc:"Check if two floating-point numbers are approximately equal",type:"math/approx_eq"}),r.registerNodeType({class:Ps,title:"Floor",desc:"Floor number to remove fractional part",type:"math/floor"}),r.registerNodeType("math/noise",ut),r.registerNodeType({class:je,title:"Operation",desc:"Easy math operators",type:"math/operation"}),r.registerNodeType("math/rand",Ht)},_t="#234",ht=class K extends C{constructor(t){super(),this.channel=0,this.cmd=0,this.data=new Uint32Array(3),t&&this.setup(t)}static computePitch(t){return Math.pow(2,(t-69)/12)*440}static computePitchBend(t,e){return t+(e<<7)-8192}static computeCommandFromString(t){if(!t)return 0;if(t&&t.constructor===Number)return t;switch(t=t.toUpperCase(),t){case"NOTE ON":case"NOTEON":return K.NOTEON;case"NOTE OFF":case"NOTEOFF":return K.NOTEON;case"KEY PRESSURE":case"KEYPRESSURE":return K.KEYPRESSURE;case"CONTROLLER CHANGE":case"CONTROLLERCHANGE":case"CC":return K.CONTROLLERCHANGE;case"PROGRAM CHANGE":case"PROGRAMCHANGE":case"PC":return K.PROGRAMCHANGE;case"CHANNEL PRESSURE":case"CHANNELPRESSURE":return K.CHANNELPRESSURE;case"PITCH BEND":case"PITCHBEND":return K.PITCHBEND;case"TIME TICK":case"TIMETICK":return K.TIMETICK;default:return Number(t)}}static toNoteString(t,e){t=Math.round(t);var s=t-21,i=Math.floor((t-24)/12+1);return s=s%12,s<0&&(s=12+s),K.notes[s]+(e?"":i)}static NoteStringToPitch(t){t=t.toUpperCase();var e=t[0],s=4;t[1]=="#"?(e+="#",t.length>2&&(s=Number(t[2]))):t.length>1&&(s=Number(t[1]));var i=K.note_to_index[e];return i==null?null:(s-1)*12+i+21}fromJSON(t){this.setup(t.data)}setup(t){var e=t;t.constructor===Object&&(e=t.data),this.data.set(e);var s=e[0];this.status=s;var i=s&240;s>=240?this.cmd=s:this.cmd=i,this.cmd==K.NOTEON&&this.velocity==0&&(this.cmd=K.NOTEOFF),this.cmd_str=K.commands[this.cmd]||"",(i>=K.NOTEON||i<=K.NOTEOFF)&&(this.channel=s&15)}getPitch(){return Math.pow(2,(this.data[1]-69)/12)*440}getCC(){return this.data[1]}getCCValue(){return this.data[2]}getPitchBend(){return this.data[1]+(this.data[2]<<7)-8192}setCommandFromString(t){this.cmd=K.computeCommandFromString(t)}toString(){var t=""+this.channel+". ";switch(this.cmd){case K.NOTEON:t+="NOTEON "+K.toNoteString(this.data[1]);break;case K.NOTEOFF:t+="NOTEOFF "+K.toNoteString(this.data[1]);break;case K.CONTROLLERCHANGE:t+="CC "+this.data[1]+" "+this.data[2];break;case K.PROGRAMCHANGE:t+="PC "+this.data[1];break;case K.PITCHBEND:t+="PITCHBEND "+this.getPitchBend();break;case K.KEYPRESSURE:t+="KEYPRESS "+this.data[1];break}return t}toHexString(){for(var t="",e=0;e<this.data.length;e++)t+=this.data[e].toString(16)+" "}toJSON(){return{data:[this.data[0],this.data[1],this.data[2]],object_class:"MIDIEvent"}}};ht.notes=["A","A#","B","C","C#","D","D#","E","F","F#","G","G#"];ht.note_to_index={A:0,"A#":1,B:2,C:3,"C#":4,D:5,"D#":6,E:7,F:8,"F#":9,G:10,"G#":11};ht.NOTEOFF=128;ht.NOTEON=144;ht.KEYPRESSURE=160;ht.CONTROLLERCHANGE=176;ht.PROGRAMCHANGE=192;ht.CHANNELPRESSURE=208;ht.PITCHBEND=224;ht.TIMETICK=248;ht.commands={128:"note off",144:"note on",160:"key pressure",176:"controller change",192:"program change",208:"channel pressure",224:"pitch bend",240:"system",242:"Song pos",243:"Song select",246:"Tune request",248:"time tick",250:"Start Song",251:"Continue Song",252:"Stop Song",254:"Sensing",255:"Reset"};ht.commands_short={128:"NOTEOFF",144:"NOTEOFF",160:"KEYP",176:"CC",192:"PC",208:"CP",224:"PB",240:"SYS",242:"POS",243:"SELECT",246:"TUNEREQ",248:"TT",250:"START",251:"CONTINUE",252:"STOP",254:"SENS",255:"RESET"};ht.commands_reversed={};let k=ht;for(var ts in k.commands)k.commands_reversed[k.commands[ts]]=ts;Object.defineProperty(k.prototype,"note",{get:function(){return this.cmd!=k.NOTEON?-1:k.toNoteString(this.data[1],!0)},set:function(r){throw"notes cannot be assigned this way, must modify the data[1]"},enumerable:!0});Object.defineProperty(k.prototype,"octave",{get:function(){if(this.cmd!=k.NOTEON)return-1;var r=this.data[1]-24;return Math.floor(r/12+1)},set:function(r){throw"octave cannot be assigned this way, must modify the data[1]"},enumerable:!0});Object.defineProperty(k.prototype,"velocity",{get:function(){return this.cmd==k.NOTEON?this.data[2]:-1},set:function(r){this.data[2]=r},enumerable:!0});const be=class Me extends C{constructor(t,e){if(super(),!navigator.requestMIDIAccess){this.error="not suppoorted",e?e("Not supported"):console.error("MIDI NOT SUPPORTED, enable by chrome://flags");return}this.on_ready=t,this.state={note:[],cc:[]},this.input_ports=null,this.input_ports_info=[],this.output_ports=null,this.output_ports_info=[],navigator.requestMIDIAccess().then(this.onMIDISuccess.bind(this),this.onMIDIFailure.bind(this))}static parseMsg(t){}onMIDISuccess(t){console.log("MIDI ready!"),console.log(t),this.midi=t,this.updatePorts(),this.on_ready&&this.on_ready(this)}updatePorts(){var t=this.midi;this.input_ports=t.inputs,this.input_ports_info=[],this.output_ports=t.outputs,this.output_ports_info=[];for(var e=0,i=this.input_ports.values(),n=i.next();n&&n.done===!1;){var s=n.value;this.input_ports_info.push(s),console.log("Input port [type:'"+s.type+"'] id:'"+s.id+"' manufacturer:'"+s.manufacturer+"' name:'"+s.name+"' version:'"+s.version+"'"),e++,n=i.next()}this.num_input_ports=e,e=0;for(var i=this.output_ports.values(),n=i.next();n&&n.done===!1;){var s=n.value;this.output_ports_info.push(s),console.log("Output port [type:'"+s.type+"'] id:'"+s.id+"' manufacturer:'"+s.manufacturer+"' name:'"+s.name+"' version:'"+s.version+"'"),e++,n=i.next()}this.num_output_ports=e}onMIDIFailure(t){console.error("Failed to get MIDI access - "+t)}openInputPort(t,e){var s=this.input_ports.get("input-"+t);if(!s)return!1;var i=this;return s.onmidimessage=function(n){var o=new k(n.data);i.updateState(o),e&&e(n.data,o),Me.on_message&&Me.on_message(n.data,o)},console.log("port open: ",s),!0}updateState(t){switch(t.cmd){case k.NOTEON:this.state.note[t.value1|0]=t.value2;break;case k.NOTEOFF:this.state.note[t.value1|0]=0;break;case k.CONTROLLERCHANGE:this.state.cc[t.getCC()]=t.getCCValue();break}}sendMIDI(t,e){if(e){var s=this.output_ports_info[t];s&&(e.constructor===k?s.send(e.data):s.send(e))}}};be.input=null;be.output=null;be.MIDIEvent=k;let Gt=be;class Te extends C{constructor(){super(),this.properties={channel:0,cc:1,value:0},this.addOutput("value","number")}onExecute(){this.properties,Gt.input&&(this.properties.value=Gt.input.state.cc[this.properties.cc]),this.setOutputData(0,this.properties.value)}}Te.title="MIDICC";Te.desc="gets a Controller Change";Te.color=_t;class Ee extends C{constructor(){super(),this.properties={channel:0,cmd:144,value1:1,value2:1},this.addInput("send",y.EVENT),this.addInput("assign",y.EVENT),this.addOutput("on_midi",y.EVENT),this.midi_event=new k,this.gate=!1}onAction(t,s){if(t=="assign"){this.properties.channel=s.channel,this.properties.cmd=s.cmd,this.properties.value1=s.data[1],this.properties.value2=s.data[2],s.cmd==k.NOTEON?this.gate=!0:s.cmd==k.NOTEOFF&&(this.gate=!1);return}var s=this.midi_event;s.channel=this.properties.channel,this.properties.cmd&&this.properties.cmd.constructor===String?s.setCommandFromString(this.properties.cmd):s.cmd=this.properties.cmd,s.data[0]=s.cmd|s.channel,s.data[1]=Number(this.properties.value1),s.data[2]=Number(this.properties.value2),this.trigger("on_midi",s)}onExecute(){var t=this.properties;if(this.inputs)for(var e=0;e<this.inputs.length;++e){var s=this.inputs[e];if(s.link!=-1)switch(s.name){case"note":var i=this.getInputData(e);i!=null&&(i.constructor===String&&(i=k.NoteStringToPitch(i)),this.properties.value1=(i|0)%255);break;case"cmd":var i=this.getInputData(e);i!=null&&(this.properties.cmd=i);break;case"value1":var i=this.getInputData(e);i!=null&&(this.properties.value1=Nt(i|0,0,127));break;case"value2":var i=this.getInputData(e);i!=null&&(this.properties.value2=Nt(i|0,0,127));break}}if(this.outputs)for(var e=0;e<this.outputs.length;++e){var n=this.outputs[e],i=null;switch(n.name){case"midi":i=new k,i.setup([t.cmd,t.value1,t.value2]),i.channel=t.channel;break;case"command":i=t.cmd;break;case"cc":i=t.value1;break;case"cc_value":i=t.value2;break;case"note":i=t.cmd==k.NOTEON||t.cmd==k.NOTEOFF?t.value1:null;break;case"velocity":i=t.cmd==k.NOTEON?t.value2:null;break;case"pitch":i=t.cmd==k.NOTEON?k.computePitch(t.value1):null;break;case"pitchbend":i=t.cmd==k.PITCHBEND?k.computePitchBend(t.value1,t.value2):null;break;case"gate":i=this.gate;break;default:continue}i!==null&&this.setOutputData(e,i)}}onPropertyChanged(t,e){t=="cmd"&&(this.properties.cmd=k.computeCommandFromString(e))}onGetInputs(){return[["cmd","number"],["note","number"],["value1","number"],["value2","number"]]}onGetOutputs(){return[["midi","midi"],["on_midi",y.EVENT],["command","number"],["note","number"],["velocity","number"],["cc","number"],["cc_value","number"],["pitch","number"],["gate","bool"],["pitchbend","number"]]}}Ee.title="MIDIEvent";Ee.desc="Create a MIDI Event";Ee.color=_t;class jt extends C{constructor(){super(),this.properties={channel:-1,cmd:-1,min_value:-1,max_value:-1};var t=this;this._learning=!1,this.addWidget("button","Learn","",function(){t._learning=!0,t.boxcolor="#FA3"}),this.addInput("in",y.EVENT),this.addOutput("on_midi",y.EVENT),this.boxcolor="#AAA"}getTitle(){var t=null;return this.properties.cmd==-1?t="Nothing":t=k.commands_short[this.properties.cmd]||"Unknown",this.properties.min_value!=-1&&this.properties.max_value!=-1&&(t+=" "+(this.properties.min_value==this.properties.max_value?this.properties.max_value:this.properties.min_value+".."+this.properties.max_value)),"Filter: "+t}onPropertyChanged(t,e){if(t=="cmd"){var s=Number(e);isNaN(s)&&(s=k.commands[e]||0),this.properties.cmd=s}}onAction(t,e){if(!(!e||e.constructor!==k)){if(this._learning)this._learning=!1,this.boxcolor="#AAA",this.properties.channel=e.channel,this.properties.cmd=e.cmd,this.properties.min_value=this.properties.max_value=e.data[1];else if(this.properties.channel!=-1&&e.channel!=this.properties.channel||this.properties.cmd!=-1&&e.cmd!=this.properties.cmd||this.properties.min_value!=-1&&e.data[1]<this.properties.min_value||this.properties.max_value!=-1&&e.data[1]>this.properties.max_value)return;this.trigger("on_midi",e)}}}jt.title="MIDI Filter";jt.desc="Filters MIDI messages";jt.color=_t;jt["@cmd"]={type:"enum",title:"Command",values:k.commands_reversed};class Ne extends C{constructor(){super(),this.properties={url:"",autoplay:!0},this.addInput("play",y.ACTION),this.addInput("pause",y.ACTION),this.addOutput("note",y.EVENT),this._midi=null,this._current_time=0,this._playing=!1,typeof window.MidiParser>"u"&&(console.error("midi-parser.js not included, LGMidiPlay requires that library: https://raw.githubusercontent.com/colxi/midi-parser-js/master/src/main.js"),this.boxcolor="red")}onAction(t){t=="play"?this.play():t=="pause"&&(this._playing=!this._playing)}onPropertyChanged(t,e){t=="url"&&this.loadMIDIFile(e)}onExecute(){if(this._midi&&this._playing){this._current_time+=this.graph.elapsed_time;for(var t=this._current_time*100,e=0;e<this._midi.tracks;++e){var s=this._midi.track[e];s._last_pos||(s._last_pos=0,s._time=0);var i=s.event[s._last_pos];if(i&&s._time+i.deltaTime<=t&&(s._last_pos++,s._time+=i.deltaTime,i.data)){var n=i.type<<4+i.channel,o=new k;o.setup([n,i.data[0],i.data[1]]),this.trigger("note",o)}}}}play(){if(this._playing=!0,this._current_time=0,!!this._midi)for(var t=0;t<this._midi.tracks;++t){var e=this._midi.track[t];e._last_pos=0,e._time=0}}loadMIDIFile(t){var e=this;h.fetchFile(t,"arraybuffer",function(s){e.boxcolor="#AFA",e._midi=window.MidiParser.parse(new Uint8Array(s)),e.properties.autoplay&&e.play()},function(s){e.boxcolor="#FAA",e._midi=null})}onDropFile(t){this.properties.url="",this.loadMIDIFile(t)}}Ne.title="MIDI fromFile";Ne.desc="Plays a MIDI file";Ne.color=_t;const Ie=class se extends C{constructor(){super(),this.addInput("generate",y.ACTION),this.addInput("scale","string"),this.addInput("octave","number"),this.addOutput("note",y.EVENT),this.properties={notes:"A,A#,B,C,C#,D,D#,E,F,F#,G,G#",octave:2,duration:.5,mode:"sequence"},this.notes_pitches=se.processScale(this.properties.notes),this.sequence_index=0}static processScale(t){for(var e=t.split(","),s=0;s<e.length;++s){var i=e[s];i.length==2&&i[1]!="#"||i.length>2?e[s]=-k.NoteStringToPitch(i):e[s]=k.note_to_index[i]||0}return e}onPropertyChanged(t,e){t=="notes"&&(this.notes_pitches=se.processScale(e))}onExecute(){var t=this.getInputData(2);t!=null&&(this.properties.octave=t);var e=this.getInputData(1);e&&(this.notes_pitches=se.processScale(e))}onAction(t){var e=0,s=this.notes_pitches.length,i=0;this.properties.mode=="sequence"?i=this.sequence_index=(this.sequence_index+1)%s:this.properties.mode=="random"&&(i=Math.floor(Math.random()*s));var n=this.notes_pitches[i];n>=0?e=n+(this.properties.octave-1)*12+33:e=-n;const o=new k;o.setup([k.NOTEON,e,10]);var a=this.properties.duration||1;this.trigger("note",o),setTimeout((function(){var l=new k;l.setup([k.NOTEOFF,e,0]),this.trigger("note",l)}).bind(this),a*1e3)}};Ie.title="MIDI Generator";Ie.desc="Generates a random MIDI note";Ie.color=_t;let Rs=Ie;class Kt extends C{constructor(){super(),this.addOutput("on_midi",y.EVENT),this.addOutput("out","midi"),this.properties={port:0},this._last_midi_event=null,this._current_midi_event=null,this.boxcolor="#AAA",this._last_time=0;var t=this;new Gt(function(e){t._midi=e,t._waiting&&t.onStart(),t._waiting=!1})}getPropertyInfo(t){if(this._midi&&t=="port"){for(var e={},s=0;s<this._midi.input_ports_info.length;++s){var i=this._midi.input_ports_info[s];e[s]=s+".- "+i.name+" version:"+i.version}return{type:"enum",values:e}}}onStart(){this._midi?this._midi.openInputPort(this.properties.port,this.onMIDIEvent.bind(this)):this._waiting=!0}onMIDIEvent(t,e){this._last_midi_event=e,this.boxcolor="#AFA",this._last_time=Yt.getTime(),this.trigger("on_midi",e),e.cmd==k.NOTEON?this.trigger("on_noteon",e):e.cmd==k.NOTEOFF?this.trigger("on_noteoff",e):e.cmd==k.CONTROLLERCHANGE?this.trigger("on_cc",e):e.cmd==k.PROGRAMCHANGE?this.trigger("on_pc",e):e.cmd==k.PITCHBEND&&this.trigger("on_pitchbend",e)}onDrawBackground(t){if(this.boxcolor="#AAA",!this.flags.collapsed&&this._last_midi_event){t.fillStyle="white";var e=Yt.getTime(),s=1-Math.max(0,(e-this._last_time)*.001);if(s>0){var i=t.globalAlpha;t.globalAlpha*=s,t.font="12px Tahoma",t.fillText(this._last_midi_event.toString(),2,this.size[1]*.5+3),t.globalAlpha=i}}}onExecute(){if(this.outputs)for(var t=this._last_midi_event,e=0;e<this.outputs.length;++e){var s=this.outputs[e],i=null;switch(s.name){case"midi":i=this._midi;break;case"last_midi":i=t;break;default:continue}this.setOutputData(e,i)}}onGetOutputs(){return[["last_midi","midi"],["on_midi",y.EVENT],["on_noteon",y.EVENT],["on_noteoff",y.EVENT],["on_cc",y.EVENT],["on_pc",y.EVENT],["on_pitchbend",y.EVENT]]}}Kt.MIDIInterface=Gt;Kt.title="MIDI Input";Kt.desc="Reads MIDI from a input port";Kt.color=_t;const Jt=class xe extends C{constructor(){super(),this.properties={num_octaves:2,start_octave:2},this.addInput("note",y.ACTION),this.addInput("reset",y.ACTION),this.addOutput("note",y.EVENT),this.size=[400,100],this.keys=[],this._last_key=-1}onDrawForeground(t){if(!this.flags.collapsed){var e=this.properties.num_octaves*12;this.keys.length=e;var s=this.size[0]/(this.properties.num_octaves*7),i=this.size[1];t.globalAlpha=1;for(var n=0;n<2;n++)for(var o=0;o<e;++o){var a=xe.keys[o%12];if(a.t==n){var l=Math.floor(o/12),u=l*7*s+a.x*s;n==0?t.fillStyle=this.keys[o]?"#CCC":"white":t.fillStyle=this.keys[o]?"#333":"black",t.fillRect(u+1,0,s*a.w-2,i*a.h)}}}}getKeyIndex(t){this.properties.num_octaves*12;for(var e=this.size[0]/(this.properties.num_octaves*7),s=this.size[1],i=1;i>=0;i--)for(var n=0;n<this.keys.length;++n){var o=xe.keys[n%12];if(o.t==i){var a=Math.floor(n/12),l=a*7*e+o.x*e,u=e*o.w,d=s*o.h;if(!(t[0]<l||t[0]>l+u||t[1]>d))return n}}return-1}onAction(t,e){if(t=="reset"){for(var s=0;s<this.keys.length;++s)this.keys[s]=!1;return}if(!(!e||e.constructor!==k)){var i=e,n=(this.properties.start_octave-1)*12+29,o=i.data[1]-n;o>=0&&o<this.keys.length&&(i.data[0]==k.NOTEON?this.keys[o]=!0:i.data[0]==k.NOTEOFF&&(this.keys[o]=!1)),this.trigger("note",i)}}onMouseDown(t,e){if(!(e[1]<0)){var s=this.getKeyIndex(e);this.keys[s]=!0,this._last_key=s;var i=(this.properties.start_octave-1)*12+29+s,n=new k;return n.setup([k.NOTEON,i,100]),this.trigger("note",n),!0}}onMouseMove(t,e){if(e[1]<0||this._last_key==-1)return;this.setDirtyCanvas(!0);const s=this.getKeyIndex(e);if(this._last_key==s)return!0;this.keys[this._last_key]=!1;const i=(this.properties.start_octave-1)*12+29+this._last_key,n=new k;n.setup([k.NOTEOFF,i,100]),this.trigger("note",n),this.keys[s]=!0;const o=(this.properties.start_octave-1)*12+29+s,a=new k;return a.setup([k.NOTEON,o,100]),this.trigger("note",a),this._last_key=s,!0}onMouseUp(t,e){if(!(e[1]<0)){var s=this.getKeyIndex(e);this.keys[s]=!1,this._last_key=-1;var i=(this.properties.start_octave-1)*12+29+s,n=new k;return n.setup([k.NOTEOFF,i,100]),this.trigger("note",n),!0}}};Jt.title="MIDI Keys";Jt.desc="Keyboard to play notes";Jt.color=_t;Jt.keys=[{x:0,w:1,h:1,t:0},{x:.75,w:.5,h:.6,t:1},{x:1,w:1,h:1,t:0},{x:1.75,w:.5,h:.6,t:1},{x:2,w:1,h:1,t:0},{x:2.75,w:.5,h:.6,t:1},{x:3,w:1,h:1,t:0},{x:4,w:1,h:1,t:0},{x:4.75,w:.5,h:.6,t:1},{x:5,w:1,h:1,t:0},{x:5.75,w:.5,h:.6,t:1},{x:6,w:1,h:1,t:0}];let Ti=Jt;const Ut=class Ms extends C{constructor(){super(),this.addInput("send",y.EVENT),this.properties={port:0};var t=this;new Gt(e=>{this._midi=e,this.widget.options.values=t.getMIDIOutputs()}),this.widget=this.addWidget("combo","Device",this.properties.port,{property:"port",values:this.getMIDIOutputs.bind(this)}),this.size=[340,60]}onGetPropertyInfo(t){if(this._midi&&t=="port"){var e=this.getMIDIOutputs();return{type:"enum",values:e}}}getMIDIOutputs(){var t={};if(!this._midi)return Ms.default_ports;if(this._midi.output_ports_info)for(var e=0;e<this._midi.output_ports_info.length;++e){var s=this._midi.output_ports_info[e];if(s){var i=e+".- "+s.name+" version:"+s.version;t[e]=i}}return t}onAction(t,e){this._midi&&(t=="send"&&this._midi.sendMIDI(this.properties.port,e),this.trigger("midi",e))}onGetInputs(){return[["send",y.ACTION]]}onGetOutputs(){return[["on_midi",y.EVENT]]}};Ut.MIDIInterface=Gt;Ut.title="MIDI Output";Ut.desc="Sends MIDI to output channel";Ut.color=_t;Ut.default_ports={0:"unknown"};let Ei=Ut;class Oe extends C{constructor(){if(super(),this.properties={volume:.5,duration:1},this.addInput("note",y.ACTION),this.addInput("volume","number"),this.addInput("duration","number"),this.addOutput("note",y.EVENT),typeof window.AudioSynth>"u")console.error("Audiosynth.js not included, LGMidiPlay requires that library"),this.boxcolor="red";else{var t=this.synth=new window.AudioSynth;this.instrument=t.createInstrument("piano")}}onAction(t,e){if(!(!e||e.constructor!==k)){if(this.instrument&&e.data[0]==k.NOTEON){var s=e.note;if(!s||s=="undefined"||s.constructor!==String)return;this.instrument.play(s,e.octave,this.properties.duration,this.properties.volume)}this.trigger("note",e)}}onExecute(){var t=this.getInputData(1);t!=null&&(this.properties.volume=t);var e=this.getInputData(2);e!=null&&(this.properties.duration=e)}}Oe.title="MIDI Play";Oe.desc="Plays a MIDI note";Oe.color=_t;class Ce extends C{constructor(){super(),this.properties={scale:"A,A#,B,C,C#,D,D#,E,F,F#,G,G#"},this.addInput("note",y.ACTION),this.addInput("scale","string"),this.addOutput("out",y.EVENT),this.valid_notes=new Array(12),this.offset_notes=new Array(12),this.processScale(this.properties.scale)}onPropertyChanged(t,e){t=="scale"&&this.processScale(e)}processScale(t){this._current_scale=t,this.notes_pitches=Rs.processScale(t);for(var e=0;e<12;++e)this.valid_notes[e]=this.notes_pitches.indexOf(e)!=-1;for(var e=0;e<12;++e){if(this.valid_notes[e]){this.offset_notes[e]=0;continue}for(var s=1;s<12;++s){if(this.valid_notes[(e-s)%12]){this.offset_notes[e]=-s;break}if(this.valid_notes[(e+s)%12]){this.offset_notes[e]=s;break}}}}onAction(t,e){if(!(!e||e.constructor!==k))if(e.data[0]==k.NOTEON||e.data[0]==k.NOTEOFF){this.midi_event=new k,this.midi_event.setup(e.data);var s=e.note,i=k.note_to_index[s],n=this.offset_notes[i];this.midi_event.data[1]+=n,this.trigger("out",this.midi_event)}else this.trigger("out",e)}onExecute(){var t=this.getInputData(1);t!=null&&t!=this._current_scale&&this.processScale(t)}}Ce.title="MIDI Quantize Pitch";Ce.desc="Transpose a MIDI note tp fit an scale";Ce.color=_t;class Ae extends C{constructor(){super(),this.addInput("on_midi",y.EVENT),this._str="",this.size=[200,40]}getTitle(){return this.flags.collapsed?this._str:this.title}onAction(t,e){e&&(e.constructor===k?this._str=e.toString():this._str="???")}onDrawForeground(t){!this._str||this.flags.collapsed||(t.font="30px Arial",t.fillText(this._str,10,this.size[1]*.8))}onGetInputs(){return[["in",y.ACTION]]}onGetOutputs(){return[["on_midi",y.EVENT]]}}Ae.title="MIDI Show";Ae.desc="Shows MIDI in the graph";Ae.color=_t;class Se extends C{constructor(){super(),this.properties={amount:0},this.addInput("in",y.ACTION),this.addInput("amount","number"),this.addOutput("out",y.EVENT),this.midi_event=new k}onAction(t,e){!e||e.constructor!==k||(e.data[0]==k.NOTEON||e.data[0]==k.NOTEOFF?(this.midi_event=new k,this.midi_event.setup(e.data),this.midi_event.data[1]=Math.round(this.midi_event.data[1]+this.properties.amount),this.trigger("out",this.midi_event)):this.trigger("out",e))}onExecute(){var t=this.getInputData(1);t!=null&&(this.properties.amount=t)}}Se.title="MIDI Transpose";Se.desc="Transpose a MIDI note";Se.color=_t;const Ni=r=>{r.MIDIEvent=k,r.registerNodeType("midi/input",Kt),r.registerNodeType("midi/output",Ei),r.registerNodeType("midi/show",Ae),r.registerNodeType("midi/filter",jt),r.registerNodeType("midi/event",Ee),r.registerNodeType("midi/cc",Te),r.registerNodeType("midi/generator",Rs),r.registerNodeType("midi/transpose",Se),r.registerNodeType("midi/quantize",Ce),r.registerNodeType("midi/fromFile",Ne),r.registerNodeType("midi/play",Oe),r.registerNodeType("midi/keys",Ti)};class xs extends C{constructor(){super(...arguments),this.properties={},this._value=null,this._str=null,this._error=null}onExecute(){const t=this.getInputData(0);if(t!=this._str&&typeof t=="string"){this._error=null,this._value=null,this._str=t;try{this._value=JSON.parse(this._str),this.boxcolor="#AEA"}catch(e){this._error=`${e}`,this.boxcolor="red"}}else t==null&&(this._str=null,this._value=null,this._error=null,this.boxcolor=h.NODE_DEFAULT_BOXCOLOR);this.setOutputData(0,this._value),this.setOutputData(1,this._error)}onConnectionsChange(t,e,s,i,n){this._str=null}}xs.slotLayout={inputs:[{name:"in",type:"string"}],outputs:[{name:"out",type:"*"},{name:"error",type:"string"}]};class Fs extends C{constructor(){super(...arguments),this.properties={space:0},this._value=null,this._obj=null,this._error=null,this._changed=!1}onExecute(){const t=this.getInputData(0);if(this._changed||this._obj!==t){this._value=null,this._changed=null,this._obj=t,this._error=null;const e=this.properties.space;try{this._value=JSON.stringify(this._obj,null,e),this.boxcolor="#AEA"}catch(s){this._error=`${s}`,this.boxcolor="red"}}else t==null&&(this._obj=null,this._value=null,this._error=null,this.boxcolor=h.NODE_DEFAULT_BOXCOLOR);this.setOutputData(0,this._value),this.setOutputData(1,this._error)}onConnectionsChange(t,e,s,i,n){this._obj=null,this._changed=!0}}Fs.slotLayout={inputs:[{name:"in",type:"*"}],outputs:[{name:"out",type:"string"},{name:"error",type:"string"}]};class Bs extends C{onExecute(){const t=this.getInputData(0);let e="";if(t&&t.constructor===Object)try{e=JSON.stringify(t)}catch{e=String(t)}else e=String(t);this.setOutputData(0,e)}}Bs.slotLayout={inputs:[{name:"in",type:""}],outputs:[{name:"out",type:"string"}]};class Gs extends C{onExecute(){const t=this.getInputData(0)==this.getInputData(1);this.setOutputData(0,t)}}Gs.slotLayout={inputs:[{name:"A",type:"string"},{name:"B",type:"string"}],outputs:[{name:"==",type:"boolean"}]};class zs extends C{onExecute(){const t=this.getInputData(0)+this.getInputData(1);this.setOutputData(0,t)}}zs.slotLayout={inputs:[{name:"A",type:"string"},{name:"B",type:"string"}],outputs:[{name:"out",type:"string"}]};class Hs extends C{onExecute(){const t=this.getInputData(0),e=this.getInputData(1);t==null||e==null?this.setOutputData(0,!1):(t.indexOf(e),this.setOutputData(0,e))}}Hs.slotLayout={inputs:[{name:"A",type:"string"},{name:"B",type:"string"}],outputs:[{name:"contains",type:"string"}]};class Us extends C{constructor(){super(...arguments),this.properties={separator:","}}onExecute(){const t=this.getInputData(0);let e=this.getInputData(1);e==null&&(e=this.properties.separator);let s=[];if(t==null)s=[];else if(t.constructor===String)s=t.split(e||" ");else if(t.constructor===Array){for(var i=[],n=0;n<t.length;++n)typeof t[n]=="string"&&(i[n]=t[n].split(e||" "));s=i}else s=null;this.setOutputData(0,s)}}Us.slotLayout={inputs:[{name:"in",type:"string,array"},{name:"sep",type:"string"}],outputs:[{name:"out",type:"array"}]};class Ke extends C{constructor(t){super(),this.properties={template:"$1, $2, $3",stringQuote:"",outputJSON:!1},this._value=null,this._args=null,this.templateWidget=this.addWidget("text","Template",this.properties.template,"template",{multiline:!0})}formatTemplateValue(t){if(typeof t=="string"){const e=this.properties.stringQuote;return`${e}${t}${e}`}return JSON.stringify(t)}substituteTemplate(t,e){let s=t.replace(/\$(\d+)/g,(i,n)=>this.formatTemplateValue(e[n-1]));return this.properties.outputJSON&&(s=JSON.parse(s)),s}onPropertyChanged(t,e){if(t==="outputJSON"){const s=e==!0;this.outputs[0].type=s?"*":"string",this.boxcolor=h.NODE_DEFAULT_BOXCOLOR}this._value=null}onExecute(){if(this._value==null){const t=this.properties.template||"";let e;if(this._args!=null)e=this._args,this._args=null;else{const s=this.getInputData(0);if(Array.isArray(s))e=s;else{e=[];for(let i=0;i<this.inputs.length;i++)if(this.inputs[i].type!==y.ACTION){const n=this.getInputData(i);e.push(n)}}}try{this.boxcolor=this.properties.outputJSON?"#AEA":h.NODE_DEFAULT_BOXCOLOR,this._value=this.substituteTemplate(t,e)}catch(s){this.boxcolor="red",this._value="",h.debug&&console.error(s)}this.triggerSlot(1,this._value)}this.setOutputData(0,this._value)}onAction(t,e){t==="update"&&(e!=null?Array.isArray(e)?this._args=e:this._args=[e]:this._args=null,this._value=null,this.onExecute())}onConnectionsChange(t,e,s,i,n){if(this._value=null,t===q.INPUT)if(s)i!=null&&e===this.inputs.length-2&&(this.removeInput(this.inputs.length-1),this.addInput("","*"),this.addInput("update",y.ACTION));else{if(this.getInputLink(this.inputs.length-2)!=null)return;this.removeInput(this.inputs.length-1);for(let o=this.inputs.length-1;o>1&&this.getInputLink(o)==null;o--)this.removeInput(o);this.getInputLink(this.inputs.length-1)!=null&&this.addInput("","*"),this.addInput("update",y.ACTION)}}}Ke.slotLayout={inputs:[{name:"",type:"string,array"},{name:"",type:"string"},{name:"update",type:y.ACTION}],outputs:[{name:"out",type:"string"},{name:"changed",type:y.EVENT}]};Ke.propertyLayout=[{name:"template",defaultValue:"$1, $2, $3",options:{multiline:!0}},{name:"stringQuote",defaultValue:""}];class Ws extends C{constructor(){super(...arguments),this.properties={precision:0}}onExecute(){const t=this.getInputData(0);if(t!=null&&t.constructor===Number){const e=t.toFixed(this.properties.precision);this.setOutputData(0,e)}else this.setOutputData(0,`"${t}"`)}}Ws.slotLayout={inputs:[{name:"in",type:"number"}],outputs:[{name:"out",type:"string"}]};class Vs extends C{constructor(){super(...arguments),this.properties={value:"",separator:","},this._table=null,this._str=null,this._last_separator=null}onExecute(){var t=this.getInputData(0);if(t){var e=this.properties.separator||",";(t!=this._str||e!=this._last_separator)&&(this._last_separator=e,this._str=t,this._table=t.split(`
`).map(function(s){return s.trim().split(e)})),this.setOutputData(0,this._table),this.setOutputData(1,this._table?this._table.length:0)}}}Vs.slotLayout={inputs:[{name:"in",type:"number"}],outputs:[{name:"table",type:"table"},{name:"rows",type:"number"}]};class qs extends C{onExecute(){const t=this.getInputData(0);let e=t;t!=null&&t.constructor===String&&(e=t.toUpperCase()),this.setOutputData(0,e)}}qs.slotLayout={inputs:[{name:"in",type:"string"}],outputs:[{name:"out",type:"string"}]};class Ys extends C{onExecute(){const t=this.getInputData(0);let e=t;t!=null&&t.constructor===String&&(e=t.toLowerCase()),this.setOutputData(0,e)}}Ys.slotLayout={inputs:[{name:"in",type:"string"}],outputs:[{name:"out",type:"string"}]};const Ii=r=>{r.registerNodeType({class:xs,title:"JSON Parse",desc:"Parses a string into a JavaScript object",type:"string/json_parse"}),r.registerNodeType({class:Fs,title:"JSON Stringify",desc:"Calls JSON.stringify() on the input value",type:"string/json_stringify"}),r.registerNodeType({class:Gs,title:"Compare",desc:"Compares strings",type:"string/compare"}),r.registerNodeType({class:zs,title:"Concatenate",desc:"Concatenates strings",type:"string/concatenate"}),r.registerNodeType({class:Hs,title:"Contains",desc:"Calls a.indexOf(b)",type:"string/contains"}),r.registerNodeType({class:Us,title:"Split",desc:'Calls str.split(sep || " ")',type:"string/split"}),r.registerNodeType({class:Ke,title:"Template",desc:"Substitutes an array of strings in a template like '$1, $2, $3'",type:"string/template"}),r.registerNodeType({class:Ws,title:"ToFixed",desc:"Calls in.toFixed()",type:"string/toFixed"}),r.registerNodeType({class:Vs,title:"ToTable",desc:"Splits a string to table",type:"string/toTable"}),r.registerNodeType({class:qs,title:"ToUpperCase",desc:"Converts to upper case",type:"string/toUpperCase"}),r.registerNodeType({class:Ys,title:"ToLowerCase",desc:"Converts to lower case",type:"string/toLowerCase"}),r.registerNodeType({class:Bs,title:"ToString",desc:"Calls .toString()",type:"string/toString"})};function It(){this.addOutput("",y.EVENT),this.addOutput("","boolean"),this.addProperty("text","click me"),this.addProperty("font_size",30),this.addProperty("message",""),this.size=[164,84],this.clicked=!1}It.title="Button";It.desc="Triggers an event";It.font="Arial";It.prototype.onDrawForeground=function(r){if(!this.flags.collapsed){var t=10;if(r.fillStyle="black",r.fillRect(t+1,t+1,this.size[0]-t*2,this.size[1]-t*2),r.fillStyle="#AAF",r.fillRect(t-1,t-1,this.size[0]-t*2,this.size[1]-t*2),r.fillStyle=this.clicked?"white":this.mouseOver?"#668":"#334",r.fillRect(t,t,this.size[0]-t*2,this.size[1]-t*2),this.properties.text||this.properties.text===0){var e=this.properties.font_size||30;r.textAlign="center",r.fillStyle=this.clicked?"black":"white",r.font=e+"px "+It.font,r.fillText(this.properties.text,this.size[0]*.5,this.size[1]*.5+e*.3),r.textAlign="left"}}};It.prototype.onMouseDown=function(r,t){if(t[0]>1&&t[1]>1&&t[0]<this.size[0]-2&&t[1]<this.size[1]-2)return this.clicked=!0,this.setOutputData(1,this.clicked),this.triggerSlot(0,this.properties.message),!0};It.prototype.onExecute=function(){this.setOutputData(1,this.clicked)};It.prototype.onMouseUp=function(r){this.clicked=!1};function $t(){this.addOutput("","string"),this.addOutput("change",y.EVENT),this.size=[80,60],this.properties={value:"A",values:"A;B;C"},this.old_y=-1,this.mouse_captured=!1,this._values=this.properties.values.split(";");var r=this;this.widgets_up=!0,this.widget=this.addWidget("combo","",this.properties.value,function(t){r.properties.value=t,r.triggerSlot(1,t)},{property:"value",values:this._values})}$t.title="Combo";$t.desc="Widget to select from a list";$t.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)};$t.prototype.onPropertyChanged=function(r,t){r=="values"?(this._values=t.split(";"),this.widget.options.values=this._values):r=="value"&&(this.widget.value=t)};function Ot(){this.size=[160,26],this.addOutput("","number"),this.properties={color:"#7AF",min:0,max:1,value:.5},this.value=-1}Ot.title="H.Slider";Ot.desc="Linear slider controller";Ot.prototype.onDrawForeground=function(r){this.value==-1&&(this.value=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min)),r.globalAlpha=1,r.lineWidth=1,r.fillStyle="#000",r.fillRect(2,2,this.size[0]-4,this.size[1]-4),r.fillStyle=this.properties.color,r.beginPath(),r.rect(4,4,(this.size[0]-8)*this.value,this.size[1]-8),r.fill()};Ot.prototype.onExecute=function(){this.properties.value=this.properties.min+(this.properties.max-this.properties.min)*this.value,this.setOutputData(0,this.properties.value),this.boxcolor=Yt.colorToString([this.value,this.value,this.value])};Ot.prototype.onMouseDown=function(r){return r.canvasY-this.pos[1]<0?!1:(this.oldmouse=[r.canvasX-this.pos[0],r.canvasY-this.pos[1]],this.captureInput(!0),!0)};Ot.prototype.onMouseMove=function(r){if(this.oldmouse){var t=[r.canvasX-this.pos[0],r.canvasY-this.pos[1]],e=this.value,s=t[0]-this.oldmouse[0];e+=s/this.size[0],e>1?e=1:e<0&&(e=0),this.value=e,this.oldmouse=t,this.setDirtyCanvas(!0)}};Ot.prototype.onMouseUp=function(r){this.oldmouse=null,this.captureInput(!1)};Ot.prototype.onMouseLeave=function(r){};function bt(){this.addOutput("","number"),this.size=[64,84],this.properties={min:0,max:1,value:.5,color:"#7AF",precision:2},this.value=-1}bt.title="Knob";bt.desc="Circular controller";bt.size=[80,100];bt.prototype.onDrawForeground=function(r){if(!this.flags.collapsed){this.value==-1&&(this.value=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min));var t=this.size[0]*.5,e=this.size[1]*.5,s=Math.min(this.size[0],this.size[1])*.5-5;r.globalAlpha=1,r.save(),r.translate(t,e),r.rotate(Math.PI*.75),r.fillStyle="rgba(0,0,0,0.5)",r.beginPath(),r.moveTo(0,0),r.arc(0,0,s,0,Math.PI*1.5),r.fill(),r.strokeStyle="black",r.fillStyle=this.properties.color,r.lineWidth=2,r.beginPath(),r.moveTo(0,0),r.arc(0,0,s-4,0,Math.PI*1.5*Math.max(.01,this.value)),r.closePath(),r.fill(),r.lineWidth=1,r.globalAlpha=1,r.restore(),r.fillStyle="black",r.beginPath(),r.arc(t,e,s*.75,0,Math.PI*2,!0),r.fill(),r.fillStyle=this.mouseOver?"white":this.properties.color,r.beginPath();var i=this.value*Math.PI*1.5+Math.PI*.75;r.arc(t+Math.cos(i)*s*.65,e+Math.sin(i)*s*.65,s*.05,0,Math.PI*2,!0),r.fill(),r.fillStyle=this.mouseOver?"white":"#AAA",r.font=Math.floor(s*.5)+"px Arial",r.textAlign="center",r.fillText(this.properties.value.toFixed(this.properties.precision),t,e+s*.15)}};bt.prototype.onExecute=function(){this.setOutputData(0,this.properties.value),this.boxcolor=Yt.colorToString([this.value,this.value,this.value])};bt.prototype.onMouseDown=function(r){return this.center=[this.size[0]*.5,this.size[1]*.5+20],this.radius=this.size[0]*.5,r.canvasY-this.pos[1]<20||Yt.distance([r.canvasX,r.canvasY],[this.pos[0]+this.center[0],this.pos[1]+this.center[1]])>this.radius?!1:(this.oldmouse=[r.canvasX-this.pos[0],r.canvasY-this.pos[1]],this.captureInput(!0),!0)};bt.prototype.onMouseMove=function(r){if(this.oldmouse){var t=[r.canvasX-this.pos[0],r.canvasY-this.pos[1]],e=this.value;e-=(t[1]-this.oldmouse[1])*.01,e>1?e=1:e<0&&(e=0),this.value=e,this.properties.value=this.properties.min+(this.properties.max-this.properties.min)*this.value,this.oldmouse=t,this.setDirtyCanvas(!0)}};bt.prototype.onMouseUp=function(r){this.oldmouse&&(this.oldmouse=null,this.captureInput(!1))};bt.prototype.onPropertyChanged=function(r,t){if(r=="min"||r=="max"||r=="value")return this.properties[r]=parseFloat(t),!0};function gt(){this.addOutput("","number"),this.size=[80,60],this.properties={min:-1e3,max:1e3,value:1,step:1},this.old_y=-1,this._remainder=0,this._precision=0,this.mouse_captured=!1}gt.title="Number";gt.desc="Widget to select number value";gt.pixels_threshold=10;gt.markers_color="#666";gt.prototype.onDrawForeground=function(r){var t=this.size[0]*.5,e=this.size[1];e>30?(r.fillStyle=gt.markers_color,r.beginPath(),r.moveTo(t,e*.1),r.lineTo(t+e*.1,e*.2),r.lineTo(t+e*-.1,e*.2),r.fill(),r.beginPath(),r.moveTo(t,e*.9),r.lineTo(t+e*.1,e*.8),r.lineTo(t+e*-.1,e*.8),r.fill(),r.font=(e*.7).toFixed(1)+"px Arial"):r.font=(e*.8).toFixed(1)+"px Arial",r.textAlign="center",r.font=(e*.7).toFixed(1)+"px Arial",r.fillStyle="#EEE",r.fillText(this.properties.value.toFixed(this._precision),t,e*.75)};gt.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)};gt.prototype.onPropertyChanged=function(r,t){var e=(this.properties.step+"").split(".");this._precision=e.length>1?e[1].length:0};gt.prototype.onMouseDown=function(r,t){if(!(t[1]<0))return this.old_y=r.canvasY,this.captureInput(!0),this.mouse_captured=!0,!0};gt.prototype.onMouseMove=function(r){if(this.mouse_captured){var t=this.old_y-r.canvasY;r.shiftKey&&(t*=10),(r.metaKey||r.altKey)&&(t*=.1),this.old_y=r.canvasY;var e=this._remainder+t/gt.pixels_threshold;this._remainder=e%1,e=e|0;var s=Nt(this.properties.value+e*this.properties.step,this.properties.min,this.properties.max);this.properties.value=s,this.graph._version++,this.setDirtyCanvas(!0)}};gt.prototype.onMouseUp=function(r,t){if(r.click_time<200){var e=t[1]>this.size[1]*.5?-1:1;this.properties.value=Nt(this.properties.value+e*this.properties.step,this.properties.min,this.properties.max),this.graph._version++,this.setDirtyCanvas(!0)}this.mouse_captured&&(this.mouse_captured=!1,this.captureInput(!1))};function Wt(){this.size=[200,100],this.properties={borderColor:"#ffffff",bgcolorTop:"#f0f0f0",bgcolorBottom:"#e0e0e0",shadowSize:2,borderRadius:3}}Wt.title="Panel";Wt.desc="Non interactive panel";Wt.widgets=[{name:"update",text:"Update",type:"button"}];Wt.prototype.createGradient=function(r){if(this.properties.bgcolorTop==""||this.properties.bgcolorBottom==""){this.lineargradient=0;return}this.lineargradient=r.createLinearGradient(0,0,0,this.size[1]),this.lineargradient.addColorStop(0,this.properties.bgcolorTop),this.lineargradient.addColorStop(1,this.properties.bgcolorBottom)};Wt.prototype.onDrawForeground=function(r){this.flags.collapsed||(this.lineargradient==null&&this.createGradient(r),this.lineargradient&&(r.lineWidth=1,r.strokeStyle=this.properties.borderColor,r.fillStyle=this.lineargradient,this.properties.shadowSize?(r.shadowColor="#000",r.shadowOffsetX=0,r.shadowOffsetY=0,r.shadowBlur=this.properties.shadowSize):r.shadowColor="transparent",r.roundRect(0,0,this.size[0]-1,this.size[1]-1,this.properties.shadowSize),r.fill(),r.shadowColor="transparent",r.stroke()))};function Zt(){this.size=[160,26],this.addInput("","number"),this.properties={min:0,max:1,value:0,color:"#AAF"}}Zt.title="Progress";Zt.desc="Shows data in linear progress";Zt.prototype.onExecute=function(){const r=this.getInputData(0);r!=null&&(this.properties.value=r)};Zt.prototype.onDrawForeground=function(r){r.lineWidth=1,r.fillStyle=this.properties.color;let t=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min);t=Math.min(1,t),t=Math.max(0,t),r.fillRect(2,2,(this.size[0]-4)*t,this.size[1]-4)};function ke(){this.addOutput("","number"),this.properties={value:.5,min:0,max:1,text:"V"};var r=this;this.size=[140,40],this.slider=this.addWidget("slider","V",this.properties.value,function(t){r.properties.value=t},this.properties),this.widgets_up=!0}ke.title="Inner Slider";ke.prototype.onPropertyChanged=function(r,t){r=="value"&&(this.slider.value=t)};ke.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)};function At(){this.addInputs("",0),this.properties={value:"...",font:"Arial",fontsize:18,color:"#AAA",align:"left",glowSize:0,decimals:1}}At.title="Text";At.desc="Shows the input value";At.widgets=[{name:"resize",text:"Resize box",type:"button"},{name:"led_text",text:"LED",type:"minibutton"},{name:"normal_text",text:"Normal",type:"minibutton"}];At.prototype.onDrawForeground=function(r){r.fillStyle=this.properties.color;var t=this.properties.value;this.properties.glowSize?(r.shadowColor=this.properties.color,r.shadowOffsetX=0,r.shadowOffsetY=0,r.shadowBlur=this.properties.glowSize):r.shadowColor="transparent";var e=this.properties.fontsize;if(r.textAlign=this.properties.align,r.font=e.toString()+"px "+this.properties.font,this.str=typeof t=="number"?t.toFixed(this.properties.decimals):t,typeof this.str=="string")for(var s=this.str.replace(/[\r\n]/g,"\\n").split("\\n"),i=0;i<s.length;i++)r.fillText(s[i],this.properties.align=="left"?15:this.size[0]-15,e*-.15+e*(parseInt(`${i}`)+1));r.shadowColor="transparent",this.last_ctx=r,r.textAlign="left"};At.prototype.onExecute=function(){var r=this.getInputData(0);r!=null&&(this.properties.value=r)};At.prototype.resize=function(){if(this.last_ctx){var r=this.str.split("\\n");this.last_ctx.font=this.properties.fontsize+"px "+this.properties.font;for(var t=0,e=0;e<r.length;e++){var s=this.last_ctx.measureText(r[e]).width;t<s&&(t=s)}this.size[0]=t+20,this.size[1]=4+r.length*this.properties.fontsize,this.setDirtyCanvas(!0)}};At.prototype.onPropertyChanged=function(r,t){return this.properties[r]=t,this.str=typeof t=="number"?t.toFixed(3):t,!0};function Lt(){this.addInput("","boolean"),this.addInput("e",y.ACTION),this.addOutput("v","boolean"),this.addOutput("e",y.EVENT),this.properties={font:"",value:!1},this.size=[160,44]}Lt.title="Toggle";Lt.desc="Toggles between true or false";Lt.prototype.onDrawForeground=function(r){if(!this.flags.collapsed){var t=this.size[1]*.5,e=.25,s=this.size[1]*.8;r.font=this.properties.font||(t*.8).toFixed(0)+"px Arial";var i=r.measureText(this.title).width,n=(this.size[0]-(i+t))*.5;r.fillStyle="#AAA",r.fillRect(n,s-t,t,t),r.fillStyle=this.properties.value?"#AEF":"#000",r.fillRect(n+t*e,s-t+t*e,t*(1-e*2),t*(1-e*2)),r.textAlign="left",r.fillStyle="#AAA",r.fillText(this.title,t*1.2+n,s*.85),r.textAlign="left"}};Lt.prototype.onAction=function(r){this.properties.value=!this.properties.value,this.trigger("e",this.properties.value)};Lt.prototype.onExecute=function(){var r=this.getInputData(0);r!=null&&(this.properties.value=r),this.setOutputData(0,this.properties.value)};Lt.prototype.onMouseDown=function(r,t){if(t[0]>1&&t[1]>1&&t[0]<this.size[0]-2&&t[1]<this.size[1]-2)return this.properties.value=!this.properties.value,this.graph._version++,this.trigger("e",this.properties.value),!0};const Oi=r=>{r.registerNodeType("widget/button",It),r.registerNodeType("widget/toggle",Lt),r.registerNodeType("widget/number",gt),r.registerNodeType("widget/combo",$t),r.registerNodeType("widget/knob",bt),r.registerNodeType("widget/internal_slider",ke),r.registerNodeType("widget/hslider",Ot),r.registerNodeType("widget/progress",Zt),r.registerNodeType("widget/text",At),r.registerNodeType("widget/panel",Wt)};h.use(pi);h.use(ci);h.use(gi);h.use(_i);h.use(vi);h.use(mi);h.use(bi);h.use(Ni);h.use(Ii);h.use(Oi);function Ci(r){r.clear();const t=h.createNode("basic/number");t.pos=[200,100],t.setValue(5);const e=h.createNode("basic/watch");e.pos=[500,100],r.add(t),r.add(e),t.connect(0,e,0)}function Ai(r){r.clear();var t=h.createNode("basic/number");t.pos=[200,100],t.setValue(5);var e=h.createNode("basic/number");e.pos=[200,200],e.setValue(10);var s=h.createNode("basic/watch");s.pos=[500,100];var i=h.createNode("basic/watch");i.pos=[500,200],r.add(t),r.add(e),r.add(s),r.add(i),t.connect(0,s,0),e.connect(0,i,0)}function Si(r){r.clear();var t=h.createNode("basic/number");t.pos=[200,100],t.setValue(5);var e=h.createNode("basic/number");e.pos=[200,200],e.setValue(10);var s=h.createNode("basic/watch");s.pos=[500,100];var i=h.createNode("basic/watch");i.pos=[500,200];var n=h.createNode("math/operation");n.pos=[500,300];var o=h.createNode("basic/watch");o.pos=[700,100],r.add(t),r.add(e),r.add(s),r.add(i),r.add(n),r.add(o),t.connect(0,n,0),e.connect(0,n,1),t.connect(0,s,0),e.connect(0,i,0),n.connect(0,o,0)}function ki(r){r.clear();const t=h.createNode("audio/source");t.pos=[200,100],t.setProperty("src","./demodata/audio.wav");const e=h.createNode("audio/destination");e.pos=[400,100],r.add(t),r.add(e),t.connect(0,e,0)}function wi(r){r.clear();const t=h.createNode("widget/knob");t.pos=[50,50];const e=h.createNode("audio/source");e.pos=[200,50],e.setProperty("src","./demodata/audio.wav");const s=h.createNode("audio/destination");s.pos=[400,50];const i=h.createNode("audio/analyser");i.pos=[400,300];const n=h.createNode("audio/visualization");n.pos=[600,50];const o=h.createNode("audio/visualization");o.pos=[600,300],r.add(t),r.add(e),r.add(s),r.add(i),r.add(n),r.add(o),t.connect(0,e,0),e.connect(0,s,0),e.connect(0,i,0),i.connect(0,n,0),i.connect(1,o,0)}function Di(r){r.clear();const t=h.createNode("widget/knob");t.pos=[50,50];const e=h.createNode("audio/source");e.pos=[200,50],e.setProperty("src","./demodata/oscillofun.mp3");const s=h.createNode("audio/destination");s.pos=[400,50];const i=h.createNode("audio/analyser");i.pos=[400,100];const n=h.createNode("audio/visualization");n.pos=[600,50];const o=h.createNode("audio/visualization");o.pos=[600,300];const a=h.createNode("audio/oscilloscope");a.pos=[200,200],a.size=[300,300],r.add(t),r.add(e),r.add(s),r.add(i),r.add(n),r.add(o),r.add(a),t.connect(0,e,0),e.connect(0,s,0),e.connect(0,i,0),i.connect(0,n,0),i.connect(1,o,0),e.connect(1,a,0)}function Li(r){r.clear();const t=h.createNode("circuit/oscillator");t.pos=[200,100];const e=h.createNode("circuit/led");e.pos=[500,100],r.add(t),r.add(e),t.connect(0,e,0)}class Pt extends C{constructor(){super(),this.addInput("level","Boolean"),this.value=!1}onExecute(){let t=this.getInputData(0);this.value=t}onDrawBackground(t,e){this.flags.collapsed||(t.save(),t.fillStyle=this.value?"#fff":"#000",t.fillRect(0,0,this.size[0],this.size[1]),t.restore())}}Pt.shape=1;Pt.title="LED";Pt.desc="LED";Pt.title_color="#012";Pt.registerType="circuit/led";Pt.filter="is_filter";class Rt extends C{constructor(){super(),this.addOutput("level","Boolean"),this.value=!0,this.time=Date.now(),this.properties={freq:1},this.value_widget=this.addWidget("number","Freq",this.properties.freq,"freq",{min:1,max:20,step:1})}onExecute(){let t=Date.now();t-this.time>1e3/this.properties.freq&&(this.time=t,this.value=!this.value,this.setOutputData(0,this.value),this.setDirtyCanvas(!0,!0))}}Rt.title="Oscillator";Rt.desc="Oscillator";Rt.shape=1;Rt.title_color="#012";Rt.registerType="circuit/oscillator";Rt.filter="is_filter";const Pi=r=>{[Rt,Pt].forEach(e=>{r.registerNodeType({type:e.registerType,class:e,title:e.title,name:e.title,desc:e.desc})})},Ri={install:Pi};function Xs(){this.addOutput("","number"),this.properties={},this.slider=this.addWidget("slider","Slider",.5,function(r){},{min:0,max:1}),this.number=this.addWidget("number","Number",.5,function(r){},{min:0,max:100}),this.combo=this.addWidget("combo","Combo","red",function(r){},{values:["red","green","blue"]}),this.text=this.addWidget("text","Text","edit me",function(r){},{}),this.text2=this.addWidget("text","Text","multiline",function(r){},{multiline:!0}),this.toggle=this.addWidget("toggle","Toggle",!0,function(r){},{on:"enabled",off:"disabled"}),this.button=this.addWidget("button","Button",null,function(r){},{}),this.toggle2=this.addWidget("toggle","Disabled",!0,function(r){},{on:"enabled",off:"disabled"}),this.toggle2.disabled=!0,this.serialize_widgets=!0,this.size=this.computeSize()}Xs.title="Widgets";function Mt(){this.addInput("","number"),this.addOutput("","number"),this.properties={},this.size=this.computeSize(),this.visible=!1,this.enabled=!1}Mt.title="Custom Shapes";Mt.title_mode=LiteGraph.TRANSPARENT_TITLE;Mt.slot_start_y=20;Mt.prototype.onDrawBackground=function(r){this.flags.collapsed||(r.fillStyle="#555",r.fillRect(0,0,this.size[0],20),this.enabled&&(r.fillStyle="#AFB",r.beginPath(),r.moveTo(this.size[0]-20,0),r.lineTo(this.size[0]-25,20),r.lineTo(this.size[0],20),r.lineTo(this.size[0],0),r.fill()),this.visible&&(r.fillStyle="#ABF",r.beginPath(),r.moveTo(this.size[0]-40,0),r.lineTo(this.size[0]-45,20),r.lineTo(this.size[0]-25,20),r.lineTo(this.size[0]-20,0),r.fill()),r.strokeStyle="#333",r.beginPath(),r.moveTo(0,20),r.lineTo(this.size[0]+1,20),r.moveTo(this.size[0]-20,0),r.lineTo(this.size[0]-25,20),r.moveTo(this.size[0]-40,0),r.lineTo(this.size[0]-45,20),r.stroke(),this.mouseOver&&(r.fillStyle="#AAA",r.fillText("Example of helper",0,this.size[1]+14)))};Mt.prototype.onMouseDown=function(r,t){t[1]>20||(t[0]>this.size[0]-20?this.enabled=!this.enabled:t[0]>this.size[0]-40&&(this.visible=!this.visible))};Mt.prototype.onBounding=function(r){!this.flags.collapsed&&this.mouseOver&&(r[3]=this.size[1]+20)};function js(){this.addInput("C","number"),this.addOutput("A","number"),this.addOutput("B","number"),this.horizontal=!0,this.size=[100,40]}js.title="Flat Slots";function Ks(){this.properties={name:"foo",age:10,alive:!0,children:["John","Emily","Charles"],skills:{speed:10,dexterity:100}};var r=this;this.addWidget("button","Log",null,function(){console.log(r.properties)})}Ks.title="Properties";const Mi=r=>{r.registerNodeType({type:"features/widgets",class:Xs}),r.registerNodeType({type:"features/shape",class:Mt}),r.registerNodeType({type:"features/slots",class:js}),r.registerNodeType({type:"features/properties_editor",class:Ks})},xi={install:Mi};h.use(Ri);h.use(xi);h.debug=!1;h.node_images_path="./imgs";class Fi{constructor(t,e={}){this.meter=null,this.graphCanvas2=null,this.miniwindow=null,this.options=e,this.root=this.createRoot(),this.tools=this.root.querySelector(".tools"),this.toolsLeft=this.root.querySelector(".tools-left"),this.toolsRight=this.root.querySelector(".tools-right"),this.content=this.root.querySelector(".content"),this.footer=this.root.querySelector(".footer"),this.canvas=this.root.querySelector(".graphCanvas"),this.addLoadCounter(),this.selector=this.createSelector(),this.addButtonsToLeft(),this.addButtonsToRight(e),e.miniwindow&&this.addMiniWindow(300,200);const s=document.getElementById(t);s&&s.appendChild(this.root),this.graph=new Fe,this.graphCanvas=new O(this.canvas,this.graph),this.graphCanvas.background_image="./imgs/grid.png",this.graph.onAfterExecute=()=>{this.graphCanvas.draw(!0)},this.graphCanvas.onDropItem=this.onDropItem.bind(this),this.graphCanvas.resize(),this.load()}createRoot(){const t=document.createElement("div");return t.className="litegraph litegraph-editor",t.innerHTML=`
        <div class='header'>
          <div class='tools tools-left'></div>
          <div class='tools tools-right'></div>
        </div>
        <div class='content'>
          <div class='editor-area'>
            <canvas class='graphCanvas'></canvas>
          </div>
        </div>
        `,t}addLoadCounter(){this.meter=document.createElement("div"),this.meter.className="headerpanel loadmeter toolbar-widget";var t=`
<div class='cpuload'>
  <strong>CPU</strong>
  <div class='bgload'>
    <div class='fgload'></div>
  </div>
</div>
<div class='gpuload'>
  <strong>GFX</strong>
  <div class='bgload'>
    <div class='fgload'></div>
  </div>
</div>
`;this.meter.innerHTML=t,this.root.querySelector(".header .tools-left").appendChild(this.meter);var e=this;setInterval(()=>{this.meter.querySelector(".cpuload .fgload").style.width=2*e.graph.execution_time*90+"px",e.graph.status==ct.STATUS_RUNNING?this.meter.querySelector(".gpuload .fgload").style.width=e.graphCanvas.render_time*10*90+"px":this.meter.querySelector(".gpuload .fgload").style.width="4px"},200)}addToolsButton(t,e,s,i,n){n||(n=".tools");var o=this.createButton(e,s,i);o.id=t,this.root.querySelector(n).appendChild(o)}createSelector(){const t=document.createElement("span");t.id="LGEditorTopBarSelector",t.className="selector",t.innerHTML=`
    <select>
      <option>Empty</option>
    </select>
    `;const e=t.querySelector("select");return e.addEventListener("change",s=>{const i=this.selector.selectedIndex,n=this.selector.options[i],o=n.dataset.url;this.stop(),o?this.graph.load(o):n.callback?n.callback():this.graph.clear()}),this.toolsLeft.appendChild(t),e}createButton(t,e,s){var i=document.createElement("button");return e&&(i.innerHTML="<img src='"+e+"'/> "),i.classList.add("btn"),i.innerHTML+=t,s&&i.addEventListener("click",s),i}addButtonsToLeft(){this.addToolsButton("save","Save","",this.save.bind(this),".tools-left"),this.addToolsButton("load","Load","",this.load.bind(this),".tools-left"),this.addToolsButton("download","Download","",this.download.bind(this),".tools-left")}addButtonsToRight(t){this.addToolsButton("playnode_button","Play","imgs/icon-play.png",this.onPlayButton.bind(this),".tools-right"),this.addToolsButton("playstepnode_button","Step","imgs/icon-playstep.png",this.onPlayStepButton.bind(this),".tools-right"),t.skipLiveMode||this.addToolsButton("livemode_button","Live","imgs/icon-record.png",this.onLiveButton.bind(this),".tools-right"),t.skipMaximize||this.addToolsButton("maximize_button","","imgs/icon-maximize.png",this.onFullscreenButton.bind(this),".tools-right")}save(){console.log(this);try{const t=JSON.stringify(this.graph.serialize());localStorage.setItem("graphdemo_save",t),console.log("saved")}catch(t){console.log("save error",t)}}load(){const t=localStorage.getItem("graphdemo_save");if(t)try{this.graph.configure(JSON.parse(t)),console.log("loaded")}catch(e){console.log("load error",e)}}download(){var t=JSON.stringify(this.graph.serialize()),e=new Blob([t]),s=URL.createObjectURL(e),i=document.createElement("a");i.setAttribute("href",s),i.setAttribute("download","graph.json"),i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i),setTimeout(()=>{URL.revokeObjectURL(s)},1e3*60)}onPlayButton(){this.graph.status==ct.STATUS_STOPPED?this.start():this.stop()}start(){var t=this.root.querySelector("#playnode_button");t.innerHTML="<img src='imgs/icon-stop.png'/> Stop",this.graph.start()}stop(){var t=this.root.querySelector("#playnode_button");t.innerHTML="<img src='imgs/icon-play.png'/> Play",this.graph.stop()}onPlayStepButton(){var t=this.graph;t.runStep(1),this.graphCanvas.draw(!0,!0)}onLiveButton(){var t=!this.graphCanvas.live_mode;this.graphCanvas.switchLiveMode(!0),this.graphCanvas.draw();var e=this.root.querySelector("#livemode_button");e.innerHTML=t?"<img src='imgs/icon-gear.png'/> Edit":"<img src='imgs/icon-record.png'/> Live"}onDropItem(t){if(t.dataTransfer){var e=this;for(let s=0;s<t.dataTransfer.files.length;++s){let i=t.dataTransfer.files[s],n=O.getFileExtension(i.name),o=new FileReader;n=="json"&&(o.onload=function(a){var l=JSON.parse(o.result);e.graph.configure(l)},o.readAsText(i))}}}toggleFullscreen(){if(!document.fullscreenElement)document.documentElement.requestFullscreen();else if(document.exitFullscreen)document.exitFullscreen();else throw"Fullscreen not supported";var t=this;setTimeout(function(){t.graphCanvas.resize()},100)}onFullscreenButton(){this.toggleFullscreen()}addMiniWindow(t,e){this.miniwindow&&(console.warn("Miniwindow already created."),this.miniwindow.close()),this.miniwindow=document.createElement("div"),this.miniwindow.className="litegraph miniwindow",this.miniwindow.innerHTML="<canvas class='graphCanvas' width='"+t+"' height='"+e+"' tabindex=10></canvas>";var s=new O(this.canvas,this.graph);s.show_info=!1,s.background_image="imgs/grid.png",s.scale=.25,s.allow_dragnodes=!1,s.allow_interaction=!1,s.render_shadows=!1,s.maxZoom=.25,this.miniwindow.graphCanvas=s,s.onClear=function(){s.scale=.25,s.allow_dragnodes=!1,s.allow_interaction=!1},s.onRenderBackground=(n,o)=>{o.strokeStyle="#567";var a=s.convertOffsetToCanvas([0,0]),l=s.convertOffsetToCanvas([s.canvas.width,s.canvas.height]);a=s.convertCanvasToOffset(a),l=s.convertCanvasToOffset(l),o.lineWidth=1,o.strokeRect(Math.floor(a[0])+.5,Math.floor(a[1])+.5,Math.floor(l[0]-a[0]),Math.floor(l[1]-a[1]))},this.miniwindow.style.position="absolute",this.miniwindow.style.top="4px",this.miniwindow.style.right="4px",this.miniwindow.close=()=>{s.setGraph(null),this.miniwindow.parentNode.removeChild(this.miniwindow)};var i=document.createElement("div");i.className="corner-button",i.innerHTML="&#10060;",i.addEventListener("click",this.miniwindow.close.bind(this)),this.miniwindow.appendChild(i),this.root.querySelector(".content").appendChild(this.miniwindow)}addMultiview(){var t=this.canvas;this.graphCanvas.ctx.fillStyle="black",this.graphCanvas.ctx.fillRect(0,0,t.width,t.height),this.graphCanvas.viewport=[0,0,t.width*.5-2,t.height];var e=new O(t,this.graph);e.background_image="imgs/grid.png",this.graphCanvas2=e,this.graphCanvas2.viewport=[t.width*.5,0,t.width*.5,t.height]}}const mt=new Fi("main",{miniwindow:!1});mt.graphCanvas.pause_rendering=!1;window.addEventListener("resize",()=>{mt.graphCanvas.resize()});window.onbeforeunload=()=>{const r=JSON.stringify(mt.graph.serialize());localStorage.setItem("litegraph demo backup",r)};function pt(r,t){var e=document.createElement("option");typeof t=="string"?e.dataset.url=t:typeof t=="function"&&(e.callback=t),e.innerHTML=r,mt.selector.appendChild(e)}pt("Audio1",()=>ki(mt.graph));pt("Audio2",()=>wi(mt.graph));pt("Audio3",()=>Di(mt.graph));pt("Basic1",()=>Ci(mt.graph));pt("Basic2",()=>Ai(mt.graph));pt("Basic3",()=>Si(mt.graph));pt("Circuit1",()=>Li(mt.graph));pt("Features","examples/features.json");pt("Benchmark","examples/benchmark.json");pt("Subgraph","examples/subgraph.json");pt("Audio","examples/audio.json");pt("Audio Delay","examples/audio_delay.json");pt("Audio Reverb","examples/audio_reverb.json");pt("MIDI Generation","examples/midi_generation.json");
